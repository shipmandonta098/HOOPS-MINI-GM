<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoops Mini GM ‚Äî Starter</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg-0:#0d0f14;
      --bg-1:#11151b;
      --bg-2:#151a21;
      --bg-3:#1b212b;
      --text-0:#e7ecf2;
      --text-1:#b8c0cc;
      --muted:#7c8796;
      --pri:#6aa2ff;
      --pri-2:#2e6bff;
      --good:#3ac679;
      --warn:#ffb020;
      --bad:#ff6b6b;
      --border:#232b36;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius:12px;
      --gap:12px;
      --gap-lg:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); 
      background:linear-gradient(135deg, #0a0c10 0%, #11151b 25%, #0d0f14 50%, #151a21 75%, #0d0f14 100%);
      background-size:400% 400%;
      animation:gradientShift 15s ease infinite;
      color:var(--text-0); letter-spacing:.2px;
    }
    @keyframes gradientShift{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* Setup Screen */
    .setup-screen{
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
      opacity:1; transition:opacity 0.5s ease;
    }
    .setup-screen.fade-out{opacity:0}
    .setup-container{
      width:min(680px, 100%); 
      background:linear-gradient(135deg, rgba(17,21,27,0.95) 0%, rgba(13,15,20,0.98) 100%);
      border:1px solid var(--border); border-radius:16px; 
      box-shadow:0 20px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(106,162,255,0.1);
      backdrop-filter:blur(20px);
      overflow:hidden;
    }
    .setup-header{
      padding:32px 32px 24px; text-align:center; 
      background:linear-gradient(180deg, rgba(106,162,255,0.08) 0%, transparent 100%);
      border-bottom:1px solid var(--border);
    }
    .setup-header h1{
      margin:0 0 8px; font-size:32px; font-weight:700; 
      background:linear-gradient(135deg, var(--pri) 0%, #8bb9ff 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .setup-header .tagline{
      color:var(--text-1); font-size:14px; font-style:italic;
    }
    .setup-body{padding:32px}
    .form-group{margin-bottom:20px}
    .form-group label{
      display:block; margin-bottom:6px; font-size:13px; font-weight:600; 
      color:var(--text-0); letter-spacing:0.3px;
    }
    .form-group input, .form-group select{
      width:100%; padding:12px 14px; border-radius:10px; 
      background:rgba(12,17,24,0.6); color:var(--text-0); 
      border:1px solid var(--border); font-family:var(--sans); font-size:14px;
      transition:all 0.2s ease;
    }
    .form-group input:focus, .form-group select:focus{
      outline:none; border-color:var(--pri); 
      box-shadow:0 0 0 3px rgba(106,162,255,0.15);
    }
    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    
    .toggle-field{
      display:flex; align-items:center; justify-content:space-between; 
      padding:12px 14px; background:rgba(12,17,24,0.4); 
      border:1px solid var(--border); border-radius:10px;
      cursor:pointer; transition:background 0.2s ease;
    }
    .toggle-field:hover{background:rgba(27,33,43,0.6)}
    .toggle-field label{margin:0; cursor:pointer; font-size:14px}
    .toggle-switch{
      position:relative; width:44px; height:24px; 
      background:var(--bg-3); border-radius:999px; 
      border:1px solid var(--border); transition:all 0.3s ease;
    }
    .toggle-switch::after{
      content:""; position:absolute; top:2px; left:2px; 
      width:18px; height:18px; background:var(--text-1); 
      border-radius:50%; transition:all 0.3s ease;
    }
    input[type="checkbox"]:checked + .toggle-switch{
      background:var(--pri); border-color:var(--pri);
    }
    input[type="checkbox"]:checked + .toggle-switch::after{
      left:22px; background:white;
    }
    input[type="checkbox"]{display:none}

    .advanced-toggle{
      margin:24px 0 16px; padding:12px; background:rgba(106,162,255,0.05); 
      border:1px solid rgba(106,162,255,0.2); border-radius:10px; 
      cursor:pointer; text-align:center; font-weight:600; 
      color:var(--pri); transition:all 0.2s ease;
    }
    .advanced-toggle:hover{background:rgba(106,162,255,0.1)}
    .advanced-settings{
      max-height:0; overflow:hidden; transition:max-height 0.4s ease;
    }
    .advanced-settings.open{max-height:400px}

    .setup-actions{
      padding:24px 32px 32px; display:flex; gap:12px; 
      border-top:1px solid var(--border);
    }
    .setup-btn{
      flex:1; padding:14px 24px; border-radius:10px; 
      font-size:15px; font-weight:600; cursor:pointer; 
      border:1px solid var(--border); transition:all 0.2s ease;
    }
    .setup-btn.primary{
      background:linear-gradient(135deg, var(--pri) 0%, var(--pri-2) 100%);
      border-color:var(--pri); color:white; 
      box-shadow:0 4px 16px rgba(106,162,255,0.3);
    }
    .setup-btn.primary:hover{
      transform:translateY(-2px); 
      box-shadow:0 6px 24px rgba(106,162,255,0.4);
    }
    .setup-btn.secondary{
      background:var(--bg-3); color:var(--text-0);
    }
    .setup-btn.secondary:hover{background:var(--bg-2)}
    .setup-btn.secondary:hover{background:var(--bg-2)}

    /* Main App */
    .app{
      display:none; grid-template-columns:260px 1fr; grid-template-rows:56px 1fr; height:100vh;
      grid-template-areas: "sidebar topbar" "sidebar main";
      opacity:0; transition:opacity 0.5s ease;
    }
    .app.active{display:grid; opacity:1}
    header{
      grid-area:topbar; display:flex; align-items:center; gap:10px; padding:0 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,var(--bg-1),var(--bg-2));
      position:sticky; top:0; z-index:5;
    }
    header .title{font-weight:700; letter-spacing:.4px}
    header .spacer{flex:1}
    header .btn{margin-left:6px}

    aside{
      grid-area:sidebar; border-right:1px solid var(--border); background:linear-gradient(180deg,var(--bg-1),var(--bg-2));
      padding:16px 12px; display:flex; flex-direction:column; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:10px; padding:6px 8px; border-radius:10px}
    .brand svg{filter:drop-shadow(0 2px 8px rgba(0,0,0,.4))}
    .brand strong{font-size:15px; letter-spacing:.6px}
    nav{margin-top:6px; display:flex; flex-direction:column; gap:6px}
    .nav-btn{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color:var(--text-1);
      border:1px solid transparent; background:transparent; cursor:pointer; text-align:left;
    }
    .nav-btn:hover{background:var(--bg-3); color:var(--text-0)}
    .nav-btn.active{background:var(--bg-3); color:var(--text-0); border-color:var(--border)}
    .nav-section{margin-top:auto; padding-top:12px; border-top:1px dashed var(--border);}

    main{
      grid-area:main; padding:16px; overflow:auto;
      display:flex; flex-direction:column; gap:var(--gap-lg);
    }

    .panel{
      background:linear-gradient(180deg,var(--bg-2),var(--bg-1)); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px;
    }
    .panel h2{margin:0 0 10px; font-size:18px}
    .row{display:flex; gap:var(--gap); flex-wrap:wrap}
    .col{flex:1; min-width:280px}

    .capbar{
      display:flex; align-items:center; gap:12px;
    }
    .bar{position:relative; background:#0c1118; border:1px solid var(--border); height:14px; border-radius:999px; overflow:hidden; flex:1}
    .bar .fill{height:100%; background:linear-gradient(90deg,var(--pri),var(--pri-2)); width:0%}
    .kpi{font-family:var(--mono); color:var(--text-1); font-size:12px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
    .btn{
      border:1px solid var(--border); background:var(--bg-3); color:var(--text-0); padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .btn:hover{filter:brightness(1.1)}
    .btn.good{border-color:rgba(58,198,121,.3)}
    .btn.warn{border-color:rgba(255,176,32,.3)}
    .btn.bad{border-color:rgba(255,107,107,.3)}
    .btn.ghost{background:transparent}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:10px; border:1px solid var(--border)}
    thead th{
      position:sticky; top:0; background:var(--bg-2); color:var(--text-1); font-weight:600; font-size:13px; padding:10px; border-bottom:1px solid var(--border); text-align:left; cursor:pointer;
    }
    tbody td{padding:10px; border-bottom:1px solid var(--border); font-size:14px}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .num{text-align:right; font-family:var(--mono)}
    .ovr{font-weight:700}
    .pos{font-weight:600; color:var(--text-1)}
    .pill{font-family:var(--mono); font-size:12px; color:var(--text-1); background:#0c1118; padding:4px 8px; border:1px solid var(--border); border-radius:999px}

    .empty{padding:24px; color:var(--muted); text-align:center}

    /* Dashboard Enhancements */
    .dashboard-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:var(--gap-lg); margin-bottom:var(--gap-lg);
    }
    .dashboard-left, .dashboard-right{display:flex; flex-direction:column; gap:var(--gap-lg)}
    .dashboard-full{grid-column:1/-1}
    
    .record-strip{
      display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:12px;
      padding:12px; background:rgba(106,162,255,0.05); border:1px solid rgba(106,162,255,0.15);
      border-radius:10px;
    }
    .record-item{display:flex; flex-direction:column; gap:2px}
    .record-item label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px}
    .record-item strong{font-size:18px; font-family:var(--mono); color:var(--text-0)}
    
    .perf-grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:8px}
    .perf-item{
      padding:12px; background:rgba(12,17,24,0.5); border:1px solid var(--border); border-radius:8px;
    }
    .perf-item label{display:block; font-size:12px; color:var(--text-1); margin-bottom:4px}
    .perf-item .value{font-size:16px; font-weight:600; font-family:var(--mono)}
    .perf-item .value.good{color:var(--good)}
    .perf-item .value.bad{color:var(--bad)}
    .perf-item .value.neutral{color:var(--text-0)}
    
    .last-ten{display:flex; gap:4px; margin-top:8px}
    .game-dot{
      width:20px; height:20px; border-radius:4px; display:flex; align-items:center; justify-content:center;
      font-size:10px; font-weight:700; border:1px solid var(--border);
    }
    .game-dot.w{background:var(--good); color:white; border-color:var(--good)}
    .game-dot.l{background:var(--bad); color:white; border-color:var(--bad)}
    
    .finance-row{
      display:flex; justify-content:space-between; align-items:center; padding:10px 0;
      border-bottom:1px solid var(--border);
    }
    .finance-row:last-child{border-bottom:none}
    .finance-label{font-size:13px; color:var(--text-1)}
    .finance-value{font-family:var(--mono); font-size:14px; font-weight:600}
    .status-badge{
      padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600;
      text-transform:uppercase; letter-spacing:0.5px;
    }
    .status-badge.good{background:rgba(58,198,121,0.15); color:var(--good); border:1px solid rgba(58,198,121,0.3)}
    .status-badge.warn{background:rgba(255,176,32,0.15); color:var(--warn); border:1px solid rgba(255,176,32,0.3)}
    .status-badge.bad{background:rgba(255,107,107,0.15); color:var(--bad); border:1px solid rgba(255,107,107,0.3)}
    
    .feed-item{
      padding:10px 12px; margin-bottom:8px; background:rgba(12,17,24,0.4);
      border-left:3px solid var(--border); border-radius:6px; font-size:13px;
      transition:all 0.2s ease;
    }
    .feed-item:hover{background:rgba(27,33,43,0.6); border-left-color:var(--pri)}
    .feed-item .feed-tag{
      display:inline-block; padding:2px 6px; border-radius:4px; font-size:10px;
      font-weight:600; margin-right:6px; text-transform:uppercase;
    }
    .feed-item .feed-tag.trade{background:rgba(106,162,255,0.2); color:var(--pri)}
    .feed-item .feed-tag.injury{background:rgba(255,107,107,0.2); color:var(--bad)}
    .feed-item .feed-tag.league{background:rgba(124,135,150,0.2); color:var(--muted)}
    
    .headline-item{
      padding:8px 0; border-bottom:1px solid var(--border); font-size:13px; color:var(--text-1);
      transition:color 0.2s ease;
    }
    .headline-item:hover{color:var(--text-0)}
    .headline-item:last-child{border-bottom:none}
    
    .top-performer{
      display:flex; gap:16px; align-items:center; padding:16px;
      background:linear-gradient(135deg, rgba(106,162,255,0.08) 0%, rgba(46,107,255,0.05) 100%);
      border:1px solid rgba(106,162,255,0.2); border-radius:10px;
    }
    .performer-ovr{
      width:60px; height:60px; border-radius:10px; display:flex; align-items:center;
      justify-content:center; font-size:24px; font-weight:700; font-family:var(--mono);
      background:linear-gradient(135deg, var(--pri), var(--pri-2)); color:white;
      box-shadow:0 4px 12px rgba(106,162,255,0.3);
    }
    .performer-info{flex:1}
    .performer-name{font-size:16px; font-weight:700; margin-bottom:2px}
    .performer-meta{font-size:12px; color:var(--text-1); margin-bottom:8px}
    .performer-stats{display:flex; gap:12px; font-family:var(--mono); font-size:12px}
    .performer-stat{color:var(--text-1)}
    .performer-stat strong{color:var(--text-0); margin-right:2px}
    
    .analytics-strip{
      display:grid; grid-template-columns:2fr 1fr; gap:var(--gap); padding:20px;
      background:linear-gradient(135deg, var(--bg-2) 0%, var(--bg-3) 100%);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .efficiency-grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px}
    .efficiency-item{text-align:center}
    .efficiency-item label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px;
      text-transform:uppercase; letter-spacing:0.5px}
    .efficiency-value{font-size:20px; font-weight:700; font-family:var(--mono); margin-bottom:8px}
    .efficiency-bar{
      height:6px; background:rgba(12,17,24,0.8); border-radius:999px; overflow:hidden;
      border:1px solid var(--border);
    }
    .efficiency-bar .fill{height:100%; transition:width 0.3s ease}
    
    .sentiment-container{display:flex; flex-direction:column; justify-content:center; gap:12px}
    .sentiment-label{font-size:13px; color:var(--text-1); font-weight:600}
    .sentiment-bar{
      position:relative; height:32px; background:rgba(12,17,24,0.6); border-radius:999px;
      border:1px solid var(--border); overflow:hidden;
    }
    .sentiment-bar .fill{
      height:100%; background:linear-gradient(90deg, var(--bad) 0%, var(--warn) 50%, var(--good) 100%);
      transition:width 0.3s ease;
    }
    .sentiment-emoji{font-size:24px; text-align:center}

    /* Roster Tab Enhancements */
    .roster-toolbar{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px;
      padding:16px; background:rgba(27,33,43,0.4); border:1px solid var(--border); border-radius:10px;
    }
    .search-box{
      flex:1; min-width:200px; position:relative;
    }
    .search-box input{
      width:100%; padding:10px 10px 10px 36px; background:rgba(12,17,24,0.6);
      border:1px solid var(--border); border-radius:8px; color:var(--text-0);
      transition:all 0.2s ease;
    }
    .search-box input:focus{border-color:var(--pri); box-shadow:0 0 0 3px rgba(106,162,255,0.15)}
    .search-box::before{
      content:"üîç"; position:absolute; left:12px; top:50%; transform:translateY(-50%);
      font-size:14px; pointer-events:none;
    }
    .filter-group{display:flex; gap:6px; flex-wrap:wrap}
    .filter-btn{
      padding:8px 14px; background:rgba(12,17,24,0.6); border:1px solid var(--border);
      border-radius:8px; color:var(--text-1); cursor:pointer; font-size:13px;
      font-weight:600; transition:all 0.2s ease;
    }
    .filter-btn:hover{background:var(--bg-3); color:var(--text-0)}
    .filter-btn.active{background:var(--pri); border-color:var(--pri); color:white}
    .view-toggle{display:flex; gap:4px; background:rgba(12,17,24,0.6); border-radius:8px; padding:4px}
    .view-toggle button{
      padding:6px 12px; background:transparent; border:none; color:var(--text-1);
      border-radius:6px; cursor:pointer; transition:all 0.2s ease;
    }
    .view-toggle button.active{background:var(--pri); color:white}
    
    /* Player Cards */
    .roster-grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
      gap:16px; margin-top:16px;
    }
    .player-card{
      background:linear-gradient(135deg, rgba(27,33,43,0.8) 0%, rgba(21,26,33,0.9) 100%);
      border:1px solid var(--border); border-radius:12px; padding:16px;
      transition:all 0.2s ease; cursor:pointer; position:relative;
      overflow:hidden;
    }
    .player-card::before{
      content:""; position:absolute; top:0; left:0; right:0; height:4px;
      background:linear-gradient(90deg, var(--pri), var(--pri-2)); opacity:0;
      transition:opacity 0.2s ease;
    }
    .player-card:hover{border-color:var(--pri); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.4)}
    .player-card:hover::before{opacity:1}
    
    .player-header{display:flex; align-items:start; gap:12px; margin-bottom:12px}
    .player-ovr-badge{
      width:56px; height:56px; border-radius:10px; display:flex; align-items:center;
      justify-content:center; font-size:22px; font-weight:700; font-family:var(--mono);
      background:linear-gradient(135deg, var(--pri), var(--pri-2)); color:white;
      box-shadow:0 4px 12px rgba(106,162,255,0.3); flex-shrink:0;
    }
    .player-info{flex:1}
    .player-name{font-size:16px; font-weight:700; margin-bottom:4px; color:var(--text-0)}
    .player-meta{display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:var(--text-1)}
    .player-meta .pos-badge{
      background:rgba(106,162,255,0.15); color:var(--pri); padding:2px 8px;
      border-radius:4px; font-weight:600;
    }
    
    .player-stats{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:12px;
      padding:12px; background:rgba(12,17,24,0.4); border-radius:8px;
    }
    .stat-item{text-align:center}
    .stat-item label{display:block; font-size:10px; color:var(--muted); text-transform:uppercase; margin-bottom:2px}
    .stat-item value{font-size:14px; font-weight:600; font-family:var(--mono)}
    
    .player-contract{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;
      padding:8px 12px; background:rgba(12,17,24,0.3); border-radius:6px;
    }
    .contract-label{font-size:11px; color:var(--muted)}
    .contract-value{font-family:var(--mono); font-size:13px; font-weight:600}
    
    .player-status{display:flex; gap:8px; align-items:center; margin-bottom:12px}
    .status-badge{
      padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600;
      text-transform:uppercase; letter-spacing:0.5px;
    }
    .status-badge.healthy{background:rgba(58,198,121,0.15); color:var(--good); border:1px solid rgba(58,198,121,0.3)}
    .status-badge.injured{background:rgba(255,107,107,0.15); color:var(--bad); border:1px solid rgba(255,107,107,0.3)}
    .status-badge.twoway{background:rgba(124,135,150,0.15); color:var(--muted); border:1px solid rgba(124,135,150,0.3)}
    
    .morale-bar{flex:1; height:8px; background:rgba(12,17,24,0.6); border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .morale-bar .fill{height:100%; transition:width 0.3s ease}
    .morale-emoji{font-size:16px}
    
    .player-actions{display:flex; gap:6px}
    .player-actions .btn{flex:1; padding:6px 10px; font-size:12px}
    
    /* Enhanced Table View */
    .roster-table-view{overflow-x:auto}
    .roster-table-view table{margin-top:0}
    .roster-table-view tbody tr{transition:all 0.2s ease}
    .roster-table-view tbody tr:hover{background:rgba(106,162,255,0.08); transform:scale(1.005)}
    
    .height-weight{font-size:12px; color:var(--text-1); font-family:var(--mono)}
    .morale-cell{display:flex; align-items:center; gap:8px}
    .morale-mini{width:60px; height:6px; background:rgba(12,17,24,0.6); border-radius:999px; overflow:hidden}
    .morale-mini .fill{height:100%}
    
    .team-totals{
      margin-top:16px; padding:16px; background:rgba(106,162,255,0.05);
      border:1px solid rgba(106,162,255,0.2); border-radius:10px;
      display:flex; gap:24px; flex-wrap:wrap; justify-content:space-around;
    }
    .total-item{text-align:center}
    .total-item label{display:block; font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:4px}
    .total-item value{font-size:18px; font-weight:700; font-family:var(--mono); color:var(--text-0)}
    
    /* Tooltip */
    .player-tooltip{
      position:absolute; background:var(--bg-3); border:1px solid var(--border);
      border-radius:8px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.4);
      z-index:100; pointer-events:none; opacity:0; transition:opacity 0.2s ease;
      min-width:200px;
    }
    .player-tooltip.show{opacity:1}
    .tooltip-stat{display:flex; justify-content:space-between; padding:4px 0; font-size:13px}
    .tooltip-stat label{color:var(--text-1)}
    .tooltip-stat value{font-family:var(--mono); font-weight:600}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:99;
    }
    .modal{width:min(560px,92vw); background:var(--bg-2); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow)}
    .modal header{position:unset; grid-area:unset; border-bottom:1px solid var(--border); border-radius:12px 12px 0 0}
    .modal .content{padding:16px}
    .form{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .form .full{grid-column:1/-1}
    label{font-size:12px; color:var(--text-1)}
    input,select{
      width:100%; padding:10px; border-radius:10px; background:#0c1118; color:var(--text-0); border:1px solid var(--border);
      font-family:var(--sans);
    }

    /* Player Profile Modal */
    .profile-modal .content{padding:20px; max-height:calc(90vh - 100px); overflow-y:auto}
    .attr-section{margin-bottom:24px}
    .section-header{font-size:14px; text-transform:uppercase; letter-spacing:0.5px}
    .attr-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px}
    .attr-item{display:flex; flex-direction:column; gap:6px}
    .attr-item label{font-size:12px; color:var(--text-1); font-weight:500}
    .attr-bar-container{
      position:relative; width:100%; height:28px; background:var(--bg-3); border-radius:8px; overflow:hidden;
      display:flex; align-items:center; padding-left:8px
    }
    .attr-bar{
      position:absolute; left:0; top:0; bottom:0; border-radius:8px; transition:width 0.3s ease;
      opacity:0.9;
    }
    .attr-bar.blue{background:linear-gradient(135deg, #4A90E2, #357ABD)}
    .attr-bar.green{background:linear-gradient(135deg, #50C878, #3FA165)}
    .attr-bar.orange{background:linear-gradient(135deg, #FF9F40, #E67E22)}
    .attr-bar.purple{background:linear-gradient(135deg, #9B59B6, #8E44AD)}
    .attr-value{
      position:relative; z-index:1; font-family:var(--mono); font-weight:700; color:white; font-size:13px;
      text-shadow:0 1px 2px rgba(0,0,0,0.5)
    }
    .attr-text{
      padding:8px 12px; background:var(--bg-3); border-radius:8px; color:var(--text-0); font-weight:600;
      font-size:13px
    }
    .attr-item input[type="range"]{
      -webkit-appearance:none; appearance:none; width:100%; height:28px; background:var(--bg-3);
      border-radius:8px; outline:none; padding:0; border:none
    }
    .attr-item input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:20px; height:20px; background:var(--pri);
      cursor:pointer; border-radius:50%
    }
    .attr-item input[type="range"]::-moz-range-thumb{
      width:20px; height:20px; background:var(--pri); cursor:pointer; border-radius:50%; border:none
    }
    .attr-item select.attr-select{
      padding:8px 12px; background:var(--bg-3); border:1px solid var(--border); border-radius:8px;
      color:var(--text-0); font-size:13px; font-weight:600
    }

    /* Responsive */
    @media (max-width: 880px){
      .app{grid-template-columns:1fr; grid-template-rows:auto auto 1fr; grid-template-areas:"topbar" "sidebar" "main"}
      aside{flex-direction:row; overflow:auto; border-right:none; border-bottom:1px solid var(--border)}
      nav{flex-direction:row; flex-wrap:wrap}
      .nav-section{margin-top:0; margin-left:auto; border-top:none; border-left:1px dashed var(--border); padding-left:12px}
      .dashboard-grid{grid-template-columns:1fr}
      .analytics-strip{grid-template-columns:1fr}
      .record-strip{flex-direction:column; align-items:flex-start}
      .roster-toolbar{flex-direction:column; align-items:stretch}
      .search-box{width:100%}
      .filter-group{justify-content:center}
      .roster-grid{grid-template-columns:1fr}
      .team-totals{gap:12px}
      .attr-grid{grid-template-columns:1fr}
      .bio-cards-grid{grid-template-columns:1fr !important}
      .bio-page{max-width:95vw; padding:20px}
      .bio-header{flex-direction:column; align-items:center; text-align:center}
      .bio-header-info{align-items:center}
      .bio-stats-table{font-size:11px}
      .bio-stats-table th, .bio-stats-table td{padding:6px 4px}
    }

    /* Player Bio Page */
    .bio-page{
      background:linear-gradient(135deg, #0a0e16 0%, #1a1f2e 100%);
      border-radius:16px; max-width:1000px; width:90vw; max-height:90vh; overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.6); animation:slideUp 0.4s ease-out;
    }
    @keyframes slideUp{from{opacity:0; transform:translateY(30px)} to{opacity:1; transform:translateY(0)}}
    
    .bio-container{padding:32px}
    
    .bio-header{
      display:flex; gap:24px; margin-bottom:32px; padding-bottom:24px;
      border-bottom:1px solid var(--border); align-items:flex-start;
    }
    .bio-portrait{flex-shrink:0}
    .portrait-circle{
      width:120px; height:120px; border-radius:16px;
      background:linear-gradient(135deg, var(--pri), var(--pri-2));
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 8px 20px rgba(106,162,255,0.3);
      border:3px solid rgba(106,162,255,0.4);
    }
    .portrait-circle span{
      font-size:42px; font-weight:700; color:white;
    }
    .bio-header-info{display:flex; flex-direction:column; gap:8px; flex:1}
    .bio-player-name{font-size:32px; font-weight:700; color:var(--text-0)}
    .bio-nickname{font-size:16px; color:var(--pri); font-style:italic}
    .bio-meta-row{
      display:flex; gap:16px; flex-wrap:wrap; align-items:center; margin-top:8px;
      font-size:14px; color:var(--text-1);
    }
    .bio-badge{
      padding:6px 12px; border-radius:8px; font-weight:700; font-size:13px;
    }
    .bio-badge.position{background:rgba(106,162,255,0.2); color:var(--pri)}
    
    .bio-cards-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px; margin-bottom:24px}
    .bio-card{
      background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px;
      padding:16px; backdrop-filter:blur(10px);
    }
    .card-title{
      font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;
      color:var(--pri); margin-bottom:12px;
    }
    .bio-info-grid{display:flex; flex-direction:column; gap:10px}
    .bio-info-item{display:flex; flex-direction:column; gap:4px}
    .bio-info-item label{font-size:11px; color:var(--text-1); text-transform:uppercase; letter-spacing:0.3px}
    .bio-info-item value{font-size:14px; color:var(--text-0); font-weight:600}
    
    .bio-section{margin-bottom:24px}
    .section-title{
      font-size:16px; font-weight:700; color:var(--text-0); margin-bottom:12px;
      padding-bottom:8px; border-bottom:1px solid var(--border);
    }
    
    .awards-container{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .award-badge{
      padding:8px 16px; border-radius:20px; font-size:12px; font-weight:600;
      border:1px solid; display:inline-block;
    }
    .award-badge.mvp{background:rgba(255,215,0,0.15); color:#FFD700; border-color:#FFD700}
    .award-badge.all-star{background:rgba(106,162,255,0.15); color:var(--pri); border-color:var(--pri)}
    .award-badge.all-nba{background:rgba(80,200,120,0.15); color:var(--good); border-color:var(--good)}
    .award-badge.dpoy{background:rgba(220,53,69,0.15); color:var(--bad); border-color:var(--bad)}
    .award-badge.championship{background:rgba(255,159,64,0.15); color:#FF9F40; border-color:#FF9F40}
    .award-badge.rookie{background:rgba(138,43,226,0.15); color:#8A2BE2; border-color:#8A2BE2}
    .award-badge.all-defense{background:rgba(220,53,69,0.15); color:var(--bad); border-color:var(--bad)}
    
    .stats-table-container{overflow-x:auto}
    .bio-stats-table{
      width:100%; border-collapse:collapse; background:rgba(255,255,255,0.02);
      border-radius:8px; overflow:hidden;
    }
    .bio-stats-table th{
      background:var(--bg-3); padding:10px 12px; text-align:left;
      font-size:12px; color:var(--text-1); font-weight:600; text-transform:uppercase;
    }
    .bio-stats-table td{
      padding:12px; border-top:1px solid var(--border); font-size:13px; color:var(--text-0);
      font-family:var(--mono);
    }
    .bio-stats-table .season-row{background:rgba(106,162,255,0.05)}
    .bio-stats-table .career-row{background:rgba(80,200,120,0.05); font-weight:600}
    
    .bio-personality{
      background:rgba(255,255,255,0.03); border-left:3px solid var(--pri); padding:16px;
      border-radius:8px; color:var(--text-1); line-height:1.6; font-size:14px;
    }
    
    .bio-actions{
      display:flex; gap:12px; justify-content:center; padding-top:24px;
      border-top:1px solid var(--border);
    }

    /* Free Agency Styles */
    .fa-container{
      display:grid; grid-template-columns:1.2fr 1fr; gap:var(--gap-lg);
      height:calc(100vh - 80px); padding:var(--gap-lg);
    }
    .fa-list-panel, .fa-detail-panel{
      overflow:hidden; display:flex; flex-direction:column;
    }
    .fa-toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:16px;
      padding-bottom:12px; border-bottom:1px solid var(--border);
    }
    .fa-top-banner{
      background:linear-gradient(135deg, rgba(106,162,255,0.08) 0%, transparent 100%);
      border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:16px;
    }
    .fa-top-banner strong{
      display:block; margin-bottom:8px; font-size:13px; color:var(--text-0);
    }
    #topFAList{
      display:flex; gap:8px; flex-wrap:wrap; font-size:12px;
    }
    .top-fa-chip{
      background:var(--bg-2); border:1px solid var(--border); padding:6px 12px;
      border-radius:6px; color:var(--text-0); white-space:nowrap;
    }
    .top-fa-chip .ovr{
      color:var(--pri); font-weight:700; margin-left:4px;
    }
    .fa-player-list{
      overflow-y:auto; display:flex; flex-direction:column; gap:8px; flex:1;
    }
    .fa-player-card{
      background:var(--bg-1); border:1px solid var(--border); border-radius:10px;
      padding:12px; cursor:pointer; transition:all 0.2s ease;
      display:grid; grid-template-columns:auto 1fr auto auto; gap:12px; align-items:center;
    }
    .fa-player-card:hover{
      background:var(--bg-2); border-color:var(--pri); transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(106,162,255,0.2);
    }
    .fa-player-card.selected{
      background:var(--bg-3); border-color:var(--pri); box-shadow:0 0 0 2px rgba(106,162,255,0.3);
    }
    .fa-player-avatar{
      width:48px; height:48px; border-radius:50%; background:var(--bg-3);
      display:flex; align-items:center; justify-content:center; font-size:20px;
      border:2px solid var(--border);
    }
    .fa-player-info{
      min-width:0;
    }
    .fa-player-name{
      font-weight:700; font-size:15px; color:var(--text-0); margin-bottom:2px;
    }
    .fa-player-meta{
      font-size:12px; color:var(--text-1); display:flex; gap:8px; align-items:center;
    }
    .fa-player-stats{
      display:flex; gap:12px; align-items:center; font-size:13px;
    }
    .fa-stat{
      display:flex; flex-direction:column; align-items:center; min-width:40px;
    }
    .fa-stat-label{
      font-size:10px; color:var(--muted); text-transform:uppercase;
    }
    .fa-stat-value{
      font-weight:700; color:var(--text-0); font-family:var(--mono);
    }
    .fa-stat-value.ovr{color:var(--pri)}
    .fa-stat-value.pot{color:var(--good)}
    .fa-player-interest{
      min-width:100px;
    }
    .fa-interest-label{
      font-size:10px; color:var(--muted); margin-bottom:4px; text-align:center;
    }
    .fa-interest-bar{
      height:8px; background:var(--bg-3); border-radius:4px; overflow:hidden;
      border:1px solid var(--border);
    }
    .fa-interest-fill{
      height:100%; transition:width 0.3s ease, background 0.3s ease;
    }
    .fa-interest-fill.low{background:linear-gradient(90deg, var(--bad), #ff8888)}
    .fa-interest-fill.med{background:linear-gradient(90deg, var(--warn), #ffc266)}
    .fa-interest-fill.high{background:linear-gradient(90deg, var(--good), #5ad68e)}
    .fa-detail-empty{
      display:flex; align-items:center; justify-content:center; height:100%;
    }
    .fa-detail-content{
      overflow-y:auto; padding:20px;
    }
    .fa-detail-header{
      text-align:center; padding-bottom:20px; border-bottom:1px solid var(--border);
      margin-bottom:20px;
    }
    .fa-detail-avatar{
      width:80px; height:80px; border-radius:50%; background:var(--bg-3);
      margin:0 auto 12px; display:flex; align-items:center; justify-content:center;
      font-size:36px; border:3px solid var(--pri);
    }
    .fa-detail-name{
      font-size:24px; font-weight:700; color:var(--text-0); margin-bottom:4px;
    }
    .fa-detail-meta{
      font-size:14px; color:var(--text-1);
    }
    .fa-detail-section{
      margin-bottom:24px;
    }
    .fa-detail-section h3{
      font-size:14px; font-weight:700; color:var(--text-0); margin-bottom:12px;
      text-transform:uppercase; letter-spacing:0.5px;
    }
    .fa-detail-grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;
    }
    .fa-detail-item{
      background:var(--bg-1); padding:10px; border-radius:8px; border:1px solid var(--border);
    }
    .fa-detail-item label{
      font-size:11px; color:var(--muted); display:block; margin-bottom:4px;
    }
    .fa-detail-item value{
      font-size:16px; font-weight:700; color:var(--text-0); font-family:var(--mono);
    }
    .fa-offer-button{
      width:100%; padding:14px; font-size:16px; font-weight:700;
      background:linear-gradient(135deg, var(--good), #3ac679);
      border:none; border-radius:10px; color:white; cursor:pointer;
      transition:all 0.2s ease; box-shadow:0 4px 12px rgba(58,198,121,0.3);
    }
    .fa-offer-button:hover{
      transform:translateY(-2px); box-shadow:0 6px 16px rgba(58,198,121,0.4);
    }
    .fa-offer-button:disabled{
      background:var(--bg-3); color:var(--muted); cursor:not-allowed;
      box-shadow:none; transform:none;
    }
    .checkbox-label{
      display:flex; align-items:center; gap:6px; cursor:pointer;
    }
    .checkbox-label input[type="checkbox"]{
      width:16px; height:16px; cursor:pointer;
    }
    
    /* Contract Modal Specific */
    .interest-bar-container{
      height:12px; background:var(--bg-3); border-radius:6px; overflow:hidden;
      border:1px solid var(--border);
    }
    .interest-bar-fill{
      height:100%; transition:width 0.3s ease;
      background:linear-gradient(90deg, var(--good), #5ad68e);
    }
    
    /* Coaching Styles */
    .coaching-container{
      padding:var(--gap-lg); max-width:1400px; margin:0 auto;
      height:calc(100vh - 80px); overflow-y:auto;
    }
    .coaching-staff-section, .coaching-candidates-section{
      margin-bottom:32px;
    }
    .coach-card-container{
      margin-bottom:20px;
    }
    .coach-card{
      background:var(--bg-1); border:1px solid var(--border); border-radius:12px;
      padding:20px; transition:all 0.2s ease;
    }
    .coach-card.head-coach{
      border:2px solid var(--pri); background:linear-gradient(135deg, var(--bg-1) 0%, rgba(106,162,255,0.05) 100%);
      box-shadow:0 4px 16px rgba(106,162,255,0.15);
    }
    .coach-card:hover{
      background:var(--bg-2); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.3);
    }
    .coach-header{
      display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;
    }
    .coach-name-section{
      flex:1;
    }
    .coach-name{
      font-size:20px; font-weight:700; color:var(--text-0); margin-bottom:4px;
    }
    .coach-meta{
      font-size:13px; color:var(--text-1); display:flex; gap:12px; align-items:center;
    }
    .coach-role-badge{
      display:inline-block; padding:4px 10px; background:var(--bg-3);
      border:1px solid var(--pri); border-radius:6px; font-size:11px;
      color:var(--pri); font-weight:600; text-transform:uppercase;
    }
    .coach-actions{
      display:flex; gap:8px;
    }
    .coach-trust-section{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:12px; margin-bottom:16px;
    }
    .trust-label{
      font-size:11px; color:var(--muted); margin-bottom:6px; text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .trust-bar-container{
      height:10px; background:var(--bg-3); border-radius:5px; overflow:hidden;
      border:1px solid var(--border); margin-bottom:6px;
    }
    .trust-bar-fill{
      height:100%; transition:width 0.5s ease, background 0.5s ease;
      border-radius:4px;
    }
    .trust-bar-fill.high{background:linear-gradient(90deg, var(--good), #5ad68e)}
    .trust-bar-fill.medium{background:linear-gradient(90deg, var(--warn), #ffc266)}
    .trust-bar-fill.low{background:linear-gradient(90deg, var(--bad), #ff8888)}
    .trust-value{
      font-size:14px; font-weight:700; color:var(--text-0); text-align:right;
    }
    .coach-style-section{
      display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;
    }
    .coach-style-box{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px; padding:12px;
    }
    .coach-style-title{
      font-size:11px; color:var(--muted); margin-bottom:6px; text-transform:uppercase;
    }
    .coach-style-value{
      font-size:16px; font-weight:700; color:var(--pri);
    }
    .coach-style-bars{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:12px;
    }
    .coach-style-bar-item{
      text-align:center;
    }
    .coach-style-bar-label{
      font-size:10px; color:var(--muted); margin-bottom:4px;
    }
    .coach-attrs-grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;
    }
    .coach-attr-item{
      display:flex; justify-content:space-between; align-items:center;
      font-size:13px; padding:8px; background:var(--bg-2); border-radius:6px;
    }
    .coach-attr-label{
      color:var(--text-1);
    }
    .coach-attr-value{
      font-weight:700; color:var(--text-0); font-family:var(--mono);
    }
    .coach-contract-section{
      display:flex; justify-content:space-between; padding-top:12px;
      border-top:1px solid var(--border); margin-top:16px;
    }
    .coach-contract-item{
      text-align:center;
    }
    .coach-contract-label{
      font-size:10px; color:var(--muted); text-transform:uppercase; margin-bottom:4px;
    }
    .coach-contract-value{
      font-size:16px; font-weight:700; color:var(--text-0);
    }
    .assistants-grid, .candidates-grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(380px, 1fr)); gap:16px;
    }
    .candidate-card{
      cursor:pointer; position:relative;
    }
    .candidate-card::after{
      content:'üëÅ View Details'; position:absolute; top:50%; left:50%;
      transform:translate(-50%, -50%); background:rgba(106,162,255,0.95);
      color:white; padding:8px 16px; border-radius:8px; font-size:13px;
      font-weight:600; opacity:0; transition:opacity 0.2s ease; pointer-events:none;
    }
    .candidate-card:hover::after{
      opacity:1;
    }
    .hire-coach-btn{
      margin-top:12px; width:100%;
    }
    .coach-report-card{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-top:16px;
    }
    .report-card-item{
      background:var(--bg-3); border:1px solid var(--border); border-radius:8px;
      padding:12px; text-align:center;
    }
    .report-card-label{
      font-size:11px; color:var(--muted); margin-bottom:6px;
    }
    .report-card-value{
      font-size:18px; font-weight:700;
    }
    .report-card-value.good{color:var(--good)}
    .report-card-value.neutral{color:var(--warn)}
    .report-card-value.bad{color:var(--bad)}
    
    /* Owner Styles */
    .owner-container{
      padding:var(--gap-lg); max-width:1200px; margin:0 auto;
      height:calc(100vh - 80px); overflow-y:auto;
    }
    .owner-profile-section{
      padding:24px; margin-bottom:20px;
    }
    .owner-header{
      display:flex; gap:24px; align-items:flex-start; margin-bottom:24px;
      padding-bottom:20px; border-bottom:1px solid var(--border);
    }
    .owner-portrait{
      width:100px; height:100px; border-radius:50%;
      background:linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(218,165,32,0.1) 100%);
      border:3px solid rgba(255,215,0,0.4);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 4px 20px rgba(255,215,0,0.2);
    }
    .owner-silhouette{
      font-size:48px; filter:drop-shadow(0 2px 8px rgba(255,215,0,0.4));
    }
    .owner-info{
      flex:1;
    }
    .owner-info h3{
      font-size:24px; font-weight:700; color:var(--text-0); margin:0 0 8px 0;
    }
    .owner-meta{
      font-size:14px; color:var(--text-1); display:flex; gap:12px; margin-bottom:8px;
    }
    .owner-desc{
      font-size:13px; color:var(--muted); font-style:italic;
    }
    .trust-meter-section{
      background:var(--bg-2); border:1px solid var(--border); border-radius:12px;
      padding:20px; margin-bottom:20px;
    }
    .section-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
      letter-spacing:0.5px; margin-bottom:12px; font-weight:600;
    }
    .trust-meter-display{
      display:flex; align-items:center; gap:20px;
    }
    .trust-value-large{
      font-size:48px; font-weight:700; color:var(--text-0);
      font-family:var(--mono); min-width:100px;
    }
    .trust-bar-large-container{
      flex:1; height:24px; background:var(--bg-3); border-radius:12px;
      overflow:hidden; border:2px solid var(--border); position:relative;
    }
    .trust-bar-large-fill{
      height:100%; transition:width 1s ease, background 0.5s ease;
      box-shadow:inset 0 2px 8px rgba(255,255,255,0.1);
    }
    .trust-bar-large-fill.critical{background:linear-gradient(90deg, #b91c1c, #dc2626)}
    .trust-bar-large-fill.low{background:linear-gradient(90deg, #dc2626, #ef4444)}
    .trust-bar-large-fill.medium{background:linear-gradient(90deg, #f59e0b, #fbbf24)}
    .trust-bar-large-fill.good{background:linear-gradient(90deg, #10b981, #34d399)}
    .trust-bar-large-fill.excellent{background:linear-gradient(90deg, #059669, #10b981)}
    .trust-status{
      font-size:14px; font-weight:600; color:var(--text-1); margin-left:20px;
    }
    .owner-notes{
      background:rgba(106,162,255,0.05); border:1px solid rgba(106,162,255,0.2);
      border-radius:8px; padding:16px;
    }
    .owner-notes-text{
      font-size:14px; color:var(--text-0); line-height:1.6;
      font-style:italic;
    }
    .owner-expectations-section, .owner-financial-section, .owner-traits-section, .owner-meetings-section{
      padding:20px; margin-bottom:20px;
    }
    .owner-expectations-section h3, .owner-financial-section h3, .owner-traits-section h3, .owner-meetings-section h3{
      font-size:18px; font-weight:700; color:var(--text-0); margin:0 0 16px 0;
    }
    .goals-grid{
      display:flex; flex-direction:column; gap:12px; margin-bottom:16px;
    }
    .goal-item{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px; display:flex; justify-content:space-between; align-items:center;
    }
    .goal-item.high-priority{
      border-left:4px solid var(--bad);
    }
    .goal-item.medium-priority{
      border-left:4px solid var(--warn);
    }
    .goal-item.low-priority{
      border-left:4px solid var(--pri);
    }
    .goal-info{
      flex:1;
    }
    .goal-type{
      font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:4px;
    }
    .goal-desc{
      font-size:14px; color:var(--text-0); font-weight:600; margin-bottom:4px;
    }
    .goal-priority{
      font-size:12px; color:var(--text-1);
    }
    .goal-status{
      display:flex; align-items:center; gap:8px; font-size:24px;
    }
    .goal-status.met{color:var(--good)}
    .goal-status.unmet{color:var(--bad)}
    .goal-status.pending{color:var(--muted)}
    .financial-grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:16px;
    }
    .financial-item{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px; text-align:center;
    }
    .financial-label{
      font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:8px;
    }
    .financial-value{
      font-size:20px; font-weight:700; color:var(--text-0); margin-bottom:4px;
    }
    .financial-sublabel{
      font-size:12px; color:var(--text-1);
    }
    .traits-grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;
    }
    .trait-item{
      display:flex; flex-direction:column; gap:6px;
    }
    .trait-label{
      font-size:12px; color:var(--text-1); display:flex; justify-content:space-between;
    }
    .trait-value{
      font-weight:700; color:var(--text-0); font-family:var(--mono);
    }
    .meetings-list{
      display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto;
    }
    .meeting-item{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:12px; display:flex; gap:12px; align-items:flex-start;
    }
    .meeting-icon{
      font-size:20px; width:32px; text-align:center;
    }
    .meeting-content{
      flex:1;
    }
    .meeting-type{
      font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:4px;
    }
    .meeting-text{
      font-size:13px; color:var(--text-0); margin-bottom:4px;
    }
    .meeting-date{
      font-size:11px; color:var(--text-1);
    }
    .empty-state{
      padding:40px; text-align:center; color:var(--muted); font-size:14px;
    }
    .owner-meeting-modal{
      animation:slideIn 0.3s ease;
    }
    @keyframes slideIn{
      from{transform:translateY(-20px); opacity:0}
      to{transform:translateY(0); opacity:1}
    }
    .owner-meeting-feedback{
      background:linear-gradient(135deg, var(--bg-2) 0%, rgba(106,162,255,0.05) 100%);
      border:1px solid var(--border); border-radius:12px; padding:24px;
      text-align:center; margin-bottom:20px;
    }
    .owner-meeting-portrait{
      font-size:64px; margin-bottom:16px;
      filter:drop-shadow(0 4px 12px rgba(255,215,0,0.3));
    }
    .owner-meeting-quote{
      font-size:16px; color:var(--text-0); line-height:1.6; font-style:italic;
      position:relative; padding:0 20px;
    }
    .owner-meeting-quote::before{
      content:'"'; position:absolute; left:0; top:-10px;
      font-size:48px; color:var(--pri); opacity:0.3;
    }
    .trust-change-indicator{
      background:rgba(106,162,255,0.1); border:1px solid rgba(106,162,255,0.3);
      border-radius:8px; padding:12px; margin-bottom:20px;
      display:flex; align-items:center; gap:12px; justify-content:center;
    }
    .trust-change-icon{
      font-size:24px; font-weight:700;
    }
    .trust-change-icon.positive{color:var(--good)}
    .trust-change-icon.negative{color:var(--bad)}
    .trust-change-text{
      font-size:14px; font-weight:600; color:var(--text-0);
    }
    .meeting-actions{
      display:flex; gap:12px; justify-content:center;
    }
    
    /* Finance Styles */
    .finance-container{
      display:flex; flex-direction:column; gap:24px; max-width:1400px; margin:0 auto;
    }
    .finance-panel{
      background:var(--bg-1); border:1px solid var(--border); border-radius:12px;
      padding:24px;
    }
    .finance-panel h3{
      margin:0 0 20px 0; font-size:20px; color:var(--text-0);
      border-bottom:2px solid var(--border); padding-bottom:12px;
    }
    .finance-kpis{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px; margin-bottom:24px;
    }
    .finance-kpi{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px; text-align:center;
    }
    .kpi-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
      margin-bottom:8px; letter-spacing:0.5px;
    }
    .kpi-value{
      font-size:24px; font-weight:700; color:var(--text-0);
      font-family:var(--mono);
    }
    .kpi-value.good{color:var(--good)}
    .kpi-value.bad{color:var(--bad)}
    .kpi-badge{
      display:inline-block; padding:6px 12px; border-radius:6px;
      font-size:13px; font-weight:600; margin-top:4px;
    }
    .cap-visual{
      margin-bottom:24px;
    }
    .cap-bar-container{
      position:relative; height:40px; background:var(--bg-2);
      border:1px solid var(--border); border-radius:8px; overflow:visible;
      margin-bottom:32px;
    }
    .cap-bar-fill{
      height:100%; background:linear-gradient(90deg, var(--good) 0%, var(--warn) 70%, var(--bad) 100%);
      border-radius:7px; transition:width 0.3s ease;
    }
    .cap-marker{
      position:absolute; top:-8px; bottom:-8px; width:2px;
      background:rgba(255,255,255,0.5); transform:translateX(-1px);
    }
    .cap-marker-label{
      position:absolute; top:-24px; left:50%; transform:translateX(-50%);
      font-size:10px; color:var(--muted); text-transform:uppercase;
      white-space:nowrap; font-weight:600;
    }
    .cap-line{background:rgba(106,162,255,0.6)}
    .tax-line{background:rgba(255,193,7,0.7)}
    .apron1-line{background:rgba(255,107,53,0.7)}
    .apron2-line{background:rgba(220,53,69,0.8)}
    .cap-legend{
      display:flex; gap:20px; flex-wrap:wrap; justify-content:center;
      font-size:12px; color:var(--text-1);
    }
    .legend-item{
      display:flex; align-items:center; gap:6px;
    }
    .legend-dot{
      width:12px; height:12px; border-radius:50%; display:inline-block;
    }
    .roster-breakdown{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px;
    }
    .section-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
      margin-bottom:12px; font-weight:600; letter-spacing:0.5px;
    }
    .top-salaries-list{
      display:flex; flex-direction:column; gap:8px;
    }
    .salary-row{
      display:flex; justify-content:space-between; align-items:center;
      padding:8px; background:var(--bg-1); border-radius:6px;
    }
    .salary-player-name{
      font-size:13px; color:var(--text-0); font-weight:600;
    }
    .salary-player-value{
      font-size:13px; color:var(--text-1); font-family:var(--mono);
    }
    .finance-breakdown{
      display:flex; flex-direction:column; gap:24px; margin-bottom:24px;
    }
    .breakdown-section{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px;
    }
    .breakdown-header{
      font-size:13px; color:var(--text-0); font-weight:600;
      margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid var(--border);
    }
    .breakdown-items{
      display:flex; flex-direction:column; gap:12px;
    }
    .breakdown-item{
      display:grid; grid-template-columns:140px 1fr 100px; gap:12px;
      align-items:center; font-size:12px;
    }
    .breakdown-label{
      color:var(--text-1); font-weight:500;
    }
    .breakdown-bar{
      height:20px; background:var(--bg-1); border-radius:4px;
      overflow:hidden; position:relative;
    }
    .breakdown-bar-fill{
      height:100%; background:var(--good); transition:width 0.3s ease;
      display:block;
    }
    .breakdown-bar-fill.bad{background:var(--bad)}
    .breakdown-value{
      text-align:right; color:var(--text-0); font-family:var(--mono);
      font-weight:600;
    }
    .highlight-tax{
      background:rgba(255,193,7,0.05); border:1px solid rgba(255,193,7,0.2);
      border-radius:6px; padding:8px; margin-top:4px;
    }
    .finance-controls{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px; background:var(--bg-2); border:1px solid var(--border);
      border-radius:8px; padding:20px;
    }
    .control-item{
      display:flex; flex-direction:column; gap:8px;
    }
    .control-item label{
      font-size:12px; color:var(--text-1); font-weight:600;
    }
    .control-item input[type="range"]{
      width:100%; height:6px; background:var(--bg-1); border-radius:3px;
      outline:none; -webkit-appearance:none; appearance:none;
    }
    .control-item input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:16px; height:16px; background:var(--pri); border-radius:50%;
      cursor:pointer;
    }
    .control-item input[type="range"]::-moz-range-thumb{
      width:16px; height:16px; background:var(--pri); border-radius:50%;
      cursor:pointer; border:none;
    }
    .control-item span{
      font-size:13px; color:var(--text-0); font-family:var(--mono);
      font-weight:600; text-align:center;
    }
    .outlook-table{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      overflow:hidden; margin-bottom:16px;
    }
    .outlook-header{
      display:grid; grid-template-columns:80px repeat(5, 1fr);
      background:var(--bg-3); border-bottom:2px solid var(--border);
      font-weight:600; font-size:11px; color:var(--muted);
      text-transform:uppercase;
    }
    .outlook-row{
      display:grid; grid-template-columns:80px repeat(5, 1fr);
      border-bottom:1px solid var(--border); font-size:13px;
    }
    .outlook-row:last-child{border-bottom:none}
    .outlook-cell{
      padding:12px; text-align:center; color:var(--text-0);
    }
    .outlook-cell.year{
      font-weight:700; background:var(--bg-1); color:var(--pri);
    }
    .outlook-cell.total{
      font-weight:700; font-family:var(--mono);
    }
    .outlook-cell.status{
      font-size:11px; font-weight:600; text-transform:uppercase;
    }
    .outlook-notes{
      background:rgba(106,162,255,0.05); border:1px solid rgba(106,162,255,0.2);
      border-radius:8px; padding:16px; font-size:12px; color:var(--text-1);
      line-height:1.6;
    }
    .outlook-notes p{
      margin:0 0 8px 0;
    }
    .outlook-notes p:last-child{margin:0}
    .owner-budget-panel{
      background:linear-gradient(135deg, var(--bg-1) 0%, rgba(255,215,0,0.03) 100%);
      border:2px solid rgba(255,215,0,0.2);
    }
    .owner-budget-details{
      display:flex; flex-direction:column; gap:12px;
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px; margin-bottom:20px;
    }
    .budget-item{
      display:flex; justify-content:space-between; align-items:center;
      font-size:13px; padding:8px 0; border-bottom:1px solid var(--border);
    }
    .budget-item:last-child{border-bottom:none}
    .budget-label{
      color:var(--text-1); font-weight:500;
    }
    .budget-value{
      color:var(--text-0); font-weight:700; font-family:var(--mono);
    }
    .risk-assessment{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px; margin-bottom:20px;
    }
    .risk-list{
      display:flex; flex-direction:column; gap:10px; margin-top:12px;
    }
    .risk-item{
      display:flex; align-items:flex-start; gap:10px; padding:10px;
      background:var(--bg-1); border-left:3px solid; border-radius:6px;
      font-size:12px; color:var(--text-0);
    }
    .risk-item.high{border-color:var(--bad); background:rgba(220,53,69,0.05)}
    .risk-item.medium{border-color:var(--warn); background:rgba(255,193,7,0.05)}
    .risk-item.low{border-color:var(--good); background:rgba(40,167,69,0.05)}
    .risk-icon{
      font-size:16px; flex-shrink:0; margin-top:2px;
    }
    .budget-recommendations{
      background:var(--bg-2); border:1px solid var(--border); border-radius:8px;
      padding:16px;
    }
    .recommendations-list{
      display:flex; flex-direction:column; gap:10px; margin-top:12px;
    }
    .recommendation-item{
      display:flex; align-items:flex-start; gap:10px; padding:12px;
      background:rgba(106,162,255,0.05); border:1px solid rgba(106,162,255,0.2);
      border-radius:6px; font-size:12px; color:var(--text-0); line-height:1.5;
    }
    .recommendation-icon{
      font-size:16px; flex-shrink:0; margin-top:2px;
    }
    
    /* Fan Hype Meter Styles */
    .fan-hype-widget{
      background:var(--bg-2); border:1px solid var(--border); border-radius:12px;
      padding:20px; display:flex; flex-direction:column; align-items:center; gap:16px;
    }
    .fan-hype-label{
      font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;
      font-weight:600;
    }
    .fan-hype-meter{
      position:relative; width:140px; height:140px;
    }
    .fan-hype-circle{
      width:100%; height:100%; border-radius:50%;
      background:conic-gradient(
        from 0deg,
        var(--hype-color) 0deg,
        var(--hype-color) calc(var(--hype-percent) * 3.6deg),
        var(--bg-3) calc(var(--hype-percent) * 3.6deg),
        var(--bg-3) 360deg
      );
      display:flex; align-items:center; justify-content:center;
      position:relative;
      transition:all 0.5s ease;
    }
    .fan-hype-circle.glow{
      filter:drop-shadow(0 0 20px var(--hype-color));
      animation:pulseGlow 2s ease-in-out infinite;
    }
    @keyframes pulseGlow{
      0%, 100%{ filter:drop-shadow(0 0 15px var(--hype-color)); }
      50%{ filter:drop-shadow(0 0 30px var(--hype-color)); }
    }
    .fan-hype-inner{
      width:110px; height:110px; border-radius:50%;
      background:var(--bg-1); display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:4px;
    }
    .fan-hype-value{
      font-size:36px; font-weight:700; color:var(--hype-color);
      line-height:1;
    }
    .fan-hype-max{
      font-size:14px; color:var(--muted); font-weight:500;
    }
    .fan-hype-sentiment{
      font-size:14px; font-weight:600; color:var(--hype-color);
      text-transform:uppercase; letter-spacing:1px;
    }
    .fan-hype-history{
      width:100%; max-height:150px; overflow-y:auto;
      font-size:11px; color:var(--muted);
    }
    .fan-hype-event{
      padding:6px 0; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; gap:8px;
    }
    .fan-hype-event:last-child{ border-bottom:none; }
    .fan-hype-delta{
      font-weight:600; min-width:40px; text-align:right;
    }
    .fan-hype-delta.positive{ color:#4ade80; }
    .fan-hype-delta.negative{ color:#f87171; }
    
    /* Schedule Styles */
    .schedule-container{
      display:flex; flex-direction:column; gap:20px;
    }
    .schedule-header{
      display:grid; grid-template-columns:1fr auto auto; gap:20px; align-items:center;
      padding:16px;
    }
    .schedule-nav{
      display:flex; gap:12px; align-items:center;
    }
    .month-display{
      font-size:18px; font-weight:700; min-width:150px; text-align:center;
    }
    .schedule-stats{
      display:flex; gap:20px;
    }
    .stat-item{
      display:flex; flex-direction:column; gap:4px;
    }
    .stat-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
    }
    .stat-value{
      font-size:16px; font-weight:600;
    }
    .schedule-actions{
      display:flex; gap:8px;
    }
    .schedule-layout{
      display:grid; grid-template-columns:500px 1fr; gap:20px;
    }
    .schedule-calendar{
      display:flex; flex-direction:column; gap:16px;
    }
    .calendar-filters{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .filter-btn{
      background:var(--bg-3); border:1px solid var(--border); padding:6px 12px;
      border-radius:6px; font-size:12px; cursor:pointer; transition:all 0.2s;
    }
    .filter-btn:hover{
      background:var(--bg-2); color:var(--text-0);
    }
    .filter-btn.active{
      background:var(--accent); color:#000; font-weight:600;
    }
    .calendar-grid{
      display:grid; grid-template-columns:repeat(7, 1fr); gap:4px;
    }
    .calendar-day-header{
      background:var(--bg-3); padding:8px 4px; text-align:center;
      font-size:10px; font-weight:600; color:var(--muted);
      text-transform:uppercase; border-radius:4px;
    }
    .calendar-cell{
      background:var(--bg-3); border:1px solid var(--border); border-radius:6px;
      padding:6px; min-height:80px; cursor:pointer; transition:all 0.2s;
      position:relative;
    }
    .calendar-cell:hover{
      background:var(--bg-2); border-color:var(--accent);
    }
    .calendar-cell.selected{
      background:var(--bg-2); border-color:var(--accent); box-shadow:0 0 12px rgba(74,222,128,0.3);
    }
    .calendar-cell.other-month{
      opacity:0.3;
    }
    .calendar-cell.today{
      border-color:var(--accent); border-width:2px;
    }
    .cell-date{
      font-size:11px; color:var(--muted); margin-bottom:4px;
    }
    .game-badge{
      font-size:10px; padding:3px 6px; border-radius:4px; margin-bottom:2px;
      display:inline-block;
    }
    .game-badge.home{
      background:rgba(74,222,128,0.2); color:#4ade80; border:1px solid #4ade80;
    }
    .game-badge.away{
      background:rgba(96,165,250,0.2); color:#60a5fa; border:1px solid #60a5fa;
    }
    .game-badge.tv{
      background:rgba(251,191,36,0.2); color:#fbbf24; border:1px solid #fbbf24;
      font-weight:600;
    }
    .game-badge.rivalry{
      background:rgba(239,68,68,0.2); color:#ef4444; border:1px solid #ef4444;
      font-weight:600;
    }
    .game-badge.b2b{
      background:rgba(168,85,247,0.2); color:#a855f7; border:1px solid #a855f7;
    }
    .game-result{
      font-size:13px; font-weight:700; margin-top:4px;
    }
    .game-result.win{
      color:var(--good);
    }
    .game-result.loss{
      color:var(--bad);
    }
    .game-opponent{
      font-size:11px; color:var(--text-1); margin-top:4px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .game-detail-panel{
      min-height:600px;
    }
    .game-detail-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border);
    }
    .game-detail-title{
      font-size:20px; font-weight:700;
    }
    .game-detail-meta{
      font-size:12px; color:var(--muted); display:flex; gap:12px; margin-top:8px;
    }
    .win-probability{
      display:flex; flex-direction:column; gap:8px; margin:20px 0;
      padding:16px; background:var(--bg-3); border-radius:8px;
    }
    .win-prob-label{
      font-size:12px; color:var(--muted); text-transform:uppercase;
    }
    .win-prob-bar{
      height:24px; background:var(--bg-1); border-radius:4px; overflow:hidden;
      position:relative;
    }
    .win-prob-fill{
      height:100%; background:linear-gradient(90deg, var(--good), #4ade80);
      transition:width 0.3s;
    }
    .win-prob-value{
      position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
      font-size:14px; font-weight:700; color:var(--text-0);
    }
    .opponent-preview{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:16px;
      margin:20px 0; padding:16px; background:var(--bg-3); border-radius:8px;
    }
    .preview-item{
      display:flex; flex-direction:column; gap:4px;
    }
    .preview-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
    }
    .preview-value{
      font-size:14px; font-weight:600;
    }
    
    /* Draft Styles */
    .draft-container{
      display:flex; flex-direction:column; gap:20px;
    }
    .draft-header{
      display:flex; justify-content:space-between; align-items:center;
      padding:16px; gap:20px; flex-wrap:wrap;
    }
    .draft-status{
      display:flex; gap:24px; flex-wrap:wrap;
    }
    .status-item{
      display:flex; flex-direction:column; gap:4px;
    }
    .status-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .status-value{
      font-size:18px; font-weight:700; color:var(--text-0);
      font-family:var(--mono);
    }
    .draft-actions{
      display:flex; gap:12px; flex-wrap:wrap;
    }
    .draft-layout{
      display:grid; grid-template-columns:450px 1fr; gap:20px;
      min-height:600px;
    }
    @media (max-width: 1200px){
      .draft-layout{grid-template-columns:1fr}
    }
    .draft-board{
      display:flex; flex-direction:column; max-height:800px;
    }
    .board-header{
      display:flex; justify-content:space-between; align-items:center;
      padding-bottom:12px; border-bottom:2px solid var(--border);
      margin-bottom:16px;
    }
    .board-header h3{
      margin:0; font-size:18px; color:var(--text-0);
    }
    .board-controls{
      display:flex; gap:8px;
    }
    .btn-sm{
      padding:6px 10px; font-size:12px; background:var(--bg-2);
      border:1px solid var(--border); border-radius:6px; color:var(--text-0);
      cursor:pointer;
    }
    .btn-sm:hover{background:var(--bg-3)}
    .input-sm{
      padding:8px; font-size:13px; background:var(--bg-2);
      border:1px solid var(--border); border-radius:6px; color:var(--text-0);
      font-family:var(--mono); width:80px;
    }
    .board-tiers{
      flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:12px;
    }
    .tier-group{
      display:flex; flex-direction:column;
    }
    .tier-header{
      font-size:11px; font-weight:700; text-transform:uppercase;
      padding:8px 12px; background:var(--bg-3); border-radius:6px;
      margin-bottom:8px; display:flex; align-items:center; gap:8px;
    }
    .tier-badge{
      display:inline-block; padding:2px 8px; border-radius:4px;
      font-size:10px; font-weight:600;
    }
    .tier-badge.Elite{background:rgba(138,43,226,0.2); color:#8a2be2}
    .tier-badge.High{background:rgba(30,144,255,0.2); color:#1e90ff}
    .tier-badge.Mid{background:rgba(50,205,50,0.2); color:#32cd32}
    .tier-badge.Late{background:rgba(255,165,0,0.2); color:#ffa500}
    .tier-badge.Flyer{background:rgba(128,128,128,0.2); color:#888}
    .prospect-list{
      display:flex; flex-direction:column; gap:6px;
    }
    .prospect-card{
      background:var(--bg-2); border:1px solid var(--border);
      border-radius:8px; padding:12px; cursor:pointer;
      transition:all 0.2s; position:relative;
    }
    .prospect-card:hover{
      background:var(--bg-3); border-color:var(--pri); transform:translateX(4px);
    }
    .prospect-card.selected{
      border-color:var(--pri); background:rgba(106,162,255,0.1);
    }
    .prospect-card.drafted{
      opacity:0.4; cursor:default; filter:grayscale(0.8);
    }
    .prospect-card.drafted:hover{
      transform:none; border-color:var(--border);
    }
    .prospect-header{
      display:flex; justify-content:space-between; align-items:flex-start;
      margin-bottom:8px;
    }
    .prospect-name{
      font-size:14px; font-weight:700; color:var(--text-0);
    }
    .prospect-rank{
      font-size:20px; font-weight:700; color:var(--muted);
      font-family:var(--mono); line-height:1;
    }
    .prospect-meta{
      display:flex; gap:12px; font-size:12px; color:var(--text-1);
      margin-bottom:8px;
    }
    .prospect-flags{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .prospect-flag{
      font-size:16px; line-height:1;
    }
    .confidence-bar-container{
      height:4px; background:var(--bg-1); border-radius:2px;
      overflow:hidden; margin-top:8px;
    }
    .confidence-bar{
      height:100%; background:linear-gradient(90deg, var(--bad) 0%, var(--warn) 50%, var(--good) 100%);
      transition:width 0.3s;
    }
    .draft-detail{
      display:flex; flex-direction:column;
    }
    .detail-tabs{
      display:flex; gap:8px; border-bottom:2px solid var(--border);
      margin-bottom:16px;
    }
    .detail-tab{
      padding:10px 16px; background:transparent; border:none;
      color:var(--text-1); font-size:13px; font-weight:600;
      cursor:pointer; border-bottom:3px solid transparent;
      transition:all 0.2s; margin-bottom:-2px;
    }
    .detail-tab:hover{color:var(--text-0); border-bottom-color:var(--muted)}
    .detail-tab.active{color:var(--pri); border-bottom-color:var(--pri)}
    .detail-content{
      flex:1; overflow-y:auto;
    }
    .prospect-detail-card{
      background:var(--bg-2); border:1px solid var(--border);
      border-radius:12px; padding:20px;
    }
    .prospect-detail-header{
      display:flex; justify-content:space-between; align-items:flex-start;
      margin-bottom:20px; padding-bottom:16px; border-bottom:2px solid var(--border);
    }
    .prospect-detail-name{
      font-size:24px; font-weight:700; color:var(--text-0);
      margin-bottom:4px;
    }
    .prospect-detail-archetype{
      font-size:14px; color:var(--text-1); font-style:italic;
    }
    .prospect-measurables{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:16px;
      margin-bottom:20px;
    }
    .measurable-item{
      text-align:center;
    }
    .measurable-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
      margin-bottom:4px;
    }
    .measurable-value{
      font-size:18px; font-weight:700; color:var(--text-0);
      font-family:var(--mono);
    }
    .skills-grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;
      margin-bottom:20px;
    }
    .skill-item{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; background:var(--bg-1); border-radius:6px;
    }
    .skill-label{
      font-size:12px; color:var(--text-1); font-weight:600;
    }
    .skill-grade{
      font-size:16px; font-weight:700; font-family:var(--mono);
      padding:4px 10px; border-radius:4px;
    }
    .skill-grade.hidden{
      color:var(--muted); opacity:0.3;
    }
    .skill-grade.A, .skill-grade.A-{color:#32cd32}
    .skill-grade.B+, .skill-grade.B, .skill-grade.B-{color:#1e90ff}
    .skill-grade.C+, .skill-grade.C, .skill-grade.C-{color:#ffa500}
    .skill-grade.D+, .skill-grade.D, .skill-grade.F{color:var(--bad)}
    .risk-dials{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:16px;
      margin-bottom:20px;
    }
    .risk-dial{
      text-align:center;
    }
    .risk-dial-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
      margin-bottom:8px;
    }
    .risk-dial-circle{
      width:80px; height:80px; margin:0 auto;
      border-radius:50%; position:relative;
      background:conic-gradient(var(--bad) 0deg, var(--bad) var(--risk-deg, 0deg), var(--bg-1) var(--risk-deg, 0deg));
      display:flex; align-items:center; justify-content:center;
    }
    .risk-dial-value{
      width:60px; height:60px; border-radius:50%; background:var(--bg-2);
      display:flex; align-items:center; justify-content:center;
      font-size:18px; font-weight:700; font-family:var(--mono);
      color:var(--text-0);
    }
    .traits-section{
      margin-top:20px; padding-top:16px; border-top:1px solid var(--border);
    }
    .traits-section h4{
      font-size:13px; color:var(--muted); text-transform:uppercase;
      margin-bottom:12px;
    }
    .trait-badges{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .trait-badge{
      padding:6px 12px; border-radius:6px; font-size:12px;
      font-weight:600; border:1px solid;
    }
    .trait-badge.positive{
      background:rgba(40,167,69,0.1); border-color:var(--good); color:var(--good);
    }
    .trait-badge.negative{
      background:rgba(220,53,69,0.1); border-color:var(--bad); color:var(--bad);
    }
    .trait-badge.neutral{
      background:rgba(255,193,7,0.1); border-color:var(--warn); color:var(--warn);
    }
    .scouting-actions{
      display:flex; flex-direction:column; gap:12px;
    }
    .scout-action{
      background:var(--bg-2); border:1px solid var(--border);
      border-radius:8px; padding:16px; display:flex;
      justify-content:space-between; align-items:center;
    }
    .scout-action-info{
      flex:1;
    }
    .scout-action-name{
      font-size:14px; font-weight:700; color:var(--text-0);
      margin-bottom:4px;
    }
    .scout-action-desc{
      font-size:12px; color:var(--text-1);
    }
    .scout-action-cost{
      font-size:12px; color:var(--muted); margin-top:4px;
    }
    .scout-action.completed{
      opacity:0.5; border-color:var(--good);
    }
    .scout-action.completed .scout-action-name::after{
      content:" ‚úì"; color:var(--good);
    }
    .trade-simulator{
      display:flex; flex-direction:column; gap:16px;
    }
    .trade-row{
      display:flex; flex-direction:column; gap:8px;
    }
    .trade-row label{
      font-size:12px; color:var(--text-1); font-weight:600;
    }
    .trade-value-display{
      background:var(--bg-2); border:1px solid var(--border);
      border-radius:8px; padding:16px; display:flex;
      justify-content:space-around;
    }
    .value-item{
      text-align:center;
    }
    .value-label{
      font-size:11px; color:var(--muted); text-transform:uppercase;
      display:block; margin-bottom:4px;
    }
    .value-item span:not(.value-label){
      font-size:16px; font-weight:700; font-family:var(--mono);
      color:var(--text-0);
    }
    .value-highlight{
      color:var(--pri) !important;
    }
    .trade-result{
      padding:12px; border-radius:8px; font-size:13px;
      font-weight:600; text-align:center; margin-top:8px;
    }
    .trade-result.success{
      background:rgba(40,167,69,0.1); color:var(--good);
      border:1px solid var(--good);
    }
    .trade-result.failure{
      background:rgba(220,53,69,0.1); color:var(--bad);
      border:1px solid var(--bad);
    }
    .needs-grid{
      display:grid; grid-template-columns:repeat(5, 1fr); gap:12px;
    }
    .need-item{
      background:var(--bg-2); border:1px solid var(--border);
      border-radius:8px; padding:16px; text-align:center;
    }
    .need-pos{
      font-size:16px; font-weight:700; color:var(--text-0);
      margin-bottom:12px;
    }
    .need-bar-container{
      height:60px; background:var(--bg-1); border-radius:4px;
      overflow:hidden; display:flex; flex-direction:column-reverse;
    }
    .need-bar{
      background:linear-gradient(0deg, var(--bad) 0%, var(--warn) 50%, var(--good) 100%);
      transition:height 0.3s;
    }
    .need-label{
      font-size:11px; color:var(--muted); margin-top:8px;
      text-transform:uppercase;
    }
    
    /* Schedule game action buttons */
    .schedule-game-row button{
      transition: all 0.2s ease;
      font-family: inherit;
    }
    .schedule-game-row button:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      filter: brightness(1.1);
    }
    .schedule-game-row button:active{
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <!-- LEAGUE SETUP SCREEN -->
  <div class="setup-screen" id="setupScreen">
    <div class="setup-container">
      <div class="setup-header">
        <h1>üèÄ Hoops Mini GM</h1>
        <p class="tagline">Build your dynasty. Rewrite basketball history.</p>
      </div>
      
      <div class="setup-body">
        <div class="form-group">
          <label for="leagueName">League Name</label>
          <input type="text" id="leagueName" placeholder="My Basketball Empire" value="My League">
        </div>

        <div class="form-group">
          <label for="teamToManage">Choose Your Team</label>
          <select id="teamToManage">
            <option value="Atlanta Apex">Atlanta Apex</option>
            <option value="Boston Breakers">Boston Breakers</option>
            <option value="Brooklyn Bridges">Brooklyn Bridges</option>
            <option value="Charlotte Cobras">Charlotte Cobras</option>
            <option value="Chicago Cyclones">Chicago Cyclones</option>
            <option value="Cleveland Comets">Cleveland Comets</option>
            <option value="Dallas Dynasty">Dallas Dynasty</option>
            <option value="Denver Elevation">Denver Elevation</option>
            <option value="Detroit Dynamos">Detroit Dynamos</option>
            <option value="Golden State Guardians">Golden State Guardians</option>
            <option value="Houston Heatwave">Houston Heatwave</option>
            <option value="Indiana Ignition">Indiana Ignition</option>
            <option value="LA Lightning">LA Lightning</option>
            <option value="Los Angeles Legends">Los Angeles Legends</option>
            <option value="Memphis Momentum">Memphis Momentum</option>
            <option value="Miami Mirage">Miami Mirage</option>
            <option value="Milwaukee Metros">Milwaukee Metros</option>
            <option value="Minnesota Mavericks">Minnesota Mavericks</option>
            <option value="New Orleans Neptunes">New Orleans Neptunes</option>
            <option value="New York Navigators">New York Navigators</option>
            <option value="Oklahoma City Outlaws">Oklahoma City Outlaws</option>
            <option value="Orlando Overdrive">Orlando Overdrive</option>
            <option value="Philadelphia Phoenixes">Philadelphia Phoenixes</option>
            <option value="Phoenix Predators">Phoenix Predators</option>
            <option value="Portland Pioneers">Portland Pioneers</option>
            <option value="Sacramento Spartans">Sacramento Spartans</option>
            <option value="San Antonio Strikers">San Antonio Strikers</option>
            <option value="San Francisco Riptide" selected>San Francisco Riptide</option>
            <option value="Toronto Tempest">Toronto Tempest</option>
            <option value="Utah Uprising">Utah Uprising</option>
            <option value="Washington Wildcats">Washington Wildcats</option>
            <option value="random">üé≤ Random Team</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="startSeason">Starting Season</label>
            <select id="startSeason">
              <option value="1996">1996-97</option>
              <option value="2000">2000-01</option>
              <option value="2005">2005-06</option>
              <option value="2010">2010-11</option>
              <option value="2015">2015-16</option>
              <option value="2020">2020-21</option>
              <option value="2026" selected>2026-27</option>
            </select>
          </div>

          <div class="form-group">
            <label for="numTeams">Number of Teams</label>
            <select id="numTeams">
              <option value="8">8 Teams</option>
              <option value="12">12 Teams</option>
              <option value="16">16 Teams</option>
              <option value="20">20 Teams</option>
              <option value="24">24 Teams</option>
              <option value="30" selected>30 Teams</option>
              <option value="32">32 Teams</option>
              <option value="36">36 Teams</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="capMode">Salary Cap Mode</label>
            <select id="capMode">
              <option value="fixed">Fixed Cap</option>
              <option value="dynamic" selected>Dynamic Cap</option>
              <option value="custom">Custom</option>
            </select>
          </div>

          <div class="form-group">
            <label for="difficulty">Difficulty</label>
            <select id="difficulty">
              <option value="sandbox" selected>Sandbox</option>
              <option value="balanced">Balanced</option>
              <option value="hardcore">Hardcore</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <div class="toggle-field">
            <label for="confSplit">Conference Split</label>
            <input type="checkbox" id="confSplit" checked>
            <span class="toggle-switch"></span>
          </div>
        </div>

        <div class="form-group">
          <div class="toggle-field">
            <label for="randomNames">Randomize Team Names</label>
            <input type="checkbox" id="randomNames">
            <span class="toggle-switch"></span>
          </div>
        </div>

        <div class="advanced-toggle" id="advancedToggle">
          ‚öôÔ∏è Advanced Settings
        </div>

        <div class="advanced-settings" id="advancedSettings">
          <div class="form-group">
            <div class="toggle-field">
              <label for="expansionDraft">Expansion Draft</label>
              <input type="checkbox" id="expansionDraft">
              <span class="toggle-switch"></span>
            </div>
          </div>

          <div class="form-group">
            <div class="toggle-field">
              <label for="injuries">Player Injuries</label>
              <input type="checkbox" id="injuries" checked>
              <span class="toggle-switch"></span>
            </div>
          </div>

          <div class="form-group">
            <div class="toggle-field">
              <label for="morale">Morale System</label>
              <input type="checkbox" id="morale" checked>
              <span class="toggle-switch"></span>
            </div>
          </div>

          <div class="form-group">
            <div class="toggle-field">
              <label for="realisticContracts">Realistic Contracts</label>
              <input type="checkbox" id="realisticContracts" checked>
              <span class="toggle-switch"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="setup-actions">
        <button class="setup-btn secondary" id="loadSaveBtn">Load Save</button>
        <button class="setup-btn primary" id="startLeagueBtn">Start League</button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="app" id="mainApp">
    <!-- SIDEBAR -->
    <aside>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden="true">
          <circle cx="32" cy="32" r="30" fill="#1f2632" />
          <circle cx="32" cy="22" r="10" fill="#6aa2ff"/>
          <rect x="22" y="34" width="20" height="12" rx="6" fill="#2e6bff"/>
        </svg>
        <strong>Hoops Mini GM</strong>
      </div>
      <nav id="nav">
        <button class="nav-btn active" data-view="dashboard">üè† Dashboard</button>
        <button class="nav-btn" data-view="roster">üßæ Roster</button>
        <button class="nav-btn" data-view="cap">üí∞ Cap Sheet</button>
        <button class="nav-btn" data-view="freeagency">üí∏ Free Agency</button>
        <button class="nav-btn" data-view="coaching">üß† Coaching</button>
        <button class="nav-btn" data-view="owner">üëë Owner</button>
        <button class="nav-btn" data-view="finance">üè¶ Finance</button>
        <button class="nav-btn" data-view="trades">üîÅ Trades</button>
        <button class="nav-btn" data-view="schedule">üóìÔ∏è Schedule</button>
        <button class="nav-btn" data-view="draft">üß¢ Draft</button>
      </nav>
      <div class="nav-section">
        <button class="nav-btn" data-view="settings">‚öôÔ∏è Settings</button>
      </div>
    </aside>

    <!-- TOPBAR -->
    <header>
      <div class="title">San Francisco Riptide</div>
      <span class="tag" id="seasonTag">Season: 2026</span>
      <span class="tag">Mode: <strong style="color:var(--text-0)">Sandbox</strong></span>
      <div class="spacer"></div>
      <button class="btn ghost" id="simDayBtn">Sim Day ‚ñ∂</button>
      <button class="btn good" id="saveBtn">Save</button>
      <button class="btn warn" id="resetBtn">Reset</button>
    </header>

    <!-- MAIN -->
    <main id="viewRoot">
      <!-- DASHBOARD -->
      <section data-view="dashboard">
        <div class="dashboard-grid">
          <!-- LEFT COLUMN -->
          <div class="dashboard-left">
            <!-- Team Overview -->
            <div class="panel">
              <h2>Team Overview</h2>
              <div class="record-strip">
                <div class="record-item">
                  <label>Record</label>
                  <strong id="teamRecord">0-0</strong>
                </div>
                <div class="record-item">
                  <label>Win %</label>
                  <strong id="teamWinPct">.000</strong>
                </div>
                <div class="record-item">
                  <label>Conf. Rank</label>
                  <strong id="confRank">--</strong>
                </div>
                <div class="record-item">
                  <label>Division</label>
                  <strong id="divRank">--</strong>
                </div>
              </div>
              
              <div class="capbar">
                <div class="bar" aria-label="Payroll vs Cap"><div class="fill" id="capFill"></div></div>
                <div class="kpi" id="capKpi">$0 / $0</div>
              </div>
              <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap">
                <span class="pill" id="spacePill">Cap Space: $0</span>
                <span class="pill" id="taxPill">Tax Room: $0</span>
                <span class="pill" id="apronPill">Apron Room: $0</span>
              </div>
              
              <div class="toolbar" style="margin-top:12px">
                <button class="btn" data-view-jump="roster">Open Roster</button>
                <button class="btn" data-view-jump="cap">Cap Sheet</button>
                <button class="btn" data-view-jump="trades">Trades</button>
              </div>
            </div>

            <!-- Performance Snapshot -->
            <div class="panel">
              <h2>Performance Snapshot</h2>
              <div class="perf-item">
                <label>Last 10 Games</label>
                <div class="last-ten" id="lastTen"></div>
              </div>
              
              <div class="perf-grid">
                <div class="perf-item">
                  <label>Point Diff</label>
                  <div class="value neutral" id="pointDiff">+0.0</div>
                </div>
                <div class="perf-item">
                  <label>Current Streak</label>
                  <div class="value neutral" id="streak">--</div>
                </div>
                <div class="perf-item">
                  <label>Team Chemistry</label>
                  <div class="value neutral" id="teamChemistry">--</div>
                </div>
              </div>
              
              <div class="perf-item" style="margin-top:12px">
                <label>Next Opponent</label>
                <div class="value neutral" id="nextOpponent" style="font-size:14px">TBD</div>
              </div>
            </div>

            <!-- Financial Summary -->
            <div class="panel">
              <h2>Financial Summary</h2>
              <div class="finance-row">
                <span class="finance-label">Total Payroll</span>
                <span class="finance-value" id="totalPayroll">$0</span>
              </div>
              <div class="finance-row">
                <span class="finance-label">Cap Room</span>
                <span class="finance-value" id="capRoom">$0</span>
              </div>
              <div class="finance-row">
                <span class="finance-label">Tax Status</span>
                <span class="status-badge good" id="taxStatus">Under Cap</span>
              </div>
              <div class="finance-row">
                <span class="finance-label">Next Season Projection</span>
                <span class="finance-value" id="nextSeasonProj">$0 <span style="color:var(--muted); font-size:11px">‚Üë</span></span>
              </div>
            </div>
            
            <!-- Fan Hype Meter -->
            <div class="fan-hype-widget">
              <div class="fan-hype-label">Fan Sentiment</div>
              <div class="fan-hype-meter">
                <div class="fan-hype-circle" id="fanHypeCircle">
                  <div class="fan-hype-inner">
                    <div class="fan-hype-value" id="fanHypeValue">50</div>
                    <div class="fan-hype-max">/100</div>
                  </div>
                </div>
              </div>
              <div class="fan-hype-sentiment" id="fanHypeSentiment">Restless</div>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div class="dashboard-right">
            <!-- Recent Activity -->
            <div class="panel">
              <h2>Recent Activity</h2>
              <div id="feed"></div>
            </div>

            <!-- League Headlines -->
            <div class="panel">
              <h2>League Headlines</h2>
              <div id="leagueHeadlines"></div>
            </div>

            <!-- Top Performer -->
            <div class="panel">
              <h2>Top Performer</h2>
              <div id="topPerformer"></div>
            </div>
          </div>
        </div>

        <!-- Analytics & Fan Sentiment Strip -->
        <div class="analytics-strip dashboard-full">
          <div>
            <h2 style="margin:0 0 16px; font-size:16px">Efficiency Trends</h2>
            <div class="efficiency-grid">
              <div class="efficiency-item">
                <label>Off Rtg</label>
                <div class="efficiency-value" id="offRtg" style="color:var(--good)">112.5</div>
                <div class="efficiency-bar"><div class="fill" id="offRtgBar" style="width:75%; background:var(--good)"></div></div>
              </div>
              <div class="efficiency-item">
                <label>Def Rtg</label>
                <div class="efficiency-value" id="defRtg" style="color:var(--pri)">108.2</div>
                <div class="efficiency-bar"><div class="fill" id="defRtgBar" style="width:68%; background:var(--pri)"></div></div>
              </div>
              <div class="efficiency-item">
                <label>Pace</label>
                <div class="efficiency-value" id="pace" style="color:var(--text-0)">98.7</div>
                <div class="efficiency-bar"><div class="fill" id="paceBar" style="width:60%; background:var(--text-1)"></div></div>
              </div>
            </div>
          </div>
          
          <div class="sentiment-container">
            <div class="sentiment-label">Fan Sentiment</div>
            <div class="sentiment-bar">
              <div class="fill" id="sentimentFill" style="width:50%"></div>
            </div>
            <div class="sentiment-emoji" id="sentimentEmoji">üòê</div>
          </div>
        </div>
      </section>

      <!-- ROSTER -->
      <section data-view="roster" hidden>
        <div class="panel">
          <h2>Roster Management</h2>
          
          <!-- Toolbar -->
          <div class="roster-toolbar">
            <select id="teamSelector" class="btn" style="min-width:200px; font-weight:600">
              <option value="myTeam">üèÄ My Team</option>
            </select>
            
            <div class="search-box">
              <input type="text" id="playerSearch" placeholder="Search players...">
            </div>
            
            <div class="filter-group">
              <button class="filter-btn active" data-pos="all">All</button>
              <button class="filter-btn" data-pos="PG">PG</button>
              <button class="filter-btn" data-pos="SG">SG</button>
              <button class="filter-btn" data-pos="SF">SF</button>
              <button class="filter-btn" data-pos="PF">PF</button>
              <button class="filter-btn" data-pos="C">C</button>
            </div>
            
            <select id="sortBy" class="btn">
              <option value="ovr">Sort by OVR</option>
              <option value="age">Sort by Age</option>
              <option value="salary">Sort by Salary</option>
              <option value="morale">Sort by Morale</option>
              <option value="name">Sort by Name</option>
            </select>
            
            <div class="view-toggle">
              <button class="active" data-view-mode="table">üìã Table</button>
              <button data-view-mode="cards">üé¥ Cards</button>
            </div>
            
            <button class="btn good" id="addPlayerBtn">+ Add Player</button>
            <span class="tag" id="rosterCount">0/15</span>
          </div>

          <!-- Table View -->
          <div class="roster-table-view" id="rosterTableView">
            <table id="rosterTable">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Pos</th>
                  <th class="num">Age</th>
                  <th class="num">OVR</th>
                  <th>Physical</th>
                  <th class="num">Contract</th>
                  <th>Morale</th>
                  <th>Status</th>
                  <th class="num">Actions</th>
                </tr>
              </thead>
              <tbody id="rosterBody">
              </tbody>
            </table>
          </div>

          <!-- Card View -->
          <div class="roster-grid" id="rosterCardView" style="display:none">
          </div>

          <!-- Team Totals -->
          <div class="team-totals" id="teamTotals">
            <div class="total-item">
              <label>Avg Age</label>
              <value id="avgAge">--</value>
            </div>
            <div class="total-item">
              <label>Avg OVR</label>
              <value id="avgOVR">--</value>
            </div>
            <div class="total-item">
              <label>Total Salary</label>
              <value id="totalSalary">$0</value>
            </div>
            <div class="total-item">
              <label>Avg Morale</label>
              <value id="avgMorale">--</value>
            </div>
          </div>
        </div>
      </section>

      <!-- CAP SHEET -->
      <section class="panel" data-view="cap" hidden>
        <h2>Cap Sheet</h2>
        <div class="toolbar">
          <span class="tag">Cap: <span id="capNum">$0</span></span>
          <span class="tag">Tax Line: <span id="taxNum">$0</span></span>
          <span class="tag">First Apron: <span id="apron1Num">$0</span></span>
          <span class="tag">Second Apron: <span id="apron2Num">$0</span></span>
        </div>
        <div class="table-wrap">
          <table id="capTable">
            <thead>
              <tr>
                <th>Player</th><th class="num">2026</th><th class="num">2027</th><th class="num">2028</th><th class="num">Options</th>
              </tr>
            </thead>
            <tbody id="capBody"></tbody>
          </table>
        </div>
      </section>

      <!-- TRADES -->
      <section class="panel" data-view="trades" hidden>
        <h2>Trade Center</h2>
        <div class="toolbar">
          <button class="btn" id="tradeIdea">Generate Trade Idea</button>
          <span class="tag">Prototype</span>
        </div>
        <div id="tradeArea" class="empty">Trade engine not wired yet. This is where pick protections, matching rules, and AI team preferences will live.</div>
      </section>

      <!-- SCHEDULE -->
      <section data-view="schedule" hidden>
        <div class="schedule-container">
          <h2>Season Schedule</h2>
          
          <div style="margin-bottom: 12px;">
            <button class="btn good" id="generateScheduleBtn">üîÑ Generate Schedule</button>
          </div>
          
          <!-- Header Controls -->
          <div class="schedule-header panel">
            <div class="schedule-stats">
              <div class="stat-item">
                <span class="stat-label">Record:</span>
                <span class="stat-value" id="scheduleRecord">0-0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Win %:</span>
                <span class="stat-value" id="scheduleWinPct">.000</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Next Game:</span>
                <span class="stat-value" id="scheduleNextGame">TBD</span>
              </div>
            </div>
            
            <div class="schedule-actions">
              <button class="btn good" id="simGame" disabled>‚ñ∂ Sim Game</button>
              <button class="btn" id="simWeek">‚è© Sim Week</button>
              <button class="btn" id="simMonth">‚è≠ Sim Month</button>
            </div>
          </div>
          
          <!-- Simple List Layout -->
          <div class="panel">
            <div class="schedule-filters" style="margin-bottom: 16px; display: flex; gap: 8px;">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="home">Home</button>
              <button class="filter-btn" data-filter="away">Away</button>
              <button class="filter-btn" data-filter="upcoming">Upcoming</button>
              <button class="filter-btn" data-filter="completed">Completed</button>
            </div>
            
            <div id="scheduleList">
              <!-- Generated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- DRAFT -->
      <section data-view="draft" hidden>
        <div class="draft-container">
          <h2>Draft Room</h2>
          
          <!-- Draft Controls & Info -->
          <div class="draft-header panel">
            <div class="draft-status">
              <div class="status-item">
                <span class="status-label">Your Pick:</span>
                <span class="status-value" id="draftYourPick">#15</span>
              </div>
              <div class="status-item">
                <span class="status-label">Scouting Points:</span>
                <span class="status-value" id="draftScoutPoints">100</span>
              </div>
              <div class="status-item">
                <span class="status-label">Current Pick:</span>
                <span class="status-value" id="draftCurrentPick">#1</span>
              </div>
              <div class="status-item">
                <span class="status-label">Time:</span>
                <span class="status-value" id="draftClock">5:00</span>
              </div>
            </div>
            <div class="draft-actions">
              <button class="btn" id="generateProspectsBtn">üîÑ Generate Draft Class</button>
              <button class="btn good" id="startDraftBtn" disabled>‚ñ∂Ô∏è Start Draft</button>
              <button class="btn" id="autoDraftBtn" disabled>‚ö° Auto-Pick</button>
            </div>
          </div>
          
          <!-- Two-Column Layout -->
          <div class="draft-layout">
            <!-- Left: Big Board -->
            <div class="draft-board panel">
              <div class="board-header">
                <h3>Big Board</h3>
                <div class="board-controls">
                  <select id="boardFilterPos" class="btn-sm">
                    <option value="all">All Positions</option>
                    <option value="PG">PG</option>
                    <option value="SG">SG</option>
                    <option value="SF">SF</option>
                    <option value="PF">PF</option>
                    <option value="C">C</option>
                  </select>
                  <select id="boardFilterTier" class="btn-sm">
                    <option value="all">All Tiers</option>
                    <option value="Elite">Elite</option>
                    <option value="High">High</option>
                    <option value="Mid">Mid</option>
                    <option value="Late">Late</option>
                    <option value="Flyer">Flyer</option>
                  </select>
                </div>
              </div>
              
              <div class="board-tiers" id="draftBoardList">
                <div class="empty-state">Generate draft class to begin scouting</div>
              </div>
            </div>
            
            <!-- Right: Detail Panel -->
            <div class="draft-detail panel">
              <div class="detail-tabs">
                <button class="detail-tab active" data-tab="prospect">üìã Prospect</button>
                <button class="detail-tab" data-tab="scout">üîç Scout</button>
                <button class="detail-tab" data-tab="trade">üìä Trade</button>
                <button class="detail-tab" data-tab="needs">üìà Needs</button>
              </div>
              
              <!-- Prospect Tab -->
              <div class="detail-content" id="detailProspect">
                <div class="empty-state">Select a prospect to view details</div>
              </div>
              
              <!-- Scout Tab -->
              <div class="detail-content" id="detailScout" hidden>
                <div id="scoutingActions">
                  <div class="empty-state">Select a prospect to scout</div>
                </div>
              </div>
              
              <!-- Trade Tab -->
              <div class="detail-content" id="detailTrade" hidden>
                <h3>Trade Draft Picks</h3>
                <div class="trade-simulator">
                  <div class="trade-row">
                    <label>Trade Away Pick #</label>
                    <input type="number" id="tradeGivePick" min="1" max="60" value="15" class="input-sm">
                  </div>
                  <div class="trade-row">
                    <label>Receive Pick #</label>
                    <input type="number" id="tradeGetPick" min="1" max="60" value="10" class="input-sm">
                  </div>
                  <div class="trade-value-display">
                    <div class="value-item">
                      <span class="value-label">Give Value:</span>
                      <span id="tradeGiveValue">0</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">Get Value:</span>
                      <span id="tradeGetValue">0</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">Surplus:</span>
                      <span id="tradeSurplus" class="value-highlight">0</span>
                    </div>
                  </div>
                  <button class="btn good" id="proposeDraftTradeBtn">Propose Trade</button>
                  <div id="tradeResult" class="trade-result"></div>
                </div>
              </div>
              
              <!-- Needs Tab -->
              <div class="detail-content" id="detailNeeds" hidden>
                <h3>Team Needs Analysis</h3>
                <div id="teamNeedsDisplay">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FREE AGENCY -->
      <section data-view="freeagency" hidden>
        <div class="fa-container">
          <!-- Left: Player List -->
          <div class="fa-list-panel panel">
            <h2>Free Agent Market</h2>
            
            <!-- Toolbar -->
            <div class="fa-toolbar">
              <div class="search-box">
                <input type="text" id="faSearch" placeholder="Search free agents...">
              </div>
              
              <div class="filter-group">
                <button class="filter-btn active" data-fa-pos="all">All</button>
                <button class="filter-btn" data-fa-pos="guards">Guards</button>
                <button class="filter-btn" data-fa-pos="wings">Wings</button>
                <button class="filter-btn" data-fa-pos="bigs">Bigs</button>
              </div>
              
              <select id="faSortBy" class="btn">
                <option value="ovr">Sort by OVR</option>
                <option value="age">Sort by Age</option>
                <option value="salary">Sort by Asking Price</option>
                <option value="interest">Sort by Interest</option>
              </select>
              
              <label class="checkbox-label" style="font-size:13px; color:var(--text-1)">
                <input type="checkbox" id="showInterestedOnly" />
                Show Interested Only
              </label>
              
              <button class="btn" id="advanceDayFA">‚è≠ Advance Day</button>
              <span class="tag" id="faCount">0 Available</span>
            </div>

            <!-- Top Free Agents Banner -->
            <div class="fa-top-banner">
              <strong>üåü Top Free Agents</strong>
              <div id="topFAList"></div>
            </div>

            <!-- Player List -->
            <div class="fa-player-list" id="faPlayerList">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Right: Player Detail Preview -->
          <div class="fa-detail-panel panel">
            <div id="faDetailContent" class="fa-detail-empty">
              <div style="text-align:center; color:var(--muted); padding:40px 20px">
                <div style="font-size:48px; margin-bottom:16px">üë§</div>
                <p>Select a free agent to view details</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- COACHING -->
      <section data-view="coaching" hidden>
        <div class="coaching-container">
          <h2>Coaching Staff</h2>
          
          <!-- Current Staff -->
          <div class="coaching-staff-section">
            <h3 style="color:var(--text-0); font-size:16px; margin-bottom:12px">Current Staff</h3>
            
            <!-- Head Coach -->
            <div class="coach-card-container">
              <div class="coach-card head-coach" id="headCoachCard">
                <!-- Populated by JS -->
              </div>
            </div>
            
            <!-- Assistant Coaches -->
            <div class="assistants-grid" id="assistantsGrid">
              <!-- Populated by JS -->
            </div>
          </div>
          
          <!-- Available Candidates -->
          <div class="coaching-candidates-section">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
              <h3 style="color:var(--text-0); font-size:16px">Available Coaches</h3>
              <button class="btn" id="refreshCandidates">üîÑ Refresh Pool</button>
            </div>
            
            <div class="candidates-grid" id="candidatesGrid">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- OWNER -->
      <section data-view="owner" hidden>
        <div class="owner-container">
          <h2>Team Ownership</h2>
          
          <!-- Owner Profile -->
          <div class="owner-profile-section panel">
            <div class="owner-header">
              <div class="owner-portrait">
                <div class="owner-silhouette">üëë</div>
              </div>
              <div class="owner-info">
                <h3 id="ownerName">Marcus Langford</h3>
                <div class="owner-meta">
                  <span id="ownerAge">Age 58</span>
                  <span>‚Ä¢</span>
                  <span id="ownerArchetype">Legacy Builder</span>
                </div>
                <div class="owner-desc" id="ownerDesc">Prioritizes championships and long-term success</div>
              </div>
            </div>
            
            <!-- Trust Meter -->
            <div class="trust-meter-section">
              <div class="section-label">Owner Trust</div>
              <div class="trust-meter-display">
                <div class="trust-value-large" id="ownerTrustValue">65</div>
                <div class="trust-bar-large-container">
                  <div class="trust-bar-large-fill" id="ownerTrustBar"></div>
                </div>
                <div class="trust-status" id="ownerTrustStatus">Cautiously Optimistic</div>
              </div>
            </div>
            
            <!-- Owner Notes -->
            <div class="owner-notes">
              <div class="section-label">Current Stance</div>
              <div class="owner-notes-text" id="ownerNotes">
                Evaluating team direction and management decisions.
              </div>
            </div>
            
            <!-- Fan Sentiment in Owner View -->
            <div style="margin-top:20px;">
              <div class="section-label">Fan Base Sentiment</div>
              <div class="fan-hype-meter" style="margin:16px auto 0; width:120px; height:120px;">
                <div class="fan-hype-circle" id="ownerFanHypeCircle">
                  <div class="fan-hype-inner" style="width:90px; height:90px;">
                    <div class="fan-hype-value" id="ownerFanHypeValue" style="font-size:28px;">50</div>
                    <div class="fan-hype-max" style="font-size:12px;">/100</div>
                  </div>
                </div>
              </div>
              <div class="fan-hype-sentiment" id="ownerFanHypeSentiment" style="text-align:center; margin-top:12px;">Restless</div>
              <div style="text-align:center; margin-top:8px; font-size:11px; color:var(--muted);">
                Fan sentiment affects attendance and revenue
              </div>
            </div>
          </div>
          
          <!-- Season Expectations -->
          <div class="owner-expectations-section panel">
            <h3>Season Expectations</h3>
            <div class="goals-grid" id="ownerGoals">
              <!-- Populated by JS -->
            </div>
            <button class="btn" id="negotiateGoalsBtn">üìã Renegotiate Expectations</button>
          </div>
          
          <!-- Financial Overview -->
          <div class="owner-financial-section panel">
            <h3>Financial Overview</h3>
            <div class="financial-grid">
              <div class="financial-item">
                <div class="financial-label">Payroll Status</div>
                <div class="financial-value" id="ownerPayrollStatus">$0</div>
                <div class="financial-sublabel" id="ownerPayrollDesc">Under Cap</div>
              </div>
              <div class="financial-item">
                <div class="financial-label">Tax Threshold</div>
                <div class="financial-value" id="ownerTaxThreshold">$0</div>
                <div class="financial-sublabel" id="ownerTaxDesc">Luxury Tax Line</div>
              </div>
              <div class="financial-item">
                <div class="financial-label">Budget Flexibility</div>
                <div class="financial-value" id="ownerBudgetFlex">Moderate</div>
                <div class="financial-sublabel">Based on owner priorities</div>
              </div>
              <div class="financial-item">
                <div class="financial-label">Coaching Budget</div>
                <div class="financial-value" id="ownerCoachBudget">$0</div>
                <div class="financial-sublabel">Current staff total</div>
              </div>
            </div>
          </div>
          
          <!-- Owner Traits -->
          <div class="owner-traits-section panel">
            <h3>Owner Personality</h3>
            <div class="traits-grid" id="ownerTraits">
              <!-- Populated by JS -->
            </div>
          </div>
          
          <!-- Meeting History -->
          <div class="owner-meetings-section panel">
            <h3>Recent Interactions</h3>
            <div class="meetings-list" id="ownerMeetingHistory">
              <div class="empty-state">No meetings yet this season</div>
            </div>
            <button class="btn" id="requestMeetingBtn">üìû Request Meeting</button>
          </div>
        </div>
      </section>

      <!-- FINANCE -->
      <section data-view="finance" hidden>
        <div class="finance-container">
          <h2>Financial Management</h2>
          
          <!-- Panel 1: Payroll & Cap Status -->
          <div class="finance-panel panel">
            <h3>üí∞ Payroll & Salary Cap</h3>
            
            <div class="finance-kpis">
              <div class="finance-kpi">
                <div class="kpi-label">Current Payroll</div>
                <div class="kpi-value" id="finPayroll">$0</div>
              </div>
              <div class="finance-kpi">
                <div class="kpi-label">Cap Space</div>
                <div class="kpi-value" id="finCapSpace">$0</div>
              </div>
              <div class="finance-kpi">
                <div class="kpi-label">Status</div>
                <div class="kpi-badge" id="finCapStatus">Under Cap</div>
              </div>
            </div>
            
            <div class="cap-visual">
              <div class="cap-bar-container">
                <div class="cap-bar-fill" id="finCapBar"></div>
                <div class="cap-marker cap-line" style="left: 50%">
                  <span class="cap-marker-label">Cap</span>
                </div>
                <div class="cap-marker tax-line" id="finTaxMarker">
                  <span class="cap-marker-label">Tax</span>
                </div>
                <div class="cap-marker apron1-line" id="finApron1Marker">
                  <span class="cap-marker-label">Apron 1</span>
                </div>
                <div class="cap-marker apron2-line" id="finApron2Marker">
                  <span class="cap-marker-label">Apron 2</span>
                </div>
              </div>
              <div class="cap-legend">
                <div class="legend-item">
                  <span class="legend-dot" style="background: var(--good)"></span>
                  <span>Under Cap: $<span id="finCapAmount">0</span></span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot" style="background: var(--warn)"></span>
                  <span>Tax Line: $<span id="finTaxAmount">0</span></span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot" style="background: var(--bad)"></span>
                  <span>Aprons: $<span id="finApron1Amount">0</span> / $<span id="finApron2Amount">0</span></span>
                </div>
              </div>
            </div>
            
            <div class="roster-breakdown">
              <div class="section-label">Top Salaries</div>
              <div id="finTopSalaries" class="top-salaries-list">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
          
          <!-- Panel 2: Profit & Loss -->
          <div class="finance-panel panel">
            <h3>üìä Profit & Loss Statement</h3>
            
            <div class="finance-kpis">
              <div class="finance-kpi">
                <div class="kpi-label">Total Revenue</div>
                <div class="kpi-value good" id="finRevenue">$0</div>
              </div>
              <div class="finance-kpi">
                <div class="kpi-label">Total Expenses</div>
                <div class="kpi-value bad" id="finExpenses">$0</div>
              </div>
              <div class="finance-kpi">
                <div class="kpi-label">Net Profit</div>
                <div class="kpi-value" id="finProfit">$0</div>
              </div>
            </div>
            
            <div class="finance-breakdown">
              <div class="breakdown-section">
                <div class="breakdown-header">Revenue Sources</div>
                <div class="breakdown-items">
                  <div class="breakdown-item">
                    <span class="breakdown-label">Ticket Sales</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill" id="finRevenueTicketsBar"></span>
                    </span>
                    <span class="breakdown-value" id="finRevenueTickets">$0</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="breakdown-label">Merchandise</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill" id="finRevenueMerchBar"></span>
                    </span>
                    <span class="breakdown-value" id="finRevenueMerch">$0</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="breakdown-label">Playoffs</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill" id="finRevenuePlayoffsBar"></span>
                    </span>
                    <span class="breakdown-value" id="finRevenuePlayoffs">$0</span>
                  </div>
                </div>
              </div>
              
              <div class="breakdown-section">
                <div class="breakdown-header">Operating Expenses</div>
                <div class="breakdown-items">
                  <div class="breakdown-item">
                    <span class="breakdown-label">Player Payroll</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill bad" id="finExpensePlayersBar"></span>
                    </span>
                    <span class="breakdown-value" id="finExpensePlayers">$0</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="breakdown-label">Coaching Staff</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill bad" id="finExpenseStaffBar"></span>
                    </span>
                    <span class="breakdown-value" id="finExpenseStaff">$0</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="breakdown-label">Facilities & Ops</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill bad" id="finExpenseFacilitiesBar"></span>
                    </span>
                    <span class="breakdown-value" id="finExpenseFacilities">$0</span>
                  </div>
                  <div class="breakdown-item">
                    <span class="breakdown-label">Marketing/Promo</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill bad" id="finExpensePromoBar"></span>
                    </span>
                    <span class="breakdown-value" id="finExpensePromo">$0</span>
                  </div>
                  <div class="breakdown-item highlight-tax">
                    <span class="breakdown-label">‚ö† Luxury Tax</span>
                    <span class="breakdown-bar">
                      <span class="breakdown-bar-fill bad" id="finExpenseTaxBar"></span>
                    </span>
                    <span class="breakdown-value" id="finExpenseTax">$0</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="finance-controls">
              <div class="control-item">
                <label>Ticket Price Multiplier</label>
                <input type="range" id="finTicketPrice" min="0.7" max="1.5" step="0.1" value="1.0">
                <span id="finTicketPriceValue">1.0x</span>
              </div>
              <div class="control-item">
                <label>Marketing Spend (millions)</label>
                <input type="range" id="finPromoSpend" min="0" max="10" step="1" value="0">
                <span id="finPromoSpendValue">$0M</span>
              </div>
              <div class="control-item">
                <label>Facility Level</label>
                <input type="range" id="finFacilityLvl" min="0" max="5" step="1" value="0">
                <span id="finFacilityLvlValue">Level 0</span>
              </div>
            </div>
          </div>
          
          <!-- Panel 3: Multi-Year Outlook -->
          <div class="finance-panel panel">
            <h3>üìÖ Multi-Year Cap Outlook</h3>
            
            <div class="outlook-table" id="finOutlookTable">
              <div class="outlook-header">
                <div class="outlook-cell">Year</div>
                <div class="outlook-cell">Guaranteed</div>
                <div class="outlook-cell">Options</div>
                <div class="outlook-cell">Dead Money</div>
                <div class="outlook-cell">Total</div>
                <div class="outlook-cell">vs Cap</div>
              </div>
              <!-- Rows populated by JS -->
            </div>
            
            <div class="outlook-notes">
              <p><strong>Note:</strong> Projections assume flat salaries and do not include draft picks or free agent signings.</p>
              <p>Use this to plan for future cap space and contract decisions.</p>
            </div>
          </div>
          
          <!-- Panel 4: Owner Budget & Risk -->
          <div class="finance-panel panel owner-budget-panel">
            <h3>üëë Owner Budget & Risk Assessment</h3>
            
            <div class="finance-kpis">
              <div class="finance-kpi">
                <div class="kpi-label">Owner Budget Target</div>
                <div class="kpi-value" id="finOwnerBudget">$0</div>
              </div>
              <div class="finance-kpi">
                <div class="kpi-label">Current vs Target</div>
                <div class="kpi-badge" id="finBudgetStatus">On Track</div>
              </div>
              <div class="finance-kpi">
                <div class="kpi-label">Financial Trust Impact</div>
                <div class="kpi-value" id="finTrustImpact">0</div>
              </div>
            </div>
            
            <div class="owner-budget-details">
              <div class="budget-item">
                <span class="budget-label">Owner Archetype:</span>
                <span class="budget-value" id="finOwnerArchetype">-</span>
              </div>
              <div class="budget-item">
                <span class="budget-label">Spending Philosophy:</span>
                <span class="budget-value" id="finOwnerPhilosophy">-</span>
              </div>
              <div class="budget-item">
                <span class="budget-label">Market Size:</span>
                <span class="budget-value" id="finMarketSize">-</span>
              </div>
            </div>
            
            <div class="risk-assessment">
              <div class="section-label">Risk Factors</div>
              <div id="finRiskFactors" class="risk-list">
                <!-- Populated by JS -->
              </div>
            </div>
            
            <div class="budget-recommendations">
              <div class="section-label">Recommendations</div>
              <div id="finRecommendations" class="recommendations-list">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="panel" data-view="settings" hidden>
        <h2>Settings</h2>
        <div class="row">
          <div class="col">
            <label>Team Name</label>
            <input id="teamName" value="San Francisco Riptide" />
          </div>
          <div class="col">
            <label>Season</label>
            <input id="seasonInput" type="number" value="2026" />
          </div>
        </div>
        
        <div class="settings-section" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
          <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--text-0);">Gameplay Options</h3>
          <div class="settings-option">
            <label class="checkbox-label" style="font-size: 14px; color: var(--text-0); display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="ownerInterventionToggle" checked />
              <div>
                <div style="font-weight: 600;">Owner Intervention</div>
                <div style="font-size: 12px; color: var(--text-1); margin-top: 4px;">
                  Owner can overrule major GM decisions (coach firings, star trades, tax spending). Higher trust = less interference.
                </div>
              </div>
            </label>
          </div>
        </div>
        
        <div class="toolbar" style="margin-top:12px">
          <button class="btn good" id="applySettings">Apply</button>
        </div>
      </section>
    </main>
  </div>

  <!-- ADD PLAYER MODAL -->
  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addPlayerTitle">
      <header>
        <div class="title" id="addPlayerTitle">Add Player</div>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeModal">Close</button>
      </header>
      <div class="content">
        <div class="form">
          <div>
            <label>Name</label>
            <input id="pName" placeholder="e.g., J. Rivera" />
          </div>
          <div>
            <label>Position</label>
            <select id="pPos">
              <option>PG</option><option>SG</option><option>SF</option><option>PF</option><option>C</option>
            </select>
          </div>
          <div>
            <label>Age</label>
            <input id="pAge" type="number" min="18" max="45" value="24" />
          </div>
          <div>
            <label>OVR</label>
            <input id="pOvr" type="number" min="40" max="99" value="76" />
          </div>
          <div>
            <label>Salary (2026)</label>
            <input id="pSalary" type="number" min="0" step="100000" value="8200000" />
          </div>
          <div>
            <label>Years</label>
            <input id="pYears" type="number" min="1" max="5" value="2" />
          </div>
          <div class="full">
            <label>Notes</label>
            <input id="pNotes" placeholder="e.g., 3&D wing, team option Yr2" />
          </div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn good" id="submitPlayer">Add to Roster</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAYER PROFILE MODAL -->
  <div class="modal-backdrop" id="profileModal" style="display:none">
    <div class="modal profile-modal" role="dialog" aria-modal="true" style="max-width:800px; max-height:90vh; overflow-y:auto">
      <header>
        <div>
          <div class="title" id="profilePlayerName">Player Profile</div>
          <div style="font-size:13px; color:var(--text-1); margin-top:4px" id="profilePlayerMeta">PG ‚Ä¢ Age 24 ‚Ä¢ 6'2" ‚Ä¢ 190lb</div>
        </div>
        <div class="spacer"></div>
        <button class="btn" id="toggleProfileEdit" style="margin-right:8px">Edit</button>
        <button class="btn ghost" id="closeProfileModal">Close</button>
      </header>
      <div class="content" id="profileContent">
        <!-- Core Attributes -->
        <div class="attr-section">
          <div class="section-header" style="background:linear-gradient(135deg, var(--pri), var(--pri-2)); color:white; padding:8px 12px; border-radius:8px; margin-bottom:12px; font-weight:700">
            Core Attributes
          </div>
          <div class="attr-grid">
            <div class="attr-item">
              <label>OVR (Overall)</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="ovr" style="width:75%"></div>
                <span class="attr-value" id="attr-ovr">75</span>
              </div>
            </div>
            <div class="attr-item">
              <label>POT (Potential)</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="pot" style="width:82%"></div>
                <span class="attr-value" id="attr-pot">82</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Durability</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="durability" style="width:68%"></div>
                <span class="attr-value" id="attr-durability">68</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Archetype</label>
              <div class="attr-text" id="attr-archetype">Floor General</div>
            </div>
          </div>
        </div>

        <!-- Skills -->
        <div class="attr-section">
          <div class="section-header" style="background:linear-gradient(135deg, #4A90E2, #357ABD); color:white; padding:8px 12px; border-radius:8px; margin-bottom:12px; font-weight:700">
            ‚õπÔ∏è Skills
          </div>
          <div class="attr-grid">
            <div class="attr-item">
              <label>Inside Scoring</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="inside" style="width:65%"></div>
                <span class="attr-value" id="attr-inside">65</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Mid-Range</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="mid" style="width:72%"></div>
                <span class="attr-value" id="attr-mid">72</span>
              </div>
            </div>
            <div class="attr-item">
              <label>3PT Shooting</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="three" style="width:78%"></div>
                <span class="attr-value" id="attr-three">78</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Free Throw</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="ft" style="width:81%"></div>
                <span class="attr-value" id="attr-ft">81</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Playmaking</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="playmaking" style="width:88%"></div>
                <span class="attr-value" id="attr-playmaking">88</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Ball Handling</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="ballHandling" style="width:85%"></div>
                <span class="attr-value" id="attr-ballHandling">85</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Offensive IQ</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="offensiveIQ" style="width:76%"></div>
                <span class="attr-value" id="attr-offensiveIQ">76</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Defensive IQ</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="defensiveIQ" style="width:71%"></div>
                <span class="attr-value" id="attr-defensiveIQ">71</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Perimeter Defense</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="perimeterD" style="width:74%"></div>
                <span class="attr-value" id="attr-perimeterD">74</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Post Defense</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="postD" style="width:58%"></div>
                <span class="attr-value" id="attr-postD">58</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Rebounding</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="rebounding" style="width:62%"></div>
                <span class="attr-value" id="attr-rebounding">62</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Athleticism</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="athleticism" style="width:80%"></div>
                <span class="attr-value" id="attr-athleticism">80</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Strength</label>
              <div class="attr-bar-container">
                <div class="attr-bar blue" data-attr="strength" style="width:66%"></div>
                <span class="attr-value" id="attr-strength">66</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Mental -->
        <div class="attr-section">
          <div class="section-header" style="background:linear-gradient(135deg, #50C878, #3FA165); color:white; padding:8px 12px; border-radius:8px; margin-bottom:12px; font-weight:700">
            üß† Mental Attributes
          </div>
          <div class="attr-grid">
            <div class="attr-item">
              <label>Leadership</label>
              <div class="attr-bar-container">
                <div class="attr-bar green" data-attr="leadership" style="width:72%"></div>
                <span class="attr-value" id="attr-leadership">72</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Work Ethic</label>
              <div class="attr-bar-container">
                <div class="attr-bar green" data-attr="workEthic" style="width:85%"></div>
                <span class="attr-value" id="attr-workEthic">85</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Composure</label>
              <div class="attr-bar-container">
                <div class="attr-bar green" data-attr="composure" style="width:78%"></div>
                <span class="attr-value" id="attr-composure">78</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Discipline</label>
              <div class="attr-bar-container">
                <div class="attr-bar green" data-attr="discipline" style="width:81%"></div>
                <span class="attr-value" id="attr-discipline">81</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Coachability</label>
              <div class="attr-bar-container">
                <div class="attr-bar green" data-attr="coachability" style="width:88%"></div>
                <span class="attr-value" id="attr-coachability">88</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Hidden -->
        <div class="attr-section">
          <div class="section-header" style="background:linear-gradient(135deg, #FF9F40, #E67E22); color:white; padding:8px 12px; border-radius:8px; margin-bottom:12px; font-weight:700">
            üîí Hidden Attributes
          </div>
          <div class="attr-grid">
            <div class="attr-item">
              <label>Greed</label>
              <div class="attr-bar-container">
                <div class="attr-bar orange" data-attr="greed" style="width:55%"></div>
                <span class="attr-value" id="attr-greed">55</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Loyalty</label>
              <div class="attr-bar-container">
                <div class="attr-bar orange" data-attr="loyalty" style="width:75%"></div>
                <span class="attr-value" id="attr-loyalty">75</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Clutch</label>
              <div class="attr-bar-container">
                <div class="attr-bar orange" data-attr="clutch" style="width:68%"></div>
                <span class="attr-value" id="attr-clutch">68</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Popularity</label>
              <div class="attr-bar-container">
                <div class="attr-bar orange" data-attr="popularity" style="width:82%"></div>
                <span class="attr-value" id="attr-popularity">82</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Market Preference</label>
              <div class="attr-text" id="attr-marketPreference">Large</div>
            </div>
          </div>
        </div>

        <!-- Personality Traits -->
        <div class="attr-section">
          <div class="section-header" style="background:linear-gradient(135deg, #9B59B6, #8E44AD); color:white; padding:8px 12px; border-radius:8px; margin-bottom:12px; font-weight:700">
            üé≠ Personality Traits
          </div>
          
          <div style="margin-bottom:16px; padding:12px; background:rgba(155,89,182,0.1); border-left:3px solid #9B59B6; border-radius:6px">
            <div style="font-size:13px; color:var(--text-1); font-style:italic" id="personality-summary">
              Natural leader, consummate professional, clutch performer
            </div>
          </div>
          
          <div class="attr-grid">
            <div class="attr-item">
              <label>Leadership</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-leadership" style="width:85%"></div>
                <span class="attr-value" id="attr-p-leadership">85</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Ego</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-ego" style="width:70%"></div>
                <span class="attr-value" id="attr-p-ego">70</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Competitiveness</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-competitiveness" style="width:90%"></div>
                <span class="attr-value" id="attr-p-competitiveness">90</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Work Ethic</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-workEthic" style="width:88%"></div>
                <span class="attr-value" id="attr-p-workEthic">88</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Coachability</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-coachability" style="width:75%"></div>
                <span class="attr-value" id="attr-p-coachability">75</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Temper</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-temper" style="width:55%"></div>
                <span class="attr-value" id="attr-p-temper">55</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Loyalty</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-loyalty" style="width:80%"></div>
                <span class="attr-value" id="attr-p-loyalty">80</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Greed</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-greed" style="width:45%"></div>
                <span class="attr-value" id="attr-p-greed">45</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Media Savvy</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-mediaSavvy" style="width:72%"></div>
                <span class="attr-value" id="attr-p-mediaSavvy">72</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Clutch Gene</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-clutch" style="width:82%"></div>
                <span class="attr-value" id="attr-p-clutch">82</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Discipline</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-discipline" style="width:78%"></div>
                <span class="attr-value" id="attr-p-discipline">78</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Resilience</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-resilience" style="width:85%"></div>
                <span class="attr-value" id="attr-p-resilience">85</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Charisma</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-charisma" style="width:80%"></div>
                <span class="attr-value" id="attr-p-charisma">80</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Professionalism</label>
              <div class="attr-bar-container">
                <div class="attr-bar purple" data-attr="p-professionalism" style="width:88%"></div>
                <span class="attr-value" id="attr-p-professionalism">88</span>
              </div>
            </div>
            <div class="attr-item">
              <label>Social Type</label>
              <div class="attr-text" id="attr-p-socialType">Extrovert</div>
            </div>
            <div class="attr-item">
              <label>Motivation</label>
              <div class="attr-text" id="attr-p-motivation">Rings</div>
            </div>
            <div class="attr-item">
              <label>Market Preference</label>
              <div class="attr-text" id="attr-p-marketPreference">Large</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAYER BIO PAGE -->
  <div class="modal-backdrop" id="bioModal" style="display:none">
    <div class="bio-page" role="dialog" aria-modal="true">
      <div class="bio-container">
        <!-- Header Section -->
        <div class="bio-header">
          <div class="bio-portrait">
            <div class="portrait-circle" id="bioPortrait">
              <span id="bioInitials">DJ</span>
            </div>
          </div>
          <div class="bio-header-info">
            <div class="bio-player-name" id="bioPlayerName">Darius Jackson</div>
            <div class="bio-nickname" id="bioNickname">"The Floor General"</div>
            <div class="bio-meta-row">
              <span class="bio-badge position" id="bioPosition">PG</span>
              <span id="bioShoots">Shoots: R</span>
              <span id="bioHeight">6'2"</span>
              <span id="bioWeight">190 lb (86 kg)</span>
            </div>
          </div>
        </div>

        <!-- Info Cards Grid -->
        <div class="bio-cards-grid">
          <!-- Team Info Card -->
          <div class="bio-card">
            <div class="card-title">Team Information</div>
            <div class="bio-info-grid">
              <div class="bio-info-item">
                <label>Current Team</label>
                <value id="bioTeam">San Francisco Riptide</value>
              </div>
              <div class="bio-info-item">
                <label>Contract</label>
                <value id="bioContract">$8.2M / 3 years</value>
              </div>
              <div class="bio-info-item">
                <label>Morale</label>
                <value id="bioMorale">85 üòÉ</value>
              </div>
            </div>
          </div>

          <!-- Personal Info Card -->
          <div class="bio-card">
            <div class="card-title">Personal Information</div>
            <div class="bio-info-grid">
              <div class="bio-info-item">
                <label>Birth Date</label>
                <value id="bioBirthDate">March 15, 1998</value>
              </div>
              <div class="bio-info-item">
                <label>Age</label>
                <value id="bioAge">28 years old</value>
              </div>
              <div class="bio-info-item">
                <label>Birthplace</label>
                <value id="bioBirthplace">Los Angeles, CA</value>
              </div>
            </div>
          </div>

          <!-- Career Info Card -->
          <div class="bio-card">
            <div class="card-title">Career Information</div>
            <div class="bio-info-grid">
              <div class="bio-info-item">
                <label>College</label>
                <value id="bioCollege">Duke</value>
              </div>
              <div class="bio-info-item">
                <label>Draft</label>
                <value id="bioDraft">2017 ‚Ä¢ Pick #12 ‚Ä¢ Atlanta Apex</value>
              </div>
              <div class="bio-info-item">
                <label>Experience</label>
                <value id="bioExperience">9 seasons</value>
              </div>
            </div>
          </div>
        </div>

        <!-- Achievements Section -->
        <div class="bio-section">
          <div class="section-title">üèÜ Achievements & Awards</div>
          <div class="awards-container" id="bioAwards">
            <span class="award-badge mvp">MVP</span>
            <span class="award-badge all-star">All-Star</span>
            <span class="award-badge all-nba">All-NBA First Team</span>
          </div>
        </div>

        <!-- Stats Section -->
        <div class="bio-section">
          <div class="section-title">üìä Statistics</div>
          <div class="stats-table-container">
            <table class="bio-stats-table">
              <thead>
                <tr>
                  <th>Period</th>
                  <th>PPG</th>
                  <th>RPG</th>
                  <th>APG</th>
                  <th>SPG</th>
                  <th>BPG</th>
                  <th>FG%</th>
                  <th>3P%</th>
                  <th>FT%</th>
                </tr>
              </thead>
              <tbody id="bioStatsBody">
                <tr class="season-row">
                  <td>2025-26</td>
                  <td>18.5</td>
                  <td>4.2</td>
                  <td>7.8</td>
                  <td>1.4</td>
                  <td>0.3</td>
                  <td>45.2</td>
                  <td>37.8</td>
                  <td>85.6</td>
                </tr>
                <tr class="career-row">
                  <td><strong>Career</strong></td>
                  <td>16.2</td>
                  <td>3.9</td>
                  <td>6.5</td>
                  <td>1.2</td>
                  <td>0.2</td>
                  <td>43.8</td>
                  <td>36.2</td>
                  <td>83.4</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Personality Section -->
        <div class="bio-section">
          <div class="section-title">üí¨ Player Profile</div>
          <div class="bio-personality" id="bioPersonality">
            Darius is a natural leader, elite scorer, and thrives under pressure. Known as a floor general, they bring unique value to any roster.
          </div>
          <div style="margin-top:12px; padding:10px; background:rgba(155,89,182,0.1); border-radius:6px; border-left:3px solid #9B59B6">
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px">Personality Traits</div>
            <div style="font-size:13px; color:var(--text-0); font-style:italic" id="bioPersonalityTraits">
              Natural leader, consummate professional, clutch performer
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="bio-actions">
          <button class="btn" id="viewFullAttributes">View Full Attributes</button>
          <button class="btn good" id="closeBioModal">Back to Roster</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTRACT OFFER MODAL -->
  <div class="modal-backdrop" id="contractModal" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:600px">
      <header>
        <div>
          <div class="title" id="contractPlayerName">Contract Offer</div>
          <div style="font-size:13px; color:var(--text-1); margin-top:4px" id="contractPlayerMeta">PG ‚Ä¢ Age 24 ‚Ä¢ OVR 75</div>
        </div>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeContractModal">Close</button>
      </header>
      <div class="content">
        <!-- Player Interest -->
        <div style="margin-bottom:20px">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
            <label style="font-weight:600">Team Interest Level</label>
            <span id="contractInterestValue" style="font-weight:700; color:var(--pri)">75%</span>
          </div>
          <div class="interest-bar-container">
            <div class="interest-bar-fill" id="contractInterestBar" style="width:75%"></div>
          </div>
          <div style="font-size:12px; color:var(--muted); margin-top:4px" id="contractInterestText">
            High interest - good chance of signing
          </div>
        </div>

        <!-- Asking Price -->
        <div style="margin-bottom:20px; padding:12px; background:var(--bg-2); border:1px solid var(--border); border-radius:8px">
          <div style="font-size:12px; color:var(--text-1); margin-bottom:4px">Player Demands</div>
          <div style="display:flex; gap:16px; align-items:center">
            <div>
              <div style="font-size:11px; color:var(--muted)">Salary</div>
              <div style="font-size:18px; font-weight:700; color:var(--text-0)" id="contractAskingSalary">$12,000,000</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted)">Years</div>
              <div style="font-size:18px; font-weight:700; color:var(--text-0)" id="contractAskingYears">3</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted)">Min Role</div>
              <div style="font-size:14px; font-weight:600; color:var(--text-0)" id="contractAskingRole">Starter</div>
            </div>
          </div>
        </div>

        <!-- Offer Form -->
        <div class="form">
          <div>
            <label>Salary Offer (per year)</label>
            <input id="offerSalary" type="number" min="0" step="100000" value="12000000" />
            <div style="font-size:11px; color:var(--muted); margin-top:4px">Annual salary amount</div>
          </div>
          <div>
            <label>Contract Length (years)</label>
            <input id="offerYears" type="number" min="1" max="5" value="3" />
            <div style="font-size:11px; color:var(--muted); margin-top:4px">1-5 years maximum</div>
          </div>
          <div>
            <label>Role</label>
            <select id="offerRole">
              <option value="Starter">Starter</option>
              <option value="Bench">Bench</option>
              <option value="Reserve">Reserve</option>
            </select>
            <div style="font-size:11px; color:var(--muted); margin-top:4px">Promised playing time</div>
          </div>
        </div>

        <!-- Cap Impact -->
        <div style="margin-top:20px; padding:12px; background:var(--bg-1); border:1px solid var(--border); border-radius:8px">
          <div style="font-size:12px; font-weight:600; margin-bottom:8px; color:var(--text-1)">Cap Impact</div>
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px">
            <span style="color:var(--muted)">Current Cap Space:</span>
            <span id="contractCurrentCap" style="color:var(--text-0); font-weight:600">$25,000,000</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:13px">
            <span style="color:var(--muted)">After Signing:</span>
            <span id="contractAfterCap" style="color:var(--text-0); font-weight:600">$13,000,000</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="toolbar" style="margin-top:20px">
          <button class="btn good" id="submitOffer">
            <span id="offerButtonText">Offer Contract</span>
          </button>
          <button class="btn ghost" id="cancelOffer">Cancel</button>
        </div>

        <!-- Result Message -->
        <div id="contractResult" style="display:none; margin-top:16px; padding:12px; border-radius:8px"></div>
      </div>
    </div>
  </div>

  <!-- COACH PROFILE MODAL -->
  <div class="modal-backdrop" id="coachProfileModal" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:800px">
      <header>
        <div>
          <div class="title" id="coachProfileName">Mike Rivers</div>
          <div style="font-size:13px; color:var(--text-1); margin-top:4px" id="coachProfileMeta">Age 52 ‚Ä¢ Head Coach ‚Ä¢ Tactician</div>
        </div>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeCoachProfileModal">Close</button>
      </header>
      <div class="content">
        <!-- Trust & Contract Info -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px">
          <div class="panel" style="padding:16px">
            <div style="font-size:12px; color:var(--muted); margin-bottom:8px">Trust Level</div>
            <div style="display:flex; align-items:center; gap:12px">
              <div style="font-size:32px; font-weight:700" id="coachProfileTrust">75</div>
              <div class="trust-bar-container" style="flex:1">
                <div class="trust-bar-fill" id="coachProfileTrustBar"></div>
              </div>
            </div>
          </div>
          
          <div class="panel" style="padding:16px">
            <div style="font-size:12px; color:var(--muted); margin-bottom:8px">Contract</div>
            <div style="font-size:18px; font-weight:700; color:var(--text-0)" id="coachProfileContract">$5,000,000 / 3 yrs</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px" id="coachProfileYearsLeft">2 years remaining</div>
          </div>
        </div>

        <!-- Career Record -->
        <div class="panel" style="padding:16px; margin-bottom:20px">
          <div style="font-size:14px; font-weight:600; margin-bottom:12px; color:var(--text-0)">Career Record</div>
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; text-align:center">
            <div>
              <div style="font-size:11px; color:var(--muted)">Wins</div>
              <div style="font-size:24px; font-weight:700; color:var(--good)" id="coachProfileWins">0</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted)">Losses</div>
              <div style="font-size:24px; font-weight:700; color:var(--bad)" id="coachProfileLosses">0</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted)">Win %</div>
              <div style="font-size:24px; font-weight:700; color:var(--pri)" id="coachProfileWinPct">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- Coaching Style -->
        <div class="panel" style="padding:16px; margin-bottom:20px">
          <div style="font-size:14px; font-weight:600; margin-bottom:12px; color:var(--text-0)">Coaching Style</div>
          <div style="margin-bottom:16px">
            <div style="font-size:16px; font-weight:600; color:var(--pri)" id="coachProfileStyleName">Pace & Space</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px" id="coachProfileFocus">Focus: Three-Point Shooting</div>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px">
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px">Offense</div>
              <div class="attr-bar-container">
                <div class="attr-bar blue" id="coachProfileOffBar"></div>
              </div>
              <div style="font-size:11px; text-align:right; color:var(--text-1)" id="coachProfileOffValue">85</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px">Defense</div>
              <div class="attr-bar-container">
                <div class="attr-bar blue" id="coachProfileDefBar"></div>
              </div>
              <div style="font-size:11px; text-align:right; color:var(--text-1)" id="coachProfileDefValue">60</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px">Pace</div>
              <div class="attr-bar-container">
                <div class="attr-bar blue" id="coachProfilePaceBar"></div>
              </div>
              <div style="font-size:11px; text-align:right; color:var(--text-1)" id="coachProfilePaceValue">90</div>
            </div>
          </div>
        </div>

        <!-- Attributes -->
        <div class="panel" style="padding:16px">
          <div style="font-size:14px; font-weight:600; margin-bottom:12px; color:var(--text-0)">Coaching Attributes</div>
          <div id="coachProfileAttributes" style="display:grid; gap:8px">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- Actions (for current coaches only) -->
        <div class="toolbar" style="margin-top:20px" id="coachProfileActions">
          <button class="btn" id="extendCoachBtn">üìù Extend Contract</button>
          <button class="btn bad" id="fireCoachBtn">üî• Fire Coach</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HIRE COACH MODAL -->
  <div class="modal-backdrop" id="hireCoachModal" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:700px">
      <header>
        <div>
          <div class="title">Hire Coach</div>
          <div style="font-size:13px; color:var(--text-1); margin-top:4px" id="hireCoachMeta">Select a candidate to hire</div>
        </div>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeHireCoachModal">Close</button>
      </header>
      <div class="content">
        <!-- Selected Coach Preview -->
        <div id="hireCoachPreview" style="margin-bottom:20px">
          <!-- Populated when a candidate is selected -->
        </div>

        <!-- Hire Confirmation -->
        <div class="panel" style="padding:16px; margin-bottom:20px; background:var(--bg-2)">
          <div style="font-size:12px; font-weight:600; margin-bottom:8px; color:var(--text-1)">Contract Terms</div>
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px">
            <span style="color:var(--muted)">Annual Salary:</span>
            <span id="hireCoachSalary" style="color:var(--text-0); font-weight:600">$5,000,000</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px">
            <span style="color:var(--muted)">Contract Length:</span>
            <span id="hireCoachYears" style="color:var(--text-0); font-weight:600">3 years</span>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:13px">
            <span style="color:var(--muted)">Total Value:</span>
            <span id="hireCoachTotal" style="color:var(--pri); font-weight:700">$15,000,000</span>
          </div>
        </div>

        <div id="hireCoachWarning" style="display:none; padding:12px; background:rgba(255,107,107,0.1); border:1px solid var(--bad); border-radius:8px; margin-bottom:16px">
          <div style="font-size:13px; color:var(--bad); font-weight:600">‚ö† This will replace your current Head Coach</div>
          <div style="font-size:12px; color:var(--text-1); margin-top:4px">Your current coach will be fired and their contract terminated.</div>
        </div>

        <div class="toolbar">
          <button class="btn good" id="confirmHireBtn" disabled>Hire Coach</button>
          <button class="btn ghost" id="cancelHireBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FIRE COACH CONFIRMATION MODAL -->
  <div class="modal-backdrop" id="fireCoachModal" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:500px">
      <header>
        <div class="title">Fire Coach</div>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeFireCoachModal">Close</button>
      </header>
      <div class="content">
        <div style="padding:20px; text-align:center">
          <div style="font-size:48px; margin-bottom:16px">üî•</div>
          <div style="font-size:18px; font-weight:600; margin-bottom:12px; color:var(--text-0)" id="fireCoachName">Mike Rivers</div>
          <div style="font-size:14px; color:var(--muted); margin-bottom:20px">Are you sure you want to fire this coach?</div>
          
          <div style="padding:12px; background:var(--bg-2); border-radius:8px; margin-bottom:20px; text-align:left">
            <div style="font-size:12px; color:var(--muted); margin-bottom:8px">Contract Buyout</div>
            <div style="font-size:20px; font-weight:700; color:var(--bad)" id="fireCoachBuyout">$10,000,000</div>
            <div style="font-size:11px; color:var(--text-1); margin-top:4px" id="fireCoachBuyoutDetails">2 years remaining</div>
          </div>
          
          <div style="padding:12px; background:rgba(255,107,107,0.1); border:1px solid var(--bad); border-radius:8px; margin-bottom:20px">
            <div style="font-size:12px; color:var(--bad)">This action cannot be undone. Trust with remaining staff may decrease.</div>
          </div>
        </div>

        <div class="toolbar">
          <button class="btn bad" id="confirmFireBtn">Fire Coach</button>
          <button class="btn ghost" id="cancelFireBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- OWNER MEETING MODAL -->
  <div class="modal-backdrop" id="ownerMeetingModal" style="display:none; backdrop-filter:blur(8px); background:rgba(0,0,0,0.85)">
    <div class="modal owner-meeting-modal" role="dialog" aria-modal="true" style="max-width:700px">
      <header>
        <div>
          <div class="title" id="meetingTitle">Owner Meeting</div>
          <div style="font-size:13px; color:var(--text-1); margin-top:4px" id="meetingSubtitle">Season Progress Review</div>
        </div>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeOwnerMeetingModal">Close</button>
      </header>
      <div class="content">
        <!-- Owner Feedback -->
        <div class="owner-meeting-feedback" id="meetingFeedback">
          <div class="owner-meeting-portrait">üëë</div>
          <div class="owner-meeting-quote" id="meetingQuote">
            "Let's discuss how things are going with the team..."
          </div>
        </div>
        
        <!-- Trust Change Indicator -->
        <div class="trust-change-indicator" id="trustChangeIndicator" style="display:none">
          <div class="trust-change-icon" id="trustChangeIcon">‚Üë</div>
          <div class="trust-change-text" id="trustChangeText">Trust increased by 5</div>
        </div>
        
        <!-- Performance Review -->
        <div class="panel" style="padding:16px; margin:20px 0; background:var(--bg-2)">
          <div style="font-size:14px; font-weight:600; margin-bottom:12px">Performance Summary</div>
          <div id="meetingPerformance" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; font-size:13px">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Goals Progress -->
        <div class="panel" style="padding:16px; margin-bottom:20px; background:var(--bg-2)">
          <div style="font-size:14px; font-weight:600; margin-bottom:12px">Goal Progress</div>
          <div id="meetingGoals" style="display:flex; flex-direction:column; gap:10px">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Meeting Actions -->
        <div class="meeting-actions">
          <button class="btn good" id="acceptMeetingBtn">Acknowledge</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEGOTIATE GOALS MODAL -->
  <div class="modal-backdrop" id="negotiateGoalsModal" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:650px">
      <header>
        <div class="title">Renegotiate Expectations</div>
        <div class="spacer"></div>
        <button class="btn ghost" id="closeNegotiateModal">Close</button>
      </header>
      <div class="content">
        <div style="padding:16px; background:var(--bg-2); border-radius:8px; margin-bottom:20px">
          <div style="font-size:13px; color:var(--text-1); margin-bottom:8px">
            You can attempt to adjust the owner's expectations for the season.
          </div>
          <div style="font-size:12px; color:var(--muted)">
            <strong>Accept</strong> current goals for a trust boost but tighter accountability.<br>
            <strong>Push back</strong> for more freedom but risk damaging relationship.
          </div>
        </div>
        
        <div id="negotiateGoalsList" style="margin-bottom:20px">
          <!-- Populated by JS -->
        </div>
        
        <div class="toolbar">
          <button class="btn good" id="acceptGoalsBtn">‚úì Accept Expectations</button>
          <button class="btn bad" id="pushBackBtn">‚Ü© Push Back</button>
          <button class="btn ghost" id="cancelNegotiateBtn">Cancel</button>
        </div>
        
        <div id="negotiateResult" style="display:none; margin-top:16px; padding:12px; border-radius:8px"></div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------------
    // League Setup Logic
    // -------------------------------
    const STORAGE_KEY = "hoops-mini-gm";
    const SETUP_STORAGE_KEY = "hoops-mini-gm-setup";
    
    // Check if league already exists
    function hasExistingLeague(){
      return localStorage.getItem(STORAGE_KEY) !== null;
    }

    // Advanced settings toggle
    const advancedToggle = document.getElementById("advancedToggle");
    const advancedSettings = document.getElementById("advancedSettings");
    advancedToggle?.addEventListener("click", () => {
      advancedSettings.classList.toggle("open");
    });

    // Start League button
    document.getElementById("startLeagueBtn")?.addEventListener("click", () => {
      const leagueSetup = {
        leagueName: document.getElementById("leagueName").value || "My League",
        teamToManage: document.getElementById("teamToManage").value,
        startSeason: parseInt(document.getElementById("startSeason").value),
        numTeams: parseInt(document.getElementById("numTeams").value),
        capMode: document.getElementById("capMode").value,
        difficulty: document.getElementById("difficulty").value,
        conferenceSplit: document.getElementById("confSplit").checked,
        randomNames: document.getElementById("randomNames").checked,
        expansionDraft: document.getElementById("expansionDraft").checked,
        injuries: document.getElementById("injuries").checked,
        morale: document.getElementById("morale").checked,
        realisticContracts: document.getElementById("realisticContracts").checked
      };

      // Save setup to localStorage
      localStorage.setItem(SETUP_STORAGE_KEY, JSON.stringify(leagueSetup));

      // Initialize new league with setup parameters
      initializeLeague(leagueSetup);

      // Fade transition
      const setupScreen = document.getElementById("setupScreen");
      const mainApp = document.getElementById("mainApp");
      
      if (setupScreen && mainApp) {
        setupScreen.classList.add("fade-out");
        setTimeout(() => {
          setupScreen.style.display = "none";
          mainApp.classList.add("active");
        }, 500);
      }
    });

    // Load Save button
    document.getElementById("loadSaveBtn")?.addEventListener("click", () => {
      if (!hasExistingLeague()) {
        alert("No saved league found. Please start a new league first.");
        return;
      }

      // Load existing league
      const setupScreen = document.getElementById("setupScreen");
      const mainApp = document.getElementById("mainApp");
      
      if (setupScreen && mainApp) {
        setupScreen.classList.add("fade-out");
        setTimeout(() => {
          setupScreen.style.display = "none";
          mainApp.classList.add("active");
          // STATE will be loaded from localStorage automatically
          rerenderAll();
        }, 500);
      }
    });

    // Auto-load if save exists
    window.addEventListener("DOMContentLoaded", () => {
      if (hasExistingLeague()) {
        // Show load option more prominently
        document.getElementById("loadSaveBtn").style.background = "linear-gradient(135deg, var(--good) 0%, #2d9d5f 100%)";
        document.getElementById("loadSaveBtn").style.borderColor = "var(--good)";
        document.getElementById("loadSaveBtn").style.color = "white";
      }
    });

    // -------------------------------
    // Initialize League from Setup
    // -------------------------------
    function initializeLeague(setup) {
      let teamName;
      
      if (setup.teamToManage === "random") {
        teamName = generateRandomTeamName();
      } else if (setup.randomNames) {
        teamName = generateRandomTeamName();
      } else {
        teamName = setup.teamToManage;
      }
      
      const newState = {
        meta: { 
          teamName: teamName,
          leagueName: setup.leagueName,
          season: setup.startSeason, 
          numTeams: setup.numTeams,
          difficulty: setup.difficulty,
          rules: DEFAULT_RULES 
        },
        roster: generateRoster(),
        leagueRosters: generateLeagueRosters(),
        events: [
          {ts: Date.now(), text:`Welcome to ${setup.leagueName}! You're now managing the ${teamName}. Your journey begins in ${setup.startSeason}-${(setup.startSeason+1).toString().slice(2)}.`, type:"league"}
        ],
        prospects: [],
        freeAgents: generateFreeAgents(75),
        settings: setup,
        dashboard: {
          wins: 0,
          losses: 0,
          confRank: 8,
          divRank: 3,
          lastTen: [],
          pointDiff: 0,
          streak: { type: "none", count: 0 },
          nextOpponent: "Memphis Momentum",
          nextGameDate: "Nov 15",
          offRtg: 112.5,
          defRtg: 108.2,
          pace: 98.7,
          sentiment: 50
        }
      };

      // Calculate interest for all free agents
      newState.freeAgents.forEach(fa => {
        fa.interest = calculateInterest(fa, newState);
      });

      STATE = newState;
      save(STATE);
      rerenderAll();
    }

    function generateRandomTeamName() {
      const cities = ["Phoenix", "Seattle", "Las Vegas", "Vancouver", "Montreal", "Austin", "Nashville", "San Diego", "Kansas City", "Louisville"];
      const names = ["Thunder", "Dragons", "Vipers", "Raptors", "Lightning", "Titans", "Storm", "Fusion", "Eclipse", "Phoenix"];
      return `${cities[Math.floor(Math.random()*cities.length)]} ${names[Math.floor(Math.random()*names.length)]}`;
    }

    // -------------------------------
    // Player Generation
    // -------------------------------
    // -------------------------------
    // Player Generation
    // -------------------------------
    
    // Bio Data Generators
    function generateNickname(name, archetype, ovr) {
      const firstNames = name.split(' ')[0];
      const lastNames = name.split(' ')[1] || '';
      
      const nicknames = [
        `The ${archetype.split(' ')[0]}`,
        `${firstNames[0]}-${lastNames.substring(0, 3).toUpperCase()}`,
        ovr >= 85 ? "The Franchise" : "",
        ovr >= 80 ? "All-Star" : "",
        `${firstNames.substring(0, 3)}-${lastNames.substring(0, 3)}`,
        "",  // Some players have no nickname
        ""
      ];
      
      return nicknames[Math.floor(Math.random() * nicknames.length)];
    }
    
    function generateBirthplace() {
      const cities = [
        "Los Angeles, CA", "New York, NY", "Chicago, IL", "Houston, TX", "Phoenix, AZ",
        "Philadelphia, PA", "San Antonio, TX", "San Diego, CA", "Dallas, TX", "San Jose, CA",
        "Detroit, MI", "Memphis, TN", "Boston, MA", "Seattle, WA", "Denver, CO",
        "Washington, DC", "Atlanta, GA", "Miami, FL", "Minneapolis, MN", "Cleveland, OH",
        "Toronto, Canada", "Montreal, Canada", "Paris, France", "London, UK", "Berlin, Germany",
        "Barcelona, Spain", "Athens, Greece", "Melbourne, Australia", "Lagos, Nigeria", "Tokyo, Japan"
      ];
      return cities[Math.floor(Math.random() * cities.length)];
    }
    
    function generateCollege() {
      const colleges = [
        "Duke", "Kentucky", "North Carolina", "Kansas", "UCLA", "Villanova", "Michigan State",
        "Gonzaga", "Arizona", "Texas", "Michigan", "Louisville", "Syracuse", "Florida",
        "Ohio State", "Indiana", "Wisconsin", "Maryland", "UConn", "Memphis",
        "International", "High School", "G-League", "Overseas"
      ];
      return colleges[Math.floor(Math.random() * colleges.length)];
    }
    
    function generateDraftInfo(age, ovr) {
      const currentYear = 2026;
      const yearsAgo = age - 19; // Assume drafted at 19
      const draftYear = currentYear - yearsAgo;
      
      let draftPick;
      if (ovr >= 85) draftPick = 1 + Math.floor(Math.random() * 10); // Top 10
      else if (ovr >= 75) draftPick = 8 + Math.floor(Math.random() * 22); // 8-30
      else draftPick = 20 + Math.floor(Math.random() * 40); // 20-60
      
      return { draftYear, draftPick };
    }
    
    function generateAwards(ovr, age, archetype) {
      const awards = [];
      const experience = age - 19;
      
      if (ovr >= 90) {
        awards.push("MVP");
        awards.push("All-NBA First Team");
        if (Math.random() > 0.5) awards.push("Finals MVP");
      } else if (ovr >= 85) {
        if (Math.random() > 0.4) awards.push("All-Star");
        if (Math.random() > 0.6) awards.push("All-NBA Second Team");
      } else if (ovr >= 80) {
        if (Math.random() > 0.5) awards.push("All-Star");
        if (Math.random() > 0.7) awards.push("All-Defense");
      }
      
      if (experience <= 3 && ovr >= 75) {
        if (Math.random() > 0.5) awards.push("Rookie of the Year");
      }
      
      if (archetype.includes("Defensive") || archetype.includes("Defense")) {
        if (ovr >= 80 && Math.random() > 0.6) awards.push("DPOY");
      }
      
      if (experience > 8 && ovr >= 75) {
        if (Math.random() > 0.7) awards.push("Championship");
      }
      
      return awards;
    }
    
    function generateBioText(name, archetype, mental, ovr) {
      const personalities = [];
      
      if (mental.leadership >= 80) personalities.push("natural leader");
      else if (mental.leadership >= 60) personalities.push("vocal presence");
      else personalities.push("quiet professional");
      
      if (ovr >= 85) personalities.push("elite scorer");
      else if (ovr >= 80) personalities.push("reliable contributor");
      else if (ovr >= 70) personalities.push("developing talent");
      
      if (mental.composure >= 80) personalities.push("thrives under pressure");
      else if (mental.composure < 50) personalities.push("struggles in clutch moments");
      
      if (mental.workEthic >= 85) personalities.push("gym rat with exceptional work ethic");
      else if (mental.workEthic < 50) personalities.push("relies on natural talent");
      
      if (mental.coachability >= 80) personalities.push("highly coachable");
      
      // Build sentence
      const firstName = name.split(' ')[0];
      let bio = `${firstName} is a `;
      
      if (personalities.length > 0) {
        bio += personalities.slice(0, 2).join(", ");
        if (personalities.length > 2) {
          bio += ", and " + personalities[2];
        }
        bio += ".";
      }
      
      if (archetype) {
        bio += ` Known as a ${archetype.toLowerCase()}, `;
        bio += "they bring unique value to any roster.";
      }
      
      return bio;
    }
    
    // -------------------------------
    // Personality Traits System
    // -------------------------------
    function generatePersonalityTraits(ovr, age, mental) {
      // Core personality attributes (0-100 scale)
      
      // Leadership: ability to inspire and guide teammates
      let leadership = mental.leadership || 40 + Math.floor(Math.random() * 55);
      if (ovr >= 85) leadership += 15; // Stars tend to be leaders
      if (age >= 30) leadership += 10; // Veterans gain leadership
      leadership = Math.min(99, leadership);
      
      // Ego: self-importance and need for recognition
      let ego = 35 + Math.floor(Math.random() * 60);
      if (ovr >= 85) ego += 20; // Stars have bigger egos
      if (ovr < 65) ego -= 10; // Role players more humble
      ego = Math.max(10, Math.min(99, ego));
      
      // Competitiveness: drive to win at all costs
      const competitiveness = 45 + Math.floor(Math.random() * 50);
      
      // Work Ethic: dedication to improvement
      const workEthic = mental.workEthic || 45 + Math.floor(Math.random() * 50);
      
      // Coachability: willingness to take instruction
      let coachability = mental.coachability || 45 + Math.floor(Math.random() * 50);
      if (ego > 80) coachability -= 15; // High ego reduces coachability
      coachability = Math.max(20, Math.min(99, coachability));
      
      // Temper: emotional stability and anger management
      let temper = 30 + Math.floor(Math.random() * 60);
      if (competitiveness > 80) temper += 10; // Competitive players more intense
      temper = Math.min(99, temper);
      
      // Loyalty: attachment to team/city
      const loyalty = 35 + Math.floor(Math.random() * 60);
      
      // Greed: prioritization of money over other factors
      const greed = 30 + Math.floor(Math.random() * 60);
      
      // Market Preference
      const marketOptions = ["Small", "Mid", "Large", "Any"];
      const marketWeights = [0.15, 0.3, 0.4, 0.15]; // More likely to prefer large markets
      let marketPref = "Mid";
      const marketRand = Math.random();
      let cumulative = 0;
      for (let i = 0; i < marketOptions.length; i++) {
        cumulative += marketWeights[i];
        if (marketRand < cumulative) {
          marketPref = marketOptions[i];
          break;
        }
      }
      
      // Media Savvy: ability to handle press and public relations
      let mediaSavvy = 35 + Math.floor(Math.random() * 55);
      if (ovr >= 80) mediaSavvy += 15; // Stars get more media training
      mediaSavvy = Math.min(99, mediaSavvy);
      
      // Clutch Gene: performance under pressure
      const clutch = mental.clutch || 40 + Math.floor(Math.random() * 50);
      
      // Discipline: professionalism and adherence to rules
      const discipline = mental.discipline || 40 + Math.floor(Math.random() * 55);
      
      // Resilience: ability to bounce back from adversity
      let resilience = 40 + Math.floor(Math.random() * 50);
      if (age >= 28) resilience += 10; // Veterans more resilient
      resilience = Math.min(99, resilience);
      
      // Charisma: likability and social magnetism
      let charisma = 35 + Math.floor(Math.random() * 60);
      if (leadership > 75) charisma += 10; // Leaders tend to be charismatic
      charisma = Math.min(99, charisma);
      
      // Social Type
      const socialType = Math.random() > 0.35 ? "Extrovert" : "Introvert"; // 65% extrovert
      
      // Motivation: primary career driver
      const motivations = ["Legacy", "Money", "Fame", "Rings", "Revenge", "Respect"];
      let motivation = motivations[Math.floor(Math.random() * motivations.length)];
      if (ovr >= 85) {
        // Stars more likely to chase legacy/rings
        motivation = Math.random() > 0.4 ? "Legacy" : Math.random() > 0.5 ? "Rings" : "Respect";
      } else if (ovr < 70) {
        // Role players more likely to chase money
        motivation = Math.random() > 0.5 ? "Money" : "Respect";
      }
      
      // Professionalism: overall conduct and reliability
      let professionalism = 45 + Math.floor(Math.random() * 50);
      if (discipline > 75) professionalism += 10;
      if (temper > 80) professionalism -= 15;
      professionalism = Math.max(25, Math.min(99, professionalism));
      
      return {
        leadership,
        ego,
        competitiveness,
        workEthic,
        coachability,
        temper,
        loyalty,
        greed,
        marketPreference: marketPref,
        mediaSavvy,
        clutch,
        discipline,
        resilience,
        charisma,
        socialType,
        motivation,
        professionalism
      };
    }
    
    function getPersonalityDescription(personality) {
      const traits = [];
      
      // Primary trait
      if (personality.leadership >= 80) traits.push("natural leader");
      else if (personality.ego >= 80) traits.push("confident superstar");
      else if (personality.workEthic >= 85) traits.push("gym rat");
      else if (personality.competitiveness >= 85) traits.push("fierce competitor");
      
      // Secondary trait
      if (personality.professionalism >= 80) traits.push("consummate professional");
      else if (personality.loyalty >= 80) traits.push("loyal veteran");
      else if (personality.greed >= 75) traits.push("business-minded");
      else if (personality.charisma >= 80) traits.push("fan favorite");
      
      // Tertiary trait
      if (personality.clutch >= 80) traits.push("clutch performer");
      else if (personality.resilience >= 80) traits.push("mentally tough");
      else if (personality.mediaSavvy >= 80) traits.push("media darling");
      else if (personality.coachability >= 85) traits.push("highly coachable");
      
      // Motivation
      if (personality.motivation === "Legacy") traits.push("legacy-driven");
      else if (personality.motivation === "Rings") traits.push("championship-focused");
      else if (personality.motivation === "Money") traits.push("financially motivated");
      
      // Negative traits (if applicable)
      if (personality.temper >= 80 && traits.length < 3) traits.push("fiery temperament");
      if (personality.ego >= 85 && personality.coachability < 50 && traits.length < 3) traits.push("difficult to coach");
      
      // Default if not enough traits
      if (traits.length === 0) {
        traits.push("solid role player");
        traits.push("team-first mentality");
      }
      
      // Build description
      if (traits.length === 1) return traits[0];
      if (traits.length === 2) return `${traits[0]}, ${traits[1]}`;
      if (traits.length === 3) return `${traits[0]}, ${traits[1]}, ${traits[2]}`;
      return `${traits[0]}, ${traits[1]}, and ${traits[2]}`;
    }
    
    function generateSeasonStats(ovr, pos) {
      const base = {
        ppg: Math.max(5, (ovr - 50) * 0.4 + Math.random() * 5),
        rpg: pos === "C" || pos === "PF" ? Math.max(3, (ovr - 50) * 0.15 + Math.random() * 3) : Math.max(2, (ovr - 60) * 0.1 + Math.random() * 2),
        apg: pos === "PG" ? Math.max(3, (ovr - 50) * 0.15 + Math.random() * 3) : Math.max(1, (ovr - 60) * 0.08 + Math.random() * 2),
        spg: Math.max(0.5, (ovr - 60) * 0.03 + Math.random() * 0.5),
        bpg: pos === "C" || pos === "PF" ? Math.max(0.3, (ovr - 60) * 0.04 + Math.random() * 0.8) : Math.max(0.1, Math.random() * 0.4),
        fgPct: Math.min(0.55, Math.max(0.38, 0.35 + (ovr - 50) * 0.004 + Math.random() * 0.08)),
        threePct: Math.min(0.45, Math.max(0.28, 0.28 + (ovr - 50) * 0.003 + Math.random() * 0.08)),
        ftPct: Math.min(0.92, Math.max(0.65, 0.65 + (ovr - 50) * 0.005 + Math.random() * 0.1))
      };
      
      return {
        ppg: base.ppg.toFixed(1),
        rpg: base.rpg.toFixed(1),
        apg: base.apg.toFixed(1),
        spg: base.spg.toFixed(1),
        bpg: base.bpg.toFixed(1),
        fgPct: (base.fgPct * 100).toFixed(1),
        threePct: (base.threePct * 100).toFixed(1),
        ftPct: (base.ftPct * 100).toFixed(1)
      };
    }
    
    function calculateOVR(skills, pos) {
      // Position-specific weightings
      const weights = {
        PG: { playmaking: 0.20, ballHandling: 0.15, three: 0.12, mid: 0.10, defensiveIQ: 0.10, perimeterD: 0.10, athleticism: 0.10, offensiveIQ: 0.08, ft: 0.05 },
        SG: { three: 0.18, mid: 0.15, perimeterD: 0.12, athleticism: 0.12, offensiveIQ: 0.10, defensiveIQ: 0.10, playmaking: 0.08, ballHandling: 0.08, ft: 0.07 },
        SF: { three: 0.15, athleticism: 0.15, perimeterD: 0.12, mid: 0.10, offensiveIQ: 0.10, defensiveIQ: 0.10, inside: 0.08, rebounding: 0.10, strength: 0.10 },
        PF: { inside: 0.15, rebounding: 0.15, strength: 0.12, postD: 0.12, mid: 0.10, athleticism: 0.10, defensiveIQ: 0.10, three: 0.08, offensiveIQ: 0.08 },
        C: { inside: 0.18, rebounding: 0.18, postD: 0.15, strength: 0.15, defensiveIQ: 0.12, athleticism: 0.10, offensiveIQ: 0.07, mid: 0.05 }
      };
      
      const posWeights = weights[pos] || weights.SF;
      let total = 0;
      
      Object.keys(posWeights).forEach(skill => {
        total += (skills[skill] || 50) * posWeights[skill];
      });
      
      return Math.round(total);
    }
    
    // -------------------------------
    // Coach Generation
    // -------------------------------
    
    function generateCoach(role = "head", tier = null) {
      const firstNames = ["Mike", "Steve", "Doc", "Pop", "Rick", "Erik", "Tyronn", "Brad", "Quin", "Nick", "Tom", "Monty", "Willie", "Billy", "Jason", "Luke", "Frank", "Kenny", "Mike D.", "Stan"];
      const lastNames = ["Rivers", "Kerr", "Popovich", "Stevens", "Spoelstra", "Carlisle", "Snyder", "Nurse", "Malone", "Budenholzer", "Thibodeau", "Williams", "Donovan", "Vogel", "D'Antoni", "Van Gundy", "Atkinson", "Brown", "Clifford", "Casey"];
      
      const archetypes = [
        "Player's Coach", "Tactician", "Defensive Guru", "Offensive Innovator",
        "Motivator", "Disciplinarian", "Player Developer", "Analytics Guru",
        "Old School", "Modern Strategist", "Veteran Whisperer", "Youth Builder"
      ];
      
      const personalities = [
        "Calm Strategist", "Player's Coach", "Hothead", "Disciplinarian",
        "Laid Back", "Intense Competitor", "Media Darling", "Quiet Professional",
        "Player's Friend", "Tough Love", "Analytical Mind", "Motivational Speaker"
      ];
      
      const styles = [
        { name: "Pace & Space", offense: 85, defense: 60, pace: 90, focus: "Three-Point Shooting" },
        { name: "Grit & Grind", offense: 55, defense: 95, pace: 40, focus: "Defense First" },
        { name: "Motion Offense", offense: 80, defense: 70, pace: 65, focus: "Ball Movement" },
        { name: "ISO Heavy", offense: 75, defense: 65, pace: 55, focus: "Star-Driven" },
        { name: "Run & Gun", offense: 90, defense: 50, pace: 98, focus: "Transition" },
        { name: "Defensive Wall", offense: 60, defense: 92, pace: 50, focus: "Rim Protection" },
        { name: "Princeton", offense: 78, defense: 75, pace: 58, focus: "High IQ Basketball" },
        { name: "Seven Seconds", offense: 88, defense: 55, pace: 95, focus: "Fast Break" },
        { name: "Triangle", offense: 72, defense: 72, pace: 62, focus: "Fundamentals" },
        { name: "Switch Everything", offense: 70, defense: 85, pace: 70, focus: "Versatility" }
      ];
      
      const name = `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
      const age = 35 + Math.floor(Math.random() * 30); // 35-64
      const archetype = archetypes[Math.floor(Math.random() * archetypes.length)];
      const personality = personalities[Math.floor(Math.random() * personalities.length)];
      const style = styles[Math.floor(Math.random() * styles.length)];
      
      // Determine tier if not specified
      if (!tier) {
        const roll = Math.random();
        if (roll < 0.15) tier = "elite";      // 15% elite
        else if (roll < 0.40) tier = "great"; // 25% great
        else if (roll < 0.75) tier = "solid"; // 35% solid
        else tier = "developing";             // 25% developing
      }
      
      // Base attributes vary by tier
      let baseAttr = 50;
      if (tier === "elite") baseAttr = 80;
      else if (tier === "great") baseAttr = 70;
      else if (tier === "solid") baseAttr = 60;
      else baseAttr = 50;
      
      const variance = 12;
      
      // Generate attributes (0-100 scale)
      const attributes = {
        offensiveIQ: Math.round(Math.max(40, Math.min(99, baseAttr + (Math.random() * variance * 2 - variance)))),
        defensiveIQ: Math.round(Math.max(40, Math.min(99, baseAttr + (Math.random() * variance * 2 - variance)))),
        development: Math.round(Math.max(40, Math.min(99, baseAttr + (Math.random() * variance * 2 - variance)))),
        motivator: Math.round(Math.max(40, Math.min(99, baseAttr + (Math.random() * variance * 2 - variance)))),
        adaptability: Math.round(Math.max(40, Math.min(99, baseAttr + (Math.random() * variance * 2 - variance)))),
        discipline: Math.round(Math.max(40, Math.min(99, baseAttr + (Math.random() * variance * 2 - variance)))),
        loyalty: Math.round(Math.max(40, Math.min(99, baseAttr + (Math.random() * variance * 2 - variance))))
      };
      
      // Archetype adjustments
      if (archetype.includes("Defensive")) attributes.defensiveIQ += 10;
      if (archetype.includes("Offensive")) attributes.offensiveIQ += 10;
      if (archetype.includes("Developer")) attributes.development += 15;
      if (archetype.includes("Motivator")) attributes.motivator += 12;
      if (archetype.includes("Disciplinarian")) attributes.discipline += 12;
      
      // Clamp after adjustments
      Object.keys(attributes).forEach(key => {
        attributes[key] = Math.max(40, Math.min(99, attributes[key]));
      });
      
      // Salary based on tier and age
      let baseSalary = 1000000;
      if (tier === "elite") baseSalary = 8000000 + Math.random() * 4000000;      // 8-12M
      else if (tier === "great") baseSalary = 5000000 + Math.random() * 3000000; // 5-8M
      else if (tier === "solid") baseSalary = 2500000 + Math.random() * 2500000; // 2.5-5M
      else baseSalary = 1000000 + Math.random() * 1500000;                       // 1-2.5M
      
      const salary = Math.round(baseSalary);
      const years = role === "head" ? (1 + Math.floor(Math.random() * 4)) : (1 + Math.floor(Math.random() * 2)); // Head: 1-4, Assistant: 1-2
      
      return {
        id: uid(),
        name,
        age,
        role,
        archetype,
        personality,
        style,
        attributes,
        contract: {
          salary,
          years,
          yearsLeft: years
        },
        trust: 70, // Start at neutral-good
        record: { wins: 0, losses: 0 },
        reputation: tier,
        hired: new Date().getFullYear()
      };
    }
    
    function generateCoachCandidates(count = 12) {
      const candidates = [];
      for (let i = 0; i < count; i++) {
        candidates.push(generateCoach("candidate"));
      }
      return candidates;
    }
    
    function getCoachingBoost(coach) {
      if (!coach) return { team: 0, morale: 0, development: 1.0 };
      
      const attrs = coach.attributes;
      const teamBoost = Math.round((attrs.offensiveIQ + attrs.defensiveIQ + attrs.adaptability) / 3);
      const moraleBoost = Math.round((attrs.motivator + (100 - attrs.discipline)) / 2);
      const developmentMultiplier = 1.0 + (attrs.development / 200); // 1.2x to 1.5x
      
      return {
        team: teamBoost,
        morale: moraleBoost,
        development: developmentMultiplier
      };
    }
    
    function calculateCoachTrust(coach, teamState) {
      if (!coach || !coach.trust) coach.trust = 70;
      
      const d = teamState.dashboard;
      let trustChange = 0;
      
      // Win/loss impact
      const winPct = d.wins / (d.wins + d.losses || 1);
      if (winPct > 0.6) trustChange += 2;
      else if (winPct < 0.4) trustChange -= 2;
      
      // Streak impact
      if (d.streak.type === "w" && d.streak.count >= 5) trustChange += 3;
      if (d.streak.type === "l" && d.streak.count >= 5) trustChange -= 5;
      
      // Chemistry impact
      if (teamState.chemistry) {
        if (teamState.chemistry >= 75) trustChange += 1;
        else if (teamState.chemistry < 50) trustChange -= 2;
      }
      
      // Clamp trust between 0-100
      coach.trust = Math.max(0, Math.min(100, coach.trust + trustChange));
      
      return coach.trust;
    }
    
    function generateCoachEvent(coach, teamState) {
      if (!coach) return null;
      
      const trust = coach.trust || 70;
      const events = [];
      
      // Low trust events
      if (trust < 30) {
        events.push(`${coach.name} reportedly frustrated with front office decisions.`);
        events.push(`Sources say ${coach.name}'s relationship with management is strained.`);
        events.push(`${coach.name} seen having heated discussion with GM after practice.`);
      }
      // Medium trust
      else if (trust < 60) {
        events.push(`${coach.name} emphasizes need for roster improvements.`);
        events.push(`${coach.name} working overtime to develop young talent.`);
      }
      // High trust
      else if (trust >= 80) {
        events.push(`${coach.name} praised management for their vision and support.`);
        events.push(`Players rave about ${coach.name}'s leadership and preparation.`);
        events.push(`${coach.name} and front office in perfect harmony on team direction.`);
      }
      
      // Personality-based events
      if (coach.personality === "Hothead" && Math.random() < 0.15) {
        events.push(`${coach.name} ejected from game after heated exchange with officials.`);
      }
      if (coach.personality === "Media Darling" && Math.random() < 0.1) {
        events.push(`${coach.name}'s press conference goes viral for all the right reasons.`);
      }
      if (coach.archetype === "Player Developer" && Math.random() < 0.12) {
        events.push(`${coach.name}'s development program paying dividends for young players.`);
      }
      
      return events.length > 0 ? events[Math.floor(Math.random() * events.length)] : null;
    }
    
    // -------------------------------
    // Owner Generation
    // -------------------------------
    
    function generateOwner() {
      const firstNames = ["Marcus", "Victoria", "Robert", "Catherine", "James", "Eleanor", "William", "Sophia", "Alexander", "Olivia", "Daniel", "Isabella", "Michael", "Charlotte", "David", "Amelia"];
      const lastNames = ["Langford", "Sterling", "Blackwell", "Montgomery", "Ashford", "Sinclair", "Whitmore", "Carmichael", "Fitzgerald", "Pembroke", "Westbrook", "Harrington", "Thornton", "Beaumont", "Kensington"];
      
      const archetypes = [
        {
          name: "Legacy Builder",
          desc: "Prioritizes championships and long-term success over profit",
          patience: 75,
          involvement: 70,
          basketballIQ: 65,
          greed: 30,
          loyalty: 85,
          ambition: 95,
          temper: 45,
          publicImage: 70
        },
        {
          name: "Business Mogul",
          desc: "Bottom-line focused, profit-driven, analytics-minded",
          patience: 50,
          involvement: 60,
          basketballIQ: 55,
          greed: 90,
          loyalty: 40,
          ambition: 80,
          temper: 35,
          publicImage: 75
        },
        {
          name: "Impulsive Tycoon",
          desc: "Emotional decision-maker, swings between extremes",
          patience: 30,
          involvement: 85,
          basketballIQ: 50,
          greed: 60,
          loyalty: 50,
          ambition: 85,
          temper: 90,
          publicImage: 55
        },
        {
          name: "Traditionalist",
          desc: "Values loyalty, longevity, and old-school basketball",
          patience: 80,
          involvement: 55,
          basketballIQ: 70,
          greed: 45,
          loyalty: 95,
          ambition: 60,
          temper: 40,
          publicImage: 80
        },
        {
          name: "Billionaire Fan",
          desc: "Wealthy enthusiast who loves the game, willing to spend",
          patience: 65,
          involvement: 75,
          basketballIQ: 60,
          greed: 20,
          loyalty: 70,
          ambition: 75,
          temper: 55,
          publicImage: 65
        },
        {
          name: "Local Hero",
          desc: "Community-focused, values chemistry and public perception",
          patience: 70,
          involvement: 65,
          basketballIQ: 55,
          greed: 35,
          loyalty: 80,
          ambition: 65,
          ambition: 65,
          temper: 50,
          publicImage: 90
        },
        {
          name: "Silent Investor",
          desc: "Hands-off until crisis, minimal interaction",
          patience: 85,
          involvement: 25,
          basketballIQ: 50,
          greed: 70,
          loyalty: 55,
          ambition: 55,
          temper: 30,
          publicImage: 60
        }
      ];
      
      const name = `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
      const age = 45 + Math.floor(Math.random() * 30); // 45-74
      const archetype = archetypes[Math.floor(Math.random() * archetypes.length)];
      
      // Add some variance to traits (¬±10)
      const traits = {};
      Object.keys(archetype).forEach(key => {
        if (key !== 'name' && key !== 'desc') {
          const base = archetype[key];
          const variance = Math.floor(Math.random() * 21) - 10; // -10 to +10
          traits[key] = Math.max(10, Math.min(99, base + variance));
        }
      });
      
      return {
        name,
        age,
        archetype: archetype.name,
        archetypeDesc: archetype.desc,
        traits,
        trust: 65, // Start at cautiously optimistic
        goals: [],
        notes: "New ownership, evaluating team direction.",
        lastMeeting: null,
        meetingsDue: ["season_start"]
      };
    }
    
    function generateSeasonGoals(teamState, owner) {
      const goals = [];
      const d = teamState.dashboard;
      const currentWinPct = d.wins / (d.wins + d.losses || 1);
      
      // Win goal (archetype-dependent)
      let targetWins = 40;
      if (owner.traits.ambition >= 80) {
        targetWins = 50 + Math.floor(Math.random() * 15); // 50-64
      } else if (owner.traits.ambition >= 60) {
        targetWins = 42 + Math.floor(Math.random() * 10); // 42-51
      } else {
        targetWins = 35 + Math.floor(Math.random() * 8); // 35-42
      }
      
      goals.push({
        type: "wins",
        target: targetWins,
        description: `Win at least ${targetWins} games this season`,
        priority: owner.archetype === "Legacy Builder" ? "high" : "medium"
      });
      
      // Budget goal
      const payroll = sum(teamState.roster, p => p.salary);
      const cap = teamState.meta.rules.cap;
      const tax = teamState.meta.rules.tax;
      
      if (owner.traits.greed >= 70) {
        // Profit-focused owners want to stay under cap
        goals.push({
          type: "budget",
          target: "under_cap",
          description: "Keep payroll under the salary cap",
          priority: "high"
        });
      } else if (owner.traits.greed <= 40 && owner.traits.ambition >= 75) {
        // Spend to win
        goals.push({
          type: "budget",
          target: "contend",
          description: "Spend aggressively to build championship contender",
          priority: "medium"
        });
      } else {
        // Moderate spending
        goals.push({
          type: "budget",
          target: "under_tax",
          description: "Avoid luxury tax penalties",
          priority: "medium"
        });
      }
      
      // Team culture goal (for certain archetypes)
      if (owner.archetype === "Local Hero" || owner.archetype === "Traditionalist") {
        goals.push({
          type: "chemistry",
          target: 75,
          description: "Maintain team chemistry above 75",
          priority: "medium"
        });
      }
      
      // Development goal (for patient owners)
      if (owner.traits.patience >= 70) {
        const youngPlayers = teamState.roster.filter(p => p.age < 25);
        if (youngPlayers.length > 0) {
          goals.push({
            type: "development",
            target: "improve_youth",
            description: "Develop young core players",
            priority: "low"
          });
        }
      }
      
      return goals;
    }
    
    // -------------------------------
    // Fan Hype System
    // -------------------------------
    function updateFanHype(delta, reason) {
      if (!STATE.fans) {
        STATE.fans = { hype: 50, history: [] };
      }
      
      const oldHype = STATE.fans.hype;
      STATE.fans.hype = Math.max(0, Math.min(100, STATE.fans.hype + delta));
      
      // Record history
      STATE.fans.history.push({
        timestamp: Date.now(),
        delta,
        reason,
        hype: STATE.fans.hype
      });
      
      // Keep last 20 events
      if (STATE.fans.history.length > 20) {
        STATE.fans.history = STATE.fans.history.slice(-20);
      }
      
      // Add feed entry for significant changes
      if (Math.abs(delta) >= 10) {
        const sentiment = getFanSentiment(STATE.fans.hype);
        let feedText = "";
        
        if (delta > 0) {
          if (STATE.fans.hype >= 80) {
            feedText = `üî• Fans euphoric! ${reason}`;
          } else if (STATE.fans.hype >= 60) {
            feedText = `üìà Fanbase optimistic after ${reason.toLowerCase()}`;
          } else {
            feedText = `‚úÖ Fans approve: ${reason}`;
          }
        } else {
          if (STATE.fans.hype <= 20) {
            feedText = `üö® MUTINY! Fans demand change after ${reason.toLowerCase()}`;
          } else if (STATE.fans.hype <= 40) {
            feedText = `üò° Fans furious following ${reason.toLowerCase()}`;
          } else {
            feedText = `üëé Fanbase restless: ${reason}`;
          }
        }
        
        STATE.events.unshift({
          ts: Date.now(),
          text: feedText,
          type: "fan"
        });
      }
      
      save(STATE);
      return STATE.fans.hype;
    }
    
    function getFanSentiment(hype) {
      if (hype >= 80) return { label: "Euphoria", color: "#4ade80", glow: true };
      if (hype >= 60) return { label: "Optimistic", color: "#60a5fa", glow: false };
      if (hype >= 40) return { label: "Restless", color: "#fbbf24", glow: false };
      if (hype >= 20) return { label: "Angry", color: "#fb923c", glow: false };
      return { label: "Mutiny", color: "#f87171", glow: true };
    }
    
    function calculateFanHypeMultiplier(hype) {
      // Revenue multiplier: 0.8 to 1.3 based on hype (0-100)
      return 0.8 + (hype / 200);
    }
    
    function calculateOwnerTrust(owner, teamState) {
      if (!owner || !owner.trust) return 65;
      
      const d = teamState.dashboard;
      let trustChange = 0;
      
      // Win/loss performance (scaled by ambition)
      const winPct = d.wins / (d.wins + d.losses || 1);
      const ambitionFactor = owner.traits.ambition / 100;
      
      if (winPct > 0.65) {
        trustChange += Math.round(5 * ambitionFactor);
      } else if (winPct > 0.55) {
        trustChange += Math.round(2 * ambitionFactor);
      } else if (winPct < 0.35) {
        trustChange -= Math.round(8 * ambitionFactor);
      } else if (winPct < 0.45) {
        trustChange -= Math.round(3 * ambitionFactor);
      }
      
      // Fan hype impact on owner trust
      const fanHype = teamState.fans?.hype || 50;
      if (fanHype >= 80) {
        trustChange += 3; // Owner happy when fans are ecstatic
      } else if (fanHype >= 60) {
        trustChange += 1; // Minor boost for optimistic fans
      } else if (fanHype <= 20) {
        trustChange -= 5; // Owner very concerned when fans are mutinous
      } else if (fanHype <= 40) {
        trustChange -= 2; // Minor penalty for restless fans
      }
      
      // Streak impact (Impulsive Tycoon more affected)
      const streakMultiplier = owner.archetype === "Impulsive Tycoon" ? 1.5 : 1.0;
      if (d.streak.type === "w" && d.streak.count >= 5) {
        trustChange += Math.round(4 * streakMultiplier);
      }
      if (d.streak.type === "l" && d.streak.count >= 5) {
        trustChange -= Math.round(6 * streakMultiplier);
      }
      
      // Financial performance (greed-dependent)
      const payroll = sum(teamState.roster, p => p.salary);
      const cap = teamState.meta.rules.cap;
      const tax = teamState.meta.rules.tax;
      const greedFactor = owner.traits.greed / 100;
      
      if (payroll > tax) {
        trustChange -= Math.round(5 * greedFactor); // Over tax hurts greedy owners
      } else if (payroll < cap * 0.8 && owner.traits.ambition >= 75) {
        trustChange -= Math.round(3 * (owner.traits.ambition / 100)); // Not spending enough
      }
      
      // Chemistry (Local Hero and Traditionalist care)
      if (teamState.dashboard.chemistry) {
        if (owner.archetype === "Local Hero" || owner.archetype === "Traditionalist") {
          if (teamState.dashboard.chemistry >= 80) {
            trustChange += 3;
          } else if (teamState.dashboard.chemistry < 50) {
            trustChange -= 4;
          }
        }
      }
      
      // Goal tracking
      if (owner.goals && owner.goals.length > 0) {
        owner.goals.forEach(goal => {
          if (goal.met === true) {
            trustChange += goal.priority === "high" ? 5 : goal.priority === "medium" ? 3 : 2;
          } else if (goal.met === false) {
            trustChange -= goal.priority === "high" ? 8 : goal.priority === "medium" ? 5 : 3;
          }
        });
      }
      
      // Clamp trust
      owner.trust = Math.max(0, Math.min(100, owner.trust + trustChange));
      
      // Update notes based on trust
      if (owner.trust >= 85) {
        owner.notes = "Extremely pleased with team direction and performance.";
      } else if (owner.trust >= 70) {
        owner.notes = "Satisfied with progress, expectations are being met.";
      } else if (owner.trust >= 50) {
        owner.notes = "Watching closely, expecting improvement soon.";
      } else if (owner.trust >= 30) {
        owner.notes = "Growing concerned about team performance and direction.";
      } else if (owner.trust >= 15) {
        owner.notes = "Seriously questioning GM's decisions. Job security at risk.";
      } else {
        owner.notes = "Preparing to make a change. Final warning.";
      }
      
      return owner.trust;
    }
    
    function generateOwnerEvent(owner, teamState) {
      if (!owner) return null;
      
      const trust = owner.trust || 65;
      const events = [];
      
      // Trust-based events
      if (trust >= 85) {
        events.push(`${owner.name} publicly praises GM's strategic vision.`);
        events.push(`Owner ${owner.name}: "This is exactly the direction I envisioned."`);
        events.push(`${owner.name} approves increased budget for team improvements.`);
      } else if (trust >= 70) {
        events.push(`${owner.name} expresses confidence in current management.`);
        events.push(`Owner satisfied with team's competitive trajectory.`);
      } else if (trust >= 40) {
        events.push(`${owner.name} calls for urgency in improving team performance.`);
        events.push(`Owner ${owner.name} schedules meeting to discuss team direction.`);
        events.push(`Sources: ${owner.name} monitoring situation closely.`);
      } else if (trust >= 20) {
        events.push(`${owner.name} reportedly frustrated with lack of progress.`);
        events.push(`Owner ${owner.name} questions recent roster decisions.`);
        events.push(`Tension building between ${owner.name} and front office.`);
      } else {
        events.push(`${owner.name} holds emergency meeting with ownership group.`);
        events.push(`Report: ${owner.name} losing faith in current management.`);
        events.push(`Owner ${owner.name}: "Changes may be necessary soon."`);
      }
      
      // Archetype-specific events
      if (owner.archetype === "Impulsive Tycoon" && Math.random() < 0.15) {
        events.push(`${owner.name} makes surprise visit to practice facility.`);
        events.push(`Owner ${owner.name} speaks candidly about expectations in media scrum.`);
      }
      if (owner.archetype === "Business Mogul" && Math.random() < 0.1) {
        events.push(`${owner.name} reviews quarterly financial reports with management.`);
      }
      if (owner.archetype === "Local Hero" && Math.random() < 0.12) {
        events.push(`${owner.name} hosts community event with players.`);
      }
      
      return events.length > 0 ? events[Math.floor(Math.random() * events.length)] : null;
    }
    
    // -------------------------------
    // Owner Intervention System
    // -------------------------------
    
    function calculateInterventionRisk(owner, actionType, actionContext = {}) {
      // Action sensitivity levels
      const actionSensitivity = {
        coachFiring: 1.0,
        coachHiring: 0.7,
        starTrade: 0.9,
        luxuryTax: 0.8,
        draftPick: 0.6
      };
      
      const sensitivity = actionSensitivity[actionType] || 0.5;
      const trustFactor = 1 - (owner.trust / 100); // Lower trust = higher risk
      const involvementFactor = owner.traits.involvement / 100;
      
      // Base risk calculation
      let risk = involvementFactor * trustFactor * sensitivity;
      
      // Modifiers based on context
      if (actionType === "luxuryTax" && owner.traits.greed > 70) {
        risk *= 1.5; // Greedy owners more likely to intervene on tax
      }
      if (actionType === "coachFiring" && owner.traits.loyalty > 75) {
        risk *= 1.3; // Loyal owners protective of staff
      }
      if (actionType === "starTrade" && owner.traits.ambition > 80 && actionContext.playerOvr > 85) {
        risk *= 1.4; // Ambitious owners don't want to lose stars
      }
      
      // Trust thresholds
      if (owner.trust < 25) risk *= 1.8; // Very low trust = frequent intervention
      else if (owner.trust > 80) risk *= 0.4; // High trust = rare intervention
      
      return Math.min(0.95, risk); // Cap at 95% to allow some agency
    }
    
    function checkOwnerIntervention(actionType, actionContext = {}) {
      // Check if intervention is enabled
      if (!STATE.settings || STATE.settings.ownerIntervention === false) {
        return { intervene: false };
      }
      
      if (!STATE.owner) return { intervene: false };
      
      const risk = calculateInterventionRisk(STATE.owner, actionType, actionContext);
      const roll = Math.random();
      
      if (roll < risk) {
        // Owner intervenes
        const outcome = generateInterventionOutcome(STATE.owner, actionType, actionContext);
        return { intervene: true, outcome };
      }
      
      return { intervene: false };
    }
    
    function generateInterventionOutcome(owner, actionType, context) {
      const outcomes = [];
      const trustLevel = owner.trust;
      
      // Determine outcome type based on owner traits and trust
      const approveChance = (trustLevel / 100) * 0.6; // Max 60% approval even at 100 trust
      const rejectChance = 0.5 - (trustLevel / 200); // 50% at 0 trust, 0% at 100 trust
      const demandChance = (owner.traits.involvement / 100) * 0.3;
      const overrideChance = (owner.trust < 20 && owner.traits.temper > 70) ? 0.15 : 0.02;
      
      const roll = Math.random();
      let outcomeType = "approve";
      
      if (roll < overrideChance) outcomeType = "override";
      else if (roll < overrideChance + rejectChance) outcomeType = "reject";
      else if (roll < overrideChance + rejectChance + demandChance) outcomeType = "demand";
      else outcomeType = "approve";
      
      // Generate context-specific dialogue
      let dialogue = "";
      let trustChange = 0;
      let allowAction = true;
      
      if (actionType === "coachFiring") {
        if (outcomeType === "approve") {
          dialogue = `"I trust your judgment, but ${context.coachName} was loyal. Make this count."`;
          trustChange = 2;
        } else if (outcomeType === "reject") {
          dialogue = `"Absolutely not. ${context.coachName} stays. This team's problems aren't on the sideline."`;
          trustChange = -5;
          allowAction = false;
        } else if (outcomeType === "demand") {
          dialogue = `"If you fire ${context.coachName}, you'd better have a championship-caliber replacement lined up."`;
          trustChange = 0;
        } else if (outcomeType === "override") {
          dialogue = `"I'm overruling you. ${context.coachName} is my hire and stays until *I* say otherwise."`;
          trustChange = -10;
          allowAction = false;
        }
      } else if (actionType === "coachHiring") {
        if (outcomeType === "approve") {
          dialogue = `"${context.coachName} is an interesting choice. Let's see what they can do."`;
          trustChange = 1;
        } else if (outcomeType === "reject") {
          dialogue = `"I've vetoed bigger contracts than this. ${context.coachName} isn't worth the investment."`;
          trustChange = -3;
          allowAction = false;
        } else if (outcomeType === "demand") {
          dialogue = `"Find someone cheaper. We don't need a celebrity coach, we need wins."`;
          trustChange = -2;
          allowAction = false;
        }
      } else if (actionType === "starTrade") {
        if (outcomeType === "approve") {
          dialogue = `"Trading ${context.playerName} is risky, but I'll back your vision. Don't make me regret this."`;
          trustChange = 3;
        } else if (outcomeType === "reject") {
          dialogue = `"Are you insane? ${context.playerName} is untouchable. This franchise doesn't trade stars."`;
          trustChange = -8;
          allowAction = false;
        } else if (outcomeType === "override") {
          dialogue = `"I'm canceling this trade immediately. ${context.playerName} is the face of this team."`;
          trustChange = -12;
          allowAction = false;
        }
      } else if (actionType === "luxuryTax") {
        if (outcomeType === "approve") {
          dialogue = `"Fine. Pay the tax. But we better be championship-bound."`;
          trustChange = 0;
        } else if (outcomeType === "demand") {
          dialogue = `"Cut salary NOW. I won't bankroll mediocrity."`;
          trustChange = -6;
        } else if (outcomeType === "reject") {
          dialogue = `"No more spending. Make moves to get under the tax by next month."`;
          trustChange = -4;
        }
      }
      
      return {
        type: outcomeType,
        dialogue,
        trustChange,
        allowAction,
        actionType,
        timestamp: Date.now()
      };
    }
    
    function applyInterventionOutcome(outcome) {
      const owner = STATE.owner;
      
      // Apply trust change
      owner.trust = Math.max(0, Math.min(100, owner.trust + outcome.trustChange));
      
      // Add to owner events history
      if (!STATE.ownerEvents) STATE.ownerEvents = [];
      STATE.ownerEvents.push(outcome);
      
      // Post to event feed
      const trustEmoji = outcome.trustChange > 0 ? "üìà" : outcome.trustChange < 0 ? "üìâ" : "‚û°Ô∏è";
      const actionDesc = {
        coachFiring: "Coach Firing",
        coachHiring: "Coach Hiring",
        starTrade: "Star Trade",
        luxuryTax: "Luxury Tax",
        draftPick: "Draft Pick"
      }[outcome.actionType] || "GM Decision";
      
      addEvent(`${trustEmoji} Owner ${outcome.type === "override" ? "OVERRULED" : outcome.type === "reject" ? "VETOED" : outcome.type === "demand" ? "DEMANDS ACTION on" : "weighs in on"} ${actionDesc}. ${outcome.dialogue} (Trust ${outcome.trustChange >= 0 ? "+" : ""}${outcome.trustChange})`, "league");
      
      // Update owner notes
      owner.notes = outcome.dialogue;
      
      // Save state
      save(STATE);
      
      return outcome.allowAction;
    }
    
    function showInterventionModal(outcome, onComplete) {
      const modal = document.createElement("div");
      modal.className = "modal-backdrop";
      modal.style.zIndex = "10000";
      
      const severityColor = outcome.type === "override" ? "var(--bad)" : 
                           outcome.type === "reject" ? "var(--warn)" :
                           outcome.type === "demand" ? "var(--warn)" : "var(--good)";
      
      modal.innerHTML = `
        <div class="modal intervention-modal" style="max-width: 600px; border: 3px solid ${severityColor}; animation: slideIn 0.3s ease;">
          <header style="background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, transparent 100%); border-bottom: 2px solid ${severityColor};">
            <div class="title" style="font-size: 20px;">üëë Owner Intervention</div>
            <div class="spacer"></div>
          </header>
          <div class="content">
            <div class="owner-intervention-content">
              <div class="owner-portrait-large" style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 80px; margin-bottom: 16px; filter: drop-shadow(0 4px 12px rgba(255,215,0,0.4));">üëë</div>
                <div style="font-size: 18px; font-weight: 700; color: var(--text-0); margin-bottom: 4px;">${STATE.owner.name}</div>
                <div style="font-size: 13px; color: var(--text-1);">${STATE.owner.archetype}</div>
              </div>
              
              <div class="intervention-dialogue" style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.3); border-radius: 12px; padding: 24px; margin-bottom: 24px; position: relative;">
                <div style="position: absolute; top: -12px; left: 24px; background: var(--bg-1); padding: 0 12px; font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600;">
                  ${outcome.type === "override" ? "üö´ OVERRULED" : outcome.type === "reject" ? "‚õî VETOED" : outcome.type === "demand" ? "‚ö†Ô∏è DEMANDS" : "‚úÖ APPROVED (RELUCTANTLY)"}
                </div>
                <div style="font-size: 16px; color: var(--text-0); line-height: 1.7; font-style: italic; text-align: center;">
                  ${outcome.dialogue}
                </div>
              </div>
              
              <div class="intervention-impact" style="background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                  <div style="text-align: center;">
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px;">Trust Impact</div>
                    <div style="font-size: 24px; font-weight: 700; color: ${outcome.trustChange >= 0 ? "var(--good)" : "var(--bad)"};">
                      ${outcome.trustChange >= 0 ? "+" : ""}${outcome.trustChange}
                    </div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px;">Action Status</div>
                    <div style="font-size: 14px; font-weight: 700; color: ${outcome.allowAction ? "var(--good)" : "var(--bad)"};">
                      ${outcome.allowAction ? "ALLOWED" : "BLOCKED"}
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="intervention-actions" style="display: flex; gap: 12px; justify-content: center;">
                ${!outcome.allowAction && outcome.type !== "override" ? `
                  <button class="btn" id="interventionAppeal" style="background: var(--warn); color: white;">
                    üé≤ Appeal Decision (Risky)
                  </button>
                ` : ""}
                <button class="btn good" id="interventionAccept">
                  ${outcome.allowAction ? "Proceed" : "Acknowledge"}
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Accept button
      modal.querySelector("#interventionAccept").addEventListener("click", () => {
        applyInterventionOutcome(outcome);
        modal.remove();
        if (onComplete) onComplete(outcome.allowAction);
      });
      
      // Appeal button (if available)
      const appealBtn = modal.querySelector("#interventionAppeal");
      if (appealBtn) {
        appealBtn.addEventListener("click", () => {
          // Risk: 50% success, but costs trust either way
          const appealSuccess = Math.random() < 0.3; // 30% success rate
          const temper = STATE.owner.traits.temper || 50;
          const temperPenalty = Math.floor(temper / 10); // Higher temper = bigger penalty
          
          if (appealSuccess) {
            STATE.owner.trust = Math.max(0, STATE.owner.trust - 3);
            addEvent(`üéØ Appeal successful! Owner grudgingly allows the decision. Trust -3`, "league");
            outcome.allowAction = true;
            outcome.trustChange -= 3;
          } else {
            STATE.owner.trust = Math.max(0, STATE.owner.trust - temperPenalty);
            addEvent(`‚ùå Appeal backfired! Owner furious at being challenged. Trust -${temperPenalty}`, "league");
            outcome.trustChange -= temperPenalty;
          }
          
          applyInterventionOutcome(outcome);
          modal.remove();
          if (onComplete) onComplete(outcome.allowAction);
        });
      }
    }
    
    // -------------------------------
    // Rivalry System
    // -------------------------------
    
    function getRivalryKey(team1, team2) {
      // Always return consistent key (alphabetical order)
      return team1 < team2 ? `${team1}_${team2}` : `${team2}_${team1}`;
    }
    
    function initializeRivalries() {
      if (!STATE.rivalries) STATE.rivalries = {};
      
      // Natural geographic/historical rivalries start at 50 (Warm)
      const naturalRivals = [
        ["LA Lightning", "Golden State Guardians"],
        ["New York Navigators", "Brooklyn Bridges"],
        ["Chicago Cyclones", "Detroit Dynamos"],
        ["Boston Breakers", "Philadelphia Phoenixes"],
        ["Miami Mirage", "Orlando Overdrive"],
        ["Dallas Dynasty", "Houston Heatwave"],
        ["Portland Pioneers", "San Francisco Riptide"]
      ];
      
      naturalRivals.forEach(([team1, team2]) => {
        const key = getRivalryKey(team1, team2);
        if (!STATE.rivalries[key]) {
          STATE.rivalries[key] = {
            heat: 50,
            history: [],
            lastMeeting: 0,
            totalMeetings: 0,
            playoffMeetings: 0
          };
        }
      });
    }
    
    function getRivalryHeat(team1, team2) {
      const key = getRivalryKey(team1, team2);
      return STATE.rivalries[key]?.heat || 0;
    }
    
    function getRivalryLevel(heat) {
      if (heat >= 81) return { label: "Red Hot", color: "#ef4444", icon: "üî•üî•", glow: "0 0 20px #ef4444" };
      if (heat >= 61) return { label: "Hot", color: "#f97316", icon: "üî•", glow: "0 0 15px #f97316" };
      if (heat >= 41) return { label: "Warm", color: "#eab308", icon: "üå°Ô∏è", glow: "none" };
      if (heat >= 21) return { label: "Cold", color: "#60a5fa", icon: "‚ùÑÔ∏è", glow: "none" };
      return { label: "Ice Cold", color: "#3b82f6", icon: "üßä", glow: "none" };
    }
    
    function updateRivalryHeat(team1, team2, delta, reason) {
      const key = getRivalryKey(team1, team2);
      
      if (!STATE.rivalries[key]) {
        STATE.rivalries[key] = {
          heat: 0,
          history: [],
          lastMeeting: 0,
          totalMeetings: 0,
          playoffMeetings: 0
        };
      }
      
      const rivalry = STATE.rivalries[key];
      const oldHeat = rivalry.heat;
      rivalry.heat = Math.max(0, Math.min(100, rivalry.heat + delta));
      
      // Log significant changes
      if (Math.abs(delta) >= 5) {
        rivalry.history.unshift({
          day: STATE.schedule?.currentDay || 0,
          delta: delta,
          reason: reason,
          newHeat: rivalry.heat
        });
        
        // Keep only last 20 events
        if (rivalry.history.length > 20) {
          rivalry.history = rivalry.history.slice(0, 20);
        }
      }
      
      // Generate feed entry for major heat changes
      const oldLevel = getRivalryLevel(oldHeat);
      const newLevel = getRivalryLevel(rivalry.heat);
      
      if (oldLevel.label !== newLevel.label) {
        addEvent(`${team1} vs ${team2} rivalry now ${newLevel.icon} ${newLevel.label}! ${reason}`, "league");
      }
      
      return rivalry.heat;
    }
    
    function decayRivalryHeat() {
      // Called periodically (e.g., every 30 days) to reduce heat for inactive rivalries
      const currentDay = STATE.schedule?.currentDay || 0;
      
      Object.keys(STATE.rivalries).forEach(key => {
        const rivalry = STATE.rivalries[key];
        const daysSinceLastMeeting = currentDay - rivalry.lastMeeting;
        
        // Decay 1 point every 10 days of inactivity (after 30 day grace period)
        if (daysSinceLastMeeting > 30) {
          const decay = Math.floor((daysSinceLastMeeting - 30) / 10);
          if (decay > 0) {
            rivalry.heat = Math.max(0, rivalry.heat - Math.min(decay, 3)); // Max 3 per decay check
          }
        }
      });
    }
    
    function processRivalryGameEvents(game, won, scoreDiff) {
      const myTeam = STATE.meta.teamName;
      const isHome = game.homeTeam === myTeam;
      const opponent = isHome ? game.awayTeam : game.homeTeam;
      
      const key = getRivalryKey(myTeam, opponent);
      if (!STATE.rivalries[key]) {
        STATE.rivalries[key] = {
          heat: 20, // Start new rivalries at Cold
          history: [],
          lastMeeting: 0,
          totalMeetings: 0,
          playoffMeetings: 0
        };
      }
      
      const rivalry = STATE.rivalries[key];
      rivalry.lastMeeting = game.day;
      rivalry.totalMeetings++;
      
      let heatDelta = 0;
      let reasons = [];
      
      // Base heat from any meeting
      heatDelta += 2;
      reasons.push("game played");
      
      // Close game (within 5 points)
      if (scoreDiff <= 5) {
        heatDelta += 8;
        reasons.push("nail-biter finish");
      }
      
      // Blowout (20+ points) - slight decrease
      if (scoreDiff >= 20) {
        heatDelta -= 3;
        reasons.push("one-sided affair");
      }
      
      // Overtime adds heat
      if (game.overtime) {
        heatDelta += 10;
        reasons.push("overtime thriller");
      }
      
      // TV game adds exposure
      if (game.tvGame) {
        heatDelta += 5;
        reasons.push("national TV spotlight");
      }
      
      // Back-to-back revenge factor
      const myLastGame = STATE.schedule.games
        .filter(g => g.day < game.day && g.status === 'final' && 
                (g.homeTeam === myTeam || g.awayTeam === myTeam) &&
                (g.homeTeam === opponent || g.awayTeam === opponent))
        .sort((a, b) => b.day - a.day)[0];
      
      if (myLastGame && (game.day - myLastGame.day) <= 15) {
        // Recent meeting - check if this is revenge
        const lastGameWon = (myLastGame.homeTeam === myTeam && myLastGame.score.home > myLastGame.score.away) ||
                           (myLastGame.awayTeam === myTeam && myLastGame.score.away > myLastGame.score.home);
        
        if (lastGameWon !== won) {
          heatDelta += 7;
          reasons.push("revenge game");
        }
      }
      
      // Win streak against rival
      const recentGames = STATE.schedule.games
        .filter(g => g.day <= game.day && g.status === 'final' && 
                (g.homeTeam === myTeam || g.awayTeam === myTeam) &&
                (g.homeTeam === opponent || g.awayTeam === opponent))
        .sort((a, b) => b.day - a.day)
        .slice(0, 3);
      
      const myWins = recentGames.filter(g => 
        (g.homeTeam === myTeam && g.score.home > g.score.away) ||
        (g.awayTeam === myTeam && g.score.away > g.score.home)
      ).length;
      
      if (myWins === 3 || myWins === 0) {
        heatDelta += 6;
        reasons.push(myWins === 3 ? "dominating the series" : "struggling in matchup");
      }
      
      // Already a hot rivalry? Amplify changes
      if (rivalry.heat >= 70) {
        heatDelta = Math.floor(heatDelta * 1.3);
      }
      
      updateRivalryHeat(myTeam, opponent, heatDelta, reasons.join(", "));
    }
    
    // -------------------------------
    // Schedule System - Day-Based (170-day season)
    // -------------------------------
    
    function generateDayBasedSchedule(myTeamId) {
      const teams = LEAGUE_TEAMS;
      const totalTeams = teams.length; // 30 teams
      const totalDays = 170;
      const gamesPerTeam = 82;
      const allStarBreakStart = 61;
      const allStarBreakEnd = 66;
      
      // Rivalry pairs
      const rivalries = {
        "LA Lightning": ["Golden State Guardians"],
        "Golden State Guardians": ["LA Lightning"],
        "New York Navigators": ["Brooklyn Bridges"],
        "Brooklyn Bridges": ["New York Navigators"],
        "Chicago Cyclones": ["Detroit Dynamos"],
        "Detroit Dynamos": ["Chicago Cyclones"],
        "Boston Breakers": ["Philadelphia Phoenixes"],
        "Philadelphia Phoenixes": ["Boston Breakers"],
        "Miami Mirage": ["Orlando Overdrive"],
        "Orlando Overdrive": ["Miami Mirage"],
        "Dallas Dynasty": ["Houston Heatwave"],
        "Houston Heatwave": ["Dallas Dynasty"],
        "Portland Pioneers": ["San Francisco Riptide"],
        "San Francisco Riptide": ["Portland Pioneers"]
      };
      
      // Initialize team schedules
      const teamSchedules = {};
      teams.forEach(team => {
        teamSchedules[team] = {
          games: [],
          homeGames: 0,
          awayGames: 0,
          b2bCount: 0,
          lastGameDay: 0,
          currentRoadTrip: 0,
          currentHomeStand: 0
        };
      });
      
      const allGames = [];
      let gameId = 0;
      
      // Phase 1: Generate matchups (who plays who, how many times)
      const matchups = [];
      teams.forEach((team, idx) => {
        const opponents = teams.filter(t => t !== team);
        
        // Play each opponent 2-3 times (total 82 games)
        // Same conference: 3-4 games, Different conference: 2 games
        opponents.forEach(opp => {
          const isRival = rivalries[team]?.includes(opp);
          const gamesVsOpp = isRival ? 4 : (Math.random() < 0.5 ? 3 : 2);
          
          for (let i = 0; i < gamesVsOpp; i++) {
            if (teamSchedules[team].games.length < gamesPerTeam) {
              matchups.push({
                team1: team,
                team2: opp,
                isRival: isRival
              });
            }
          }
        });
      });
      
      // Phase 2: Distribute games across 170 days (skip days 1-10 and 61-66)
      const availableDays = [];
      for (let d = 11; d <= totalDays; d++) {
        if (d < allStarBreakStart || d > allStarBreakEnd) {
          availableDays.push(d);
        }
      }
      
      // Shuffle matchups for variety
      for (let i = matchups.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [matchups[i], matchups[j]] = [matchups[j], matchups[i]];
      }
      
      // Phase 3: Schedule games day by day
      let currentDay = 11;
      let matchupIndex = 0;
      const scheduledPairs = new Set();
      
      while (matchupIndex < matchups.length && currentDay <= totalDays) {
        // Skip All-Star break
        if (currentDay >= allStarBreakStart && currentDay <= allStarBreakEnd) {
          currentDay++;
          continue;
        }
        
        const gamesThisDay = [];
        const teamsPlayingToday = new Set();
        
        // Try to schedule 12-15 games per day (24-30 teams playing)
        const targetGamesPerDay = 12 + Math.floor(Math.random() * 4);
        
        for (let attempt = 0; attempt < matchups.length && gamesThisDay.length < targetGamesPerDay; attempt++) {
          const matchup = matchups[matchupIndex % matchups.length];
          const { team1, team2, isRival } = matchup;
          
          // Check if both teams are available today
          if (!teamsPlayingToday.has(team1) && !teamsPlayingToday.has(team2)) {
            const t1Sched = teamSchedules[team1];
            const t2Sched = teamSchedules[team2];
            
            // Check if teams haven't exceeded game limits
            if (t1Sched.games.length < gamesPerTeam && t2Sched.games.length < gamesPerTeam) {
              // Decide home/away
              let homeTeam, awayTeam;
              if (t1Sched.homeGames < 41 && t2Sched.awayGames < 41) {
                homeTeam = team1;
                awayTeam = team2;
              } else if (t1Sched.awayGames < 41 && t2Sched.homeGames < 41) {
                homeTeam = team2;
                awayTeam = team1;
              } else {
                // Balance needed
                if (t1Sched.homeGames < t1Sched.awayGames) {
                  homeTeam = team1;
                  awayTeam = team2;
                } else {
                  homeTeam = team2;
                  awayTeam = team1;
                }
              }
              
              // Check for back-to-backs
              const b2bHome = (currentDay - t1Sched.lastGameDay === 1);
              const b2bAway = (currentDay - t2Sched.lastGameDay === 1);
              const homeSched = teamSchedules[homeTeam];
              const awaySched = teamSchedules[awayTeam];
              
              // Limit B2Bs to 15 per team
              if ((b2bHome && homeSched.b2bCount >= 15) || (b2bAway && awaySched.b2bCount >= 15)) {
                matchupIndex++;
                continue;
              }
              
              // Determine if TV game (rivals, top matchups, random 25%)
              const isTVGame = isRival || Math.random() < 0.25;
              
              // Determine fatigue
              let fatigue = "none";
              if (b2bHome || b2bAway) fatigue = "medium";
              if (b2bHome && b2bAway) fatigue = "high";
              
              const game = {
                id: `game_${gameId++}`,
                day: currentDay,
                homeTeam: homeTeam,
                awayTeam: awayTeam,
                b2bHome: b2bHome,
                b2bAway: b2bAway,
                tvGame: isTVGame,
                rivalry: isRival,
                status: "upcoming",
                score: null,
                fatigue: fatigue,
                attendance: 0
              };
              
              allGames.push(game);
              gamesThisDay.push(game);
              teamsPlayingToday.add(homeTeam);
              teamsPlayingToday.add(awayTeam);
              
              // Update team schedules
              homeSched.games.push(game.id);
              homeSched.homeGames++;
              homeSched.lastGameDay = currentDay;
              if (b2bHome) homeSched.b2bCount++;
              
              awaySched.games.push(game.id);
              awaySched.awayGames++;
              awaySched.lastGameDay = currentDay;
              if (b2bAway) awaySched.b2bCount++;
              
              matchupIndex++;
            } else {
              matchupIndex++;
            }
          } else {
            matchupIndex++;
          }
        }
        
        currentDay++;
      }
      
      // Sort games by day
      allGames.sort((a, b) => a.day - b.day);
      
      console.log(`Generated ${allGames.length} games across ${totalDays} days`);
      return allGames;
    }
    
    function calculateWinProbability(teamElo, oppElo, isHome) {
      const HCA = isHome ? 100 : -100; // Home court advantage
      const eloDiff = oppElo - teamElo + HCA;
      return 1 / (1 + Math.pow(10, eloDiff / 400));
    }
    
    function initializeLeagueElos() {
      const elos = {};
      LEAGUE_TEAMS.forEach(team => {
        // Random Elo between 1300-1700 (1500 average)
        elos[team] = 1400 + Math.floor(Math.random() * 200);
      });
      return elos;
    }
    
    // -------------------------------
    // Draft System
    // -------------------------------
    
    function generateDraftProspects(year = 2026, count = 60) {
      const firstNames = ["Zion","Luka","Trae","Ja","RJ","Coby","Tyler","Cameron","Keldon","Brandon","Jaxson","PJ","Nickeil","Kevin","Matisse","Grant","Bol","Goga","Carsen","Admiral"];
      const lastNames = ["Williams","Robinson","Barrett","Morant","Hunter","White","Herro","Johnson","Reddish","Clarke","Hayes","Washington","Alexander-Walker","Porter","Thybulle","Williams","Bol","Bitadze","Edwards","Schofield"];
      
      const archetypes = {
        PG: ["Floor General", "Scoring Guard", "Playmaker", "Combo Guard", "Point God"],
        SG: ["3&D Wing", "Shot Creator", "Scorer", "Athletic Slasher", "Sharpshooter"],
        SF: ["Two-Way Wing", "Point Forward", "3PT Specialist", "Versatile Wing", "Lockdown Defender"],
        PF: ["Stretch Four", "Modern Big", "Rim Runner", "Face-Up Big", "Energy Big"],
        C: ["Paint Beast", "Stretch Five", "Defensive Anchor", "Traditional Center", "Mobile Big"]
      };
      
      const prospects = [];
      const positions = ["PG","SG","SF","PF","C"];
      
      for (let i = 0; i < count; i++) {
        const pos = positions[Math.floor(Math.random() * positions.length)];
        const age = 19 + Math.floor(Math.random() * 3); // 19-21
        const archetype = archetypes[pos][Math.floor(Math.random() * archetypes[pos].length)];
        
        // Generate ceiling and floor (determines potential)
        const baseCeiling = 55 + Math.floor(Math.random() * 40); // 55-94
        const floor = Math.max(40, baseCeiling - 15 - Math.floor(Math.random() * 20)); // Floor 15-35 below ceiling
        const projectedOvr = Math.floor((baseCeiling + floor) / 2); // Average
        
        // Risk factors
        const injuryRisk = Math.floor(Math.random() * 100); // 0-100
        const characterRisk = Math.floor(Math.random() * 100);
        const bustProbability = Math.min(80, injuryRisk * 0.3 + characterRisk * 0.2 + (100 - baseCeiling) * 0.5);
        const starProbability = Math.max(5, baseCeiling - 70 + Math.floor(Math.random() * 20));
        
        // Measurables
        const heightInches = pos === "PG" ? 72 + Math.floor(Math.random() * 6) :
                            pos === "SG" ? 75 + Math.floor(Math.random() * 6) :
                            pos === "SF" ? 78 + Math.floor(Math.random() * 6) :
                            pos === "PF" ? 80 + Math.floor(Math.random() * 6) :
                            82 + Math.floor(Math.random() * 8);
        const height = `${Math.floor(heightInches / 12)}'${heightInches % 12}"`;
        const weight = pos === "C" ? 230 + Math.floor(Math.random() * 40) :
                      pos === "PF" ? 210 + Math.floor(Math.random() * 35) :
                      190 + Math.floor(Math.random() * 30);
        const wingspan = heightInches + Math.floor(Math.random() * 8) - 2;
        const wingspanFmt = `${Math.floor(wingspan / 12)}'${wingspan % 12}"`;
        
        // Skills (letter grades, initially hidden)
        const skillBase = Math.floor(projectedOvr / 10); // 4-9 range
        const skills = {
          shooting: ["F","D","D+","C-","C","C+","B-","B","B+","A-","A"][Math.min(10, Math.max(0, skillBase + Math.floor(Math.random() * 3) - 1))],
          finishing: ["F","D","D+","C-","C","C+","B-","B","B+","A-","A"][Math.min(10, Math.max(0, skillBase + Math.floor(Math.random() * 3) - 1))],
          passing: ["F","D","D+","C-","C","C+","B-","B","B+","A-","A"][Math.min(10, Math.max(0, skillBase + Math.floor(Math.random() * 3) - 1))],
          defense: ["F","D","D+","C-","C","C+","B-","B","B+","A-","A"][Math.min(10, Math.max(0, skillBase + Math.floor(Math.random() * 3) - 1))],
          athleticism: ["F","D","D+","C-","C","C+","B-","B","B+","A-","A"][Math.min(10, Math.max(0, skillBase + Math.floor(Math.random() * 3) - 1))],
          bbiq: ["F","D","D+","C-","C","C+","B-","B","B+","A-","A"][Math.min(10, Math.max(0, skillBase + Math.floor(Math.random() * 3) - 1))]
        };
        
        // Scouting confidence (0-100, starts low)
        const baseConfidence = i < 15 ? 40 + Math.floor(Math.random() * 20) : // Top 15 get more initial scouting
                              i < 30 ? 20 + Math.floor(Math.random() * 20) :
                              10 + Math.floor(Math.random() * 15);
        
        // Hidden traits (revealed through scouting)
        const hiddenTraits = [];
        if (Math.random() < 0.15) hiddenTraits.push("Injury History");
        if (Math.random() < 0.10) hiddenTraits.push("Character Concerns");
        if (Math.random() < 0.20) hiddenTraits.push("High Motor");
        if (Math.random() < 0.15) hiddenTraits.push("Elite Work Ethic");
        if (Math.random() < 0.12) hiddenTraits.push("Low Basketball IQ");
        if (Math.random() < 0.18) hiddenTraits.push("Team Leader");
        
        // Generate full mental attributes (affects personality)
        const mental = {
          focus: 50 + Math.floor(Math.random() * 50),
          workEthic: 50 + Math.floor(Math.random() * 50),
          composure: 50 + Math.floor(Math.random() * 50),
          leadership: 50 + Math.floor(Math.random() * 50)
        };
        
        // Generate personality traits
        const personality = generatePersonalityTraits(projectedOvr, age, mental);
        
        // Generate bio data
        const draftInfo = {
          year: year - 1,
          round: i < 30 ? 1 : 2,
          pick: i < 30 ? i + 1 : i - 29,
          team: "Undrafted"
        };
        
        const shoots = Math.random() > 0.12 ? "Right" : "Left";
        const birthDate = `${Math.floor(Math.random() * 12) + 1}/${Math.floor(Math.random() * 28) + 1}/${year - age}`;
        
        const bio = {
          fullName: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
          nickname: "",
          shoots,
          birthDate,
          birthplace: generateBirthplace(),
          college: generateCollege(),
          draftTeam: "Undrafted",
          draftYear: year,
          draftRound: 0,
          draftPick: 0,
          yearsInLeague: 0,
          careerStats: {
            gamesPlayed: 0,
            ppg: 0,
            rpg: 0,
            apg: 0,
            fg: 0,
            ft: 0,
            three: 0
          },
          bioText: generateBioText(
            `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
            archetype,
            mental,
            projectedOvr
          )
        };
        
        prospects.push({
          id: `prospect_${i}_${Date.now()}`,
          name: bio.fullName,
          pos,
          age,
          archetype,
          height,
          weight,
          wingspan: wingspanFmt,
          ceiling: baseCeiling,
          floor,
          projectedOvr,
          skills,
          mental,
          personality,
          bio,
          injuryRisk,
          characterRisk,
          bustProbability: Math.round(bustProbability),
          starProbability: Math.round(starProbability),
          scoutingConfidence: baseConfidence,
          scoutingReports: {
            combine: false,
            workout: false,
            interview: false,
            film: false
          },
          hiddenTraits,
          revealedTraits: [],
          tier: i < 5 ? "Elite" : i < 15 ? "High" : i < 30 ? "Mid" : i < 45 ? "Late" : "Flyer",
          userFlags: [], // ‚≠ê favorite, üö´ avoid
          userNotes: "",
          draftPosition: null, // Gets filled when drafted
          userRank: i + 1 // Initial big board position
        });
      }
      
      return prospects;
    }
    
    function calculateDraftPickValue(pickNumber) {
      // Simplified pick value chart (similar to NBA trade value)
      if (pickNumber === 1) return 3000;
      if (pickNumber <= 3) return 2200 - (pickNumber - 1) * 400;
      if (pickNumber <= 5) return 1600 - (pickNumber - 3) * 200;
      if (pickNumber <= 10) return 1200 - (pickNumber - 5) * 100;
      if (pickNumber <= 20) return 700 - (pickNumber - 10) * 40;
      if (pickNumber <= 30) return 300 - (pickNumber - 20) * 15;
      return Math.max(10, 150 - (pickNumber - 30) * 4);
    }
    
    function scoutProspect(prospect, scoutType) {
      if (prospect.scoutingReports[scoutType]) {
        return { success: false, message: "Already scouted this way" };
      }
      
      prospect.scoutingReports[scoutType] = true;
      
      const confidenceGain = {
        combine: 15,
        workout: 20,
        interview: 12,
        film: 18
      }[scoutType] || 10;
      
      prospect.scoutingConfidence = Math.min(100, prospect.scoutingConfidence + confidenceGain);
      
      // Reveal hidden traits
      if (scoutType === "interview" && prospect.hiddenTraits.includes("Character Concerns")) prospect.revealedTraits.push("Character Concerns");
      if (scoutType === "interview" && prospect.hiddenTraits.includes("Team Leader")) prospect.revealedTraits.push("Team Leader");
      if (scoutType === "combine" && prospect.hiddenTraits.includes("Injury History")) prospect.revealedTraits.push("Injury History");
      if (scoutType === "film" && prospect.hiddenTraits.includes("Low Basketball IQ")) prospect.revealedTraits.push("Low Basketball IQ");
      if (scoutType === "workout" && prospect.hiddenTraits.includes("Elite Work Ethic")) prospect.revealedTraits.push("Elite Work Ethic");
      if (scoutType === "workout" && prospect.hiddenTraits.includes("High Motor")) prospect.revealedTraits.push("High Motor");
      
      return {
        success: true,
        confidenceGain,
        traitsRevealed: prospect.revealedTraits.length,
        newConfidence: prospect.scoutingConfidence
      };
    }
    
    function draftPlayer(prospect, contractType = "rookie") {
      const draftedPlayer = {
        id: uid(),
        name: prospect.name,
        pos: prospect.pos,
        age: prospect.age,
        ovr: prospect.projectedOvr,
        pot: prospect.ceiling,
        skills: {
          shooting: {F:40,D:50,"D+":55,"C-":60,C:65,"C+":70,"B-":75,B:80,"B+":85,"A-":90,A:95}[prospect.skills.shooting] || 65,
          finishing: {F:40,D:50,"D+":55,"C-":60,C:65,"C+":70,"B-":75,B:80,"B+":85,"A-":90,A:95}[prospect.skills.finishing] || 65,
          passing: {F:40,D:50,"D+":55,"C-":60,C:65,"C+":70,"B-":75,B:80,"B+":85,"A-":90,A:95}[prospect.skills.passing] || 65,
          defense: {F:40,D:50,"D+":55,"C-":60,C:65,"C+":70,"B-":75,B:80,"B+":85,"A-":90,A:95}[prospect.skills.defense] || 65,
          athleticism: {F:40,D:50,"D+":55,"C-":60,C:65,"C+":70,"B-":75,B:80,"B+":85,"A-":90,A:95}[prospect.skills.athleticism] || 65,
          rebounding: {F:40,D:50,"D+":55,"C-":60,C:65,"C+":70,"B-":75,B:80,"B+":85,"A-":90,A:95}[prospect.skills.defense] || 65,
          stamina: 75
        },
        years: contractType === "two-way" ? 1 : 4,
        salary: contractType === "two-way" ? 500_000 : (prospect.userRank === 1 ? 10_000_000 : Math.max(1_000_000, 8_000_000 - (prospect.userRank * 200_000))),
        notes: `${prospect.archetype} | ${prospect.tier} Tier | Drafted ${STATE.meta.season}`,
        personality: generatePersonalityTraits(),
        morale: 75
      };
      
      if (contractType === "stash") {
        draftedPlayer.contract = "Stashed Overseas";
        draftedPlayer.salary = 0;
        draftedPlayer.notes += " | Stashed";
      }
      
      return draftedPlayer;
    }
    
    // -------------------------------
    // Finance System
    // -------------------------------
    
    function getMarketSize(teamName) {
      const largeMarkets = ["Los Angeles", "LA", "New York", "Brooklyn", "Chicago", "Golden State", "Miami", "Boston"];
      const smallMarkets = ["Memphis", "New Orleans", "Indiana", "Milwaukee", "Utah", "Oklahoma", "Sacramento"];
      
      for (const city of largeMarkets) {
        if (teamName.includes(city)) return "large";
      }
      for (const city of smallMarkets) {
        if (teamName.includes(city)) return "small";
      }
      return "medium";
    }
    
    function getMarketModifier(marketSize) {
      if (marketSize === "large") return 1.4;
      if (marketSize === "small") return 0.75;
      return 1.0;
    }
    
    function calculateRevenue(teamState, finance) {
      const d = teamState.dashboard;
      const marketSize = getMarketSize(teamState.meta.teamName);
      const marketMod = getMarketModifier(marketSize);
      
      // Fan hype multiplier (0.8 to 1.3 based on 0-100 hype)
      const fanHype = teamState.fans?.hype || 50;
      const hypeMultiplier = calculateFanHypeMultiplier(fanHype);
      
      // Base ticket revenue (scales with wins and attendance)
      const winPct = d.wins / (d.wins + d.losses || 1);
      const baseTicketRevenue = 80_000_000; // $80M baseline
      const ticketPriceMultiplier = finance.settings?.ticketPrice || 1.0;
      const attendanceBoost = Math.max(0.5, Math.min(1.5, 0.5 + (winPct * 1.5))); // 50%-150% based on wins
      
      const ticketRevenue = baseTicketRevenue * ticketPriceMultiplier * attendanceBoost * marketMod * hypeMultiplier;
      
      // Merchandise (scales with wins and market)
      const baseMerch = 25_000_000; // $25M baseline
      const merchBoost = Math.max(0.6, Math.min(2.0, 0.6 + (winPct * 2) + ((d.wins >= 50) ? 0.4 : 0)));
      const facilityBonus = (finance.settings?.facilityLvl || 0) * 0.1; // 10% per level
      
      const merchRevenue = baseMerch * merchBoost * marketMod * (1 + facilityBonus) * hypeMultiplier;
      
      // Playoffs (bonus revenue)
      let playoffRevenue = 0;
      if (d.wins >= 50) playoffRevenue = 15_000_000; // Made playoffs
      if (d.wins >= 55) playoffRevenue = 25_000_000; // Strong seed
      if (d.wins >= 60) playoffRevenue = 40_000_000; // Championship contender
      
      // Promo spend impact (negative expense but boosts other revenue)
      const promoSpend = finance.settings?.promoSpend || 0;
      const promoBoost = promoSpend * 0.02; // 2% boost per million spent
      
      const totalRevenue = (ticketRevenue + merchRevenue + playoffRevenue) * (1 + promoBoost);
      
      return {
        tickets: Math.round(ticketRevenue),
        merch: Math.round(merchRevenue),
        playoffs: playoffRevenue,
        promoBoost,
        total: Math.round(totalRevenue)
      };
    }
    
    function calculateExpenses(teamState, finance) {
      // Player payroll
      const playerPayroll = sum(teamState.roster, p => p.salary);
      
      // Coaching staff
      let coachingStaff = 0;
      if (teamState.coaches?.head) {
        coachingStaff += teamState.coaches.head.contract.salary;
      }
      if (teamState.coaches?.assistants) {
        teamState.coaches.assistants.forEach(c => {
          coachingStaff += c.contract.salary;
        });
      }
      
      // Facilities & operations
      const baseFacilities = 15_000_000; // $15M baseline
      const facilityUpgrades = (finance.settings?.facilityLvl || 0) * 3_000_000; // $3M per level
      const facilitiesTotal = baseFacilities + facilityUpgrades;
      
      // Promo spend
      const promoSpend = (finance.settings?.promoSpend || 0) * 1_000_000;
      
      // Luxury tax
      let luxuryTax = 0;
      const taxLine = teamState.meta.rules.tax;
      if (playerPayroll > taxLine) {
        const overTax = playerPayroll - taxLine;
        // Progressive tax: $1.50 per $1 over for first $5M, $1.75 for next $5M, etc.
        if (overTax <= 5_000_000) {
          luxuryTax = overTax * 1.5;
        } else if (overTax <= 10_000_000) {
          luxuryTax = (5_000_000 * 1.5) + ((overTax - 5_000_000) * 1.75);
        } else if (overTax <= 15_000_000) {
          luxuryTax = (5_000_000 * 1.5) + (5_000_000 * 1.75) + ((overTax - 10_000_000) * 2.5);
        } else {
          luxuryTax = (5_000_000 * 1.5) + (5_000_000 * 1.75) + (5_000_000 * 2.5) + ((overTax - 15_000_000) * 3.25);
        }
      }
      
      const totalExpenses = playerPayroll + coachingStaff + facilitiesTotal + promoSpend + luxuryTax;
      
      return {
        players: playerPayroll,
        staff: coachingStaff,
        facilities: facilitiesTotal,
        promo: promoSpend,
        tax: Math.round(luxuryTax),
        total: Math.round(totalExpenses)
      };
    }
    
    function calculateProfit(revenue, expenses) {
      return revenue.total - expenses.total;
    }
    
    function getCapStatus(payroll, rules) {
      const { cap, tax, apron1, apron2 } = rules;
      
      if (payroll >= apron2) return { status: "apron2", text: "Second Apron", color: "var(--bad)", severity: 4 };
      if (payroll >= apron1) return { status: "apron1", text: "First Apron", color: "var(--bad)", severity: 3 };
      if (payroll >= tax) return { status: "luxuryTax", text: "Luxury Tax", color: "var(--warn)", severity: 2 };
      if (payroll >= cap) return { status: "overCap", text: "Over Cap", color: "var(--warn)", severity: 1 };
      return { status: "underCap", text: "Under Cap", color: "var(--good)", severity: 0 };
    }
    
    function calculateMultiYearOutlook(teamState) {
      const currentYear = teamState.meta.season;
      const projections = [];
      
      for (let yearOffset = 1; yearOffset <= 4; yearOffset++) {
        const year = currentYear + yearOffset;
        let guaranteed = 0;
        let teamOptions = 0;
        let playerOptions = 0;
        
        teamState.roster.forEach(p => {
          const yearsLeft = p.years - yearOffset;
          if (yearsLeft > 0) {
            guaranteed += p.salary; // Simplified: assume flat salary
          } else if (yearsLeft === 0) {
            // Last year could be option or expiring
            teamOptions += p.salary * 0.3; // Estimate 30% have team options
          }
        });
        
        projections.push({
          year,
          guaranteed: Math.round(guaranteed),
          options: Math.round(teamOptions),
          dead: 0, // Future: track dead money
          total: Math.round(guaranteed + teamOptions)
        });
      }
      
      return projections;
    }
    
    function calculateOwnerBudgetTarget(owner, rules) {
      // Owner sets budget based on archetype
      if (owner.archetype === "Business Mogul") {
        return rules.cap; // Stay under cap
      } else if (owner.archetype === "Legacy Builder" || owner.archetype === "Billionaire Fan") {
        return rules.apron2; // Willing to pay up to second apron
      } else if (owner.traits.greed >= 70) {
        return rules.tax; // Stay under tax
      } else if (owner.traits.ambition >= 80) {
        return rules.apron1; // Willing to hit first apron
      } else {
        return rules.tax; // Default: avoid tax
      }
    }
    
    function applyFinancialTrustModifiers(teamState) {
      if (!teamState.owner || !teamState.finance) return;
      
      const owner = teamState.owner;
      const expenses = teamState.finance.expenses;
      const revenue = teamState.finance.revenue;
      const profit = calculateProfit(revenue, expenses);
      const d = teamState.dashboard;
      const winPct = d.wins / (d.wins + d.losses || 1);
      
      const budgetTarget = calculateOwnerBudgetTarget(owner, teamState.meta.rules);
      const taxLine = teamState.meta.rules.tax;
      
      let trustDelta = 0;
      const events = [];
      
      // Over tax penalties
      if (expenses.players > taxLine) {
        if (winPct < 0.550) {
          // Losing and paying tax = bad
          trustDelta -= 8;
          events.push(`Owner furious about luxury tax payments while team struggles. Trust -8`);
        } else if (winPct >= 0.600) {
          // Winning justifies tax
          if (owner.archetype === "Legacy Builder" || owner.archetype === "Billionaire Fan") {
            trustDelta -= 2;
            events.push(`Owner accepts luxury tax for winning team. Trust -2`);
          } else if (owner.archetype === "Business Mogul") {
            trustDelta -= 6;
            events.push(`Business-minded owner unhappy with tax bill despite wins. Trust -6`);
          } else {
            trustDelta -= 4;
            events.push(`Owner reluctantly pays luxury tax. Trust -4`);
          }
        } else {
          // Mediocre and paying tax
          trustDelta -= 5;
          events.push(`Owner questions luxury tax spending for mediocre results. Trust -5`);
        }
      }
      
      // Profit bonuses
      if (profit > 0 && expenses.players < budgetTarget) {
        trustDelta += 4;
        events.push(`Owner pleased with profitable season and fiscal responsibility. Trust +4`);
      } else if (profit < -20_000_000) {
        trustDelta -= 3;
        events.push(`Owner concerned about significant financial losses. Trust -3`);
      }
      
      // Apron violations
      if (expenses.players >= teamState.meta.rules.apron2) {
        trustDelta -= 3;
        events.push(`‚ö† Second apron violation limits roster flexibility. Owner concerned. Trust -3`);
      }
      
      // Apply trust changes
      if (trustDelta !== 0) {
        owner.trust = Math.max(0, Math.min(100, owner.trust + trustDelta));
        events.forEach(event => addEvent(event, "league"));
      }
      
      // Owner intervention on severe luxury tax overspending (random chance when losing badly)
      if (expenses.tax > 10_000_000 && winPct < 0.400 && Math.random() < 0.15) {
        const interventionCheck = checkOwnerIntervention("luxuryTax", {
          taxAmount: expenses.tax,
          winPct: winPct,
          payroll: expenses.players
        });
        
        if (interventionCheck.intervene && interventionCheck.outcome.type === "demand") {
          // Auto-apply demand outcome without modal (background intervention)
          owner.trust = Math.max(0, Math.min(100, owner.trust + interventionCheck.outcome.trustChange));
          addEvent(`üí∞ ${owner.name} DEMANDS salary reduction! ${interventionCheck.outcome.dialogue} Trust ${interventionCheck.outcome.trustChange}`, "league");
          
          if (!teamState.ownerEvents) teamState.ownerEvents = [];
          teamState.ownerEvents.push(interventionCheck.outcome);
        }
      }
      
      return trustDelta;
    }
    
    function generateRoster() {
      const first = ["Darius","Marcus","Jalen","Devin","Kobe","Zion","Trey","Lamont","Elijah",
"Kendrick","Andre","Isaiah","Tyrese","Jordan","Jayden","Brice","Dominic",
"Caleb","Roman","Silas","Malik","Kamari","Jett","Cameron","Bryson",
"Colby","Miles","Carson","Evan","Logan","Jamal","Corey","Travis",
"Derrick","Shawn","Trevor","Hayden","Parker","Chase","Owen","Blake",
"Hunter","Shane","Noah","Caden","Tanner","Grant","Wesley","Nate"]

      const last = ["Lawson","Coleman","Harper","Wells","Patterson","Knight","Holloway",
"Reyes","Carter","Morrison","Harris","Shaw","Mitchell","Burns","Sullivan",
"Porter","Henderson","Bryant","Howard","Stevens","Wade","Douglas","Green",
"Duncan","Palmer","Saunders","Matthews","Foster","Webb","Armstrong",
"Griffin","Banks","Hayes","Miller","Cooper","Reed","Walker","Price",
"Bailey","Dean","Rice","Hughes","Wallace","Payne","Cross","Garrett",
"Long","Hardy","Rivers","Stephens"]

      const archetypes = {
        PG: ["Floor General", "Scoring Guard", "Defensive Pest", "Combo Guard", "Pure Point"],
        SG: ["3&D Wing", "Shot Creator", "Slasher", "Defensive Stopper", "Volume Scorer"],
        SF: ["Two-Way Wing", "Point Forward", "3PT Specialist", "Athletic Finisher", "Versatile Defender"],
        PF: ["Stretch Four", "Power Forward", "Rim Protector", "Face-Up Big", "Enforcer"],
        C: ["Paint Beast", "Stretch Five", "Defensive Anchor", "Pick & Roll Big", "Traditional Center"]
      };
      
      const positions = ["PG","SG","SF","PF","C"];
      const roster = [];
      
      // Generate 15 players
      for (let i = 0; i < 15; i++) {
        const pos = positions[i % 5]; // Ensure balanced positions
        const age = 19 + Math.floor(Math.random() * 15); // 19-33
        
        // Generate base skills
        const baseSkill = 50 + Math.floor(Math.random() * 40); // 50-90 base
        const variance = 15;
        
        const skills = {
          inside: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          mid: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          three: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          ft: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          playmaking: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          ballHandling: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          offensiveIQ: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          defensiveIQ: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          perimeterD: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          postD: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          rebounding: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          athleticism: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
          strength: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance)))
        };
        
        // Position-based adjustments
        if (pos === "PG") {
          skills.playmaking += 10;
          skills.ballHandling += 10;
          skills.three += 5;
          skills.strength -= 10;
        } else if (pos === "SG") {
          skills.three += 10;
          skills.mid += 5;
          skills.perimeterD += 5;
        } else if (pos === "SF") {
          skills.athleticism += 5;
          skills.perimeterD += 5;
        } else if (pos === "PF") {
          skills.rebounding += 10;
          skills.strength += 10;
          skills.postD += 5;
          skills.ballHandling -= 10;
        } else { // C
          skills.inside += 15;
          skills.rebounding += 15;
          skills.strength += 15;
          skills.postD += 10;
          skills.ballHandling -= 15;
          skills.three -= 10;
        }
        
        // Clamp after adjustments
        Object.keys(skills).forEach(key => {
          skills[key] = Math.round(Math.max(25, Math.min(99, skills[key])));
        });
        
        // Calculate OVR from skills
        const ovr = calculateOVR(skills, pos);
        
        // Potential (higher for younger players)
        const potVariance = age < 23 ? 15 : age < 27 ? 8 : 3;
        const pot = Math.min(99, ovr + Math.floor(Math.random() * potVariance));
        
        // Mental attributes
        const mental = {
          leadership: 40 + Math.floor(Math.random() * 55),
          workEthic: 45 + Math.floor(Math.random() * 50),
          composure: 40 + Math.floor(Math.random() * 55),
          discipline: 40 + Math.floor(Math.random() * 55),
          coachability: 45 + Math.floor(Math.random() * 50)
        };
        
        // Hidden attributes
        const hidden = {
          greed: 30 + Math.floor(Math.random() * 60),
          loyalty: 35 + Math.floor(Math.random() * 60),
          marketPreference: ["Small", "Mid", "Large"][Math.floor(Math.random() * 3)],
          clutch: 40 + Math.floor(Math.random() * 50),
          popularity: ovr > 85 ? 70 + Math.floor(Math.random() * 30) : 30 + Math.floor(Math.random() * 50)
        };
        
        // Height based on position
        let height, weight;
        if (pos === "PG") {
          height = `6'${Math.floor(Math.random() * 5)}"`;
          weight = 180 + Math.floor(Math.random() * 30);
        } else if (pos === "SG") {
          height = `6'${3 + Math.floor(Math.random() * 4)}"`;
          weight = 190 + Math.floor(Math.random() * 30);
        } else if (pos === "SF") {
          height = `6'${5 + Math.floor(Math.random() * 4)}"`;
          weight = 210 + Math.floor(Math.random() * 30);
        } else if (pos === "PF") {
          height = `6'${7 + Math.floor(Math.random() * 4)}"`;
          weight = 225 + Math.floor(Math.random() * 30);
        } else {
          height = `6'${9 + Math.floor(Math.random() * 4)}"`;
          weight = 240 + Math.floor(Math.random() * 40);
        }
        
        // Salary based on OVR
        let salary;
        if (ovr >= 85) salary = 20_000_000 + Math.floor(Math.random() * 15_000_000);
        else if (ovr >= 80) salary = 12_000_000 + Math.floor(Math.random() * 10_000_000);
        else if (ovr >= 75) salary = 5_000_000 + Math.floor(Math.random() * 8_000_000);
        else salary = 1_000_000 + Math.floor(Math.random() * 5_000_000);
        
        const years = 1 + Math.floor(Math.random() * 4); // 1-4 years
        const morale = 40 + Math.floor(Math.random() * 60); // 40-100
        const durability = 50 + Math.floor(Math.random() * 45); // 50-95
        
        // Status probabilities
        let status = "healthy";
        const rand = Math.random();
        if (rand < 0.05) status = "injured";
        else if (rand < 0.1) status = "twoway";
        
        const archetype = archetypes[pos][Math.floor(Math.random() * archetypes[pos].length)];
        
        const playerName = `${first[Math.floor(Math.random() * first.length)]} ${last[Math.floor(Math.random() * last.length)]}`;
        const draftInfo = generateDraftInfo(age, ovr);
        const shoots = Math.random() > 0.12 ? "Right" : "Left"; // ~88% right-handed
        const birthDate = `${Math.floor(Math.random() * 12) + 1}/${Math.floor(Math.random() * 28) + 1}/${2026 - age}`;
        
        // Generate personality traits
        const personality = generatePersonalityTraits(ovr, age, mental);
        
        // Generate bio data
        const bio = {
          fullName: playerName,
          nickname: generateNickname(playerName, archetype, ovr),
          shoots,
          birthDate,
          birthplace: generateBirthplace(),
          college: generateCollege(),
          draftTeam: LEAGUE_TEAMS[Math.floor(Math.random() * LEAGUE_TEAMS.length)],
          draftYear: draftInfo.draftYear,
          draftPick: draftInfo.draftPick,
          experience: age - 19,
          awards: generateAwards(ovr, age, archetype),
          seasonStats: generateSeasonStats(ovr, pos),
          careerStats: generateSeasonStats(ovr - Math.floor(Math.random() * 5), pos), // Career slightly lower
          bioText: "", // Will be generated after mental attributes are available
          personalityDesc: getPersonalityDescription(personality)
        };
        
        roster.push({
          id: uid(),
          name: playerName,
          pos,
          age,
          ovr,
          pot,
          height,
          weight,
          salary,
          years,
          morale,
          status,
          archetype,
          durability,
          skills,
          mental,
          hidden,
          personality,
          bio,
          notes: generatePlayerNote(pos, ovr)
        });
      }
      
      // Generate bio text after all players are created (needs mental attributes)
      roster.forEach(player => {
        player.bio.bioText = generateBioText(player.name, player.archetype, player.mental, player.ovr);
      });
      
      return roster.sort((a, b) => b.ovr - a.ovr); // Sort by OVR descending
    }
    
    function generatePlayerNote(pos, ovr) {
      const notes = {
        PG: ["Floor general", "Playmaker", "Pick & roll maestro", "Defensive stopper", "Three-level scorer"],
        SG: ["Perimeter threat", "Slasher", "Elite defender", "Catch & shoot specialist", "Two-way guard"],
        SF: ["3&D wing", "Versatile scorer", "Lockdown defender", "Do-it-all forward", "Transition threat"],
        PF: ["Stretch four", "Paint protector", "Pick & pop specialist", "Energy guy", "Rebounding machine"],
        C: ["Rim protector", "Drop big", "Elite screener", "Back-to-basket scorer", "Modern center"]
      };
      const list = notes[pos] || notes.SF;
      return list[Math.floor(Math.random() * list.length)];
    }

    // -------------------------------
    // Free Agency System
    // -------------------------------
    function generateFreeAgents(count = 75) {
      const first = ["Darius","Marcus","Jalen","Devin","Kobe","Zion","Trey","Lamont","Elijah",
"Kendrick","Andre","Isaiah","Tyrese","Jordan","Jayden","Brice","Dominic",
"Caleb","Roman","Silas","Malik","Kamari","Jett","Cameron","Bryson",
"Colby","Miles","Carson","Evan","Logan","Jamal","Corey","Travis",
"Derrick","Shawn","Trevor","Hayden","Parker","Chase","Owen","Blake",
"Hunter","Shane","Noah","Caden","Tanner","Grant","Wesley","Nate"]

      const last = ["Lawson","Coleman","Harper","Wells","Patterson","Knight","Holloway",
"Reyes","Carter","Morrison","Harris","Shaw","Mitchell","Burns","Sullivan",
"Porter","Henderson","Bryant","Howard","Stevens","Wade","Douglas","Green",
"Duncan","Palmer","Saunders","Matthews","Foster","Webb","Armstrong",
"Griffin","Banks","Hayes","Miller","Cooper","Reed","Walker","Price",
"Bailey","Dean","Rice","Hughes","Wallace","Payne","Cross","Garrett",
"Long","Hardy","Rivers","Stephens"]

      const positions = ["PG","SG","SF","PF","C"];
      const archetypes = {
        PG: ["Floor General", "Scoring Guard", "Defensive Pest", "Combo Guard", "Pure Point"],
        SG: ["3&D Wing", "Shot Creator", "Slasher", "Defensive Stopper", "Volume Scorer"],
        SF: ["Two-Way Wing", "Point Forward", "3PT Specialist", "Athletic Finisher", "Versatile Defender"],
        PF: ["Stretch Four", "Power Forward", "Rim Protector", "Face-Up Big", "Enforcer"],
        C: ["Paint Beast", "Stretch Five", "Defensive Anchor", "Pick & Roll Big", "Traditional Center"]
      };
      
      const freeAgents = [];
      
      // Distribution: 10% stars, 30% solid players, 40% role players, 20% minimum guys
      for (let i = 0; i < count; i++) {
        const pos = positions[Math.floor(Math.random() * positions.length)];
        
        // Determine tier
        let tier;
        const rand = Math.random();
        if (rand < 0.1) tier = "star"; // 10%
        else if (rand < 0.4) tier = "solid"; // 30%
        else if (rand < 0.8) tier = "role"; // 40%
        else tier = "minimum"; // 20%
        
        // Age distribution
        let age;
        if (tier === "star") age = 24 + Math.floor(Math.random() * 6); // 24-29
        else if (tier === "solid") age = 23 + Math.floor(Math.random() * 8); // 23-30
        else if (tier === "role") age = 22 + Math.floor(Math.random() * 10); // 22-31
        else age = 26 + Math.floor(Math.random() * 8); // 26-33 (older minimum guys)
        
        // OVR based on tier
        let baseOvr;
        if (tier === "star") baseOvr = 82 + Math.floor(Math.random() * 12); // 82-93
        else if (tier === "solid") baseOvr = 74 + Math.floor(Math.random() * 8); // 74-81
        else if (tier === "role") baseOvr = 65 + Math.floor(Math.random() * 9); // 65-73
        else baseOvr = 55 + Math.floor(Math.random() * 10); // 55-64
        
        const variance = 15;
        const skills = {
          inside: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          mid: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          three: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          ft: Math.max(40, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          playmaking: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          ballHandling: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          offensiveIQ: Math.max(40, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          defensiveIQ: Math.max(40, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          perimeterD: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          postD: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          rebounding: Math.max(30, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          athleticism: Math.max(40, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance))),
          strength: Math.max(40, Math.min(99, baseOvr + (Math.random() * variance * 2 - variance)))
        };
        
        // Position adjustments (same as generateRoster)
        if (pos === "PG") {
          skills.playmaking += 10; skills.ballHandling += 10; skills.three += 5; skills.strength -= 10;
        } else if (pos === "SG") {
          skills.three += 10; skills.mid += 5; skills.perimeterD += 5;
        } else if (pos === "SF") {
          skills.athleticism += 5; skills.perimeterD += 5;
        } else if (pos === "PF") {
          skills.rebounding += 10; skills.strength += 10; skills.postD += 5; skills.ballHandling -= 10;
        } else {
          skills.inside += 15; skills.rebounding += 15; skills.strength += 15; skills.postD += 10;
          skills.ballHandling -= 15; skills.three -= 10;
        }
        
        Object.keys(skills).forEach(key => {
          skills[key] = Math.round(Math.max(25, Math.min(99, skills[key])));
        });
        
        const ovr = calculateOVR(skills, pos);
        const potVariance = age < 25 ? 10 : age < 28 ? 5 : 2;
        const pot = Math.min(99, ovr + Math.floor(Math.random() * potVariance));
        
        const mental = {
          leadership: 40 + Math.floor(Math.random() * 55),
          workEthic: 45 + Math.floor(Math.random() * 50),
          composure: 40 + Math.floor(Math.random() * 55),
          discipline: 40 + Math.floor(Math.random() * 55),
          coachability: 45 + Math.floor(Math.random() * 50)
        };
        
        const hidden = {
          greed: 30 + Math.floor(Math.random() * 60),
          loyalty: 35 + Math.floor(Math.random() * 60),
          marketPreference: ["Small", "Mid", "Large"][Math.floor(Math.random() * 3)],
          clutch: 40 + Math.floor(Math.random() * 50),
          popularity: ovr > 85 ? 70 + Math.floor(Math.random() * 30) : 30 + Math.floor(Math.random() * 50)
        };
        
        // Salary demands based on OVR and tier
        let askingSalary;
        if (ovr >= 85) askingSalary = 25_000_000 + Math.floor(Math.random() * 15_000_000);
        else if (ovr >= 80) askingSalary = 15_000_000 + Math.floor(Math.random() * 12_000_000);
        else if (ovr >= 75) askingSalary = 8_000_000 + Math.floor(Math.random() * 8_000_000);
        else if (ovr >= 70) askingSalary = 4_000_000 + Math.floor(Math.random() * 5_000_000);
        else if (ovr >= 65) askingSalary = 2_000_000 + Math.floor(Math.random() * 3_000_000);
        else askingSalary = 1_000_000 + Math.floor(Math.random() * 1_500_000);
        
        // Years demanded
        let askingYears;
        if (ovr >= 85) askingYears = 3 + Math.floor(Math.random() * 2); // 3-4
        else if (ovr >= 75) askingYears = 2 + Math.floor(Math.random() * 2); // 2-3
        else if (ovr >= 65) askingYears = 1 + Math.floor(Math.random() * 2); // 1-2
        else askingYears = 1;
        
        // Role preference
        let askingRole;
        if (ovr >= 80) askingRole = "Starter";
        else if (ovr >= 70) askingRole = Math.random() > 0.5 ? "Starter" : "Bench";
        else if (ovr >= 60) askingRole = "Bench";
        else askingRole = "Reserve";
        
        const archetype = archetypes[pos][Math.floor(Math.random() * archetypes[pos].length)];
        const playerName = `${first[Math.floor(Math.random() * first.length)]} ${last[Math.floor(Math.random() * last.length)]}`;
        
        // Height/weight
        let height, weight;
        if (pos === "PG") {
          height = `6'${Math.floor(Math.random() * 5)}"`;
          weight = 180 + Math.floor(Math.random() * 30);
        } else if (pos === "SG") {
          height = `6'${3 + Math.floor(Math.random() * 4)}"`;
          weight = 190 + Math.floor(Math.random() * 30);
        } else if (pos === "SF") {
          height = `6'${5 + Math.floor(Math.random() * 4)}"`;
          weight = 210 + Math.floor(Math.random() * 30);
        } else if (pos === "PF") {
          height = `6'${7 + Math.floor(Math.random() * 4)}"`;
          weight = 225 + Math.floor(Math.random() * 30);
        } else {
          height = `6'${9 + Math.floor(Math.random() * 4)}"`;
          weight = 240 + Math.floor(Math.random() * 40);
        }
        
        const durability = 50 + Math.floor(Math.random() * 45);
        const faType = Math.random() > 0.8 ? "Restricted" : "Unrestricted";
        
        // Generate personality traits
        const personality = generatePersonalityTraits(ovr, age, mental);
        
        freeAgents.push({
          id: uid(),
          name: playerName,
          pos,
          age,
          ovr,
          pot,
          height,
          weight,
          archetype,
          durability,
          skills,
          mental,
          hidden,
          personality,
          askingSalary,
          askingYears,
          askingRole,
          faType,
          interest: 0, // Will be calculated
          notes: generatePlayerNote(pos, ovr)
        });
      }
      
      return freeAgents.sort((a, b) => b.ovr - a.ovr);
    }
    
    function calculateInterest(player, teamState) {
      // Base interest from player popularity and randomness
      let interest = 30 + Math.floor(Math.random() * 30); // 30-60 base
      
      // Personality influences
      const personality = player.personality || {};
      
      // Team record factor (better record = more interest)
      const totalGames = teamState.dashboard.wins + teamState.dashboard.losses;
      if (totalGames > 0) {
        const winPct = teamState.dashboard.wins / totalGames;
        if (winPct > 0.6) {
          interest += 20;
          // Competitive players care MORE about winning
          if (personality.competitiveness >= 80) interest += 10;
          if (personality.motivation === "Rings") interest += 15;
        } else if (winPct > 0.5) {
          interest += 10;
        } else if (winPct < 0.3) {
          interest -= 15;
          // Competitive players avoid losing teams
          if (personality.competitiveness >= 80) interest -= 10;
          if (personality.motivation === "Rings") interest -= 20;
        }
      }
      
      // Cap space factor (can we afford them?)
      const totalSalary = sum(teamState.roster, p => p.salary);
      const capSpace = teamState.meta.rules.cap - totalSalary;
      
      if (capSpace >= player.askingSalary) {
        interest += 15; // We can afford them
        // Greedy players more interested if we can overpay
        if (personality.greed >= 75 && capSpace >= player.askingSalary * 1.3) {
          interest += 15;
        }
      } else if (capSpace >= player.askingSalary * 0.8) {
        interest += 5; // Close
      } else {
        interest -= 20; // Can't afford
        // Money-motivated players won't even consider
        if (personality.motivation === "Money") interest -= 15;
      }
      
      // Roster need (do we need this position?)
      const positionCount = teamState.roster.filter(p => p.pos === player.pos).length;
      if (positionCount < 2) interest += 15; // High need
      else if (positionCount < 3) interest += 8; // Some need
      else if (positionCount > 4) interest -= 10; // Crowded
      
      // Market preference
      const teamMarket = "Mid"; // Could be dynamic based on team
      if (personality.marketPreference === teamMarket) {
        interest += 10;
      } else if (personality.marketPreference === "Large" && teamMarket !== "Large") {
        interest -= 15;
      } else if (personality.marketPreference === "Any") {
        interest += 5; // Flexible players
      }
      
      // Loyalty factor
      if (personality.loyalty >= 75) {
        interest += 8; // Loyal players value stability
      } else if (personality.loyalty < 40) {
        interest -= 5; // Disloyal mercenaries harder to attract
      }
      
      // Legacy/Fame motivation
      if (personality.motivation === "Legacy" && teamState.meta.teamName.includes("Lakers") || teamState.meta.teamName.includes("Celtics")) {
        interest += 10; // Attracted to historic franchises
      }
      if (personality.motivation === "Fame") {
        if (teamMarket === "Large") interest += 15;
      }
      
      return Math.max(0, Math.min(100, Math.round(interest)));
    }
    
    // -------------------------------
    // Morale & Chemistry Systems
    // -------------------------------
    function calculatePlayerMorale(player, teamState) {
      const personality = player.personality || {};
      let morale = player.morale || 60;
      
      // Base morale influenced by personality
      if (personality.resilience >= 80) {
        morale = Math.max(morale, 60); // Resilient players maintain minimum morale
      }
      
      // Team record impact
      const totalGames = teamState.dashboard.wins + teamState.dashboard.losses;
      if (totalGames > 0) {
        const winPct = teamState.dashboard.wins / totalGames;
        if (winPct > 0.7) {
          morale += 10;
        } else if (winPct > 0.6) {
          morale += 5;
        } else if (winPct < 0.3) {
          morale -= 15;
          // High ego players suffer more from losing
          if (personality.ego >= 80) morale -= 10;
          // Competitive players hate losing
          if (personality.competitiveness >= 80) morale -= 5;
        } else if (winPct < 0.4) {
          morale -= 8;
        }
      }
      
      // Role satisfaction (based on OVR and salary)
      const teamAvgOVR = teamState.roster.reduce((sum, p) => sum + p.ovr, 0) / teamState.roster.length;
      if (player.ovr >= teamAvgOVR + 10) {
        // Star player
        if (player.salary < 15_000_000) {
          morale -= 10; // Underpaid star
          if (personality.greed >= 75) morale -= 10;
        }
        // Stars demand playing time
        if (personality.ego >= 80) {
          morale -= 5; // High ego stars always want more
        }
      } else if (player.ovr < teamAvgOVR - 10) {
        // Bench player
        if (player.salary > 8_000_000) {
          morale += 5; // Happy to be overpaid
        }
        if (personality.professionalism >= 80) {
          morale += 5; // Professionals accept their role
        }
      }
      
      // Professionalism factor
      if (personality.professionalism >= 85) {
        morale += 5; // Professionals stay positive
      } else if (personality.professionalism < 40) {
        morale -= 8; // Unprofessional players cause drama
      }
      
      // Leadership bonus
      if (personality.leadership >= 80) {
        morale += 5; // Leaders inspire themselves
      }
      
      // Discipline and work ethic
      if (personality.discipline < 40 || personality.temper >= 85) {
        morale -= 5; // Volatile players struggle
      }
      
      // Coaching impact on morale
      if (teamState.coaches && teamState.coaches.head) {
        const coach = teamState.coaches.head;
        const boost = getCoachingBoost(coach);
        
        // Motivator coaches improve morale
        morale += Math.round((boost.morale - 50) / 10); // ¬±5 based on coach
        
        // High trust with coach improves morale
        if (coach.trust >= 80) {
          morale += 5;
        } else if (coach.trust < 30) {
          morale -= 8; // Players don't respect low-trust coach
        }
        
        // Personality compatibility with coaching style
        if (coach.personality === "Disciplinarian" && personality.discipline < 50) {
          morale -= 5; // Clash with strict coach
        }
        if (coach.personality === "Player's Coach" && personality.coachability >= 70) {
          morale += 5; // Players love supportive coach
        }
      }
      
      return Math.max(20, Math.min(100, Math.round(morale)));
    }
    
    function calculateTeamChemistry(roster) {
      if (!roster || roster.length === 0) return 50;
      
      let chemistry = 60; // Base chemistry
      
      // Average professionalism
      const avgProfessionalism = roster.reduce((sum, p) => {
        return sum + (p.personality?.professionalism || 50);
      }, 0) / roster.length;
      
      if (avgProfessionalism >= 80) chemistry += 15;
      else if (avgProfessionalism >= 70) chemistry += 10;
      else if (avgProfessionalism < 50) chemistry -= 10;
      
      // Average charisma
      const avgCharisma = roster.reduce((sum, p) => {
        return sum + (p.personality?.charisma || 50);
      }, 0) / roster.length;
      
      if (avgCharisma >= 75) chemistry += 10;
      else if (avgCharisma < 40) chemistry -= 5;
      
      // Average coachability
      const avgCoachability = roster.reduce((sum, p) => {
        return sum + (p.personality?.coachability || 50);
      }, 0) / roster.length;
      
      if (avgCoachability >= 80) chemistry += 10;
      else if (avgCoachability < 50) chemistry -= 8;
      
      // Count high-ego players
      const highEgoPlayers = roster.filter(p => (p.personality?.ego || 0) >= 80);
      if (highEgoPlayers.length >= 3) {
        chemistry -= 15; // Too many alphas
      } else if (highEgoPlayers.length === 2) {
        chemistry -= 8; // Some ego conflicts
      }
      
      // Count leaders
      const leaders = roster.filter(p => (p.personality?.leadership || 0) >= 80);
      if (leaders.length >= 2) {
        chemistry += 10; // Strong leadership
      } else if (leaders.length === 1) {
        chemistry += 5; // Some leadership
      } else {
        chemistry -= 5; // No clear leaders
      }
      
      // Extrovert/Introvert balance
      const extroverts = roster.filter(p => p.personality?.socialType === "Extrovert").length;
      const introverts = roster.filter(p => p.personality?.socialType === "Introvert").length;
      const ratio = extroverts / (extroverts + introverts || 1);
      if (ratio >= 0.4 && ratio <= 0.7) {
        chemistry += 5; // Good balance
      }
      
      // Team motivation alignment
      const ringChasers = roster.filter(p => p.personality?.motivation === "Rings").length;
      const moneyChasers = roster.filter(p => p.personality?.motivation === "Money").length;
      if (ringChasers >= roster.length * 0.6) {
        chemistry += 10; // United in championship pursuit
      } else if (moneyChasers >= roster.length * 0.6) {
        chemistry -= 5; // Mercenaries lack cohesion
      }
      
      return Math.max(20, Math.min(100, Math.round(chemistry)));
    }
    
    function advanceFreeAgencyDay() {
      if (!STATE.freeAgents) return;
      
      // Slightly adjust demands and interest
      STATE.freeAgents.forEach(fa => {
        // 30% chance salary demand changes slightly
        if (Math.random() < 0.3) {
          const change = 0.95 + Math.random() * 0.1; // ¬±5%
          fa.askingSalary = Math.round(fa.askingSalary * change);
        }
        
        // Recalculate interest with slight randomness
        fa.interest = calculateInterest(fa, STATE);
        
        // 10% chance years demanded changes
        if (Math.random() < 0.1 && fa.askingYears > 1) {
          fa.askingYears += Math.random() > 0.5 ? -1 : 1;
          fa.askingYears = Math.max(1, Math.min(5, fa.askingYears));
        }
      });
      
      save(STATE);
      toast("Free agency market updated.");
      renderFreeAgency();
    }
    
    // -------------------------------
    // Personality-Based Events
    // -------------------------------
    function generatePersonalityEvents(teamState) {
      const events = [];
      const roster = teamState.roster;
      
      roster.forEach(player => {
        const p = player.personality;
        if (!p) return;
        
        // Leadership events
        if (p.leadership >= 85 && Math.random() < 0.15) {
          events.push({
            ts: Date.now(),
            text: `${player.name} praised for mentoring rookies and elevating team culture.`,
            type: "positive"
          });
        }
        
        // Ego conflicts
        if (p.ego >= 85 && player.morale < 60 && Math.random() < 0.2) {
          events.push({
            ts: Date.now(),
            text: `${player.name} frustrated with reduced role, causing tension in locker room.`,
            type: "negative"
          });
        }
        
        // Temper incidents
        if (p.temper >= 85 && p.discipline < 50 && Math.random() < 0.1) {
          events.push({
            ts: Date.now(),
            text: `${player.name} received technical foul after heated argument with referee.`,
            type: "negative"
          });
        }
        
        // Media savvy
        if (p.mediaSavvy >= 80 && Math.random() < 0.12) {
          events.push({
            ts: Date.now(),
            text: `${player.name}'s post-game interview goes viral, boosting team's media presence.`,
            type: "positive"
          });
        } else if (p.mediaSavvy < 40 && Math.random() < 0.08) {
          events.push({
            ts: Date.now(),
            text: `${player.name} makes controversial comments to press, creating PR headache.`,
            type: "negative"
          });
        }
        
        // Work ethic
        if (p.workEthic >= 90 && Math.random() < 0.1) {
          events.push({
            ts: Date.now(),
            text: `Coaches rave about ${player.name}'s dedication in practice sessions.`,
            type: "positive"
          });
        }
        
        // Professionalism issues
        if (p.professionalism < 40 && Math.random() < 0.12) {
          events.push({
            ts: Date.now(),
            text: `${player.name} late to team meeting, fined by coaching staff.`,
            type: "negative"
          });
        }
        
        // Clutch performances
        if (p.clutch >= 85 && Math.random() < 0.08) {
          events.push({
            ts: Date.now(),
            text: `${player.name} delivers in crunch time, cementing reputation as clutch performer.`,
            type: "positive"
          });
        }
        
        // Loyalty appreciation
        if (p.loyalty >= 85 && player.years >= 3 && Math.random() < 0.1) {
          events.push({
            ts: Date.now(),
            text: `${player.name} expresses desire to finish career with organization.`,
            type: "positive"
          });
        }
        
        // Greed/Trade demands
        if (p.greed >= 85 && player.salary < 15_000_000 && player.ovr >= 75 && Math.random() < 0.15) {
          events.push({
            ts: Date.now(),
            text: `${player.name}'s agent requests contract extension talks.`,
            type: "neutral"
          });
        }
        
        // Social extrovert events
        if (p.socialType === "Extrovert" && p.charisma >= 75 && Math.random() < 0.1) {
          events.push({
            ts: Date.now(),
            text: `${player.name} organizes team dinner, boosting locker room chemistry.`,
            type: "positive"
          });
        }
        
        // Competitive drive
        if (p.competitiveness >= 85 && p.motivation === "Rings" && Math.random() < 0.12) {
          const totalGames = teamState.dashboard.wins + teamState.dashboard.losses;
          const winPct = totalGames > 0 ? teamState.dashboard.wins / totalGames : 0.5;
          if (winPct < 0.4) {
            events.push({
              ts: Date.now(),
              text: `${player.name} challenges teammates to raise level of play after tough stretch.`,
              type: "neutral"
            });
          }
        }
      });
      
      return events;
    }

    // -------------------------------
    // Minimal data model (expandable)
    // -------------------------------
    const DEFAULT_RULES = {
      cap: 149_000_000,     // 2026 example cap
      tax: 181_000_000,     // tax threshold
      apron1: 189_000_000,  // first apron
      apron2: 199_000_000,  // second apron
      rosterLimit: 15
    };

    const LEAGUE_TEAMS = [
      "Atlanta Apex", "Boston Breakers", "Brooklyn Bridges", "Charlotte Cobras",
      "Chicago Cyclones", "Cleveland Comets", "Dallas Dynasty", "Denver Elevation",
      "Detroit Dynamos", "Golden State Guardians", "Houston Heatwave", "Indiana Ignition",
      "LA Lightning", "Memphis Momentum", "Miami Mirage",
      "Milwaukee Metros", "Minnesota Mavericks", "New Orleans Neptunes", "New York Navigators",
      "Oklahoma City Outlaws", "Orlando Overdrive", "Philadelphia Phoenixes", "Phoenix Predators",
      "Portland Pioneers", "Sacramento Spartans", "San Antonio Strikers", "San Francisco Riptide",
      "Toronto Tempest", "Utah Uprising", "Washington Wildcats"
    ];

    function generateLeagueRosters() {
      const leagueRosters = {};
      LEAGUE_TEAMS.forEach(team => {
        leagueRosters[team] = generateRoster();
      });
      return leagueRosters;
    }

    const initialState = {
      meta: { teamName: "San Francisco Riptide", season: 2026, rules: DEFAULT_RULES },
      roster: generateRoster(),
      leagueRosters: generateLeagueRosters(),
      owner: (() => {
        const owner = generateOwner();
        // Goals will be generated after state is created
        return owner;
      })(),
      coaches: {
        head: generateCoach("head", "solid"),
        assistants: [
          generateCoach("assistant", "solid"),
          generateCoach("assistant", "developing")
        ],
        candidates: generateCoachCandidates(12)
      },
      finance: {
        revenue: { tickets: 0, merch: 0, playoffs: 0, total: 0 },
        expenses: { players: 0, staff: 0, facilities: 0, promo: 0, tax: 0, total: 0 },
        settings: { ticketPrice: 1.0, promoSpend: 0, facilityLvl: 0 },
        projections: []
      },
      settings: {
        ownerIntervention: true
      },
      fans: {
        hype: 50, // 0-100, starts neutral
        history: []
      },
      ownerEvents: [], // Track intervention history
      events: [
        {ts: Date.now(), text:"Hired analytics intern who speaks exclusively in effective field goal percentage.", type:"league"}
      ],
      prospects: [],
      freeAgents: [], // Will be generated on first load
      draft: {
        prospects: [],
        yourPick: 15,
        currentPick: 0,
        scoutingPoints: 100,
        maxScoutingPoints: 100,
        draftStarted: false,
        selectedProspect: null,
        draftedPlayers: []
      },
      schedule: {
        games: [], // Array of game objects (170-day schedule)
        currentDay: 1, // Current day of season (1-170)
        selectedGame: null,
        elo: 1500, // Team Elo rating
        leagueElos: {} // Opponent Elo ratings
      },
      rivalries: {
        // Format: "TeamA_TeamB": { heat: 0-100, history: [], lastMeeting: day }
        // Pre-seeded natural rivalries
      },
      dashboard: {
        wins: 0,
        losses: 0,
        confRank: 8,
        divRank: 3,
        lastTen: [],
        pointDiff: 0,
        streak: { type: "none", count: 0 },
        nextOpponent: "Memphis Momentum",
        nextGameDate: "Nov 15",
        offRtg: 112.5,
        defRtg: 108.2,
        pace: 98.7,
        sentiment: 50
      }
    };

    // -------------------------------
    // Storage
    // -------------------------------
    // STORAGE_KEY already defined at top of script
    function load(){
      try { 
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initialState;
        // Ensure leagueRosters exists for backward compatibility
        if (!saved.leagueRosters) {
          saved.leagueRosters = generateLeagueRosters();
        }
        // Ensure freeAgents exists
        if (!saved.freeAgents || saved.freeAgents.length === 0) {
          saved.freeAgents = generateFreeAgents(75);
          // Calculate initial interest for all free agents
          saved.freeAgents.forEach(fa => {
            fa.interest = calculateInterest(fa, saved);
          });
        }
        // Ensure coaches exist
        if (!saved.coaches) {
          saved.coaches = {
            head: generateCoach("head", "solid"),
            assistants: [
              generateCoach("assistant", "solid"),
              generateCoach("assistant", "developing")
            ],
            candidates: generateCoachCandidates(12)
          };
        }
        // Ensure owner exists
        if (!saved.owner) {
          saved.owner = generateOwner();
          saved.owner.goals = generateSeasonGoals(saved, saved.owner);
        }
        // Ensure fans object exists
        if (!saved.fans) {
          saved.fans = { hype: 50, history: [] };
        }
        return saved;
      }
      catch { return initialState }
    }
    function save(state){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      toast("Saved league.");
    }

    // -------------------------------
    // Utilities
    // -------------------------------
    function uid(){ return Math.random().toString(36).slice(2,9) }
    const fmt = (n) => "$" + Math.round(n).toLocaleString();
    function sum(a, f){ return a.reduce((t,x)=>t+f(x),0) }
    function by(key, dir=1){ return (a,b)=> (a[key]>b[key]?1:-1)*dir }
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)) }

    // -------------------------------
    // State (live)
    // -------------------------------
    let STATE = load();

    // -------------------------------
    // DOM helpers
    // -------------------------------
    const $ = (q, root=document)=>root.querySelector(q);
    const $$ = (q, root=document)=>Array.from(root.querySelectorAll(q));

    // -------------------------------
    // Navigation
    // -------------------------------
    $$("#nav .nav-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const view = btn.dataset.view;
        $$("#nav .nav-btn").forEach(b=>b.classList.toggle("active", b===btn));
        $$("main section[data-view]").forEach(sec=>{
          sec.hidden = (sec.dataset.view !== view);
        });
        if(view === "roster") renderRoster();
        if(view === "cap") renderCapSheet();
        if(view === "freeagency") renderFreeAgency();
        if(view === "coaching") renderCoaching();
        if(view === "owner") renderOwner();
        if(view === "finance") renderFinance();
        if(view === "schedule") renderSchedule();
        if(view === "draft") renderDraft();
      });
    });
    $$("[data-view-jump]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const target = btn.getAttribute("data-view-jump");
        $(`#nav .nav-btn[data-view="${target}"]`).click();
      });
    });

    // -------------------------------
    // Topbar actions
    // -------------------------------
    $("#saveBtn").addEventListener("click", ()=> save(STATE));
    $("#resetBtn").addEventListener("click", ()=>{
      if(confirm("Reset league to defaults?")){ STATE = structuredClone(initialState); rerenderAll(); toast("League reset."); }
    });
    $("#simDayBtn").addEventListener("click", ()=>{
      simulateGame();
      toast("Game simulated!");
      rerenderAll();
    });

    function simulateGame(){
      if (!STATE.dashboard) {
        STATE.dashboard = {
          wins: 0, losses: 0, confRank: 8, divRank: 3, lastTen: [],
          pointDiff: 0, streak: { type: "none", count: 0 },
          nextOpponent: "Memphis Momentum", nextGameDate: "Nov 15",
          offRtg: 112.5, defRtg: 108.2, pace: 98.7, sentiment: 50
        };
      }
      
      const d = STATE.dashboard;
      
      // Apply coaching boost to game outcome
      let winChance = 0.5;
      if (STATE.coaches && STATE.coaches.head) {
        const coach = STATE.coaches.head;
        const boost = getCoachingBoost(coach);
        // Better coaches improve win probability
        winChance += (boost.team - 50) / 500; // ¬±10% based on coach quality
      }
      
      // Random game outcome
      const won = Math.random() < winChance;
      const scoreDiff = Math.floor(Math.random() * 20) - 10;
      
      if (won) {
        d.wins++;
        if (d.streak.type === "w") {
          d.streak.count++;
        } else {
          d.streak = { type: "w", count: 1 };
        }
        addEvent(`Victory! Won by ${Math.abs(scoreDiff)} points.`, "league");
        
        // Fan hype updates based on streaks
        if (d.streak.count === 3) {
          updateFanHype(5, "Team on 3-game win streak");
        } else if (d.streak.count === 5) {
          updateFanHype(7, "Impressive 5-game win streak!");
        } else if (d.streak.count >= 8) {
          updateFanHype(10, "Dominant win streak electrifies fanbase");
        }
        
        // Update coach record
        if (STATE.coaches && STATE.coaches.head) {
          STATE.coaches.head.record.wins++;
        }
      } else {
        d.losses++;
        if (d.streak.type === "l") {
          d.streak.count++;
        } else {
          d.streak = { type: "l", count: 1 };
        }
        addEvent(`Tough loss. Lost by ${Math.abs(scoreDiff)} points.`, "league");
        
        // Fan hype updates for losing streaks
        if (d.streak.count === 3) {
          updateFanHype(-5, "Team struggles with 3-game losing streak");
        } else if (d.streak.count === 5) {
          updateFanHype(-10, "Fans frustrated by 5-game skid");
        } else if (d.streak.count >= 8) {
          updateFanHype(-15, "Losing streak triggers fan outrage");
        }
        
        // Update coach record
        if (STATE.coaches && STATE.coaches.head) {
          STATE.coaches.head.record.losses++;
        }
      }
      
      // Update last 10
      d.lastTen.unshift(won ? "w" : "l");
      if (d.lastTen.length > 10) d.lastTen = d.lastTen.slice(0, 10);
      
      // Update point differential
      d.pointDiff = ((d.pointDiff * (d.wins + d.losses - 1)) + scoreDiff) / (d.wins + d.losses);
      
      // Update rankings (random walk)
      d.confRank = Math.max(1, Math.min(15, d.confRank + (Math.random() > 0.5 ? -1 : 1)));
      d.divRank = Math.max(1, Math.min(5, d.divRank + (Math.random() > 0.5 ? -1 : 1)));
      
      // Update efficiency ratings
      d.offRtg += (Math.random() - 0.5) * 2;
      d.defRtg += (Math.random() - 0.5) * 2;
      d.pace += (Math.random() - 0.5);
      
      // Update sentiment based on recent performance
      const recentWins = d.lastTen.filter(r => r === "w").length;
      d.sentiment = (recentWins / Math.max(1, d.lastTen.length)) * 100;
      
      // Random next opponent
      const teams = ["Memphis Momentum", "LA Lightning", "Boston Breakers", "Phoenix Predators", "Toronto Tempest", "Denver Elevation"];
      d.nextOpponent = teams[Math.floor(Math.random() * teams.length)];
      
      // Random events
      if (Math.random() > 0.7) {
        const events = [
          { text: "Player receives weekly award nomination.", type: "league" },
          { text: "Minor injury reported to backup guard.", type: "injury" },
          { text: "Trade rumors surface around veteran forward.", type: "trade" },
          { text: "Coach praises team's defensive effort.", type: "league" }
        ];
        const event = events[Math.floor(Math.random() * events.length)];
        addEvent(event.text, event.type);
      }
      
      // Update player morale based on personality and team performance
      STATE.roster.forEach(player => {
        if (player.personality) {
          const newMorale = calculatePlayerMorale(player, STATE);
          player.morale = newMorale;
        }
      });
      
      // Generate personality-based events (20% chance)
      if (Math.random() < 0.2) {
        const personalityEvents = generatePersonalityEvents(STATE);
        if (personalityEvents.length > 0) {
          const event = personalityEvents[Math.floor(Math.random() * personalityEvents.length)];
          addEvent(event.text, event.type);
        }
      }
      
      // Calculate and store team chemistry
      const chemistry = calculateTeamChemistry(STATE.roster);
      if (!STATE.dashboard.chemistry) {
        STATE.dashboard.chemistry = chemistry;
      } else {
        STATE.dashboard.chemistry = Math.round((STATE.dashboard.chemistry + chemistry) / 2); // Running average
      }
      
      // Update coaching trust
      if (STATE.coaches && STATE.coaches.head) {
        calculateCoachTrust(STATE.coaches.head, STATE);
        
        // Generate coaching events (15% chance)
        if (Math.random() < 0.15) {
          const coachEvent = generateCoachEvent(STATE.coaches.head, STATE);
          if (coachEvent) {
            addEvent(coachEvent, "league");
          }
        }
      }
      
      // Apply coaching development boost
      if (STATE.coaches && STATE.coaches.head) {
        const boost = getCoachingBoost(STATE.coaches.head);
        STATE.roster.forEach(player => {
          // Young players benefit more from good development coaching
          if (player.age < 26 && player.ovr < player.pot) {
            const devChance = 0.05 * boost.development; // Base 5% improved by coach
            if (Math.random() < devChance) {
              const skillToImprove = Object.keys(player.skills)[Math.floor(Math.random() * Object.keys(player.skills).length)];
              player.skills[skillToImprove] = Math.min(99, player.skills[skillToImprove] + 1);
              // Recalculate OVR
              player.ovr = calculateOVR(player.skills, player.pos);
            }
          }
        });
      }
      
      // Update owner trust periodically (every 5 games)
      const totalGames = d.wins + d.losses;
      if (STATE.owner && totalGames % 5 === 0 && totalGames > 0) {
        calculateOwnerTrust(STATE.owner, STATE);
        
        // Generate owner events (10% chance per update)
        if (Math.random() < 0.1) {
          const ownerEvent = generateOwnerEvent(STATE.owner, STATE);
          if (ownerEvent) {
            addEvent(ownerEvent, "league");
          }
        }
        
        // Trigger meeting at milestones
        if (totalGames === 20 && !STATE.owner.meetingsDue.includes("mid_season_done")) {
          STATE.owner.meetingsDue.push("mid_season");
          addEvent(`Owner ${STATE.owner.name} has scheduled a mid-season review meeting.`, "league");
        }
        if (totalGames === 82 && !STATE.owner.meetingsDue.includes("season_end_done")) {
          STATE.owner.meetingsDue.push("season_end");
          addEvent(`Owner ${STATE.owner.name} requests end-of-season meeting.`, "league");
        }
        
        // Job security warning
        if (STATE.owner.trust < 20 && Math.random() < 0.2) {
          addEvent(`üö® WARNING: Owner losing faith. Job security in jeopardy.`, "league");
        }
        
        // Update financial trust modifiers
        applyFinancialTrustModifiers(STATE);
      }
      
      save(STATE);
    }

    // -------------------------------
    // Settings
    // -------------------------------
    $("#applySettings").addEventListener("click", ()=>{
      STATE.meta.teamName = $("#teamName").value.trim() || "My Team";
      STATE.meta.season = Number($("#seasonInput").value) || STATE.meta.season;
      
      // Update settings
      if (!STATE.settings) STATE.settings = {};
      STATE.settings.ownerIntervention = $("#ownerInterventionToggle").checked;
      
      $(".title").textContent = STATE.meta.teamName;
      $("#seasonTag").textContent = `Season: ${STATE.meta.season}`;
      save(STATE);
      toast("Settings applied.");
    });

    // -------------------------------
    // Dashboard
    // -------------------------------
    function renderFanHype() {
      if (!STATE.fans) {
        STATE.fans = { hype: 50, history: [] };
      }
      
      const hype = STATE.fans.hype;
      const sentiment = getFanSentiment(hype);
      
      // Update dashboard hype meter
      const circle = $("#fanHypeCircle");
      const value = $("#fanHypeValue");
      const sentimentEl = $("#fanHypeSentiment");
      
      if (circle && value && sentimentEl) {
        circle.style.setProperty('--hype-percent', hype);
        circle.style.setProperty('--hype-color', sentiment.color);
        circle.classList.toggle('glow', sentiment.glow);
        
        value.textContent = Math.round(hype);
        value.style.color = sentiment.color;
        sentimentEl.textContent = sentiment.label;
        sentimentEl.style.color = sentiment.color;
      }
      
      // Update owner view hype meter
      const ownerCircle = $("#ownerFanHypeCircle");
      const ownerValue = $("#ownerFanHypeValue");
      const ownerSentiment = $("#ownerFanHypeSentiment");
      
      if (ownerCircle && ownerValue && ownerSentiment) {
        ownerCircle.style.setProperty('--hype-percent', hype);
        ownerCircle.style.setProperty('--hype-color', sentiment.color);
        ownerCircle.classList.toggle('glow', sentiment.glow);
        
        ownerValue.textContent = Math.round(hype);
        ownerValue.style.color = sentiment.color;
        ownerSentiment.textContent = sentiment.label;
        ownerSentiment.style.color = sentiment.color;
      }
    }
    
    function renderDashboardCaps(){
      const {cap,tax,apron1,apron2} = STATE.meta.rules;
      const payroll = sum(STATE.roster, p=>p.salary);
      const pct = clamp((payroll/cap)*100,0,100);
      $("#capFill").style.width = pct.toFixed(1)+"%";
      $("#capKpi").textContent = `${fmt(payroll)} / ${fmt(cap)}`;
      $("#spacePill").textContent = `Cap Space: ${fmt(cap - payroll)}`;
      $("#taxPill").textContent = `Tax Room: ${fmt(tax - payroll)}`;
      $("#apronPill").textContent = `Apron Room: ${fmt(apron1 - payroll)} (A1) ‚Ä¢ ${fmt(apron2 - payroll)} (A2)`;
      
      // Financial Summary
      $("#totalPayroll").textContent = fmt(payroll);
      $("#capRoom").textContent = fmt(cap - payroll);
      
      const taxStatus = $("#taxStatus");
      if (payroll < cap) {
        taxStatus.textContent = "Under Cap";
        taxStatus.className = "status-badge good";
      } else if (payroll < tax) {
        taxStatus.textContent = "Over Cap";
        taxStatus.className = "status-badge warn";
      } else {
        taxStatus.textContent = "In Tax";
        taxStatus.className = "status-badge bad";
      }
      
      const nextYear = payroll * 1.05;
      $("#nextSeasonProj").innerHTML = `${fmt(nextYear)} <span style="color:var(--muted); font-size:11px">‚Üë</span>`;
    }
    
    function renderDashboardRecord(){
      if (!STATE.dashboard) {
        STATE.dashboard = {
          wins: 0, losses: 0, confRank: 8, divRank: 3, lastTen: [],
          pointDiff: 0, streak: { type: "none", count: 0 },
          nextOpponent: "Memphis Momentum", nextGameDate: "Nov 15",
          offRtg: 112.5, defRtg: 108.2, pace: 98.7, sentiment: 50
        };
      }
      
      const d = STATE.dashboard;
      const total = d.wins + d.losses;
      const winPct = total > 0 ? (d.wins / total).toFixed(3) : ".000";
      
      $("#teamRecord").textContent = `${d.wins}-${d.losses}`;
      $("#teamWinPct").textContent = winPct;
      $("#confRank").textContent = d.confRank || "--";
      $("#divRank").textContent = d.divRank || "--";
    }
    
    function renderPerformance(){
      if (!STATE.dashboard) return;
      const d = STATE.dashboard;
      
      // Last 10 games
      const lastTenEl = $("#lastTen");
      if (d.lastTen.length === 0) {
        lastTenEl.innerHTML = '<span style="color:var(--muted); font-size:12px">No games played yet</span>';
      } else {
        lastTenEl.innerHTML = d.lastTen.map(result => 
          `<div class="game-dot ${result}">${result.toUpperCase()}</div>`
        ).join("");
      }
      
      // Point Differential
      const diffEl = $("#pointDiff");
      const diff = d.pointDiff || 0;
      diffEl.textContent = diff >= 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);
      diffEl.className = "value " + (diff > 0 ? "good" : diff < 0 ? "bad" : "neutral");
      
      // Streak
      const streakEl = $("#streak");
      if (d.streak.type === "none") {
        streakEl.textContent = "--";
        streakEl.className = "value neutral";
      } else {
        streakEl.textContent = `${d.streak.type.toUpperCase()}${d.streak.count}`;
        streakEl.className = "value " + (d.streak.type === "w" ? "good" : "bad");
      }
      
      // Team Chemistry
      const chemistryEl = $("#teamChemistry");
      if (!d.chemistry) {
        d.chemistry = calculateTeamChemistry(STATE.roster);
      }
      const chem = d.chemistry || 50;
      chemistryEl.textContent = chem;
      chemistryEl.className = "value " + (chem >= 75 ? "good" : chem >= 50 ? "neutral" : "bad");
      
      // Next Opponent
      $("#nextOpponent").textContent = `${d.nextOpponent} ‚Ä¢ ${d.nextGameDate}`;
    }
    
    function renderFeed(){
      const feed = $("#feed");
      if(!STATE.events.length){ 
        feed.innerHTML = '<div class="empty">No events yet. Your beat writer is doomscrolling.</div>';
        return;
      }
      feed.innerHTML = STATE.events.slice(0,6).map(e=>{
        const type = e.type || "league";
        const tagClass = `feed-tag ${type}`;
        const tagText = type.charAt(0).toUpperCase() + type.slice(1);
        return `<div class="feed-item"><span class="${tagClass}">${tagText}</span>${escapeHtml(e.text)}</div>`;
      }).join("");
    }
    
    function renderLeagueHeadlines(){
      const headlines = [
        "Seattle Thunder extend winning streak to 8 games.",
        "LA Legends shopping veteran forward ahead of deadline.",
        "Phoenix Predators fire head coach after 2-10 start.",
        "Toronto Tempest sign undrafted rookie to two-way deal.",
        "Denver Elevation's star center out 4-6 weeks with injury.",
        "Boston Breakers clinch playoff berth with dominant win.",
        "Trade rumors swirl around Chicago Cyclones' franchise player.",
        "New York Navigators make blockbuster three-team trade."
      ];
      
      const shuffled = headlines.sort(() => Math.random() - 0.5).slice(0, 5);
      $("#leagueHeadlines").innerHTML = shuffled.map(h => 
        `<div class="headline-item">üì∞ ${h}</div>`
      ).join("");
    }
    
    function renderTopPerformer(){
      if (!STATE.roster.length) {
        $("#topPerformer").innerHTML = '<div class="empty">No players on roster</div>';
        return;
      }
      
      const topPlayer = STATE.roster.reduce((best, p) => p.ovr > best.ovr ? p : best, STATE.roster[0]);
      
      const ppg = (15 + Math.random() * 15).toFixed(1);
      const rpg = (4 + Math.random() * 8).toFixed(1);
      const apg = (3 + Math.random() * 7).toFixed(1);
      
      $("#topPerformer").innerHTML = `
        <div class="top-performer">
          <div class="performer-ovr">${topPlayer.ovr}</div>
          <div class="performer-info">
            <div class="performer-name">${escapeHtml(topPlayer.name)}</div>
            <div class="performer-meta">${topPlayer.pos} ‚Ä¢ ${topPlayer.age} yrs old</div>
            <div class="performer-stats">
              <span class="performer-stat"><strong>${ppg}</strong>PPG</span>
              <span class="performer-stat"><strong>${rpg}</strong>RPG</span>
              <span class="performer-stat"><strong>${apg}</strong>APG</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderAnalytics(){
      if (!STATE.dashboard) return;
      const d = STATE.dashboard;
      
      // Efficiency
      $("#offRtg").textContent = d.offRtg.toFixed(1);
      $("#defRtg").textContent = d.defRtg.toFixed(1);
      $("#pace").textContent = d.pace.toFixed(1);
      
      $("#offRtgBar").style.width = `${clamp((d.offRtg - 90) / 30 * 100, 0, 100)}%`;
      $("#defRtgBar").style.width = `${clamp((120 - d.defRtg) / 30 * 100, 0, 100)}%`;
      $("#paceBar").style.width = `${clamp((d.pace - 85) / 30 * 100, 0, 100)}%`;
      
      // Sentiment
      const sentiment = d.sentiment || 50;
      $("#sentimentFill").style.width = `${sentiment}%`;
      
      const emoji = sentiment < 30 ? "üò†" : sentiment < 50 ? "üòê" : sentiment < 70 ? "üôÇ" : "üòÑ";
      $("#sentimentEmoji").textContent = emoji;
    }

    // -------------------------------
    // Roster
    // -------------------------------
    let currentSort = {key:"ovr", dir:-1};
    let currentFilter = "all";
    let searchQuery = "";
    let viewMode = "table";
    let currentViewingTeam = "myTeam"; // "myTeam" or team name from LEAGUE_TEAMS
    
    // Position filter buttons
    $$(".filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        $$(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.pos;
        renderRoster();
      });
    });
    
    // Search
    $("#playerSearch")?.addEventListener("input", (e) => {
      searchQuery = e.target.value.toLowerCase();
      renderRoster();
    });
    
    // Sort dropdown
    $("#sortBy")?.addEventListener("change", (e) => {
      const value = e.target.value;
      currentSort = {
        key: value,
        dir: value === "name" ? 1 : -1
      };
      renderRoster();
    });
    
    // View toggle
    $$(".view-toggle button").forEach(btn => {
      btn.addEventListener("click", () => {
        $$(".view-toggle button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        viewMode = btn.dataset.viewMode;
        renderRoster();
      });
    });
    
    // Team selector - populate and handle changes
    function initializeTeamSelector() {
      const teamSelector = $("#teamSelector");
      if (!teamSelector) return;
      
      // Populate dropdown with all teams
      teamSelector.innerHTML = '<option value="myTeam">üèÄ My Team</option>';
      LEAGUE_TEAMS.forEach(team => {
        const option = document.createElement("option");
        option.value = team;
        option.textContent = team;
        teamSelector.appendChild(option);
      });
      
      // Handle team selection changes
      teamSelector.addEventListener("change", (e) => {
        currentViewingTeam = e.target.value;
        renderRoster();
      });
    }
    
    initializeTeamSelector();

    function renderRoster(){
      // Check if roster elements exist (tab may be hidden on initial load)
      const rosterBody = $("#rosterBody");
      const rosterCount = $("#rosterCount");
      const rosterTableView = $("#rosterTableView");
      const rosterCardView = $("#rosterCardView");
      
      if (!rosterBody || !rosterCount || !rosterTableView || !rosterCardView) {
        return; // Elements not ready yet
      }
      
      // Get the appropriate roster based on current viewing team
      let roster = currentViewingTeam === "myTeam" 
        ? [...STATE.roster] 
        : [...(STATE.leagueRosters?.[currentViewingTeam] || [])];
      
      console.log("Viewing team:", currentViewingTeam);
      console.log("Roster first player:", roster[0]?.name);
      console.log("Total league teams with rosters:", Object.keys(STATE.leagueRosters || {}).length);
      
      // If no roster found for this team, generate one
      if (roster.length === 0 && currentViewingTeam !== "myTeam") {
        if (!STATE.leagueRosters) STATE.leagueRosters = {};
        STATE.leagueRosters[currentViewingTeam] = generateRoster();
        roster = [...STATE.leagueRosters[currentViewingTeam]];
      }
      
      // Apply filter
      if (currentFilter !== "all") {
        roster = roster.filter(p => p.pos === currentFilter);
      }
      
      // Apply search
      if (searchQuery) {
        roster = roster.filter(p => 
          p.name.toLowerCase().includes(searchQuery) ||
          p.pos.toLowerCase().includes(searchQuery)
        );
      }
      
      // Apply sort
      roster.sort(by(currentSort.key, currentSort.dir));
      
      rosterCount.textContent = `${STATE.roster.length}/${STATE.meta.rules.rosterLimit}`;
      
      if (viewMode === "table") {
        rosterTableView.style.display = "block";
        rosterCardView.style.display = "none";
        renderRosterTable(roster);
      } else {
        rosterTableView.style.display = "none";
        rosterCardView.style.display = "grid";
        renderRosterCards(roster);
      }
      
      // Show/hide Add Player button based on viewing team
      const addPlayerBtn = $("#addPlayerBtn");
      if (addPlayerBtn) {
        addPlayerBtn.style.display = currentViewingTeam === "myTeam" ? "inline-block" : "none";
      }
      
      renderTeamTotals();
      renderDashboardCaps();
      renderCapSheet();
    }
    
    function renderRosterTable(roster) {
      const tbody = $("#rosterBody");
      if (!roster.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="empty">No players found</td></tr>`;
        return;
      }
      
      tbody.innerHTML = roster.map(p => {
        const moraleColor = p.morale >= 80 ? "var(--good)" : p.morale >= 50 ? "var(--warn)" : "var(--bad)";
        const moraleEmoji = p.morale >= 80 ? "üòÉ" : p.morale >= 50 ? "üòê" : "üòû";
        const statusClass = p.status === "injured" ? "injured" : p.status === "twoway" ? "twoway" : "healthy";
        
        return `
          <tr>
            <td>
              <div style="display:flex; align-items:center; gap:10px">
                <div style="width:40px; height:40px; border-radius:8px; background:linear-gradient(135deg, var(--pri), var(--pri-2)); 
                  display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:16px">
                  ${p.ovr}
                </div>
                <div>
                  <strong class="player-name-click" data-player-id="${p.id}" style="cursor:pointer; text-decoration:underline; text-decoration-color:transparent; transition:text-decoration-color 0.2s" 
                    onmouseover="this.style.textDecorationColor='var(--pri)'" 
                    onmouseout="this.style.textDecorationColor='transparent'">${escapeHtml(p.name)}</strong>
                  <div style="font-size:11px; color:var(--muted)">${escapeHtml(p.notes||"")}</div>
                </div>
              </div>
            </td>
            <td><span class="pos-badge" style="background:rgba(106,162,255,0.15); color:var(--pri); padding:4px 8px; border-radius:4px; font-weight:600">${p.pos}</span></td>
            <td class="num">${p.age}</td>
            <td class="num ovr">${p.ovr}</td>
            <td class="height-weight">${p.height || "6'6\""} ‚Ä¢ ${p.weight || 210}lb</td>
            <td class="num">
              <div style="font-family:var(--mono); font-weight:600">${fmt(p.salary)}</div>
              <div style="font-size:11px; color:var(--muted)">${p.years} yr${p.years > 1 ? 's' : ''}</div>
            </td>
            <td>
              <div class="morale-cell">
                <div class="morale-mini">
                  <div class="fill" style="width:${p.morale}%; background:${moraleColor}"></div>
                </div>
                <span>${moraleEmoji}</span>
              </div>
            </td>
            <td><span class="status-badge ${statusClass}">${p.status}</span></td>
            <td class="num">
              <div style="display:flex; gap:4px; justify-content:flex-end">
                ${currentViewingTeam === "myTeam" ? `
                  <button class="btn ghost" data-act="edit" data-id="${p.id}" title="Edit" style="padding:4px 8px">‚úèÔ∏è</button>
                  <button class="btn ghost" data-act="trade" data-id="${p.id}" title="Trade" style="padding:4px 8px">üîÑ</button>
                  <button class="btn bad" data-act="waive" data-id="${p.id}" title="Waive" style="padding:4px 8px; font-size:11px">Waive</button>
                ` : '<span style="color:var(--muted); font-size:11px">View Only</span>'}
              </div>
            </td>
          </tr>
        `;
      }).join("");
      
      attachRosterActions();
    }
    
    function renderRosterCards(roster) {
      const container = $("#rosterCardView");
      if (!roster.length) {
        container.innerHTML = '<div class="empty" style="grid-column:1/-1; padding:60px">No players found</div>';
        return;
      }
      
      container.innerHTML = roster.map(p => {
        const moraleColor = p.morale >= 80 ? "var(--good)" : p.morale >= 50 ? "var(--warn)" : "var(--bad)";
        const moraleEmoji = p.morale >= 80 ? "üòÉ" : p.morale >= 50 ? "üòê" : "üòû";
        const statusClass = p.status === "injured" ? "injured" : p.status === "twoway" ? "twoway" : "healthy";
        const ppg = (10 + (p.ovr - 70) * 0.8).toFixed(1);
        const rpg = (3 + Math.random() * 6).toFixed(1);
        const apg = (2 + Math.random() * 5).toFixed(1);
        
        return `
          <div class="player-card">
            <div class="player-header">
              <div class="player-ovr-badge">${p.ovr}</div>
              <div class="player-info">
                <div class="player-name player-name-click" data-player-id="${p.id}" style="cursor:pointer; text-decoration:underline; text-decoration-color:transparent; transition:text-decoration-color 0.2s" 
                  onmouseover="this.style.textDecorationColor='var(--pri)'" 
                  onmouseout="this.style.textDecorationColor='transparent'">${escapeHtml(p.name)}</div>
                <div class="player-meta">
                  <span class="pos-badge">${p.pos}</span>
                  <span>${p.age} yrs</span>
                  <span>${p.height || "6'6\""}</span>
                  <span>${p.weight || 210}lb</span>
                </div>
              </div>
            </div>
            
            <div class="player-stats">
              <div class="stat-item">
                <label>PPG</label>
                <value>${ppg}</value>
              </div>
              <div class="stat-item">
                <label>RPG</label>
                <value>${rpg}</value>
              </div>
              <div class="stat-item">
                <label>APG</label>
                <value>${apg}</value>
              </div>
            </div>
            
            <div class="player-contract">
              <div>
                <div class="contract-label">Contract</div>
                <div class="contract-value">${fmt(p.salary)}</div>
              </div>
              <div style="text-align:right">
                <div class="contract-label">Years Left</div>
                <div class="contract-value">${p.years}</div>
              </div>
            </div>
            
            <div class="player-status">
              <span class="status-badge ${statusClass}">${p.status}</span>
              <div class="morale-bar">
                <div class="fill" style="width:${p.morale}%; background:${moraleColor}"></div>
              </div>
              <span class="morale-emoji">${moraleEmoji}</span>
            </div>
            
            <div style="font-size:12px; color:var(--text-1); margin-bottom:12px; font-style:italic">${escapeHtml(p.notes || "")}</div>
            
            <div class="player-actions">
              ${currentViewingTeam === "myTeam" ? `
                <button class="btn" data-act="edit" data-id="${p.id}">Edit</button>
                <button class="btn" data-act="trade" data-id="${p.id}">Trade</button>
                <button class="btn bad" data-act="waive" data-id="${p.id}">Waive</button>
              ` : '<div style="text-align:center; color:var(--muted); font-size:12px; padding:8px">View Only</div>'}
            </div>
          </div>
        `;
      }).join("");
      
      attachRosterActions();
    }
    
    function attachRosterActions() {
      document.querySelectorAll("[data-act]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          const p = STATE.roster.find(x => x.id === id);
          if (!p) return;
          
          if (act === "waive") {
            if (confirm(`Waive ${p.name}? This cannot be undone.`)) {
              // Fan hype update for cutting players
              if (p.ovr >= 75) {
                updateFanHype(-10, `Trading away fan favorite ${p.name}`);
              } else if (p.ovr >= 65) {
                updateFanHype(-3, `Cutting rotation player ${p.name}`);
              }
              
              STATE.roster = STATE.roster.filter(x => x.id !== id);
              addEvent(`${p.name} was waived.`, "league");
              rerenderAll();
            }
          } else if (act === "edit") {
            openEditPlayerModal(p);
          } else if (act === "trade") {
            toast("Trade interface coming soon!");
          }
        });
      });
      
      // Attach click handlers to player names for profile view
      document.querySelectorAll(".player-name-click").forEach(nameEl => {
        nameEl.addEventListener("click", () => {
          const playerId = nameEl.dataset.playerId;
          const roster = currentViewingTeam === "myTeam" ? STATE.roster : (STATE.leagueRosters[currentViewingTeam] || []);
          const player = roster.find(p => p.id === playerId);
          if (player) openPlayerBio(player);
        });
      });
    }
    
    // Player Bio Modal
    let currentBioPlayer = null;
    
    function openPlayerBio(player) {
      currentBioPlayer = player;
      renderPlayerBio(player);
      $("#bioModal").style.display = "flex";
    }
    
    function renderPlayerBio(player) {
      // Ensure backward compatibility - add missing bio data
      if (!player.bio) {
        const draftInfo = generateDraftInfo(player.age, player.ovr);
        const shoots = Math.random() > 0.12 ? "Right" : "Left";
        const birthDate = `${Math.floor(Math.random() * 12) + 1}/${Math.floor(Math.random() * 28) + 1}/${2026 - player.age}`;
        
        player.bio = {
          fullName: player.name,
          nickname: generateNickname(player.name, player.archetype || "Player", player.ovr),
          shoots,
          birthDate,
          birthplace: generateBirthplace(),
          college: generateCollege(),
          draftTeam: LEAGUE_TEAMS[Math.floor(Math.random() * LEAGUE_TEAMS.length)],
          draftYear: draftInfo.draftYear,
          draftPick: draftInfo.draftPick,
          experience: player.age - 19,
          awards: generateAwards(player.ovr, player.age, player.archetype || "Player"),
          seasonStats: generateSeasonStats(player.ovr, player.pos),
          careerStats: generateSeasonStats(player.ovr - Math.floor(Math.random() * 5), player.pos),
          bioText: generateBioText(player.name, player.archetype || "Player", player.mental || {leadership:50,composure:50,workEthic:50,coachability:50}, player.ovr)
        };
      }
      
      const bio = player.bio;
      
      // Get initials
      const nameParts = player.name.split(' ');
      const initials = nameParts.map(n => n[0]).join('').substring(0, 2);
      $("#bioInitials").textContent = initials;
      
      // Header info
      $("#bioPlayerName").textContent = bio.fullName;
      $("#bioNickname").textContent = bio.nickname ? `"${bio.nickname}"` : "";
      $("#bioNickname").style.display = bio.nickname ? "block" : "none";
      $("#bioPosition").textContent = player.pos;
      $("#bioShoots").textContent = `Shoots: ${bio.shoots}`;
      
      // Convert height to metric
      const heightMatch = player.height.match(/(\d+)'(\d+)"/);
      const feet = parseInt(heightMatch[1]);
      const inches = parseInt(heightMatch[2]);
      const totalInches = (feet * 12) + inches;
      const cm = Math.round(totalInches * 2.54);
      const kg = Math.round(player.weight * 0.453592);
      
      $("#bioHeight").textContent = `${player.height} (${cm} cm)`;
      $("#bioWeight").textContent = `${player.weight} lb (${kg} kg)`;
      
      // Team info
      const teamName = currentViewingTeam === "myTeam" ? STATE.meta.teamName : currentViewingTeam;
      $("#bioTeam").textContent = teamName;
      $("#bioContract").textContent = `${fmt(player.salary)} / ${player.years} year${player.years > 1 ? 's' : ''}`;
      
      const moraleEmoji = player.morale >= 80 ? "üòÉ" : player.morale >= 50 ? "üòê" : "üòû";
      $("#bioMorale").textContent = `${player.morale} ${moraleEmoji}`;
      
      // Personal info
      $("#bioBirthDate").textContent = bio.birthDate;
      $("#bioAge").textContent = `${player.age} years old`;
      $("#bioBirthplace").textContent = bio.birthplace;
      
      // Career info
      $("#bioCollege").textContent = bio.college;
      $("#bioDraft").textContent = `${bio.draftYear} ‚Ä¢ Pick #${bio.draftPick} ‚Ä¢ ${bio.draftTeam}`;
      $("#bioExperience").textContent = `${bio.experience} season${bio.experience !== 1 ? 's' : ''}`;
      
      // Awards
      const awardsContainer = $("#bioAwards");
      if (bio.awards && bio.awards.length > 0) {
        awardsContainer.innerHTML = bio.awards.map(award => {
          let badgeClass = "all-star";
          if (award === "MVP") badgeClass = "mvp";
          else if (award.includes("All-NBA")) badgeClass = "all-nba";
          else if (award === "DPOY") badgeClass = "dpoy";
          else if (award === "Championship") badgeClass = "championship";
          else if (award.includes("Rookie")) badgeClass = "rookie";
          else if (award.includes("Defense")) badgeClass = "all-defense";
          
          return `<span class="award-badge ${badgeClass}">${award}</span>`;
        }).join('');
      } else {
        awardsContainer.innerHTML = '<span style="color:var(--text-1); font-size:13px">No major awards yet</span>';
      }
      
      // Stats
      const statsBody = $("#bioStatsBody");
      statsBody.innerHTML = `
        <tr class="season-row">
          <td>2025-26</td>
          <td>${bio.seasonStats.ppg}</td>
          <td>${bio.seasonStats.rpg}</td>
          <td>${bio.seasonStats.apg}</td>
          <td>${bio.seasonStats.spg}</td>
          <td>${bio.seasonStats.bpg}</td>
          <td>${bio.seasonStats.fgPct}%</td>
          <td>${bio.seasonStats.threePct}%</td>
          <td>${bio.seasonStats.ftPct}%</td>
        </tr>
        <tr class="career-row">
          <td><strong>Career</strong></td>
          <td>${bio.careerStats.ppg}</td>
          <td>${bio.careerStats.rpg}</td>
          <td>${bio.careerStats.apg}</td>
          <td>${bio.careerStats.spg}</td>
          <td>${bio.careerStats.bpg}</td>
          <td>${bio.careerStats.fgPct}%</td>
          <td>${bio.careerStats.threePct}%</td>
          <td>${bio.careerStats.ftPct}%</td>
        </tr>
      `;
      
      // Bio text
      const bioPersonalityEl = $("#bioPersonality");
      const bioPersonalityTraitsEl = $("#bioPersonalityTraits");
      
      if (player.personality) {
        bioPersonalityEl.textContent = getPersonalityDescription(player);
        
        // Display top personality traits
        const traits = [];
        const pers = player.personality;
        if (pers.leadership >= 75) traits.push("natural leader");
        if (pers.ego >= 75) traits.push("strong ego");
        if (pers.competitiveness >= 75) traits.push("fierce competitor");
        if (pers.workEthic >= 75) traits.push("hard worker");
        if (pers.coachability >= 75) traits.push("coachable");
        if (pers.loyalty >= 75) traits.push("loyal");
        if (pers.professionalism >= 75) traits.push("consummate professional");
        if (pers.clutchGene >= 75) traits.push("clutch performer");
        if (pers.charisma >= 75) traits.push("charismatic");
        
        bioPersonalityTraitsEl.textContent = traits.length > 0 
          ? traits.slice(0, 3).join(", ").charAt(0).toUpperCase() + traits.slice(0, 3).join(", ").slice(1)
          : "Well-rounded personality";
      } else {
        bioPersonalityEl.textContent = bio.bioText;
        bioPersonalityTraitsEl.textContent = "‚Äî";
      }
    }
    
    $("#closeBioModal")?.addEventListener("click", () => {
      $("#bioModal").style.display = "none";
    });
    
    $("#viewFullAttributes")?.addEventListener("click", () => {
      if (currentBioPlayer) {
        $("#bioModal").style.display = "none";
        openPlayerProfile(currentBioPlayer);
      }
    });
    
    // Player Profile Modal
    let currentProfilePlayer = null;
    let isProfileEditMode = false;
    
    function openPlayerProfile(player) {
      currentProfilePlayer = player;
      isProfileEditMode = false;
      renderPlayerProfile(player, false);
      $("#profileModal").style.display = "flex";
    }
    
    function renderPlayerProfile(player, editMode = false) {
      // Ensure backward compatibility - add missing attributes
      if (!player.skills) {
        player.skills = {
          inside: player.ovr || 70, mid: player.ovr || 70, three: player.ovr || 70,
          ft: player.ovr || 70, playmaking: player.ovr || 70, ballHandling: player.ovr || 70,
          offensiveIQ: player.ovr || 70, defensiveIQ: player.ovr || 70,
          perimeterD: player.ovr || 70, postD: player.ovr || 70,
          rebounding: player.ovr || 70, athleticism: player.ovr || 70, strength: player.ovr || 70
        };
      }
      if (!player.mental) {
        player.mental = {
          leadership: 50 + Math.floor(Math.random() * 40),
          workEthic: 50 + Math.floor(Math.random() * 45),
          composure: 50 + Math.floor(Math.random() * 40),
          discipline: 50 + Math.floor(Math.random() * 40),
          coachability: 50 + Math.floor(Math.random() * 45)
        };
      }
      if (!player.hidden) {
        player.hidden = {
          greed: 40 + Math.floor(Math.random() * 50),
          loyalty: 40 + Math.floor(Math.random() * 55),
          marketPreference: ["Small", "Mid", "Large"][Math.floor(Math.random() * 3)],
          clutch: 45 + Math.floor(Math.random() * 45),
          popularity: player.ovr > 80 ? 60 + Math.floor(Math.random() * 35) : 35 + Math.floor(Math.random() * 45)
        };
      }
      if (!player.pot) player.pot = player.ovr + Math.floor(Math.random() * 10);
      if (!player.durability) player.durability = 55 + Math.floor(Math.random() * 40);
      if (!player.archetype) player.archetype = "Balanced Player";
      
      // Ensure personality traits exist
      if (!player.personality) {
        player.personality = generatePersonalityTraits(player.ovr, player.age, player.mental);
      }
      
      // Update header
      $("#profilePlayerName").textContent = player.name;
      $("#profilePlayerMeta").textContent = `${player.pos} ‚Ä¢ Age ${player.age} ‚Ä¢ ${player.height} ‚Ä¢ ${player.weight}lb`;
      
      // Update Core
      updateAttrDisplay("ovr", player.ovr, editMode);
      updateAttrDisplay("pot", player.pot, editMode);
      updateAttrDisplay("durability", player.durability, editMode);
      updateAttrDisplay("archetype", player.archetype, editMode, true);
      
      // Update Skills
      Object.keys(player.skills).forEach(skill => {
        updateAttrDisplay(skill, player.skills[skill], editMode);
      });
      
      // Update Mental
      Object.keys(player.mental).forEach(attr => {
        updateAttrDisplay(attr, player.mental[attr], editMode);
      });
      
      // Update Hidden
      updateAttrDisplay("greed", player.hidden.greed, editMode);
      updateAttrDisplay("loyalty", player.hidden.loyalty, editMode);
      updateAttrDisplay("clutch", player.hidden.clutch, editMode);
      updateAttrDisplay("popularity", player.hidden.popularity, editMode);
      updateAttrDisplay("marketPreference", player.hidden.marketPreference, editMode, true);
      
      // Update Personality Traits
      const personalityDesc = getPersonalityDescription(player.personality);
      const personalitySummary = $("#personality-summary");
      if (personalitySummary) personalitySummary.textContent = personalityDesc;
      
      updateAttrDisplay("p-leadership", player.personality.leadership, editMode);
      updateAttrDisplay("p-ego", player.personality.ego, editMode);
      updateAttrDisplay("p-competitiveness", player.personality.competitiveness, editMode);
      updateAttrDisplay("p-workEthic", player.personality.workEthic, editMode);
      updateAttrDisplay("p-coachability", player.personality.coachability, editMode);
      updateAttrDisplay("p-temper", player.personality.temper, editMode);
      updateAttrDisplay("p-loyalty", player.personality.loyalty, editMode);
      updateAttrDisplay("p-greed", player.personality.greed, editMode);
      updateAttrDisplay("p-mediaSavvy", player.personality.mediaSavvy, editMode);
      updateAttrDisplay("p-clutch", player.personality.clutch, editMode);
      updateAttrDisplay("p-discipline", player.personality.discipline, editMode);
      updateAttrDisplay("p-resilience", player.personality.resilience, editMode);
      updateAttrDisplay("p-charisma", player.personality.charisma, editMode);
      updateAttrDisplay("p-professionalism", player.personality.professionalism, editMode);
      updateAttrDisplay("p-socialType", player.personality.socialType, editMode, true);
      updateAttrDisplay("p-motivation", player.personality.motivation, editMode, true);
      updateAttrDisplay("p-marketPreference", player.personality.marketPreference, editMode, true);
      
      $("#toggleProfileEdit").textContent = editMode ? "Save" : "Edit";
    }
    
    function updateAttrDisplay(attrName, value, editMode, isText = false) {
      const valueEl = $(`#attr-${attrName}`);
      const barEl = $(`.attr-bar[data-attr="${attrName}"]`);
      
      if (!valueEl) return;
      
      if (editMode && !isText) {
        // Replace with slider
        const container = valueEl.parentElement;
        if (container && !container.querySelector('input[type="range"]')) {
          const slider = document.createElement("input");
          slider.type = "range";
          slider.min = "25";
          slider.max = "99";
          slider.value = value;
          slider.dataset.attr = attrName;
          slider.style.position = "absolute";
          slider.style.left = "0";
          slider.style.right = "0";
          slider.style.top = "0";
          slider.style.bottom = "0";
          slider.style.opacity = "0.8";
          slider.style.cursor = "pointer";
          
          slider.addEventListener("input", (e) => {
            const newVal = parseInt(e.target.value);
            valueEl.textContent = newVal;
            if (barEl) barEl.style.width = `${newVal}%`;
          });
          
          container.appendChild(slider);
        }
      } else if (editMode && isText && attrName === "marketPreference") {
        // Replace with select
        const textEl = $(`#attr-marketPreference`);
        if (textEl && !textEl.parentElement.querySelector('select')) {
          const select = document.createElement("select");
          select.className = "attr-select";
          select.innerHTML = `
            <option value="Small" ${value === "Small" ? "selected" : ""}>Small Market</option>
            <option value="Mid" ${value === "Mid" ? "selected" : ""}>Mid Market</option>
            <option value="Large" ${value === "Large" ? "selected" : ""}>Large Market</option>
          `;
          textEl.replaceWith(select);
        }
      } else {
        // View mode - remove sliders if they exist
        const container = valueEl.parentElement;
        const existingSlider = container?.querySelector('input[type="range"]');
        if (existingSlider) existingSlider.remove();
        
        if (isText) {
          valueEl.textContent = value;
        } else {
          valueEl.textContent = value;
          if (barEl) barEl.style.width = `${value}%`;
        }
      }
    }
    
    $("#closeProfileModal")?.addEventListener("click", () => {
      $("#profileModal").style.display = "none";
      isProfileEditMode = false;
    });
    
    $("#toggleProfileEdit")?.addEventListener("click", () => {
      if (!currentProfilePlayer) return;
      
      if (isProfileEditMode) {
        // Save changes
        savePlayerProfileChanges(currentProfilePlayer);
        isProfileEditMode = false;
        renderPlayerProfile(currentProfilePlayer, false);
        rerenderAll();
        toast("Player updated!");
      } else {
        // Enter edit mode
        isProfileEditMode = true;
        renderPlayerProfile(currentProfilePlayer, true);
      }
    });
    
    function savePlayerProfileChanges(player) {
      // Collect all slider values
      document.querySelectorAll('#profileContent input[type="range"]').forEach(slider => {
        const attr = slider.dataset.attr;
        const value = parseInt(slider.value);
        
        // Update the appropriate object
        if (attr === "ovr") player.ovr = value;
        else if (attr === "pot") player.pot = value;
        else if (attr === "durability") player.durability = value;
        else if (player.skills && player.skills.hasOwnProperty(attr)) {
          player.skills[attr] = value;
        } else if (player.mental && player.mental.hasOwnProperty(attr)) {
          player.mental[attr] = value;
        } else if (player.hidden && player.hidden.hasOwnProperty(attr)) {
          player.hidden[attr] = value;
        }
      });
      
      // Get market preference if changed
      const marketSelect = $("#profileContent select.attr-select");
      if (marketSelect && player.hidden) {
        player.hidden.marketPreference = marketSelect.value;
      }
      
      // Recalculate OVR from skills
      if (player.skills) {
        player.ovr = calculateOVR(player.skills, player.pos);
      }
      
      save(STATE);
    }
    
    function renderTeamTotals() {
      const avgAgeEl = $("#avgAge");
      const avgOVREl = $("#avgOVR");
      const totalSalaryEl = $("#totalSalary");
      const avgMoraleEl = $("#avgMorale");
      
      // Get the appropriate roster
      const roster = currentViewingTeam === "myTeam" 
        ? STATE.roster 
        : (STATE.leagueRosters[currentViewingTeam] || []);
      
      if (!roster.length || !avgAgeEl || !avgOVREl || !totalSalaryEl || !avgMoraleEl) return;
      
      const avgAge = (sum(roster, p => p.age) / roster.length).toFixed(1);
      const avgOVR = (sum(roster, p => p.ovr) / roster.length).toFixed(1);
      const totalSalary = sum(roster, p => p.salary);
      const avgMorale = (sum(roster, p => p.morale || 50) / roster.length).toFixed(0);
      
      avgAgeEl.textContent = avgAge;
      avgOVREl.textContent = avgOVR;
      totalSalaryEl.textContent = fmt(totalSalary);
      avgMoraleEl.textContent = avgMorale;
    }

    // Add Player Modal (keeping existing functionality)
    const modal = $("#modal");
    $("#addPlayerBtn")?.addEventListener("click", ()=> modal.style.display="flex");
    $("#closeModal")?.addEventListener("click", ()=> modal.style.display="none");
    $("#submitPlayer")?.addEventListener("click", ()=>{
      const name = $("#pName").value.trim();
      if(!name){ alert("Name required."); return; }
      const pos = $("#pPos").value;
      const age = Number($("#pAge").value)||24;
      const ovr = Number($("#pOvr").value)||70;
      const salary = Number($("#pSalary").value)||0;
      const years = Number($("#pYears").value)||1;
      const notes = $("#pNotes").value.trim();
      
      // Generate height/weight based on position
      let height, weight;
      if (pos === "PG") { height = "6'2\""; weight = 190; }
      else if (pos === "SG") { height = "6'5\""; weight = 205; }
      else if (pos === "SF") { height = "6'7\""; weight = 220; }
      else if (pos === "PF") { height = "6'9\""; weight = 235; }
      else { height = "6'11\""; weight = 250; }
      
      // Generate full attributes for new player
      const baseSkill = ovr;
      const variance = 10;
      const skills = {
        inside: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        mid: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        three: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        ft: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        playmaking: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        ballHandling: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        offensiveIQ: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        defensiveIQ: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        perimeterD: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        postD: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        rebounding: Math.max(30, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        athleticism: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance))),
        strength: Math.max(40, Math.min(99, baseSkill + (Math.random() * variance * 2 - variance)))
      };
      
      // Round all skills
      Object.keys(skills).forEach(key => {
        skills[key] = Math.round(skills[key]);
      });
      
      const mental = {
        leadership: 45 + Math.floor(Math.random() * 50),
        workEthic: 50 + Math.floor(Math.random() * 45),
        composure: 45 + Math.floor(Math.random() * 50),
        discipline: 45 + Math.floor(Math.random() * 50),
        coachability: 50 + Math.floor(Math.random() * 45)
      };
      
      const hidden = {
        greed: 35 + Math.floor(Math.random() * 55),
        loyalty: 40 + Math.floor(Math.random() * 55),
        marketPreference: ["Small", "Mid", "Large"][Math.floor(Math.random() * 3)],
        clutch: 45 + Math.floor(Math.random() * 45),
        popularity: ovr > 80 ? 65 + Math.floor(Math.random() * 30) : 35 + Math.floor(Math.random() * 50)
      };
      
      const archetypes = {
        PG: ["Floor General", "Scoring Guard", "Defensive Pest", "Combo Guard"],
        SG: ["3&D Wing", "Shot Creator", "Slasher", "Volume Scorer"],
        SF: ["Two-Way Wing", "Point Forward", "3PT Specialist", "Athletic Finisher"],
        PF: ["Stretch Four", "Power Forward", "Rim Protector", "Face-Up Big"],
        C: ["Paint Beast", "Stretch Five", "Defensive Anchor", "Pick & Roll Big"]
      };
      const archetype = archetypes[pos][Math.floor(Math.random() * archetypes[pos].length)];
      
      // Generate bio data
      const draftInfo = generateDraftInfo(age, ovr);
      const shoots = Math.random() > 0.12 ? "Right" : "Left";
      const birthDate = `${Math.floor(Math.random() * 12) + 1}/${Math.floor(Math.random() * 28) + 1}/${2026 - age}`;
      
      const bio = {
        fullName: name,
        nickname: generateNickname(name, archetype, ovr),
        shoots,
        birthDate,
        birthplace: generateBirthplace(),
        college: generateCollege(),
        draftTeam: LEAGUE_TEAMS[Math.floor(Math.random() * LEAGUE_TEAMS.length)],
        draftYear: draftInfo.draftYear,
        draftPick: draftInfo.draftPick,
        experience: age - 19,
        awards: generateAwards(ovr, age, archetype),
        seasonStats: generateSeasonStats(ovr, pos),
        careerStats: generateSeasonStats(ovr - Math.floor(Math.random() * 5), pos),
        bioText: generateBioText(name, archetype, mental, ovr)
      };
      
      STATE.roster.push({
        id:uid(), name, pos, age, ovr, 
        pot: Math.min(99, ovr + Math.floor(Math.random() * 10)),
        salary, years, notes,
        height, weight, 
        morale: 75, 
        status: "healthy",
        durability: 60 + Math.floor(Math.random() * 35),
        archetype,
        skills,
        mental,
        hidden,
        bio
      });
      addEvent(`${name} signed a ${years}-yr deal for ${fmt(salary)}.`, "league");
      modal.style.display="none";
      clearModalInputs();
      rerenderAll();
    });
    
    function clearModalInputs(){
      ["pName","pAge","pOvr","pSalary","pYears","pNotes"].forEach(id=>{ 
        const el = $("#"+id); 
        if(el) el.value = el.type==="number" ? el.value : "";
      });
    }
    
    // Edit Player Modal
    function openEditPlayerModal(player) {
      const editModal = document.createElement("div");
      editModal.className = "modal-backdrop";
      editModal.style.display = "flex";
      editModal.innerHTML = `
        <div class="modal">
          <header style="padding:16px; display:flex; justify-content:space-between; align-items:center">
            <h2 style="margin:0">Edit ${escapeHtml(player.name)}</h2>
            <button class="btn ghost" id="closeEditModal">‚úï</button>
          </header>
          <div class="content">
            <div class="form">
              <div class="full">
                <label>Overall (OVR)</label>
                <input type="number" id="editOvr" value="${player.ovr}" min="40" max="99">
              </div>
              <div>
                <label>Salary</label>
                <input type="number" id="editSalary" value="${player.salary}" min="0">
              </div>
              <div>
                <label>Years</label>
                <input type="number" id="editYears" value="${player.years}" min="1" max="5">
              </div>
              <div>
                <label>Morale</label>
                <input type="number" id="editMorale" value="${player.morale || 75}" min="0" max="100">
              </div>
              <div>
                <label>Status</label>
                <select id="editStatus">
                  <option value="healthy" ${player.status === "healthy" ? "selected" : ""}>Healthy</option>
                  <option value="injured" ${player.status === "injured" ? "selected" : ""}>Injured</option>
                  <option value="twoway" ${player.status === "twoway" ? "selected" : ""}>Two-Way</option>
                </select>
              </div>
              <div class="full">
                <label>Notes</label>
                <input type="text" id="editNotes" value="${escapeHtml(player.notes || "")}">
              </div>
            </div>
            <div style="margin-top:16px; display:flex; gap:8px">
              <button class="btn good" id="saveEdit" style="flex:1">Save Changes</button>
              <button class="btn ghost" id="cancelEdit">Cancel</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(editModal);
      
      editModal.querySelector("#closeEditModal").addEventListener("click", () => editModal.remove());
      editModal.querySelector("#cancelEdit").addEventListener("click", () => editModal.remove());
      editModal.querySelector("#saveEdit").addEventListener("click", () => {
        player.ovr = Number(editModal.querySelector("#editOvr").value);
        player.salary = Number(editModal.querySelector("#editSalary").value);
        player.years = Number(editModal.querySelector("#editYears").value);
        player.morale = Number(editModal.querySelector("#editMorale").value);
        player.status = editModal.querySelector("#editStatus").value;
        player.notes = editModal.querySelector("#editNotes").value;
        
        addEvent(`Updated ${player.name}'s contract and status.`, "league");
        editModal.remove();
        rerenderAll();
      });
    }

    // -------------------------------
    // Cap Sheet
    // -------------------------------
    function renderCapSheet(){
      const {cap,tax,apron1,apron2} = STATE.meta.rules;
      $("#capNum").textContent = fmt(cap);
      $("#taxNum").textContent = fmt(tax);
      $("#apron1Num").textContent = fmt(apron1);
      $("#apron2Num").textContent = fmt(apron2);

      const body = $("#capBody");
      if(!STATE.roster.length){ body.innerHTML = `<tr><td colspan="5" class="empty">No contracts on the books.</td></tr>`; return; }
      body.innerHTML = STATE.roster.map(p=>{
        const y1 = p.salary;
        const y2 = Math.round(p.years>=2 ? p.salary*1.05 : 0);
        const y3 = Math.round(p.years>=3 ? y2*1.05 : 0);
        const opt = /opt|option/i.test(p.notes||"") ? "Team Opt" : "";
        return `<tr>
          <td>${escapeHtml(p.name)}</td>
          <td class="num">${y1?fmt(y1):"-"}</td>
          <td class="num">${y2?fmt(y2):"-"}</td>
          <td class="num">${y3?fmt(y3):"-"}</td>
          <td class="num">${opt||"-"}</td>
        </tr>`;
      }).join("");
    }

    // -------------------------------
    // Trades (stub) & Draft (stub)
    // -------------------------------
    $("#tradeIdea").addEventListener("click", ()=>{
      const need = inferTeamNeed();
      $("#tradeArea").className="";
      $("#tradeArea").innerHTML = `
        <div style="padding:8px 0">
          <strong>Idea:</strong> Package your ${need} + 2028 1st (top-10 protected) for a higher-OVR wing on an expiring. This keeps future cap space flexible while addressing your rotation.
        </div>
        <div class="tag">Prototype logic ‚Äî to be replaced with real matching & AI preferences.</div>
      `;
    });

    // -------------------------------
    // Free Agency Rendering & Handlers
    // -------------------------------
    let currentFASort = "ovr";
    let currentFAFilter = "all";
    let currentFASearch = "";
    let showInterestedOnly = false;
    let selectedFA = null;

    function renderFreeAgency() {
      const faPlayerList = $("#faPlayerList");
      const faCount = $("#faCount");
      const topFAList = $("#topFAList");
      
      if (!faPlayerList || !STATE.freeAgents) return;
      
      let freeAgents = [...STATE.freeAgents];
      
      // Apply filters
      if (currentFAFilter !== "all") {
        if (currentFAFilter === "guards") {
          freeAgents = freeAgents.filter(fa => fa.pos === "PG" || fa.pos === "SG");
        } else if (currentFAFilter === "wings") {
          freeAgents = freeAgents.filter(fa => fa.pos === "SF");
        } else if (currentFAFilter === "bigs") {
          freeAgents = freeAgents.filter(fa => fa.pos === "PF" || fa.pos === "C");
        }
      }
      
      // Search filter
      if (currentFASearch) {
        freeAgents = freeAgents.filter(fa => 
          fa.name.toLowerCase().includes(currentFASearch) ||
          fa.pos.toLowerCase().includes(currentFASearch)
        );
      }
      
      // Interested only filter
      if (showInterestedOnly) {
        freeAgents = freeAgents.filter(fa => fa.interest >= 50);
      }
      
      // Sort
      if (currentFASort === "ovr") {
        freeAgents.sort((a, b) => b.ovr - a.ovr);
      } else if (currentFASort === "age") {
        freeAgents.sort((a, b) => a.age - b.age);
      } else if (currentFASort === "salary") {
        freeAgents.sort((a, b) => b.askingSalary - a.askingSalary);
      } else if (currentFASort === "interest") {
        freeAgents.sort((a, b) => b.interest - a.interest);
      }
      
      // Update count
      if (faCount) {
        faCount.textContent = `${freeAgents.length} Available`;
      }
      
      // Render top free agents
      if (topFAList) {
        const topFAs = [...STATE.freeAgents].sort((a, b) => b.ovr - a.ovr).slice(0, 5);
        topFAList.innerHTML = topFAs.map(fa => 
          `<div class="top-fa-chip">${fa.name} <span class="ovr">${fa.ovr}</span></div>`
        ).join('');
      }
      
      // Render player list
      if (freeAgents.length === 0) {
        faPlayerList.innerHTML = '<div class="empty" style="padding:40px; text-align:center; color:var(--muted)">No free agents match your filters</div>';
        return;
      }
      
      faPlayerList.innerHTML = freeAgents.map(fa => {
        const interestLevel = fa.interest >= 70 ? "high" : fa.interest >= 40 ? "med" : "low";
        const isSelected = selectedFA && selectedFA.id === fa.id;
        
        return `
          <div class="fa-player-card ${isSelected ? 'selected' : ''}" data-fa-id="${fa.id}">
            <div class="fa-player-avatar">${fa.name.charAt(0)}</div>
            <div class="fa-player-info">
              <div class="fa-player-name">${escapeHtml(fa.name)}</div>
              <div class="fa-player-meta">
                <span>${fa.pos}</span>
                <span>‚Ä¢</span>
                <span>Age ${fa.age}</span>
                <span>‚Ä¢</span>
                <span>${fa.archetype}</span>
                <span>‚Ä¢</span>
                <span class="tag" style="font-size:10px">${fa.faType}</span>
              </div>
            </div>
            <div class="fa-player-stats">
              <div class="fa-stat">
                <div class="fa-stat-label">OVR</div>
                <div class="fa-stat-value ovr">${fa.ovr}</div>
              </div>
              <div class="fa-stat">
                <div class="fa-stat-label">POT</div>
                <div class="fa-stat-value pot">${fa.pot}</div>
              </div>
              <div class="fa-stat">
                <div class="fa-stat-label">Ask</div>
                <div class="fa-stat-value">${fmt(fa.askingSalary)}</div>
              </div>
              <div class="fa-stat">
                <div class="fa-stat-label">Years</div>
                <div class="fa-stat-value">${fa.askingYears}y</div>
              </div>
            </div>
            <div class="fa-player-interest">
              <div class="fa-interest-label">Interest</div>
              <div class="fa-interest-bar">
                <div class="fa-interest-fill ${interestLevel}" style="width:${fa.interest}%"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Add click handlers
      $$(".fa-player-card").forEach(card => {
        card.addEventListener("click", () => {
          const faId = card.dataset.faId;
          const fa = STATE.freeAgents.find(f => f.id === faId);
          if (fa) {
            selectedFA = fa;
            renderFreeAgency();
            renderFADetail(fa);
          }
        });
      });
    }
    
    function renderFADetail(fa) {
      const faDetailContent = $("#faDetailContent");
      if (!faDetailContent) return;
      
      const totalSalary = sum(STATE.roster, p => p.salary);
      const capSpace = STATE.meta.rules.cap - totalSalary;
      const canAfford = capSpace >= fa.askingSalary;
      const rosterFull = STATE.roster.length >= STATE.meta.rules.rosterLimit;
      
      const interestLevel = fa.interest >= 70 ? "high" : fa.interest >= 40 ? "med" : "low";
      const interestText = fa.interest >= 70 ? "High interest - good chance of signing" :
                          fa.interest >= 50 ? "Moderate interest - possible signing" :
                          fa.interest >= 30 ? "Low interest - unlikely to sign" :
                          "Very low interest - almost no chance";
      
      faDetailContent.innerHTML = `
        <div class="fa-detail-content">
          <div class="fa-detail-header">
            <div class="fa-detail-avatar">${fa.name.charAt(0)}</div>
            <div class="fa-detail-name">${escapeHtml(fa.name)}</div>
            <div class="fa-detail-meta">${fa.pos} ‚Ä¢ Age ${fa.age} ‚Ä¢ ${fa.height} ‚Ä¢ ${fa.weight}lb</div>
          </div>
          
          <div class="fa-detail-section">
            <h3>Team Interest</h3>
            <div style="margin-bottom:8px">
              <div class="fa-interest-bar" style="height:12px">
                <div class="fa-interest-fill ${interestLevel}" style="width:${fa.interest}%"></div>
              </div>
            </div>
            <div style="font-size:12px; color:var(--muted)">${interestText}</div>
          </div>
          
          <div class="fa-detail-section">
            <h3>Player Demands</h3>
            <div class="fa-detail-grid">
              <div class="fa-detail-item">
                <label>Salary</label>
                <value>${fmt(fa.askingSalary)}</value>
              </div>
              <div class="fa-detail-item">
                <label>Years</label>
                <value>${fa.askingYears}</value>
              </div>
              <div class="fa-detail-item">
                <label>Role</label>
                <value>${fa.askingRole}</value>
              </div>
              <div class="fa-detail-item">
                <label>Type</label>
                <value>${fa.faType}</value>
              </div>
            </div>
          </div>
          
          <div class="fa-detail-section">
            <h3>Attributes</h3>
            <div class="fa-detail-grid">
              <div class="fa-detail-item">
                <label>Overall</label>
                <value style="color:var(--pri)">${fa.ovr}</value>
              </div>
              <div class="fa-detail-item">
                <label>Potential</label>
                <value style="color:var(--good)">${fa.pot}</value>
              </div>
              <div class="fa-detail-item">
                <label>Durability</label>
                <value>${fa.durability}</value>
              </div>
              <div class="fa-detail-item">
                <label>Archetype</label>
                <value style="font-size:12px">${fa.archetype}</value>
              </div>
            </div>
          </div>
          
          <div class="fa-detail-section">
            <h3>Cap Situation</h3>
            <div class="fa-detail-grid">
              <div class="fa-detail-item">
                <label>Available Cap</label>
                <value style="color:${canAfford ? 'var(--good)' : 'var(--bad)'}">${fmt(capSpace)}</value>
              </div>
              <div class="fa-detail-item">
                <label>Roster Spots</label>
                <value style="color:${rosterFull ? 'var(--bad)' : 'var(--good)'}">
                  ${STATE.roster.length}/${STATE.meta.rules.rosterLimit}
                </value>
              </div>
            </div>
          </div>
          
          <div class="fa-detail-section">
            <button class="fa-offer-button" id="makeOfferBtn" 
              ${!canAfford || rosterFull ? 'disabled' : ''}>
              ${!canAfford ? '‚ùå Insufficient Cap Space' :
                rosterFull ? '‚ùå Roster Full' :
                '‚úÖ Make Contract Offer'}
            </button>
            ${!canAfford ? '<div style="font-size:12px; color:var(--bad); text-align:center; margin-top:8px">Need ' + fmt(fa.askingSalary - capSpace) + ' more cap space</div>' : ''}
            ${rosterFull ? '<div style="font-size:12px; color:var(--bad); text-align:center; margin-top:8px">Release a player to make room</div>' : ''}
          </div>
        </div>
      `;
      
      // Add offer button handler
      const makeOfferBtn = $("#makeOfferBtn");
      if (makeOfferBtn && !makeOfferBtn.disabled) {
        makeOfferBtn.addEventListener("click", () => openContractModal(fa));
      }
    }
    
    function openContractModal(fa) {
      const modal = $("#contractModal");
      const contractPlayerName = $("#contractPlayerName");
      const contractPlayerMeta = $("#contractPlayerMeta");
      const contractInterestValue = $("#contractInterestValue");
      const contractInterestBar = $("#contractInterestBar");
      const contractInterestText = $("#contractInterestText");
      const contractAskingSalary = $("#contractAskingSalary");
      const contractAskingYears = $("#contractAskingYears");
      const contractAskingRole = $("#contractAskingRole");
      const offerSalary = $("#offerSalary");
      const offerYears = $("#offerYears");
      const offerRole = $("#offerRole");
      const contractCurrentCap = $("#contractCurrentCap");
      const contractAfterCap = $("#contractAfterCap");
      const contractResult = $("#contractResult");
      
      if (!modal) return;
      
      const totalSalary = sum(STATE.roster, p => p.salary);
      const capSpace = STATE.meta.rules.cap - totalSalary;
      
      contractPlayerName.textContent = `Contract Offer: ${fa.name}`;
      contractPlayerMeta.textContent = `${fa.pos} ‚Ä¢ Age ${fa.age} ‚Ä¢ OVR ${fa.ovr}`;
      contractInterestValue.textContent = `${fa.interest}%`;
      contractInterestBar.style.width = `${fa.interest}%`;
      
      const interestText = fa.interest >= 70 ? "High interest - good chance of signing" :
                          fa.interest >= 50 ? "Moderate interest - possible signing" :
                          fa.interest >= 30 ? "Low interest - unlikely to sign" :
                          "Very low interest - almost no chance";
      contractInterestText.textContent = interestText;
      
      contractAskingSalary.textContent = fmt(fa.askingSalary);
      contractAskingYears.textContent = fa.askingYears;
      contractAskingRole.textContent = fa.askingRole;
      
      offerSalary.value = fa.askingSalary;
      offerYears.value = fa.askingYears;
      offerRole.value = fa.askingRole;
      
      contractCurrentCap.textContent = fmt(capSpace);
      contractAfterCap.textContent = fmt(capSpace - fa.askingSalary);
      
      // Update cap impact on input change
      const updateCapImpact = () => {
        const salary = parseInt(offerSalary.value) || 0;
        contractAfterCap.textContent = fmt(capSpace - salary);
      };
      offerSalary.addEventListener("input", updateCapImpact);
      
      contractResult.style.display = "none";
      
      modal.style.display = "flex";
    }
    
    function closeContractModal() {
      const modal = $("#contractModal");
      if (modal) modal.style.display = "none";
    }
    
    function submitContractOffer() {
      if (!selectedFA) return;
      
      const offerSalary = parseInt($("#offerSalary").value) || 0;
      const offerYears = parseInt($("#offerYears").value) || 1;
      const offerRole = $("#offerRole").value;
      const contractResult = $("#contractResult");
      
      // Validation
      const totalSalary = sum(STATE.roster, p => p.salary);
      const capSpace = STATE.meta.rules.cap - totalSalary;
      
      if (offerSalary > capSpace) {
        contractResult.style.display = "block";
        contractResult.style.background = "rgba(255,107,107,0.15)";
        contractResult.style.border = "1px solid var(--bad)";
        contractResult.style.color = "var(--bad)";
        contractResult.textContent = "‚ùå Insufficient cap space for this offer!";
        return;
      }
      
      if (STATE.roster.length >= STATE.meta.rules.rosterLimit) {
        contractResult.style.display = "block";
        contractResult.style.background = "rgba(255,107,107,0.15)";
        contractResult.style.border = "1px solid var(--bad)";
        contractResult.style.color = "var(--bad)";
        contractResult.textContent = "‚ùå Roster is full! Release a player first.";
        return;
      }
      
      // Calculate acceptance probability
      let acceptChance = selectedFA.interest;
      
      // Salary factor
      const salaryRatio = offerSalary / selectedFA.askingSalary;
      if (salaryRatio >= 1.2) acceptChance += 20;
      else if (salaryRatio >= 1.0) acceptChance += 10;
      else if (salaryRatio >= 0.9) acceptChance += 0;
      else if (salaryRatio >= 0.8) acceptChance -= 15;
      else acceptChance -= 30;
      
      // Years factor
      if (offerYears >= selectedFA.askingYears) acceptChance += 10;
      else if (offerYears < selectedFA.askingYears - 1) acceptChance -= 15;
      
      // Role factor
      const roleRanking = { "Starter": 3, "Bench": 2, "Reserve": 1 };
      const askedRole = roleRanking[selectedFA.askingRole] || 2;
      const offeredRole = roleRanking[offerRole] || 2;
      if (offeredRole >= askedRole) acceptChance += 5;
      else acceptChance -= 20;
      
      acceptChance = Math.max(0, Math.min(100, acceptChance));
      
      // Decision
      const accepted = Math.random() * 100 < acceptChance;
      
      if (accepted) {
        // Sign the player!
        const newPlayer = {
          id: uid(),
          name: selectedFA.name,
          pos: selectedFA.pos,
          age: selectedFA.age,
          ovr: selectedFA.ovr,
          pot: selectedFA.pot,
          height: selectedFA.height,
          weight: selectedFA.weight,
          salary: offerSalary,
          years: offerYears,
          morale: 70 + Math.floor(Math.random() * 20),
          status: "healthy",
          archetype: selectedFA.archetype,
          durability: selectedFA.durability,
          skills: selectedFA.skills,
          mental: selectedFA.mental,
          hidden: selectedFA.hidden,
          notes: selectedFA.notes
        };
        
        STATE.roster.push(newPlayer);
        STATE.freeAgents = STATE.freeAgents.filter(fa => fa.id !== selectedFA.id);
        
        // Fan hype update for signings
        if (selectedFA.ovr >= 85) {
          updateFanHype(15, `Signing superstar ${selectedFA.name}`);
        } else if (selectedFA.ovr >= 75) {
          updateFanHype(8, `Adding quality talent ${selectedFA.name}`);
        } else if (selectedFA.ovr >= 70) {
          updateFanHype(3, `Bringing in solid contributor ${selectedFA.name}`);
        }
        
        addEvent(`‚úÖ Signed ${selectedFA.name} to a ${offerYears}-year, ${fmt(offerSalary)} contract!`, "transaction");
        save(STATE);
        
        contractResult.style.display = "block";
        contractResult.style.background = "rgba(58,198,121,0.15)";
        contractResult.style.border = "1px solid var(--good)";
        contractResult.style.color = "var(--good)";
        contractResult.textContent = `‚úÖ ${selectedFA.name} has accepted your offer!`;
        
        setTimeout(() => {
          closeContractModal();
          selectedFA = null;
          renderFreeAgency();
          rerenderAll();
          toast(`Signed ${newPlayer.name}!`);
        }, 2000);
        
      } else {
        contractResult.style.display = "block";
        contractResult.style.background = "rgba(255,107,107,0.15)";
        contractResult.style.border = "1px solid var(--bad)";
        contractResult.style.color = "var(--bad)";
        contractResult.textContent = `‚ùå ${selectedFA.name} declined your offer (${Math.round(acceptChance)}% chance). Try improving the offer or targeting another player.`;
      }
    }
    
    // Free Agency Event Handlers
    $("#faSortBy")?.addEventListener("change", (e) => {
      currentFASort = e.target.value;
      renderFreeAgency();
    });
    
    $$("[data-fa-pos]").forEach(btn => {
      btn.addEventListener("click", () => {
        $$("[data-fa-pos]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFAFilter = btn.dataset.faPos;
        renderFreeAgency();
      });
    });
    
    $("#faSearch")?.addEventListener("input", (e) => {
      currentFASearch = e.target.value.toLowerCase();
      renderFreeAgency();
    });
    
    // Draft Event Handlers
    $("#generateProspectsBtn")?.addEventListener("click", () => window.generateProspects());
    $("#startDraftBtn")?.addEventListener("click", () => window.startDraft());
    $("#autoDraftBtn")?.addEventListener("click", () => window.autoDraftUser());
    
    // Schedule Event Handlers
    $("#generateScheduleBtn")?.addEventListener("click", () => {
      console.log("Force generating 170-day schedule...");
      
      // Initialize rivalries on first schedule generation
      initializeRivalries();
      
      STATE.schedule = {
        games: generateDayBasedSchedule(STATE.meta.teamName),
        currentDay: 1,
        selectedGame: null,
        elo: 1500,
        leagueElos: initializeLeagueElos()
      };
      save(STATE);
      renderSchedule();
      toast("170-day schedule generated with 82 games!");
    });
    
    $("#simGame")?.addEventListener("click", () => {
      const myTeam = STATE.meta.teamName;
      const nextGame = STATE.schedule.games.find(g => 
        g.status === "upcoming" && (g.homeTeam === myTeam || g.awayTeam === myTeam)
      );
      if (nextGame) {
        simulateGame(nextGame);
        renderSchedule();
        toast("Game simulated!");
      }
    });
    
    $("#simWeek")?.addEventListener("click", () => {
      const myTeam = STATE.meta.teamName;
      const currentDay = STATE.schedule.currentDay || 1;
      const weekEnd = currentDay + 7;
      
      const weekGames = STATE.schedule.games.filter(g => {
        return g.status === "upcoming" && 
               g.day >= currentDay && 
               g.day < weekEnd &&
               (g.homeTeam === myTeam || g.awayTeam === myTeam);
      });
      
      weekGames.forEach(g => simulateGame(g));
      
      // Decay rivalries every 30 days
      if (currentDay % 30 === 0) {
        decayRivalryHeat();
      }
      
      renderSchedule();
      toast(`Simulated ${weekGames.length} game(s)!`);
    });
    
    $("#simMonth")?.addEventListener("click", () => {
      const myTeam = STATE.meta.teamName;
      const currentDay = STATE.schedule.currentDay || 1;
      const monthEnd = currentDay + 30;
      
      const monthGames = STATE.schedule.games.filter(g => {
        return g.status === "upcoming" && 
               g.day >= currentDay && 
               g.day < monthEnd &&
               (g.homeTeam === myTeam || g.awayTeam === myTeam);
      });
      
      monthGames.forEach(g => simulateGame(g));
      
      // Decay rivalries after each month simulation
      decayRivalryHeat();
      
      renderSchedule();
      toast(`Simulated ${monthGames.length} game(s)!`);
    });
    
    // Draft detail tabs
    $$("[data-draft-tab]").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.draftTab;
        $$("[data-draft-tab]").forEach(b => b.classList.toggle("active", b === btn));
        $$("[data-draft-panel]").forEach(panel => {
          panel.hidden = panel.dataset.draftPanel !== tab;
        });
      });
    });
    
    $("#showInterestedOnly")?.addEventListener("change", (e) => {
      showInterestedOnly = e.target.checked;
      renderFreeAgency();
    });
    
    $("#advanceDayFA")?.addEventListener("click", () => {
      advanceFreeAgencyDay();
    });
    
    $("#closeContractModal")?.addEventListener("click", closeContractModal);
    $("#cancelOffer")?.addEventListener("click", closeContractModal);
    $("#submitOffer")?.addEventListener("click", submitContractOffer);

    // -------------------------------
    // Coaching System
    // -------------------------------
    
    let currentCoachSelection = null;
    
    function renderCoaching() {
      if (!STATE.coaches) {
        STATE.coaches = {
          head: generateCoach("head", "solid"),
          assistants: [
            generateCoach("assistant", "solid"),
            generateCoach("assistant", "developing")
          ],
          candidates: generateCoachCandidates(12)
        };
      }
      
      // Render Head Coach
      renderCoachCard(STATE.coaches.head, $("#headCoachCard"), true);
      
      // Render Assistants
      const assistantsGrid = $("#assistantsGrid");
      assistantsGrid.innerHTML = "";
      STATE.coaches.assistants.forEach(coach => {
        const card = document.createElement("div");
        card.className = "coach-card";
        assistantsGrid.appendChild(card);
        renderCoachCard(coach, card, false);
      });
      
      // Render Candidates
      const candidatesGrid = $("#candidatesGrid");
      candidatesGrid.innerHTML = "";
      STATE.coaches.candidates.forEach(coach => {
        const card = document.createElement("div");
        card.className = "coach-card candidate-card";
        candidatesGrid.appendChild(card);
        renderCoachCard(coach, card, false, true);
      });
    }
    
    function renderCoachCard(coach, container, isHead = false, isCandidate = false) {
      const boost = getCoachingBoost(coach);
      const trust = coach.trust || 70;
      const trustClass = trust >= 70 ? "high" : trust >= 40 ? "medium" : "low";
      
      container.innerHTML = `
        <div class="coach-header">
          <div class="coach-name-section">
            <div class="coach-name">${coach.name}</div>
            <div class="coach-meta">
              <span>Age ${coach.age}</span>
              <span>‚Ä¢</span>
              <span>${coach.archetype}</span>
              <span>‚Ä¢</span>
              <span style="color:var(--muted)">${coach.personality}</span>
            </div>
          </div>
          <div class="coach-actions">
            ${isHead ? `<span class="coach-role-badge">Head Coach</span>` : 
              isCandidate ? '' : `<span class="coach-role-badge" style="border-color:var(--text-1); color:var(--text-1)">Assistant</span>`}
          </div>
        </div>
        
        ${!isCandidate ? `
          <div class="coach-trust-section">
            <div class="trust-label">Trust Level</div>
            <div class="trust-bar-container">
              <div class="trust-bar-fill ${trustClass}" style="width:${trust}%"></div>
            </div>
            <div class="trust-value">${trust}/100</div>
          </div>
        ` : ''}
        
        <div class="coach-style-section">
          <div class="coach-style-box">
            <div class="coach-style-title">Coaching Style</div>
            <div class="coach-style-value">${coach.style.name}</div>
            <div style="font-size:11px; color:var(--muted); margin-top:4px">${coach.style.focus}</div>
          </div>
          
          <div class="coach-style-box">
            <div class="coach-style-title">Team Impact</div>
            <div class="coach-style-value">+${boost.team} Rating</div>
            <div style="font-size:11px; color:var(--muted); margin-top:4px">${boost.development.toFixed(2)}x Development</div>
          </div>
        </div>
        
        <div class="coach-style-bars">
          <div class="coach-style-bar-item">
            <div class="coach-style-bar-label">Offense</div>
            <div class="attr-bar-container">
              <div class="attr-bar blue" style="width:${coach.style.offense}%"></div>
            </div>
            <div style="font-size:11px; text-align:center; color:var(--text-1); margin-top:2px">${coach.style.offense}</div>
          </div>
          <div class="coach-style-bar-item">
            <div class="coach-style-bar-label">Defense</div>
            <div class="attr-bar-container">
              <div class="attr-bar blue" style="width:${coach.style.defense}%"></div>
            </div>
            <div style="font-size:11px; text-align:center; color:var(--text-1); margin-top:2px">${coach.style.defense}</div>
          </div>
          <div class="coach-style-bar-item">
            <div class="coach-style-bar-label">Pace</div>
            <div class="attr-bar-container">
              <div class="attr-bar blue" style="width:${coach.style.pace}%"></div>
            </div>
            <div style="font-size:11px; text-align:center; color:var(--text-1); margin-top:2px">${coach.style.pace}</div>
          </div>
        </div>
        
        <div class="coach-attrs-grid" style="margin-top:16px">
          <div class="coach-attr-item">
            <span class="coach-attr-label">Offensive IQ</span>
            <span class="coach-attr-value">${coach.attributes.offensiveIQ}</span>
          </div>
          <div class="coach-attr-item">
            <span class="coach-attr-label">Defensive IQ</span>
            <span class="coach-attr-value">${coach.attributes.defensiveIQ}</span>
          </div>
          <div class="coach-attr-item">
            <span class="coach-attr-label">Development</span>
            <span class="coach-attr-value">${coach.attributes.development}</span>
          </div>
          <div class="coach-attr-item">
            <span class="coach-attr-label">Motivator</span>
            <span class="coach-attr-value">${coach.attributes.motivator}</span>
          </div>
          <div class="coach-attr-item">
            <span class="coach-attr-label">Adaptability</span>
            <span class="coach-attr-value">${coach.attributes.adaptability}</span>
          </div>
          <div class="coach-attr-item">
            <span class="coach-attr-label">Discipline</span>
            <span class="coach-attr-value">${coach.attributes.discipline}</span>
          </div>
          <div class="coach-attr-item">
            <span class="coach-attr-label">Loyalty</span>
            <span class="coach-attr-value">${coach.attributes.loyalty}</span>
          </div>
        </div>
        
        <div class="coach-contract-section">
          <div class="coach-contract-item">
            <div class="coach-contract-label">Salary</div>
            <div class="coach-contract-value">${fmt(coach.contract.salary)}</div>
          </div>
          <div class="coach-contract-item">
            <div class="coach-contract-label">Years Left</div>
            <div class="coach-contract-value">${coach.contract.yearsLeft}</div>
          </div>
          <div class="coach-contract-item">
            <div class="coach-contract-label">Record</div>
            <div class="coach-contract-value">${coach.record.wins}-${coach.record.losses}</div>
          </div>
        </div>
        
        ${isCandidate ? `
          <button class="btn good hire-coach-btn" onclick="openHireCoachModal('${coach.id}')">
            üíº Hire Coach
          </button>
        ` : `
          <button class="btn hire-coach-btn" onclick="openCoachProfile('${coach.id}', ${isHead})">
            üëÅ View Details
          </button>
        `}
      `;
    }
    
    function openCoachProfile(coachId, isHead) {
      let coach = null;
      if (isHead && STATE.coaches.head.id === coachId) {
        coach = STATE.coaches.head;
      } else {
        coach = STATE.coaches.assistants.find(c => c.id === coachId);
      }
      
      if (!coach) return;
      
      const modal = $("#coachProfileModal");
      $("#coachProfileName").textContent = coach.name;
      $("#coachProfileMeta").textContent = `Age ${coach.age} ‚Ä¢ ${isHead ? 'Head Coach' : 'Assistant Coach'} ‚Ä¢ ${coach.archetype}`;
      
      const trust = coach.trust || 70;
      $("#coachProfileTrust").textContent = trust;
      const trustBar = $("#coachProfileTrustBar");
      trustBar.style.width = `${trust}%`;
      trustBar.className = `trust-bar-fill ${trust >= 70 ? 'high' : trust >= 40 ? 'medium' : 'low'}`;
      
      $("#coachProfileContract").textContent = `${fmt(coach.contract.salary)} / ${coach.contract.years} yrs`;
      $("#coachProfileYearsLeft").textContent = `${coach.contract.yearsLeft} years remaining`;
      
      $("#coachProfileWins").textContent = coach.record.wins;
      $("#coachProfileLosses").textContent = coach.record.losses;
      const totalGames = coach.record.wins + coach.record.losses;
      $("#coachProfileWinPct").textContent = totalGames > 0 ? ((coach.record.wins / totalGames) * 100).toFixed(1) + '%' : '‚Äî';
      
      $("#coachProfileStyleName").textContent = coach.style.name;
      $("#coachProfileFocus").textContent = `Focus: ${coach.style.focus}`;
      $("#coachProfileOffBar").style.width = `${coach.style.offense}%`;
      $("#coachProfileDefBar").style.width = `${coach.style.defense}%`;
      $("#coachProfilePaceBar").style.width = `${coach.style.pace}%`;
      $("#coachProfileOffValue").textContent = coach.style.offense;
      $("#coachProfileDefValue").textContent = coach.style.defense;
      $("#coachProfilePaceValue").textContent = coach.style.pace;
      
      const attrsHtml = Object.entries(coach.attributes).map(([key, value]) => {
        const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        return `
          <div style="margin-bottom:6px">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px">
              <span style="color:var(--text-1)">${label}</span>
              <span style="color:var(--text-0); font-weight:700; font-family:var(--mono)">${value}</span>
            </div>
            <div class="attr-bar-container">
              <div class="attr-bar blue" style="width:${value}%"></div>
            </div>
          </div>
        `;
      }).join('');
      $("#coachProfileAttributes").innerHTML = attrsHtml;
      
      // Show/hide action buttons for current coaches
      const actionsDiv = $("#coachProfileActions");
      if (isHead || STATE.coaches.assistants.find(c => c.id === coachId)) {
        actionsDiv.style.display = "flex";
        $("#fireCoachBtn").onclick = () => openFireCoachModal(coachId, isHead);
      } else {
        actionsDiv.style.display = "none";
      }
      
      modal.style.display = "flex";
    }
    
    function openHireCoachModal(coachId) {
      const coach = STATE.coaches.candidates.find(c => c.id === coachId);
      if (!coach) return;
      
      currentCoachSelection = coach;
      
      const modal = $("#hireCoachModal");
      $("#hireCoachMeta").textContent = `Hiring: ${coach.name}`;
      
      const previewHtml = `
        <div class="panel" style="padding:16px; background:var(--bg-2)">
          <div style="font-size:16px; font-weight:700; margin-bottom:8px">${coach.name}</div>
          <div style="font-size:13px; color:var(--text-1); margin-bottom:12px">
            Age ${coach.age} ‚Ä¢ ${coach.archetype} ‚Ä¢ ${coach.personality}
          </div>
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; font-size:12px">
            <div>
              <div style="color:var(--muted)">Style</div>
              <div style="font-weight:600; color:var(--text-0)">${coach.style.name}</div>
            </div>
            <div>
              <div style="color:var(--muted)">Off IQ</div>
              <div style="font-weight:600; color:var(--text-0)">${coach.attributes.offensiveIQ}</div>
            </div>
            <div>
              <div style="color:var(--muted)">Def IQ</div>
              <div style="font-weight:600; color:var(--text-0)">${coach.attributes.defensiveIQ}</div>
            </div>
          </div>
        </div>
      `;
      $("#hireCoachPreview").innerHTML = previewHtml;
      
      $("#hireCoachSalary").textContent = fmt(coach.contract.salary);
      $("#hireCoachYears").textContent = `${coach.contract.years} years`;
      $("#hireCoachTotal").textContent = fmt(coach.contract.salary * coach.contract.years);
      
      const warningDiv = $("#hireCoachWarning");
      if (STATE.coaches.head) {
        warningDiv.style.display = "block";
      } else {
        warningDiv.style.display = "none";
      }
      
      $("#confirmHireBtn").disabled = false;
      modal.style.display = "flex";
    }
    
    function confirmHireCoach() {
      if (!currentCoachSelection) return;
      
      const coach = currentCoachSelection;
      
      // Check for owner intervention on expensive hires
      if (coach.contract.salary > 4_000_000) {
        const interventionCheck = checkOwnerIntervention("coachHiring", {
          coachName: coach.name,
          coachStyle: coach.style.name,
          salary: coach.contract.salary
        });
        
        if (interventionCheck.intervene) {
          $("#hireCoachModal").style.display = "none";
          showInterventionModal(interventionCheck.outcome, (allowed) => {
            if (allowed) {
              proceedWithHire();
            } else {
              toast("Owner vetoed the hire");
              currentCoachSelection = null;
              renderCoaching();
            }
          });
          return;
        }
      }
      
      proceedWithHire();
      
      function proceedWithHire() {
        // Fire current head coach if exists
        if (STATE.coaches.head) {
          addEvent(`Fired head coach ${STATE.coaches.head.name}.`, "league");
          updateFanHype(-8, `Firing head coach ${STATE.coaches.head.name}`);
        }
        
        // Hire new coach
        coach.role = "head";
        coach.trust = 70; // Start at neutral
        STATE.coaches.head = coach;
        
        // Remove from candidates
        STATE.coaches.candidates = STATE.coaches.candidates.filter(c => c.id !== coach.id);
        
        addEvent(`Hired ${coach.name} as head coach (${coach.style.name}).`, "league");
        updateFanHype(5, `Hiring new head coach ${coach.name}`);
        toast(`${coach.name} hired as Head Coach!`);
        
        $("#hireCoachModal").style.display = "none";
        currentCoachSelection = null;
        renderCoaching();
        save(STATE);
      }
    }
    
    function openFireCoachModal(coachId, isHead) {
      let coach = null;
      if (isHead && STATE.coaches.head.id === coachId) {
        coach = STATE.coaches.head;
      } else {
        coach = STATE.coaches.assistants.find(c => c.id === coachId);
      }
      
      if (!coach) return;
      
      $("#coachProfileModal").style.display = "none";
      
      const modal = $("#fireCoachModal");
      $("#fireCoachName").textContent = coach.name;
      
      const buyout = coach.contract.salary * coach.contract.yearsLeft;
      $("#fireCoachBuyout").textContent = fmt(buyout);
      $("#fireCoachBuyoutDetails").textContent = `${coach.contract.yearsLeft} years remaining`;
      
      $("#confirmFireBtn").onclick = () => {
        // Check for owner intervention
        const interventionCheck = checkOwnerIntervention("coachFiring", {
          coachName: coach.name,
          coachType: isHead ? "head" : "assistant",
          coachRecord: coach.record
        });
        
        const proceedWithFiring = () => {
          if (isHead) {
            STATE.coaches.head = null;
            addEvent(`Fired head coach ${coach.name}. Buyout: ${fmt(buyout)}`, "league");
          } else {
            STATE.coaches.assistants = STATE.coaches.assistants.filter(c => c.id !== coachId);
            addEvent(`Fired assistant coach ${coach.name}.`, "league");
          }
          
          // Decrease trust with remaining staff
          if (STATE.coaches.head && !isHead) {
            STATE.coaches.head.trust = Math.max(0, STATE.coaches.head.trust - 5);
          }
          STATE.coaches.assistants.forEach(c => {
            c.trust = Math.max(0, c.trust - 3);
          });
          
          toast(`Fired ${coach.name}`);
          modal.style.display = "none";
          renderCoaching();
          save(STATE);
        };
        
        if (interventionCheck.intervene) {
          modal.style.display = "none";
          showInterventionModal(interventionCheck.outcome, (allowed) => {
            if (allowed) {
              proceedWithFiring();
            } else {
              toast("Owner blocked the firing");
              renderCoaching();
            }
          });
        } else {
          proceedWithFiring();
        }
      };
      
      modal.style.display = "flex";
    }
    
    function refreshCoachCandidates() {
      STATE.coaches.candidates = generateCoachCandidates(12);
      renderCoaching();
      toast("Coaching pool refreshed!");
      save(STATE);
    }
    
    // Coaching Event Handlers
    $("#closeCoachProfileModal")?.addEventListener("click", () => {
      $("#coachProfileModal").style.display = "none";
    });
    
    $("#closeHireCoachModal")?.addEventListener("click", () => {
      $("#hireCoachModal").style.display = "none";
      currentCoachSelection = null;
    });
    
    $("#cancelHireBtn")?.addEventListener("click", () => {
      $("#hireCoachModal").style.display = "none";
      currentCoachSelection = null;
    });
    
    $("#confirmHireBtn")?.addEventListener("click", confirmHireCoach);
    
    $("#closeFireCoachModal")?.addEventListener("click", () => {
      $("#fireCoachModal").style.display = "none";
    });
    
    $("#cancelFireBtn")?.addEventListener("click", () => {
      $("#fireCoachModal").style.display = "none";
    });
    
    $("#refreshCandidates")?.addEventListener("click", refreshCoachCandidates);

    // -------------------------------
    // Owner System
    // -------------------------------
    
    function renderOwner() {
      if (!STATE.owner) {
        STATE.owner = generateOwner();
        STATE.owner.goals = generateSeasonGoals(STATE, STATE.owner);
      }
      
      const owner = STATE.owner;
      
      // Render owner profile
      $("#ownerName").textContent = owner.name;
      $("#ownerAge").textContent = `Age ${owner.age}`;
      $("#ownerArchetype").textContent = owner.archetype;
      $("#ownerDesc").textContent = owner.archetypeDesc;
      
      // Render trust meter
      const trust = owner.trust || 65;
      $("#ownerTrustValue").textContent = trust;
      
      const trustBar = $("#ownerTrustBar");
      trustBar.style.width = `${trust}%`;
      
      let trustClass = "medium";
      let trustStatus = "Watching Progress";
      if (trust >= 85) {
        trustClass = "excellent";
        trustStatus = "Extremely Pleased";
      } else if (trust >= 70) {
        trustClass = "good";
        trustStatus = "Satisfied";
      } else if (trust >= 50) {
        trustClass = "medium";
        trustStatus = "Cautiously Optimistic";
      } else if (trust >= 30) {
        trustClass = "low";
        trustStatus = "Concerned";
      } else {
        trustClass = "critical";
        trustStatus = "On Thin Ice";
      }
      
      trustBar.className = `trust-bar-large-fill ${trustClass}`;
      $("#ownerTrustStatus").textContent = trustStatus;
      
      // Render notes
      $("#ownerNotes").textContent = owner.notes;
      
      // Render goals
      const goalsGrid = $("#ownerGoals");
      if (owner.goals && owner.goals.length > 0) {
        goalsGrid.innerHTML = owner.goals.map(goal => {
          let status = "pending";
          let statusIcon = "‚è≥";
          
          // Check goal completion
          if (goal.type === "wins") {
            const currentWins = STATE.dashboard.wins;
            if (currentWins >= goal.target) {
              status = "met";
              statusIcon = "‚úì";
              goal.met = true;
            } else {
              goal.met = false;
            }
          } else if (goal.type === "budget") {
            const payroll = sum(STATE.roster, p => p.salary);
            const cap = STATE.meta.rules.cap;
            const tax = STATE.meta.rules.tax;
            
            if (goal.target === "under_cap" && payroll < cap) {
              status = "met";
              statusIcon = "‚úì";
              goal.met = true;
            } else if (goal.target === "under_tax" && payroll < tax) {
              status = "met";
              statusIcon = "‚úì";
              goal.met = true;
            } else if (goal.target === "contend") {
              status = "pending";
              statusIcon = "‚è≥";
            }
          } else if (goal.type === "chemistry") {
            if (STATE.dashboard.chemistry >= goal.target) {
              status = "met";
              statusIcon = "‚úì";
              goal.met = true;
            } else {
              goal.met = false;
            }
          }
          
          return `
            <div class="goal-item ${goal.priority}-priority">
              <div class="goal-info">
                <div class="goal-type">${goal.type}</div>
                <div class="goal-desc">${goal.description}</div>
                <div class="goal-priority">Priority: ${goal.priority}</div>
              </div>
              <div class="goal-status ${status}">
                ${statusIcon}
              </div>
            </div>
          `;
        }).join('');
      } else {
        goalsGrid.innerHTML = '<div class="empty-state">No expectations set for this season</div>';
      }
      
      // Render financial overview
      const payroll = sum(STATE.roster, p => p.salary);
      const cap = STATE.meta.rules.cap;
      const tax = STATE.meta.rules.tax;
      
      $("#ownerPayrollStatus").textContent = fmt(payroll);
      if (payroll < cap) {
        $("#ownerPayrollDesc").textContent = "Under Cap";
        $("#ownerPayrollDesc").style.color = "var(--good)";
      } else if (payroll < tax) {
        $("#ownerPayrollDesc").textContent = "Over Cap, Under Tax";
        $("#ownerPayrollDesc").style.color = "var(--warn)";
      } else {
        $("#ownerPayrollDesc").textContent = "In Luxury Tax";
        $("#ownerPayrollDesc").style.color = "var(--bad)";
      }
      
      $("#ownerTaxThreshold").textContent = fmt(tax);
      $("#ownerTaxDesc").textContent = "Luxury Tax Line";
      
      // Budget flexibility based on owner traits
      let budgetFlex = "Moderate";
      if (owner.traits.greed >= 75) {
        budgetFlex = "Tight";
      } else if (owner.traits.greed <= 35 && owner.traits.ambition >= 75) {
        budgetFlex = "Generous";
      }
      $("#ownerBudgetFlex").textContent = budgetFlex;
      
      // Coaching budget
      let coachingBudget = 0;
      if (STATE.coaches && STATE.coaches.head) {
        coachingBudget += STATE.coaches.head.contract.salary;
      }
      if (STATE.coaches && STATE.coaches.assistants) {
        STATE.coaches.assistants.forEach(c => {
          coachingBudget += c.contract.salary;
        });
      }
      $("#ownerCoachBudget").textContent = fmt(coachingBudget);
      
      // Render traits
      const traitsGrid = $("#ownerTraits");
      const traitLabels = {
        patience: "Patience",
        involvement: "Involvement",
        basketballIQ: "Basketball IQ",
        greed: "Profit Focus",
        loyalty: "Loyalty",
        ambition: "Ambition",
        temper: "Temper",
        publicImage: "Public Image"
      };
      
      traitsGrid.innerHTML = Object.entries(owner.traits).map(([key, value]) => {
        return `
          <div class="trait-item">
            <div class="trait-label">
              <span>${traitLabels[key] || key}</span>
              <span class="trait-value">${value}</span>
            </div>
            <div class="attr-bar-container">
              <div class="attr-bar blue" style="width:${value}%"></div>
            </div>
          </div>
        `;
      }).join('');
      
      // Render meeting history (placeholder)
      const meetingHistory = $("#ownerMeetingHistory");
      if (owner.meetingHistory && owner.meetingHistory.length > 0) {
        meetingHistory.innerHTML = owner.meetingHistory.map(meeting => {
          return `
            <div class="meeting-item">
              <div class="meeting-icon">${meeting.icon || "üí¨"}</div>
              <div class="meeting-content">
                <div class="meeting-type">${meeting.type}</div>
                <div class="meeting-text">${meeting.text}</div>
                <div class="meeting-date">${meeting.date}</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        meetingHistory.innerHTML = '<div class="empty-state">No meetings yet this season</div>';
      }
    }
    
    function renderFinance() {
      if (!STATE.finance) {
        STATE.finance = {
          revenue: { tickets: 0, merch: 0, playoffs: 0, total: 0 },
          expenses: { players: 0, staff: 0, facilities: 0, promo: 0, tax: 0, total: 0 },
          settings: { ticketPrice: 1.0, promoSpend: 0, facilityLvl: 0 },
          projections: []
        };
      }
      
      // Calculate current financials
      const revenue = calculateRevenue(STATE, STATE.finance);
      const expenses = calculateExpenses(STATE, STATE.finance);
      const profit = calculateProfit(revenue, expenses);
      
      // Update stored values
      STATE.finance.revenue = revenue;
      STATE.finance.expenses = expenses;
      
      const payroll = sum(STATE.roster, p => p.salary);
      const rules = STATE.meta.rules;
      const capSpace = Math.max(0, rules.cap - payroll);
      const capStatus = getCapStatus(payroll, rules);
      
      // Panel 1: Payroll & Cap Status
      $("#finPayroll").textContent = formatMoney(payroll);
      $("#finCapSpace").textContent = formatMoney(capSpace);
      
      const capBadge = $("#finCapStatus");
      capBadge.textContent = capStatus.text;
      capBadge.style.background = capStatus.color;
      capBadge.style.color = "#fff";
      
      // Cap visual bar
      const capPct = Math.min(100, (payroll / rules.apron2) * 100);
      $("#finCapBar").style.width = capPct + "%";
      
      // Position markers
      const taxPct = (rules.tax / rules.apron2) * 100;
      const apron1Pct = (rules.apron1 / rules.apron2) * 100;
      const apron2Pct = 100;
      
      $("#finTaxMarker").style.left = taxPct + "%";
      $("#finApron1Marker").style.left = apron1Pct + "%";
      $("#finApron2Marker").style.left = apron2Pct + "%";
      
      // Cap legend
      $("#finCapAmount").textContent = (rules.cap / 1_000_000).toFixed(0);
      $("#finTaxAmount").textContent = (rules.tax / 1_000_000).toFixed(0);
      $("#finApron1Amount").textContent = (rules.apron1 / 1_000_000).toFixed(0);
      $("#finApron2Amount").textContent = (rules.apron2 / 1_000_000).toFixed(0);
      
      // Top salaries
      const topSalaries = STATE.roster.slice().sort((a, b) => b.salary - a.salary).slice(0, 5);
      $("#finTopSalaries").innerHTML = topSalaries.map(p => `
        <div class="salary-row">
          <span class="salary-player-name">${p.name}</span>
          <span class="salary-player-value">${formatMoney(p.salary)}</span>
        </div>
      `).join('');
      
      // Panel 2: Profit & Loss
      $("#finRevenue").textContent = formatMoney(revenue.total);
      $("#finExpenses").textContent = formatMoney(expenses.total);
      
      const profitEl = $("#finProfit");
      profitEl.textContent = formatMoney(profit);
      profitEl.className = "kpi-value " + (profit >= 0 ? "good" : "bad");
      
      // Revenue breakdown
      const maxRevenue = Math.max(revenue.tickets, revenue.merch, revenue.playoffs || 1);
      $("#finRevenueTickets").textContent = formatMoney(revenue.tickets);
      $("#finRevenueTicketsBar").style.width = ((revenue.tickets / maxRevenue) * 100) + "%";
      
      $("#finRevenueMerch").textContent = formatMoney(revenue.merch);
      $("#finRevenueMerchBar").style.width = ((revenue.merch / maxRevenue) * 100) + "%";
      
      $("#finRevenuePlayoffs").textContent = formatMoney(revenue.playoffs);
      $("#finRevenuePlayoffsBar").style.width = revenue.playoffs > 0 ? ((revenue.playoffs / maxRevenue) * 100) + "%" : "0%";
      
      // Expense breakdown
      const maxExpense = Math.max(expenses.players, expenses.staff, expenses.facilities, expenses.promo, expenses.tax || 1);
      $("#finExpensePlayers").textContent = formatMoney(expenses.players);
      $("#finExpensePlayersBar").style.width = ((expenses.players / maxExpense) * 100) + "%";
      
      $("#finExpenseStaff").textContent = formatMoney(expenses.staff);
      $("#finExpenseStaffBar").style.width = ((expenses.staff / maxExpense) * 100) + "%";
      
      $("#finExpenseFacilities").textContent = formatMoney(expenses.facilities);
      $("#finExpenseFacilitiesBar").style.width = ((expenses.facilities / maxExpense) * 100) + "%";
      
      $("#finExpensePromo").textContent = formatMoney(expenses.promo);
      $("#finExpensePromoBar").style.width = expenses.promo > 0 ? ((expenses.promo / maxExpense) * 100) + "%" : "0%";
      
      $("#finExpenseTax").textContent = formatMoney(expenses.tax);
      $("#finExpenseTaxBar").style.width = expenses.tax > 0 ? ((expenses.tax / maxExpense) * 100) + "%" : "0%";
      
      // Finance controls
      $("#finTicketPrice").value = STATE.finance.settings.ticketPrice;
      $("#finTicketPriceValue").textContent = STATE.finance.settings.ticketPrice.toFixed(1) + "x";
      
      $("#finPromoSpend").value = STATE.finance.settings.promoSpend;
      $("#finPromoSpendValue").textContent = "$" + STATE.finance.settings.promoSpend + "M";
      
      $("#finFacilityLvl").value = STATE.finance.settings.facilityLvl;
      $("#finFacilityLvlValue").textContent = "Level " + STATE.finance.settings.facilityLvl;
      
      // Panel 3: Multi-Year Outlook
      const projections = calculateMultiYearOutlook(STATE);
      STATE.finance.projections = projections;
      
      const outlookTable = $("#finOutlookTable");
      const outlookRows = projections.map(proj => {
        const vsCapDiff = proj.total - rules.cap;
        const vsCapStatus = vsCapDiff > 0 ? "Over" : "Under";
        const vsCapColor = vsCapDiff > 0 ? "var(--bad)" : "var(--good)";
        
        return `
          <div class="outlook-row">
            <div class="outlook-cell year">${proj.year}</div>
            <div class="outlook-cell">${formatMoney(proj.guaranteed)}</div>
            <div class="outlook-cell">${formatMoney(proj.options)}</div>
            <div class="outlook-cell">${formatMoney(proj.dead)}</div>
            <div class="outlook-cell total">${formatMoney(proj.total)}</div>
            <div class="outlook-cell status" style="color:${vsCapColor}">${vsCapStatus} ${formatMoney(Math.abs(vsCapDiff))}</div>
          </div>
        `;
      }).join('');
      
      outlookTable.innerHTML = `
        <div class="outlook-header">
          <div class="outlook-cell">Year</div>
          <div class="outlook-cell">Guaranteed</div>
          <div class="outlook-cell">Options</div>
          <div class="outlook-cell">Dead Money</div>
          <div class="outlook-cell">Total</div>
          <div class="outlook-cell">vs Cap</div>
        </div>
        ${outlookRows}
      `;
      
      // Panel 4: Owner Budget & Risk
      const budgetTarget = calculateOwnerBudgetTarget(STATE.owner, rules);
      $("#finOwnerBudget").textContent = formatMoney(budgetTarget);
      
      const budgetDiff = payroll - budgetTarget;
      const budgetStatusEl = $("#finBudgetStatus");
      if (budgetDiff > 10_000_000) {
        budgetStatusEl.textContent = "Over Budget";
        budgetStatusEl.style.background = "var(--bad)";
      } else if (budgetDiff > 0) {
        budgetStatusEl.textContent = "At Limit";
        budgetStatusEl.style.background = "var(--warn)";
      } else {
        budgetStatusEl.textContent = "On Track";
        budgetStatusEl.style.background = "var(--good)";
      }
      budgetStatusEl.style.color = "#fff";
      
      // Trust impact (simulated)
      const trustImpact = $("#finTrustImpact");
      let trustDelta = 0;
      if (expenses.tax > 0 && STATE.dashboard.wins < 45) trustDelta -= 8;
      else if (expenses.tax > 0 && STATE.dashboard.wins >= 50) trustDelta -= 2;
      if (profit > 0 && payroll < budgetTarget) trustDelta += 4;
      if (profit < -20_000_000) trustDelta -= 3;
      
      trustImpact.textContent = (trustDelta >= 0 ? "+" : "") + trustDelta;
      trustImpact.className = "kpi-value " + (trustDelta >= 0 ? "good" : "bad");
      
      // Owner details
      $("#finOwnerArchetype").textContent = STATE.owner.archetype;
      
      let philosophy = "Balanced approach";
      if (STATE.owner.archetype === "Business Mogul") philosophy = "Profit-focused, avoid luxury tax";
      else if (STATE.owner.archetype === "Legacy Builder") philosophy = "Win at all costs";
      else if (STATE.owner.archetype === "Billionaire Fan") philosophy = "Generous spending for contention";
      else if (STATE.owner.traits.greed >= 70) philosophy = "Cost-conscious operations";
      else if (STATE.owner.traits.ambition >= 80) philosophy = "Aggressive investment";
      
      $("#finOwnerPhilosophy").textContent = philosophy;
      
      const marketSize = getMarketSize(STATE.meta.teamName);
      $("#finMarketSize").textContent = marketSize.charAt(0).toUpperCase() + marketSize.slice(1);
      
      // Risk factors
      const riskFactors = [];
      if (expenses.tax > 5_000_000) {
        riskFactors.push({ level: "high", icon: "üî¥", text: `Paying $${(expenses.tax / 1_000_000).toFixed(1)}M in luxury tax` });
      }
      if (payroll >= rules.apron2) {
        riskFactors.push({ level: "high", icon: "‚ö†Ô∏è", text: "Second apron violation - limited roster flexibility" });
      }
      if (payroll >= rules.apron1 && payroll < rules.apron2) {
        riskFactors.push({ level: "medium", icon: "üü°", text: "First apron - restricted in transactions" });
      }
      if (profit < -10_000_000) {
        riskFactors.push({ level: "medium", icon: "üí∏", text: `Operating at $${Math.abs(profit / 1_000_000).toFixed(1)}M loss` });
      }
      if (projections[0] && projections[0].total > rules.apron1) {
        riskFactors.push({ level: "medium", icon: "üìÖ", text: "Projected over apron next season" });
      }
      
      const riskList = $("#finRiskFactors");
      if (riskFactors.length > 0) {
        riskList.innerHTML = riskFactors.map(r => `
          <div class="risk-item ${r.level}">
            <span class="risk-icon">${r.icon}</span>
            <span>${r.text}</span>
          </div>
        `).join('');
      } else {
        riskList.innerHTML = '<div class="risk-item low"><span class="risk-icon">‚úÖ</span><span>No significant financial risks detected</span></div>';
      }
      
      // Recommendations
      const recommendations = [];
      if (capSpace > 20_000_000 && STATE.dashboard.wins < 35) {
        recommendations.push({ icon: "üí∞", text: "Significant cap space available - consider free agent upgrades" });
      }
      if (expenses.tax > 0 && STATE.dashboard.wins < 45) {
        recommendations.push({ icon: "üìâ", text: "Reduce payroll to avoid luxury tax while team rebuilds" });
      }
      if (payroll < rules.cap * 0.8 && STATE.dashboard.wins >= 45) {
        recommendations.push({ icon: "üìà", text: "Invest in talent - team is competitive and under budget" });
      }
      if (STATE.finance.settings.facilityLvl < 3 && profit > 10_000_000) {
        recommendations.push({ icon: "üèóÔ∏è", text: "Upgrade facilities to boost merchandise revenue" });
      }
      if (STATE.finance.settings.promoSpend === 0 && marketSize === "small") {
        recommendations.push({ icon: "üì¢", text: "Increase marketing spend to boost revenue in small market" });
      }
      
      const recList = $("#finRecommendations");
      if (recommendations.length > 0) {
        recList.innerHTML = recommendations.map(r => `
          <div class="recommendation-item">
            <span class="recommendation-icon">${r.icon}</span>
            <span>${r.text}</span>
          </div>
        `).join('');
      } else {
        recList.innerHTML = '<div class="recommendation-item"><span class="recommendation-icon">‚úÖ</span><span>Financial strategy is sound - continue current approach</span></div>';
      }
    }
    
    // -------------------------------
    // Schedule Rendering & Simulation
    // -------------------------------
    
    function renderSchedule() {
      console.log("renderSchedule called", STATE.schedule);
      
      // Initialize schedule if empty
      if (!STATE.schedule) {
        STATE.schedule = {
          games: [],
          currentDay: 1,
          selectedGame: null,
          elo: 1500,
          leagueElos: {}
        };
      }
      
      if (!STATE.schedule.games || STATE.schedule.games.length === 0) {
        console.log("Generating day-based schedule for:", STATE.meta.teamName);
        STATE.schedule.games = generateDayBasedSchedule(STATE.meta.teamName);
        STATE.schedule.currentDay = 1;
        STATE.schedule.elo = 1500;
        STATE.schedule.leagueElos = initializeLeagueElos();
        console.log("Generated", STATE.schedule.games.length, "total games");
        save(STATE);
      }
      
      // Count my team's games
      const myTeam = STATE.meta.teamName;
      const myGames = STATE.schedule.games.filter(g => g.homeTeam === myTeam || g.awayTeam === myTeam);
      const myCompleted = myGames.filter(g => g.status === 'final');
      
      // Update header stats
      $("#scheduleRecord").textContent = `${STATE.dashboard.wins}-${STATE.dashboard.losses}`;
      const winPct = (STATE.dashboard.wins / (STATE.dashboard.wins + STATE.dashboard.losses || 1)).toFixed(3);
      $("#scheduleWinPct").textContent = winPct;
      
      // Find next game
      const nextGame = myGames.find(g => g.status === "upcoming");
      if (nextGame) {
        const isHome = nextGame.homeTeam === myTeam;
        const opponent = isHome ? nextGame.awayTeam : nextGame.homeTeam;
        $("#scheduleNextGame").textContent = `Day ${nextGame.day}: ${isHome ? 'vs' : '@'} ${opponent}`;
        $("#simGame").disabled = false;
      } else {
        $("#scheduleNextGame").textContent = "Season Complete";
        $("#simGame").disabled = true;
      }
      
      // Render simple list
      renderScheduleList();
    }
    
    function renderScheduleList() {
      const list = $("#scheduleList");
      
      if (!list) {
        console.error("Schedule list not found!");
        return;
      }
      
      if (!STATE.schedule || !STATE.schedule.games || STATE.schedule.games.length === 0) {
        list.innerHTML = '<div style="padding:20px; color:var(--muted); text-align:center;">No schedule generated. Click "Generate Schedule" button.</div>';
        return;
      }
      
      const myTeam = STATE.meta.teamName;
      
      // Filter games for my team only
      const myGames = STATE.schedule.games.filter(g => 
        g.homeTeam === myTeam || g.awayTeam === myTeam
      );
      
      console.log(`Displaying ${myGames.length} games for ${myTeam}`);
      
      let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
      
      myGames.forEach((game, idx) => {
        const isHome = game.homeTeam === myTeam;
        const opponent = isHome ? game.awayTeam : game.homeTeam;
        const myB2B = isHome ? game.b2bHome : game.b2bAway;
        const oppB2B = isHome ? game.b2bAway : game.b2bHome;
        
        // Get rivalry info
        const rivalryHeat = getRivalryHeat(myTeam, opponent);
        const rivalryLevel = getRivalryLevel(rivalryHeat);
        const isRivalry = rivalryHeat >= 41; // Warm or higher
        
        // Determine win probability for upcoming games
        let wpDisplay = '';
        if (game.status === 'upcoming') {
          const oppElo = STATE.schedule.leagueElos?.[opponent] || 1500;
          const myElo = STATE.schedule.elo || 1500;
          const wp = calculateWinProbability(myElo, oppElo, isHome);
          wpDisplay = `<span style="color: var(--muted); font-size: 12px;">Win: ${(wp * 100).toFixed(0)}%</span>`;
        }
        
        // Color coding for day ranges
        let dayColor = 'var(--text-1)';
        if (game.day <= 10) dayColor = 'var(--accent)'; // Training camp
        if (game.day >= 61 && game.day <= 66) dayColor = 'var(--muted)'; // All-Star break
        
        // Add border glow for hot rivalries
        const borderStyle = rivalryLevel.glow 
          ? `border: 2px solid ${rivalryLevel.color}; box-shadow: 0 0 12px ${rivalryLevel.color}40;`
          : 'border: 1px solid var(--border);';
        
        const tooltipText = isRivalry 
          ? `Rivalry: ${rivalryLevel.label} (${rivalryHeat}/100)` 
          : '';
        
        html += `
          <div class="schedule-game-row" title="${tooltipText}" style="display: flex; align-items: center; padding: 12px; background: var(--bg-2); ${borderStyle} border-radius: 8px; gap: 12px;">
            <div style="min-width: 50px; font-weight: 700; color: ${dayColor};">Day ${game.day}</div>
            <div style="min-width: 80px;">
              <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${isHome ? '#1a3d1a' : '#1a2a3d'}; color: ${isHome ? '#4ade80' : '#60a5fa'};">
                ${isHome ? 'üè† HOME' : '‚úàÔ∏è AWAY'}
              </span>
            </div>
            <div style="flex: 1; font-weight: 600; font-size: 15px;">${isHome ? 'vs' : '@'} ${opponent}</div>
            
            <div style="display: flex; gap: 6px; align-items: center;">
              ${myB2B ? '<span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; background: #3d1a3d; color: #c084fc;">‚ö° B2B</span>' : ''}
              ${game.tvGame ? '<span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; background: #3d3d1a; color: #fbbf24;">üì∫ TV</span>' : ''}
              ${isRivalry ? `<span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${rivalryLevel.color}20; color: ${rivalryLevel.color}; border: 1px solid ${rivalryLevel.color};">${rivalryLevel.icon} ${rivalryLevel.label.toUpperCase()}</span>` : ''}
              ${game.fatigue === 'high' ? '<span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; background: #3d1a1a; color: #f87171;">üò¥ TIRED</span>' : ''}
            </div>
            
            <div style="min-width: 120px; text-align: right;">
              ${game.status === 'final' ? `
                <span style="font-weight: 700; font-size: 18px; color: ${game.score?.home > game.score?.away ? (isHome ? 'var(--good)' : 'var(--bad)') : (isHome ? 'var(--bad)' : 'var(--good)')};">
                  ${(isHome ? game.score?.home > game.score?.away : game.score?.away > game.score?.home) ? 'W' : 'L'} 
                  ${isHome ? game.score?.home : game.score?.away}-${isHome ? game.score?.away : game.score?.home}
                </span>
              ` : `
                <div style="display: flex; gap: 6px; justify-content: flex-end;">
                  <button onclick="window.quickSimGame('${game.day}')" style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ö° Simulate</button>
                  <button onclick="window.watchLive('${game.day}')" style="padding: 6px 12px; background: var(--good); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">üëÅÔ∏è Watch Live</button>
                </div>
                <div style="margin-top: 4px;">${wpDisplay}</div>
              `}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      
      // Add season phase indicators
      const phases = `
        <div style="margin-top: 20px; padding: 16px; background: var(--bg-3); border-radius: 8px; border: 1px solid var(--border);">
          <div style="font-weight: 700; margin-bottom: 12px; color: var(--text-0);">Season Phases</div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="padding: 8px; background: var(--bg-2); border-radius: 4px;">
              <div style="font-size: 12px; color: var(--muted);">Training Camp</div>
              <div style="font-weight: 600; color: var(--accent);">Days 1-10</div>
            </div>
            <div style="padding: 8px; background: var(--bg-2); border-radius: 4px;">
              <div style="font-size: 12px; color: var(--muted);">All-Star Break</div>
              <div style="font-weight: 600; color: var(--muted);">Days 61-66</div>
            </div>
            <div style="padding: 8px; background: var(--bg-2); border-radius: 4px;">
              <div style="font-size: 12px; color: var(--muted);">Regular Season</div>
              <div style="font-weight: 600; color: var(--good);">82 Games</div>
            </div>
          </div>
        </div>
      `;
      
      list.innerHTML = html + phases;
    }
    
    function renderCalendar() {
      // Deprecated - no longer using calendar view
      return;
    }
    
    function renderGameDetail(game) {
      // Deprecated - no longer using game detail panel
      return;
    }
    
    window.selectGame = function(gameId) {
      // No longer needed for list view
    };
    
    window.simSelectedGame = function() {
      // No longer needed for list view
    };
    
    // Quick simulate a game by day
    window.quickSimGame = function(day) {
      const myTeam = STATE.meta.teamName;
      const game = STATE.schedule.games.find(g => 
        g.day === parseInt(day) && 
        g.status === 'upcoming' && 
        (g.homeTeam === myTeam || g.awayTeam === myTeam)
      );
      
      if (game) {
        simulateGame(game);
        renderSchedule();
        toast("Game simulated!");
      }
    };
    
    // Watch a game live by day
    window.watchLive = function(day) {
      const myTeam = STATE.meta.teamName;
      const game = STATE.schedule.games.find(g => 
        g.day === parseInt(day) && 
        g.status === 'upcoming' && 
        (g.homeTeam === myTeam || g.awayTeam === myTeam)
      );
      
      if (game) {
        watchLiveGame(game).then(() => {
          renderSchedule();
        });
      }
    };
    
    // Play-by-play live game simulation
    async function watchLiveGame(game) {
      const myTeam = STATE.meta.teamName;
      const isHome = game.homeTeam === myTeam;
      const opponent = isHome ? game.awayTeam : game.homeTeam;
      
      // Create modal overlay
      const modal = document.createElement('div');
      modal.id = 'live-game-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: var(--bg-1); border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; border: 2px solid var(--border);';
      
      modalContent.innerHTML = `
        <div style="padding: 20px; border-bottom: 2px solid var(--border); background: var(--bg-2);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--text-0);">
              üèÄ ${isHome ? myTeam : opponent} vs ${isHome ? opponent : myTeam}
            </div>
            <button onclick="document.getElementById('live-game-modal').remove()" style="background: var(--bad); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>
          </div>
          <div style="margin-top: 12px; font-size: 14px; color: var(--muted);">Day ${game.day} ‚Ä¢ ${isHome ? 'üè† Home Game' : '‚úàÔ∏è Away Game'}</div>
        </div>
        
        <div style="padding: 24px; background: var(--bg-3); display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid var(--border);">
          <div style="text-align: center;">
            <div style="font-size: 16px; font-weight: 600; color: var(--text-1); margin-bottom: 8px;">${isHome ? myTeam : opponent}</div>
            <div id="live-score-home" style="font-size: 48px; font-weight: 700; color: var(--text-0);">0</div>
          </div>
          <div style="text-align: center;">
            <div id="live-quarter" style="font-size: 20px; font-weight: 700; color: var(--accent);">1st</div>
            <div id="live-time" style="font-size: 16px; color: var(--muted); margin-top: 4px;">12:00</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 16px; font-weight: 600; color: var(--text-1); margin-bottom: 8px;">${isHome ? opponent : myTeam}</div>
            <div id="live-score-away" style="font-size: 48px; font-weight: 700; color: var(--text-0);">0</div>
          </div>
        </div>
        
        <div id="live-play-by-play" style="flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-1);">
          <div style="text-align: center; color: var(--muted); padding: 40px;">Starting game...</div>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Simulate play-by-play
      const playByPlay = document.getElementById('live-play-by-play');
      const scoreHome = document.getElementById('live-score-home');
      const scoreAway = document.getElementById('live-score-away');
      const quarterEl = document.getElementById('live-quarter');
      const timeEl = document.getElementById('live-time');
      
      let homeScore = 0;
      let awayScore = 0;
      playByPlay.innerHTML = '';
      
      const oppElo = STATE.schedule.leagueElos[opponent] || 1500;
      let teamElo = STATE.schedule.elo;
      const myB2B = isHome ? game.b2bHome : game.b2bAway;
      if (myB2B) teamElo -= 15;
      if (game.fatigue === 'high') teamElo -= 25;
      else if (game.fatigue === 'medium') teamElo -= 15;
      
      const wp = calculateWinProbability(teamElo, oppElo, isHome);
      
      const plays = [
        "makes a layup", "hits a jump shot", "drains a three-pointer", "scores on a fast break",
        "makes both free throws", "scores on a putback", "finishes the alley-oop", "hits a mid-range jumper",
        "converts the and-one", "scores in transition", "makes a contested layup", "hits from downtown"
      ];
      
      const quarters = ['1st', '2nd', '3rd', '4th'];
      
      for (let quarter = 0; quarter < 4; quarter++) {
        quarterEl.textContent = quarters[quarter];
        
        // Each quarter has 8-12 scoring plays
        const playsInQuarter = 8 + Math.floor(Math.random() * 5);
        
        for (let i = 0; i < playsInQuarter; i++) {
          await new Promise(resolve => setTimeout(resolve, 600)); // 600ms between plays
          
          const minutes = 12 - Math.floor((i / playsInQuarter) * 12);
          const seconds = Math.floor(Math.random() * 60);
          timeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          // Determine who scores based on win probability
          const myTeamScores = Math.random() < (isHome ? wp : 1 - wp);
          const scoringTeam = myTeamScores ? myTeam : opponent;
          const points = Math.random() < 0.3 ? 3 : 2; // 30% chance of 3-pointer
          
          if (myTeamScores) {
            if (isHome) homeScore += points;
            else awayScore += points;
          } else {
            if (isHome) awayScore += points;
            else homeScore += points;
          }
          
          scoreHome.textContent = homeScore;
          scoreAway.textContent = awayScore;
          
          const play = plays[Math.floor(Math.random() * plays.length)];
          const teamColor = scoringTeam === myTeam ? 'var(--good)' : 'var(--text-1)';
          
          const playDiv = document.createElement('div');
          playDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; background: var(--bg-2); border-radius: 6px; border-left: 3px solid ' + teamColor + '; animation: slideIn 0.3s ease;';
          playDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="font-weight: 700; color: ${teamColor};">${scoringTeam}</span>
                <span style="color: var(--text-1);"> ${play}</span>
                ${points === 3 ? ' <span style="color: var(--accent);">+3</span>' : ' <span style="color: var(--muted);">+2</span>'}
              </div>
              <div style="font-size: 12px; color: var(--muted);">${minutes}:${seconds.toString().padStart(2, '0')}</div>
            </div>
          `;
          
          playByPlay.insertBefore(playDiv, playByPlay.firstChild);
          
          // Keep only last 15 plays visible
          while (playByPlay.children.length > 15) {
            playByPlay.removeChild(playByPlay.lastChild);
          }
        }
        
        // Quarter break
        if (quarter < 3) {
          await new Promise(resolve => setTimeout(resolve, 800));
          const breakDiv = document.createElement('div');
          breakDiv.style.cssText = 'padding: 16px; margin-bottom: 8px; background: var(--bg-3); border-radius: 6px; text-align: center; font-weight: 700; color: var(--accent); border: 1px dashed var(--border);';
          breakDiv.textContent = `End of ${quarters[quarter]} Quarter`;
          playByPlay.insertBefore(breakDiv, playByPlay.firstChild);
        }
      }
      
      // Check for overtime if close
      if (Math.abs(homeScore - awayScore) <= 3 && Math.random() < 0.15) {
        game.overtime = true;
        quarterEl.textContent = 'OT';
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const overtimeDiv = document.createElement('div');
        overtimeDiv.style.cssText = 'padding: 16px; margin-bottom: 8px; background: var(--accent); border-radius: 6px; text-align: center; font-weight: 700; color: white;';
        overtimeDiv.textContent = 'üî• OVERTIME!';
        playByPlay.insertBefore(overtimeDiv, playByPlay.firstChild);
        
        const otPlays = 3 + Math.floor(Math.random() * 3);
        for (let i = 0; i < otPlays; i++) {
          await new Promise(resolve => setTimeout(resolve, 700));
          
          const myTeamScores = Math.random() < (isHome ? wp : 1 - wp);
          const scoringTeam = myTeamScores ? myTeam : opponent;
          const points = Math.random() < 0.35 ? 3 : 2;
          
          if (myTeamScores) {
            if (isHome) homeScore += points;
            else awayScore += points;
          } else {
            if (isHome) awayScore += points;
            else homeScore += points;
          }
          
          scoreHome.textContent = homeScore;
          scoreAway.textContent = awayScore;
          
          const play = plays[Math.floor(Math.random() * plays.length)];
          const teamColor = scoringTeam === myTeam ? 'var(--good)' : 'var(--text-1)';
          
          const playDiv = document.createElement('div');
          playDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; background: var(--bg-2); border-radius: 6px; border-left: 3px solid ' + teamColor + ';';
          playDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="font-weight: 700; color: ${teamColor};">${scoringTeam}</span>
                <span style="color: var(--text-1);"> ${play}</span>
                ${points === 3 ? ' <span style="color: var(--accent);">+3</span>' : ' <span style="color: var(--muted);">+2</span>'}
              </div>
              <div style="font-size: 12px; color: var(--muted);">OT</div>
            </div>
          `;
          playByPlay.insertBefore(playDiv, playByPlay.firstChild);
        }
      }
      
      // Make sure there's a winner
      if (homeScore === awayScore) {
        if (Math.random() < (isHome ? wp : 1 - wp)) homeScore += 2;
        else awayScore += 2;
        scoreHome.textContent = homeScore;
        scoreAway.textContent = awayScore;
      }
      
      timeEl.textContent = '0:00';
      quarterEl.textContent = game.overtime ? 'FINAL/OT' : 'FINAL';
      
      // Show final message
      await new Promise(resolve => setTimeout(resolve, 1000));
      const won = (isHome && homeScore > awayScore) || (!isHome && awayScore > homeScore);
      const finalDiv = document.createElement('div');
      finalDiv.style.cssText = `padding: 20px; margin-bottom: 8px; background: ${won ? 'var(--good)' : 'var(--bad)'}; border-radius: 8px; text-align: center; font-weight: 700; color: white; font-size: 18px;`;
      finalDiv.textContent = won ? 'üéâ VICTORY!' : 'üòû DEFEAT';
      playByPlay.insertBefore(finalDiv, playByPlay.firstChild);
      
      // Update game state
      game.score = { home: homeScore, away: awayScore };
      game.status = 'final';
      
      // Update Elo and stats (same as simulateGame)
      const K = 32;
      const expected = 1 / (1 + Math.pow(10, (oppElo - teamElo) / 400));
      const actual = won ? 1 : 0;
      const eloChange = Math.round(K * (actual - expected));
      game.eloChange = eloChange;
      STATE.schedule.elo += eloChange;
      
      if (isHome) {
        const baseAttendance = 18000;
        const hypeBonus = STATE.fans?.hype || 50;
        const rivalryHeat = getRivalryHeat(myTeam, opponent);
        const rivalryBonus = rivalryHeat >= 41 ? 1.2 : 1.0;
        const tvBonus = game.tvGame ? 1.1 : 1.0;
        game.attendance = Math.round(baseAttendance * (hypeBonus / 50) * rivalryBonus * tvBonus);
      }
      
      if (won) {
        STATE.dashboard.wins++;
        if (STATE.dashboard.streak.type === "w") STATE.dashboard.streak.count++;
        else STATE.dashboard.streak = {type: "w", count: 1};
      } else {
        STATE.dashboard.losses++;
        if (STATE.dashboard.streak.type === "l") STATE.dashboard.streak.count++;
        else STATE.dashboard.streak = {type: "l", count: 1};
      }
      
      const blowout = Math.abs(homeScore - awayScore) >= 20;
      const rivalryHeat = getRivalryHeat(myTeam, opponent);
      const rivalryLevel = getRivalryLevel(rivalryHeat);
      
      let hypeMultiplier = 1.0;
      if (rivalryHeat >= 61) hypeMultiplier = 1.5;
      else if (rivalryHeat >= 41) hypeMultiplier = 1.2;
      
      if (won && rivalryHeat >= 41) {
        updateFanHype?.(Math.floor(8 * hypeMultiplier), `${rivalryLevel.icon} Rivalry win vs ${opponent}!`);
      } else if (!won && rivalryHeat >= 41) {
        updateFanHype?.(Math.floor(-6 * hypeMultiplier), `${rivalryLevel.icon} Rivalry loss to ${opponent}`);
      } else if (won && game.tvGame) {
        updateFanHype?.(5, `Win on national TV`);
      } else if (!won && game.tvGame) {
        updateFanHype?.(-3, `Loss on national TV`);
      } else if (!won && blowout && isHome) {
        updateFanHype?.(-5, `Blowout home loss`);
      }
      
      const finalScoreDiff = Math.abs(homeScore - awayScore);
      processRivalryGameEvents(game, won, finalScoreDiff);
      
      STATE.schedule.currentDay = game.day + 1;
      save(STATE);
    }
    
    function simulateGame(game) {
      const myTeam = STATE.meta.teamName;
      const isHome = game.homeTeam === myTeam;
      const opponent = isHome ? game.awayTeam : game.homeTeam;
      
      const oppElo = STATE.schedule.leagueElos[opponent] || 1500;
      let teamElo = STATE.schedule.elo;
      
      // Apply B2B fatigue
      const myB2B = isHome ? game.b2bHome : game.b2bAway;
      if (myB2B) teamElo -= 15;
      
      // Apply high fatigue penalty
      if (game.fatigue === 'high') teamElo -= 25;
      else if (game.fatigue === 'medium') teamElo -= 15;
      
      const wp = calculateWinProbability(teamElo, oppElo, isHome);
      const won = Math.random() < wp;
      
      // Generate score
      const baseScore = 100 + Math.floor(Math.random() * 20);
      const scoreDiff = 5 + Math.floor(Math.random() * 20);
      
      let homeScore, awayScore;
      if (won) {
        if (isHome) {
          homeScore = baseScore + scoreDiff;
          awayScore = baseScore;
        } else {
          awayScore = baseScore + scoreDiff;
          homeScore = baseScore;
        }
      } else {
        if (isHome) {
          homeScore = baseScore;
          awayScore = baseScore + scoreDiff;
        } else {
          awayScore = baseScore;
          homeScore = baseScore + scoreDiff;
        }
      }
      
      // Overtime check
      if (Math.abs(homeScore - awayScore) <= 3 && Math.random() < 0.15) {
        game.overtime = true;
        homeScore += Math.floor(Math.random() * 8);
        awayScore += Math.floor(Math.random() * 8);
      }
      
      game.score = { home: homeScore, away: awayScore };
      
      // Update Elo
      const K = 32;
      const expected = 1 / (1 + Math.pow(10, (oppElo - teamElo) / 400));
      const actual = won ? 1 : 0;
      const eloChange = Math.round(K * (actual - expected));
      game.eloChange = eloChange;
      STATE.schedule.elo += eloChange;
      
      // Calculate attendance (only for home games)
      if (isHome) {
        const baseAttendance = 18000;
        const hypeBonus = STATE.fans?.hype || 50;
        const rivalryBonus = game.rivalry ? 1.2 : 1.0;
        const tvBonus = game.tvGame ? 1.1 : 1.0;
        game.attendance = Math.round(baseAttendance * (hypeBonus / 50) * rivalryBonus * tvBonus);
      }
      
      // Update records
      if (won) {
        STATE.dashboard.wins++;
        if (STATE.dashboard.streak.type === "w") STATE.dashboard.streak.count++;
        else STATE.dashboard.streak = {type: "w", count: 1};
      } else {
        STATE.dashboard.losses++;
        if (STATE.dashboard.streak.type === "l") STATE.dashboard.streak.count++;
        else STATE.dashboard.streak = {type: "l", count: 1};
      }
      
      // Update fan hype with rivalry amplification
      const blowout = Math.abs(homeScore - awayScore) >= 20;
      const rivalryHeat = getRivalryHeat(myTeam, opponent);
      const rivalryLevel = getRivalryLevel(rivalryHeat);
      
      // Rivalry games have amplified fan reactions
      let hypeMultiplier = 1.0;
      if (rivalryHeat >= 61) hypeMultiplier = 1.5; // Hot/Red Hot rivalries
      else if (rivalryHeat >= 41) hypeMultiplier = 1.2; // Warm rivalries
      
      if (won && rivalryHeat >= 41) {
        updateFanHype?.(Math.floor(8 * hypeMultiplier), `${rivalryLevel.icon} Rivalry win vs ${opponent}!`);
      } else if (!won && rivalryHeat >= 41) {
        updateFanHype?.(Math.floor(-6 * hypeMultiplier), `${rivalryLevel.icon} Rivalry loss to ${opponent}`);
      } else if (won && game.tvGame) {
        updateFanHype?.(5, `Win on national TV`);
      } else if (!won && game.tvGame) {
        updateFanHype?.(-3, `Loss on national TV`);
      } else if (!won && blowout && isHome) {
        updateFanHype?.(-5, `Blowout home loss`);
      }
      
      // Process rivalry heat changes
      const finalScoreDiff = Math.abs(homeScore - awayScore);
      processRivalryGameEvents(game, won, finalScoreDiff);
      
      game.status = "final";
      STATE.schedule.currentDay = game.day;
      
      addEvent(`Day ${game.day}: ${won ? 'W' : 'L'} ${isHome ? homeScore : awayScore}-${isHome ? awayScore : homeScore} ${isHome ? 'vs' : '@'} ${opponent}`, "league");
      save(STATE);
    }
    
    function renderDraft() {
      if (!STATE.draft) {
        STATE.draft = {
          prospects: [],
          yourPick: 15,
          currentPick: 0,
          scoutingPoints: 100,
          maxScoutingPoints: 100,
          draftStarted: false,
          selectedProspect: null,
          draftedPlayers: []
        };
      }
      
      // Update header stats
      $("#draftYourPick").textContent = `#${STATE.draft.yourPick}`;
      $("#draftScoutPoints").textContent = `${STATE.draft.scoutingPoints}/${STATE.draft.maxScoutingPoints}`;
      $("#draftCurrentPick").textContent = STATE.draft.draftStarted ? `#${STATE.draft.currentPick + 1}` : "Not Started";
      
      // Enable/disable buttons
      $("#startDraftBtn").disabled = STATE.draft.prospects.length === 0 || STATE.draft.draftStarted;
      $("#autoDraftBtn").disabled = !STATE.draft.draftStarted || STATE.draft.currentPick !== STATE.draft.yourPick - 1;
      
      // Render big board
      renderDraftBoard();
      
      // Render team needs
      renderTeamNeeds();
    }
    
    function renderDraftBoard() {
      const board = $("#draftBoardList");
      
      if (!STATE.draft.prospects || STATE.draft.prospects.length === 0) {
        board.innerHTML = '<div class="empty-state">Generate draft class to begin scouting</div>';
        return;
      }
      
      // Group by tier
      const tiers = ["Elite", "High", "Mid", "Late", "Flyer"];
      const tierGroups = {};
      
      tiers.forEach(tier => {
        tierGroups[tier] = STATE.draft.prospects.filter(p => p.tier === tier && !p.draftPosition);
      });
      
      let html = "";
      
      tiers.forEach(tier => {
        const prospects = tierGroups[tier];
        if (prospects.length === 0) return;
        
        html += `
          <div class="tier-group">
            <div class="tier-header">
              <span class="tier-badge ${tier}">${tier}</span>
              <span style="color:var(--muted); font-size:10px;">${prospects.length} prospects</span>
            </div>
            <div class="prospect-list">
        `;
        
        prospects.forEach(p => {
          const isSelected = STATE.draft.selectedProspect?.id === p.id;
          const confidenceWidth = p.scoutingConfidence;
          const flags = [];
          if (p.userFlags.includes("‚≠ê")) flags.push("‚≠ê");
          if (p.userFlags.includes("üö´")) flags.push("üö´");
          
          html += `
            <div class="prospect-card ${isSelected ? 'selected' : ''}" data-prospect-id="${p.id}">
              <div class="prospect-header">
                <div>
                  <div class="prospect-name">${p.name}</div>
                  <div class="prospect-meta">
                    <span>${p.pos}</span>
                    <span>‚Ä¢</span>
                    <span>Age ${p.age}</span>
                    <span>‚Ä¢</span>
                    <span>${p.archetype}</span>
                  </div>
                </div>
                <div class="prospect-rank">#${p.userRank}</div>
              </div>
              ${flags.length > 0 ? `
                <div class="prospect-flags">
                  ${flags.map(f => `<span class="prospect-flag">${f}</span>`).join('')}
                </div>
              ` : ''}
              <div class="confidence-bar-container" title="Scouting Confidence: ${confidenceWidth}%">
                <div class="confidence-bar" style="width: ${confidenceWidth}%"></div>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      board.innerHTML = html;
      
      // Add click handlers
      board.querySelectorAll(".prospect-card").forEach(card => {
        card.addEventListener("click", () => {
          const id = card.dataset.prospectId;
          const prospect = STATE.draft.prospects.find(p => p.id === id);
          if (prospect) {
            STATE.draft.selectedProspect = prospect;
            renderDraft();
            renderProspectDetail(prospect);
          }
        });
      });
    }
    
    function renderProspectDetail(prospect) {
      const detailDiv = $("#detailProspect");
      
      if (!prospect) {
        detailDiv.innerHTML = '<div class="empty-state">Select a prospect to view details</div>';
        return;
      }
      
      const confidence = prospect.scoutingConfidence;
      const showFullDetails = confidence >= 50;
      
      // Calculate risk degrees for visual dials
      const injuryDeg = (prospect.injuryRisk / 100) * 360;
      const characterDeg = (prospect.characterRisk / 100) * 360;
      
      detailDiv.innerHTML = `
        <div class="prospect-detail-card">
          <div class="prospect-detail-header">
            <div>
              <div class="prospect-detail-name">${prospect.name}</div>
              <div class="prospect-detail-archetype">${prospect.archetype} ‚Ä¢ ${prospect.pos}</div>
            </div>
            <div class="tier-badge ${prospect.tier}">${prospect.tier}</div>
          </div>
          
          <div class="prospect-measurables">
            <div class="measurable-item">
              <div class="measurable-label">Height</div>
              <div class="measurable-value">${prospect.height}</div>
            </div>
            <div class="measurable-item">
              <div class="measurable-label">Weight</div>
              <div class="measurable-value">${prospect.weight}</div>
            </div>
            <div class="measurable-item">
              <div class="measurable-label">Wingspan</div>
              <div class="measurable-value">${prospect.wingspan}</div>
            </div>
            <div class="measurable-item">
              <div class="measurable-label">Age</div>
              <div class="measurable-value">${prospect.age}</div>
            </div>
            <div class="measurable-item">
              <div class="measurable-label">Proj OVR</div>
              <div class="measurable-value">${showFullDetails ? prospect.projectedOvr : "???"}</div>
            </div>
            <div class="measurable-item">
              <div class="measurable-label">Ceiling</div>
              <div class="measurable-value">${showFullDetails ? prospect.ceiling : "???"}</div>
            </div>
          </div>
          
          <h4 style="font-size:13px; color:var(--muted); text-transform:uppercase; margin-bottom:12px;">Skill Grades</h4>
          <div class="skills-grid">
            ${Object.entries(prospect.skills).map(([skill, grade]) => {
              const hidden = confidence < 30 && !['shooting', 'athleticism'].includes(skill);
              return `
                <div class="skill-item">
                  <span class="skill-label">${skill.charAt(0).toUpperCase() + skill.slice(1)}</span>
                  <span class="skill-grade ${grade} ${hidden ? 'hidden' : ''}">${hidden ? '?' : grade}</span>
                </div>
              `;
            }).join('')}
          </div>
          
          ${showFullDetails ? `
            <h4 style="font-size:13px; color:var(--muted); text-transform:uppercase; margin:20px 0 12px;">Risk Assessment</h4>
            <div class="risk-dials">
              <div class="risk-dial">
                <div class="risk-dial-label">Injury Risk</div>
                <div class="risk-dial-circle" style="--risk-deg: ${injuryDeg}deg;">
                  <div class="risk-dial-value">${prospect.injuryRisk}</div>
                </div>
              </div>
              <div class="risk-dial">
                <div class="risk-dial-label">Character Risk</div>
                <div class="risk-dial-circle" style="--risk-deg: ${characterDeg}deg;">
                  <div class="risk-dial-value">${prospect.characterRisk}</div>
                </div>
              </div>
            </div>
          ` : ''}
          
          ${prospect.revealedTraits.length > 0 ? `
            <div class="traits-section">
              <h4>Revealed Traits</h4>
              <div class="trait-badges">
                ${prospect.revealedTraits.map(trait => {
                  const isPositive = ["High Motor", "Elite Work Ethic", "Team Leader"].includes(trait);
                  const isNegative = ["Injury History", "Character Concerns", "Low Basketball IQ"].includes(trait);
                  const className = isPositive ? 'positive' : isNegative ? 'negative' : 'neutral';
                  return `<span class="trait-badge ${className}">${trait}</span>`;
                }).join('')}
              </div>
            </div>
          ` : ''}
          
          ${showFullDetails && prospect.personality ? `
            <h4 style="font-size:13px; color:var(--muted); text-transform:uppercase; margin:20px 0 12px;">Personality Profile</h4>
            <div class="personality-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:16px;">
              ${Object.entries(prospect.personality).slice(0, 6).map(([trait, value]) => `
                <div style="background:var(--bg-3); padding:10px; border-radius:6px; border:1px solid var(--border);">
                  <div style="font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:4px;">${trait}</div>
                  <div style="font-size:16px; font-weight:600; color:${value >= 75 ? 'var(--good)' : value >= 50 ? 'var(--text-0)' : 'var(--bad)'};">${value}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          ${confidence >= 70 && prospect.bio ? `
            <h4 style="font-size:13px; color:var(--muted); text-transform:uppercase; margin:20px 0 12px;">Background</h4>
            <div style="background:var(--bg-3); padding:14px; border-radius:8px; border:1px solid var(--border); margin-bottom:16px;">
              <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-bottom:12px; font-size:12px;">
                <div><span style="color:var(--muted);">College:</span> <strong>${prospect.bio.college}</strong></div>
                <div><span style="color:var(--muted);">Birthplace:</span> <strong>${prospect.bio.birthplace}</strong></div>
                <div><span style="color:var(--muted);">Shoots:</span> <strong>${prospect.bio.shoots}</strong></div>
                <div><span style="color:var(--muted);">Born:</span> <strong>${prospect.bio.birthDate}</strong></div>
              </div>
              <div style="font-size:12px; color:var(--text-1); line-height:1.6; padding-top:12px; border-top:1px solid var(--border);">
                ${prospect.bio.bioText}
              </div>
            </div>
          ` : ''}
          
          <div style="margin-top:20px; display:flex; gap:12px;">
            <button class="btn" onclick="toggleProspectFlag('${prospect.id}', '‚≠ê')">
              ${prospect.userFlags.includes("‚≠ê") ? "‚òÖ Favorited" : "‚òÜ Favorite"}
            </button>
            <button class="btn" onclick="toggleProspectFlag('${prospect.id}', 'üö´')">
              ${prospect.userFlags.includes("üö´") ? "‚úì On DNP List" : "üö´ Do Not Draft"}
            </button>
          </div>
        </div>
      `;
      
      // Render scouting tab
      renderScoutingActions(prospect);
    }
    
    function renderScoutingActions(prospect) {
      const scoutDiv = $("#detailScout");
      
      if (!prospect) {
        scoutDiv.innerHTML = '<div class="empty-state">Select a prospect to scout</div>';
        return;
      }
      
      const scoutActions = [
        { type: "combine", name: "Combine Measurements", desc: "Physical testing & measurements", cost: 10, gain: 15 },
        { type: "workout", name: "Private Workout", desc: "Skill demonstration & drills", cost: 20, gain: 20 },
        { type: "interview", name: "Interview", desc: "Character & mentality evaluation", cost: 15, gain: 12 },
        { type: "film", name: "Film Study", desc: "Game tape analysis", cost: 15, gain: 18 }
      ];
      
      let html = '<div class="scouting-actions">';
      
      scoutActions.forEach(action => {
        const completed = prospect.scoutingReports[action.type];
        const canAfford = STATE.draft.scoutingPoints >= action.cost;
        
        html += `
          <div class="scout-action ${completed ? 'completed' : ''}">
            <div class="scout-action-info">
              <div class="scout-action-name">${action.name}</div>
              <div class="scout-action-desc">${action.desc}</div>
              <div class="scout-action-cost">Cost: ${action.cost} points ‚Ä¢ +${action.gain}% confidence</div>
            </div>
            ${!completed ? `
              <button class="btn ${canAfford ? 'good' : ''}" 
                      onclick="performScouting('${prospect.id}', '${action.type}')"
                      ${!canAfford ? 'disabled' : ''}>
                Scout
              </button>
            ` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      scoutDiv.innerHTML = html;
    }
    
    function renderTeamNeeds() {
      const needsDiv = $("#teamNeedsDisplay");
      
      const positions = ["PG", "SG", "SF", "PF", "C"];
      const positionCounts = {};
      
      STATE.roster.forEach(p => {
        positionCounts[p.pos] = (positionCounts[p.pos] || 0) + 1;
      });
      
      let html = '<div class="needs-grid">';
      
      positions.forEach(pos => {
        const count = positionCounts[pos] || 0;
        const need = Math.max(0, 100 - (count * 20)); // Max need at 0 players, min at 5+
        const needLabel = need > 75 ? "Critical" : need > 50 ? "High" : need > 25 ? "Moderate" : "Low";
        
        html += `
          <div class="need-item">
            <div class="need-pos">${pos}</div>
            <div class="need-bar-container">
              <div class="need-bar" style="height: ${need}%"></div>
            </div>
            <div class="need-label">${needLabel} (${count})</div>
          </div>
        `;
      });
      
      html += '</div>';
      needsDiv.innerHTML = html;
    }
    
    // Draft event handlers
    window.performScouting = function(prospectId, scoutType) {
      const prospect = STATE.draft.prospects.find(p => p.id === prospectId);
      if (!prospect) return;
      
      const costs = { combine: 10, workout: 20, interview: 15, film: 15 };
      const cost = costs[scoutType];
      
      if (STATE.draft.scoutingPoints < cost) {
        showToast("Not enough scouting points!", "bad");
        return;
      }
      
      scoutProspect(prospect, scoutType);
      STATE.draft.scoutingPoints -= cost;
      
      save(STATE);
      renderDraft();
      renderProspectDetail(prospect);
      
      showToast(`Scouted ${prospect.name} - ${scoutType}`, "good");
    };
    
    window.toggleProspectFlag = function(prospectId, flag) {
      const prospect = STATE.draft.prospects.find(p => p.id === prospectId);
      if (!prospect) return;
      
      const idx = prospect.userFlags.indexOf(flag);
      if (idx >= 0) {
        prospect.userFlags.splice(idx, 1);
      } else {
        prospect.userFlags.push(flag);
      }
      
      save(STATE);
      renderDraft();
      renderProspectDetail(prospect);
    };
    
    window.generateProspects = function() {
      const prospects = generateDraftProspects(STATE.year, 60);
      STATE.draft.prospects = prospects;
      STATE.draft.selectedProspect = null;
      STATE.draft.draftedPlayers = [];
      STATE.draft.currentPick = 0;
      STATE.draft.draftStarted = false;
      STATE.draft.scoutingPoints = STATE.draft.maxScoutingPoints;
      
      // Assign initial user ranks
      prospects.forEach((p, i) => {
        p.userRank = i + 1;
      });
      
      save(STATE);
      renderDraft();
      
      showToast("Draft class generated! Begin scouting.", "good");
    };
    
    window.startDraft = function() {
      if (STATE.draft.prospects.length === 0) {
        showToast("Generate prospects first!", "bad");
        return;
      }
      
      STATE.draft.draftStarted = true;
      STATE.draft.currentPick = 0;
      
      save(STATE);
      renderDraft();
      
      showToast("Draft has begun!", "good");
      
      // Start advancing picks
      advanceDraft();
    };
    
    function advanceDraft() {
      if (!STATE.draft.draftStarted) return;
      
      // Check if draft is over
      if (STATE.draft.currentPick >= 60) {
        endDraft();
        return;
      }
      
      // If it's the user's pick, wait for manual selection
      if (STATE.draft.currentPick === STATE.draft.yourPick - 1) {
        showToast("Your pick is ready! Select a prospect.", "neutral");
        renderDraft();
        return;
      }
      
      // Auto-draft for CPU teams
      setTimeout(() => {
        autoDraftCPU();
        STATE.draft.currentPick++;
        save(STATE);
        renderDraft();
        advanceDraft();
      }, 800); // 0.8 second between picks
    }
    
    function autoDraftCPU() {
      const available = STATE.draft.prospects.filter(p => !p.draftPosition);
      if (available.length === 0) return;
      
      // CPU picks best available with slight randomness
      const topTier = available.filter(p => p.tier === "Elite" || p.tier === "High");
      const pickPool = topTier.length > 0 ? topTier : available;
      
      const idx = Math.floor(Math.random() * Math.min(5, pickPool.length));
      const picked = pickPool[idx];
      
      picked.draftPosition = STATE.draft.currentPick + 1;
      picked.draftedBy = `Team ${STATE.draft.currentPick + 1}`;
      
      STATE.draft.draftedPlayers.push(picked);
    }
    
    window.autoDraftUser = function() {
      if (STATE.draft.currentPick !== STATE.draft.yourPick - 1) {
        showToast("Not your pick yet!", "bad");
        return;
      }
      
      const available = STATE.draft.prospects.filter(p => !p.draftPosition && !p.userFlags.includes("üö´"));
      if (available.length === 0) {
        showToast("No prospects available!", "bad");
        return;
      }
      
      // Calculate BPA vs Needs
      const positionCounts = {};
      STATE.roster.forEach(p => {
        positionCounts[p.pos] = (positionCounts[p.pos] || 0) + 1;
      });
      
      const needyPositions = ["PG", "SG", "SF", "PF", "C"].filter(pos => (positionCounts[pos] || 0) < 2);
      
      let bestProspect = available[0];
      let bestScore = 0;
      
      available.forEach(p => {
        let score = (p.projectedOvr || 70) + (p.scoutingConfidence / 2);
        
        // Boost for team needs
        if (needyPositions.includes(p.pos)) {
          score += 15;
        }
        
        // Boost for favorited
        if (p.userFlags.includes("‚≠ê")) {
          score += 20;
        }
        
        if (score > bestScore) {
          bestScore = score;
          bestProspect = p;
        }
      });
      
      executePick(bestProspect, "standard");
    };
    
    function executePick(prospect, contractType) {
      if (!prospect) return;
      
      prospect.draftPosition = STATE.draft.yourPick;
      prospect.draftedBy = "Your Team";
      
      STATE.draft.draftedPlayers.push(prospect);
      
      const newPlayer = draftPlayer(prospect, contractType);
      STATE.roster.push(newPlayer);
      
      // Fan hype update for draft picks
      if (prospect.tier === "Elite") {
        updateFanHype(15, `Drafting elite prospect ${prospect.name}`);
      } else if (prospect.tier === "High") {
        updateFanHype(10, `Selecting high-upside ${prospect.name} in draft`);
      } else if (prospect.tier === "Mid") {
        updateFanHype(5, `Adding solid prospect ${prospect.name}`);
      }
      
      STATE.draft.currentPick++;
      
      save(STATE);
      renderDraft();
      renderRoster();
      
      showToast(`Drafted ${prospect.name} at #${STATE.draft.yourPick}!`, "good");
      
      // Continue draft
      advanceDraft();
    }
    
    function endDraft() {
      STATE.draft.draftStarted = false;
      
      const yourPick = STATE.draft.draftedPlayers.find(p => p.draftedBy === "Your Team");
      
      let msg = "Draft complete!";
      if (yourPick) {
        msg += ` You selected ${yourPick.name} at #${yourPick.draftPosition}.`;
      }
      
      showToast(msg, "good");
      
      save(STATE);
      renderDraft();
    }
    
    function openOwnerMeeting(meetingType = "progress") {
      const owner = STATE.owner;
      const modal = $("#ownerMeetingModal");
      
      // Update trust before meeting
      const oldTrust = owner.trust;
      calculateOwnerTrust(owner, STATE);
      const trustChange = owner.trust - oldTrust;
      
      // Set meeting title and subtitle
      if (meetingType === "season_start") {
        $("#meetingTitle").textContent = "Season Start Meeting";
        $("#meetingSubtitle").textContent = "Setting expectations for the season";
      } else if (meetingType === "mid_season") {
        $("#meetingTitle").textContent = "Mid-Season Review";
        $("#meetingSubtitle").textContent = "Evaluating progress";
      } else if (meetingType === "season_end") {
        $("#meetingTitle").textContent = "End of Season Review";
        $("#meetingSubtitle").textContent = "Final evaluation";
      } else {
        $("#meetingTitle").textContent = "Owner Meeting";
        $("#meetingSubtitle").textContent = "Progress Discussion";
      }
      
      // Generate feedback quote
      const trust = owner.trust;
      let quote = "";
      
      if (trust >= 85) {
        const quotes = [
          "I'm extremely impressed with what you've built here. Keep it up!",
          "This is exactly the vision I had for this team. Excellent work.",
          "You've exceeded my expectations. I'm proud of this organization.",
          "The results speak for themselves. I fully support your direction."
        ];
        quote = quotes[Math.floor(Math.random() * quotes.length)];
      } else if (trust >= 70) {
        const quotes = [
          "We're on the right track. I'm pleased with the progress.",
          "Solid work so far. Keep building on this foundation.",
          "I like what I'm seeing. Stay the course.",
          "You're meeting expectations. Let's keep this momentum."
        ];
        quote = quotes[Math.floor(Math.random() * quotes.length)];
      } else if (trust >= 50) {
        const quotes = [
          "I'm watching closely. I need to see more consistent results.",
          "We're making progress, but I expect better performance soon.",
          "Show me you can turn this around. Time is running out.",
          "I'm giving you the benefit of the doubt, but I need results."
        ];
        quote = quotes[Math.floor(Math.random() * quotes.length)];
      } else if (trust >= 30) {
        const quotes = [
          "I'm very concerned about the direction we're headed.",
          "This isn't what I signed up for. Things need to change quickly.",
          "I'm losing confidence in this approach. Show me something.",
          "We need to have a serious conversation about the future."
        ];
        quote = quotes[Math.floor(Math.random() * quotes.length)];
      } else {
        const quotes = [
          "I can't continue down this path. Major changes are needed.",
          "This is unacceptable. Your job is on the line.",
          "I'm seriously considering making a change. Prove me wrong.",
          "One more misstep and we'll be having a different conversation."
        ];
        quote = quotes[Math.floor(Math.random() * quotes.length)];
      }
      
      $("#meetingQuote").textContent = quote;
      
      // Show trust change indicator
      const trustIndicator = $("#trustChangeIndicator");
      if (trustChange !== 0) {
        trustIndicator.style.display = "flex";
        const icon = $("#trustChangeIcon");
        const text = $("#trustChangeText");
        
        if (trustChange > 0) {
          icon.textContent = "‚Üë";
          icon.className = "trust-change-icon positive";
          text.textContent = `Trust increased by ${trustChange}`;
        } else {
          icon.textContent = "‚Üì";
          icon.className = "trust-change-icon negative";
          text.textContent = `Trust decreased by ${Math.abs(trustChange)}`;
        }
      } else {
        trustIndicator.style.display = "none";
      }
      
      // Performance summary
      const d = STATE.dashboard;
      const winPct = ((d.wins / (d.wins + d.losses || 1)) * 100).toFixed(1);
      const payroll = sum(STATE.roster, p => p.salary);
      const chemistry = STATE.dashboard.chemistry || 50;
      
      $("#meetingPerformance").innerHTML = `
        <div>
          <div style="color:var(--muted); margin-bottom:4px">Record</div>
          <div style="color:var(--text-0); font-weight:700">${d.wins}-${d.losses} (${winPct}%)</div>
        </div>
        <div>
          <div style="color:var(--muted); margin-bottom:4px">Payroll</div>
          <div style="color:var(--text-0); font-weight:700">${fmt(payroll)}</div>
        </div>
        <div>
          <div style="color:var(--muted); margin-bottom:4px">Chemistry</div>
          <div style="color:var(--text-0); font-weight:700">${chemistry}</div>
        </div>
        <div>
          <div style="color:var(--muted); margin-bottom:4px">Streak</div>
          <div style="color:var(--text-0); font-weight:700">${d.streak.type === 'w' ? 'W' : d.streak.type === 'l' ? 'L' : '-'}${d.streak.count || 0}</div>
        </div>
      `;
      
      // Goals progress
      $("#meetingGoals").innerHTML = owner.goals.map(goal => {
        const met = goal.met === true ? "met" : goal.met === false ? "unmet" : "pending";
        const icon = goal.met === true ? "‚úì" : goal.met === false ? "‚úó" : "‚è≥";
        const color = goal.met === true ? "var(--good)" : goal.met === false ? "var(--bad)" : "var(--muted)";
        
        return `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--bg-3); border-radius:6px">
            <span style="font-size:13px; color:var(--text-0)">${goal.description}</span>
            <span style="font-size:20px; color:${color}">${icon}</span>
          </div>
        `;
      }).join('');
      
      // Log meeting to history
      if (!owner.meetingHistory) owner.meetingHistory = [];
      owner.meetingHistory.unshift({
        type: meetingType.replace('_', ' ').toUpperCase(),
        text: quote,
        date: `Season ${STATE.meta.season}`,
        icon: trust >= 70 ? "üòä" : trust >= 40 ? "üòê" : "üò†"
      });
      if (owner.meetingHistory.length > 10) owner.meetingHistory.pop();
      
      modal.style.display = "flex";
      save(STATE);
    }
    
    function openNegotiateGoalsModal() {
      const owner = STATE.owner;
      const modal = $("#negotiateGoalsModal");
      
      const goalsList = $("#negotiateGoalsList");
      goalsList.innerHTML = owner.goals.map((goal, i) => {
        return `
          <div class="panel" style="padding:16px; margin-bottom:12px">
            <div style="font-size:13px; font-weight:600; margin-bottom:8px; color:var(--text-0)">${goal.description}</div>
            <div style="font-size:12px; color:var(--text-1)">Priority: <strong>${goal.priority}</strong></div>
          </div>
        `;
      }).join('');
      
      modal.style.display = "flex";
    }
    
    function acceptSeasonGoals() {
      const owner = STATE.owner;
      owner.trust = Math.min(100, owner.trust + 5);
      owner.notes = "Appreciates your commitment to meeting expectations.";
      
      const result = $("#negotiateResult");
      result.style.display = "block";
      result.style.background = "rgba(58,198,121,0.1)";
      result.style.border = "1px solid var(--good)";
      result.style.color = "var(--good)";
      result.textContent = "‚úì Owner pleased with your commitment. Trust +5";
      
      addEvent(`Agreed to owner's season expectations. Trust increased.`, "league");
      setTimeout(() => {
        $("#negotiateGoalsModal").style.display = "none";
        renderOwner();
      }, 2000);
      
      save(STATE);
    }
    
    function pushBackOnGoals() {
      const owner = STATE.owner;
      
      // Chance of success based on trust and owner patience
      const trust = owner.trust;
      const patience = owner.traits.patience;
      const successChance = (trust + patience) / 200; // 0-100%
      
      const success = Math.random() < successChance;
      
      const result = $("#negotiateResult");
      result.style.display = "block";
      
      if (success) {
        // Slight trust loss but goals relaxed
        owner.trust = Math.max(0, owner.trust - 3);
        owner.notes = "Reluctantly agreed to more flexible expectations.";
        
        // Reduce goal targets slightly
        owner.goals.forEach(goal => {
          if (goal.type === "wins") {
            goal.target = Math.max(30, goal.target - 5);
            goal.description = `Win at least ${goal.target} games this season`;
          }
        });
        
        result.style.background = "rgba(251,191,36,0.1)";
        result.style.border = "1px solid var(--warn)";
        result.style.color = "var(--warn)";
        result.textContent = "‚ö† Owner accepted, but with reservations. Trust -3, goals adjusted.";
        
        addEvent(`Successfully negotiated more reasonable expectations with owner.`, "league");
      } else {
        // Failed negotiation, bigger trust loss
        owner.trust = Math.max(0, owner.trust - 8);
        owner.notes = "Frustrated by pushback on expectations. Relationship strained.";
        
        result.style.background = "rgba(255,107,107,0.1)";
        result.style.border = "1px solid var(--bad)";
        result.style.color = "var(--bad)";
        result.textContent = "‚úó Owner rejected your request. Trust -8, expectations unchanged.";
        
        addEvent(`Owner rejected attempt to renegotiate expectations. Trust damaged.`, "league");
      }
      
      setTimeout(() => {
        $("#negotiateGoalsModal").style.display = "none";
        renderOwner();
      }, 2500);
      
      save(STATE);
    }
    
    // Owner Event Handlers
    $("#closeOwnerMeetingModal")?.addEventListener("click", () => {
      $("#ownerMeetingModal").style.display = "none";
    });
    
    $("#acceptMeetingBtn")?.addEventListener("click", () => {
      $("#ownerMeetingModal").style.display = "none";
      renderOwner();
    });
    
    $("#negotiateGoalsBtn")?.addEventListener("click", openNegotiateGoalsModal);
    
    $("#closeNegotiateModal")?.addEventListener("click", () => {
      $("#negotiateGoalsModal").style.display = "none";
    });
    
    $("#cancelNegotiateBtn")?.addEventListener("click", () => {
      $("#negotiateGoalsModal").style.display = "none";
    });
    
    $("#acceptGoalsBtn")?.addEventListener("click", acceptSeasonGoals);
    $("#pushBackBtn")?.addEventListener("click", pushBackOnGoals);
    
    $("#requestMeetingBtn")?.addEventListener("click", () => {
      openOwnerMeeting("progress");
    });
    
    // Finance control listeners
    $("#finTicketPrice")?.addEventListener("input", (e) => {
      STATE.finance.settings.ticketPrice = parseFloat(e.target.value);
      renderFinance();
      save(STATE);
    });
    
    $("#finPromoSpend")?.addEventListener("input", (e) => {
      STATE.finance.settings.promoSpend = parseInt(e.target.value);
      renderFinance();
      save(STATE);
    });
    
    $("#finFacilityLvl")?.addEventListener("input", (e) => {
      STATE.finance.settings.facilityLvl = parseInt(e.target.value);
      renderFinance();
      save(STATE);
    });

    // -------------------------------
    // Helpers
    // -------------------------------
    function rerenderAll(){
      $(".title").textContent = STATE.meta.teamName;
      $("#seasonTag").textContent = `Season: ${STATE.meta.season}`;
      
      // Update settings UI
      $("#teamName").value = STATE.meta.teamName;
      $("#seasonInput").value = STATE.meta.season;
      if (!STATE.settings) STATE.settings = { ownerIntervention: true };
      $("#ownerInterventionToggle").checked = STATE.settings.ownerIntervention !== false;
      
      renderDashboardCaps();
      renderDashboardRecord();
      renderPerformance();
      renderFeed();
      renderLeagueHeadlines();
      renderTopPerformer();
      renderAnalytics();
      renderFanHype();
      renderSchedule();
      renderDraft();
      renderRoster();
      renderCapSheet();
    }
    function addEvent(text, type = "league"){ STATE.events.unshift({ts:Date.now(), text, type}); }
    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.position="fixed"; el.style.bottom="16px"; el.style.right="16px";
      el.style.background="var(--bg-3)"; el.style.color="var(--text-0)";
      el.style.border="1px solid var(--border)"; el.style.padding="10px 12px";
      el.style.borderRadius="8px"; el.style.boxShadow="var(--shadow)"; el.style.zIndex=9999;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 1800);
    }
    
    function showToast(msg, type = "neutral"){
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.position="fixed"; el.style.bottom="16px"; el.style.right="16px";
      el.style.padding="10px 12px";
      el.style.borderRadius="8px"; el.style.boxShadow="var(--shadow)"; el.style.zIndex=9999;
      el.style.border="1px solid var(--border)";
      
      if (type === "good") {
        el.style.background="#1a3d1a"; el.style.color="#4ade80"; el.style.borderColor="#4ade80";
      } else if (type === "bad") {
        el.style.background="#3d1a1a"; el.style.color="#f87171"; el.style.borderColor="#f87171";
      } else {
        el.style.background="var(--bg-3)"; el.style.color="var(--text-0)";
      }
      
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2000);
    }
    
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
    function inferTeamNeed(){
      // naive: find lowest OVR position
      const byPos = {};
      for(const p of STATE.roster){ byPos[p.pos] = Math.max(byPos[p.pos]||0, p.ovr); }
      const order = ["PG","SG","SF","PF","C"].map(pos=>({pos,ovr:byPos[pos]||0})).sort((a,b)=>a.ovr-b.ovr);
      return order[0]?.pos || "wing";
    }
    function genName(){
      const first=["Jalen","Maya","Kei","Rico","Devon","Luka","Tiana","Anya","Jude","Zion","Niko","Rhea","Kobe","Imani","Kai"];
      const last=["Lawson","Ajayi","Vega","Petrovic","Nguyen","Rodriguez","Okafor","Han","Silva","Rossi","Dubois","Khan","Ivanov","Yamamoto","O'Neal"];
      return first[Math.floor(Math.random()*first.length)]+" "+last[Math.floor(Math.random()*last.length)];
    }

    // Init
    // Initialize owner goals if not already set
    if (STATE.owner && (!STATE.owner.goals || STATE.owner.goals.length === 0)) {
      STATE.owner.goals = generateSeasonGoals(STATE, STATE.owner);
    }
    
    rerenderAll();
  </script>
</body>
</html>
